<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Garden - SOW Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .editable-table input[type="number"] {
            width: 70px;
            text-align: right;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 0.5rem;
            transition: all 0.2s;
        }
        .editable-table input[type="number"]:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        .research-step {
            border-left: 4px solid #e5e7eb;
            transition: border-color 0.3s ease;
        }
        .research-step.completed {
            border-left-color: #10b981;
        }
        .research-step.active {
            border-left-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="flex flex-col lg:flex-row min-h-screen">
        <!-- Left Panel: Research Steps and Inputs -->
        <aside class="w-full lg:w-1/3 bg-white p-6 border-r border-gray-200 flex flex-col">
            <header class="flex items-center mb-8">
                <div class="w-10 h-10 bg-indigo-600 rounded-full mr-3 flex items-center justify-center text-white font-bold text-lg">SG</div>
                <h1 class="text-2xl font-bold text-gray-900">SOW Generator</h1>
            </header>

            <div class="space-y-6">
                <!-- Step A: Client Research -->
                <div class="research-step p-4 rounded-lg bg-gray-50" id="client-research-step">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Step A: Client Research</h3>
                    <label for="client-name-input" class="block text-sm font-medium text-gray-700 mb-2">Client Name</label>
                    <div class="flex space-x-2">
                        <input type="text" id="client-name-input" class="flex-1 p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Canva, Microsoft, Hostinger">
                        <button id="client-search-btn" class="bg-blue-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200 shadow-sm">
                            Search Client
                        </button>
                    </div>
                    <div id="client-search-loading" class="hidden text-center mt-2">
                        <svg class="animate-spin h-4 w-4 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-xs text-blue-600 mt-1">Researching client...</p>
                    </div>
                </div>

                <!-- Step B: Service Research -->
                <div class="research-step p-4 rounded-lg bg-gray-50" id="service-research-step">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Step B: Service Research</h3>
                    <label for="service-research-input" class="block text-sm font-medium text-gray-700 mb-2">Service Type</label>
                    <div class="flex space-x-2">
                        <input type="text" id="service-research-input" class="flex-1 p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., HubSpot Implementation, Dynamics 365 Audit">
                        <button id="service-search-btn" class="bg-purple-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors duration-200 shadow-sm">
                            Search Service
                        </button>
                    </div>
                    <div id="service-search-loading" class="hidden text-center mt-2">
                        <svg class="animate-spin h-4 w-4 text-purple-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-xs text-purple-600 mt-1">Researching service...</p>
                    </div>
                </div>

                <!-- Step C: Detailed Brief -->
                <div class="research-step p-4 rounded-lg bg-gray-50" id="brief-step">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Step C: Detailed Brief</h3>
                    <label for="client-brief" class="block text-sm font-medium text-gray-700 mb-2">Project Requirements</label>
                    <textarea id="client-brief" rows="6" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Describe the specific requirements, goals, and scope for this project..."></textarea>
                </div>

                <!-- Final Generation Button -->
                <button id="generate-btn" class="w-full bg-indigo-600 text-white font-semibold py-4 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200 shadow-sm text-lg">
                    Generate Full Scope
                </button>
                
                <div id="final-loading" class="hidden text-center mt-4">
                    <svg class="animate-spin h-6 w-6 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-sm text-indigo-600 mt-1">Generating complete SOW...</p>
                </div>
            </div>

            <!-- Export Section -->
            <div class="mt-auto pt-6">
                <h2 class="text-lg font-semibold mb-2">Export</h2>
                <button id="export-btn" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200 shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Export as Branded PDF
                </button>
            </div>
        </aside>

        <!-- Right Panel: Research Log and SOW Output -->
        <main class="w-full lg:w-2/3 p-8 overflow-y-auto bg-gray-100">
            <!-- Research Log Section -->
            <div id="research-log" class="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-8">
                <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    Research Log
                </h2>
                <div id="research-log-content" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <h3 class="mt-2 text-lg font-medium text-gray-900">Research results will appear here</h3>
                        <p class="mt-1 text-sm text-gray-500">Start by searching for client information in Step A.</p>
                    </div>
                </div>
            </div>

            <!-- Final SOW Content Section -->
            <div id="sow-content" class="hidden bg-white p-8 rounded-xl shadow-md border border-gray-200 fade-in">
                <div class="border-b pb-4 mb-6">
                    <h2 class="text-3xl font-bold text-gray-900" id="sow-title">Scope of Work: [Client Name]</h2>
                    <p class="text-gray-600" id="sow-project"><strong>Project:</strong> [Service Type]</p>
                </div>

                <div class="prose prose-indigo max-w-none">
                    <h3 class="font-semibold">Project Overview</h3>
                    <textarea id="project-overview" class="w-full p-3 border rounded-md resize-none" rows="4">This scope of work will be generated based on your research and brief...</textarea>
                    
                    <h3 class="font-semibold mt-6">Investment Summary</h3>
                    <p class="text-sm text-gray-600 mb-4">You can modify the hours directly in the table below. Totals will update instantly.</p>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 editable-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Hours</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Rate</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="pricing-table-body">
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <div class="w-full max-w-sm space-y-3">
                            <div>
                                <label for="discount" class="block text-sm font-medium text-gray-700">Discount (%)</label>
                                <input type="number" id="discount" value="0" oninput="updateTotals()" class="mt-1 w-full p-2 border rounded-md">
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <dl class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <dt>Sub-total</dt>
                                        <dd id="sub-total">$0.00</dd>
                                    </div>
                                    <div class="flex justify-between text-sm text-red-600">
                                        <dt>Discount</dt>
                                        <dd id="discount-amount">$0.00</dd>
                                    </div>
                                    <div class="flex justify-between text-lg font-bold text-gray-900 border-t pt-2">
                                        <dt>Grand Total</dt>
                                        <dd id="grand-total">$0.00</dd>
                                    </div>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>    <script>        // --- AnythingLLM API Configuration ---
        const ANYTHINGLLM_CONFIG = {
            baseUrl: 'https://socialgarden-anything-llm.vo0egb.easypanel.host',
            apiKey: 'F7C84WV-75N4QWH-P9ERFRV-CWJ146T',
            workspace: 'main'
        };

        // --- AnythingLLM API Helper Functions ---

        /**
         * Makes a chat request to AnythingLLM API using the correct endpoint
         * @param {string} message - The message to send to the AI
         * @returns {Promise<string>} - The AI response
         */
        async function callAnythingLLM(message) {
            const response = await fetch(`${ANYTHINGLLM_CONFIG.baseUrl}/api/v1/workspace/${ANYTHINGLLM_CONFIG.workspace}/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ANYTHINGLLM_CONFIG.apiKey}`,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    mode: 'chat'
                })
            });

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            return data.textResponse || data.message || 'No response received';
        }

        // --- Global Application State ---
        let clientData = ""; // Stores client research results
        let serviceData = ""; // Stores service research results
        
        // --- DOM Element References ---
        const clientNameInput = document.getElementById('client-name-input');
        const clientSearchBtn = document.getElementById('client-search-btn');
        const clientSearchLoading = document.getElementById('client-search-loading');
        const clientResearchStep = document.getElementById('client-research-step');
        
        const serviceResearchInput = document.getElementById('service-research-input');
        const serviceSearchBtn = document.getElementById('service-search-btn');
        const serviceSearchLoading = document.getElementById('service-search-loading');
        const serviceResearchStep = document.getElementById('service-research-step');
        
        const clientBrief = document.getElementById('client-brief');
        const briefStep = document.getElementById('brief-step');
        
        const generateBtn = document.getElementById('generate-btn');
        const finalLoading = document.getElementById('final-loading');
        const exportBtn = document.getElementById('export-btn');
        
        const researchLogContent = document.getElementById('research-log-content');
        const sowContent = document.getElementById('sow-content');
        const sowTitle = document.getElementById('sow-title');
        const sowProject = document.getElementById('sow-project');
        const projectOverview = document.getElementById('project-overview');
        const pricingTableBody = document.getElementById('pricing-table-body');

        // --- Mock Data for SOW Generation ---
        const mockApiResponse = {
            roles: [
                { name: "Tech - Sr. Consultant", hours: 30, rate: 295 },
                { name: "Tech - Specialist", hours: 45, rate: 180 },
                { name: "Project Coordination", hours: 20, rate: 110 },
                { name: "Account Management", hours: 12, rate: 210 }
            ]
        };

        // --- Mock Research Data ---
        const mockClientResearch = {
            'canva': 'Canva is an Australian multinational software company that provides a web-based graphic design platform. Founded in 2012, it has grown to serve over 100 million users worldwide. Known for democratizing design through user-friendly tools and templates. Recent focus on AI-powered features and enterprise solutions.',
            'microsoft': 'Microsoft Corporation is a multinational technology company known for software products, cloud services, and enterprise solutions. Major revenue drivers include Azure cloud platform, Office 365, and Windows. Strong focus on AI integration and digital transformation services.',
            'hostinger': 'Hostinger is a Lithuanian web hosting company and internet domain registrar. Founded in 2004, it serves over 29 million users worldwide. Known for affordable hosting solutions, user-friendly control panel, and strong customer support. Recent expansion into cloud services and website builder tools.',
            'default': 'This organization appears to be a dynamic company with growth potential and technology adoption initiatives. Research indicates a focus on digital transformation and operational efficiency.'
        };

        const mockServiceResearch = {
            'hubspot implementation': 'HubSpot implementations typically involve a 4-phase approach: 1) Discovery & Audit (2-3 weeks), 2) Setup & Configuration (3-4 weeks), 3) Data Migration & Integration (2-3 weeks), 4) Training & Go-Live (1-2 weeks). Key success factors include proper contact database cleanup, workflow automation setup, and comprehensive user training.',
            'dynamics 365 audit': 'Dynamics 365 audits should cover: system performance analysis, data quality assessment, user adoption metrics, customization review, integration health checks, and security compliance. Typical audit duration is 4-6 weeks with deliverables including current state assessment, gap analysis, and improvement roadmap.',
            'salesforce implementation': 'Salesforce implementations follow a structured approach: Requirements Gathering, System Design, Configuration & Customization, Data Migration, User Training, and Go-Live Support. Average timeline is 3-6 months depending on complexity. Critical success factors include executive sponsorship, data quality, and change management.',
            'default': 'This service typically follows industry best practices with a phased implementation approach, comprehensive testing, stakeholder training, and ongoing support to ensure successful adoption and ROI achievement.'
        };        // --- AnythingLLM API Helper Functions ---

        /**
         * Makes a chat request to AnythingLLM API
         * @param {string} message - The message to send to the AI
         * @returns {Promise<string>} - The AI response
         */
        async function callAnythingLLM(message) {
            const response = await fetch(`${ANYTHINGLLM_CONFIG.baseUrl}/api/workspace/${ANYTHINGLLM_CONFIG.workspace}/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ANYTHINGLLM_CONFIG.apiKey}`,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    mode: 'chat'
                })
            });

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            return data.textResponse || data.message || 'No response received';
        }        /**
         * Extracts structured data from AI response for SOW generation
         * @param {string} aiResponse - The raw AI response
         * @param {string} clientName - Client name for SOW
         * @param {string} serviceType - Service type for SOW
         * @param {string} brief - Original brief
         * @returns {Object} - Structured SOW data
         */
        function parseSOWResponse(aiResponse, clientName, serviceType, brief) {
            // Default role structure
            const defaultRoles = [
                { name: "Tech - Sr. Consultant", hours: 30, rate: 295 },
                { name: "Tech - Specialist", hours: 45, rate: 180 },
                { name: "Project Coordination", hours: 20, rate: 110 },
                { name: "Account Management", hours: 12, rate: 210 }
            ];

            // Try to extract hour estimates from AI response
            const hourMatches = aiResponse.match(/(\d+)\s*hours?/gi);
            if (hourMatches && hourMatches.length >= 4) {
                // Update roles with AI-suggested hours
                hourMatches.slice(0, 4).forEach((match, index) => {
                    if (defaultRoles[index]) {
                        const hours = parseInt(match.match(/\d+/)[0]);
                        if (hours > 0 && hours < 200) { // Sanity check
                            defaultRoles[index].hours = hours;
                        }
                    }
                });
            }

            // Extract project overview from AI response or generate fallback
            let overview = '';
            const overviewMatch = aiResponse.match(/project overview[:\s]*([^\.]+(?:\.[^\.]*){2,3})/i);
            if (overviewMatch) {
                overview = overviewMatch[1].trim();
            } else {
                // Generate fallback overview combining all data
                overview = `This scope of work details Social Garden's proposed approach to support ${clientName || 'the client'} with their ${serviceType || 'project requirements'}. Based on our comprehensive research and analysis, we have developed a structured implementation plan that leverages industry best practices and ensures successful project delivery with measurable outcomes.`;
            }            return {
                clientName: clientName || 'Client',
                serviceType: serviceType || 'Professional Services',
                overview: overview,
                roles: defaultRoles,
                rawResponse: aiResponse
            };
        }

        // =============================================================================
        // STEP A: CLIENT RESEARCH WORKFLOW
        // =============================================================================

        /**
         * Handles client research when user clicks "Search Client" button
         * Makes real API call: @agent search for the company "[client name]"
         */
        async function performClientResearch() {
            const clientName = clientNameInput.value.trim();
            if (!clientName) {
                alert('Please enter a client name to research.');
                return;
            }

            // Update UI state
            clientSearchBtn.disabled = true;
            clientSearchLoading.classList.remove('hidden');
            clientResearchStep.classList.add('active');

            // Add searching message to research log
            addToResearchLog('Searching...', `Searching for "${clientName}"...`, 'blue');

            try {
                // Make real API call to AnythingLLM
                const prompt = `@agent search the internet for the company "${clientName}" and provide a comprehensive summary including: company background, industry, size, recent news, key focus areas, and any relevant information that would help in creating a personalized statement of work. Keep the response concise but informative (2-3 sentences).`;
                
                const research = await callAnythingLLM(prompt);
                clientData = research;

                // Update research log with results
                updateLastLogEntry('Client Research Complete', research, 'blue');

                // Mark step as completed
                clientResearchStep.classList.remove('active');
                clientResearchStep.classList.add('completed');

                console.log('Client research completed:', clientData);
            } catch (error) {
                console.error('Client research failed:', error);
                const errorMessage = `Failed to research ${clientName}. Error: ${error.message}`;
                updateLastLogEntry('Client Research Failed', errorMessage, 'red');
            } finally {
                // Reset UI state
                clientSearchBtn.disabled = false;
                clientSearchLoading.classList.add('hidden');
            }
        }        // =============================================================================
        // STEP B: SERVICE RESEARCH WORKFLOW
        // =============================================================================

        /**
         * Handles service research when user clicks "Search Service" button
         * Makes real API call: @agent search for best practices for "[service type]"
         */
        async function performServiceResearch() {
            const serviceType = serviceResearchInput.value.trim();
            if (!serviceType) {
                alert('Please enter a service type to research.');
                return;
            }

            // Update UI state
            serviceSearchBtn.disabled = true;
            serviceSearchLoading.classList.remove('hidden');
            serviceResearchStep.classList.add('active');

            // Add searching message to research log
            addToResearchLog('Searching...', `Searching for best practices for "${serviceType}"...`, 'purple');

            try {
                // Make real API call to AnythingLLM
                const prompt = `@agent search for best practices for "${serviceType}" and provide a comprehensive overview including: typical implementation phases, timeline estimates, key success factors, common challenges, and industry standards. Include specific hour estimates for different roles if possible. Keep the response detailed but concise.`;
                
                const research = await callAnythingLLM(prompt);
                serviceData = research;

                // Update research log with results
                updateLastLogEntry('Service Research Complete', research, 'purple');

                // Mark step as completed
                serviceResearchStep.classList.remove('active');
                serviceResearchStep.classList.add('completed');

                console.log('Service research completed:', serviceData);
            } catch (error) {
                console.error('Service research failed:', error);
                const errorMessage = `Failed to research ${serviceType}. Error: ${error.message}`;
                updateLastLogEntry('Service Research Failed', errorMessage, 'red');
            } finally {
                // Reset UI state
                serviceSearchBtn.disabled = false;                serviceSearchLoading.classList.add('hidden');
            }
        }

        // =============================================================================
        // STEP C: FINAL SOW GENERATION WORKFLOW
        // =============================================================================

        /**
         * Generates the complete SOW by combining client data, service data, and brief
         * Makes real API call that processes all three data sources
         */
         */
        async function generateCompleteSOW() {
            const brief = clientBrief.value.trim();
            const clientName = clientNameInput.value.trim();
            const serviceType = serviceResearchInput.value.trim();

            if (!brief) {
                alert('Please enter a detailed brief before generating the scope.');
                return;
            }

            // Update UI state
            generateBtn.disabled = true;
            finalLoading.classList.remove('hidden');
            briefStep.classList.add('active');

            // Add generation message to research log
            addToResearchLog('Generating...', 'Generating complete SOW using client research, service research, and detailed brief...', 'indigo');

            try {
                // Create comprehensive prompt combining all research and brief
                const comprehensivePrompt = `
                    Create a comprehensive Statement of Work (SOW) based on the following information:

                    CLIENT RESEARCH:
                    ${clientData || 'No specific client research available'}

                    SERVICE RESEARCH:
                    ${serviceData || 'No specific service research available'}

                    PROJECT BRIEF:
                    ${brief}

                    Please generate:
                    1. A detailed project overview (3-4 sentences)
                    2. Specific hour estimates for different consulting roles:
                       - Tech - Sr. Consultant (rate: $295/hour)
                       - Tech - Specialist (rate: $180/hour) 
                       - Project Coordination (rate: $110/hour)
                       - Account Management (rate: $210/hour)

                    Format your response with clear sections and include realistic hour estimates based on the project scope. Consider the client background and service complexity when estimating hours.
                `;

                // Make real API call to AnythingLLM
                const aiResponse = await callAnythingLLM(comprehensivePrompt);                // Parse AI response and extract data
                const sowData = parseSOWResponse(aiResponse, clientName, serviceType, brief);

                // Render the complete SOW
                renderCompleteSOW(sowData);

                // Update research log with completion
                updateLastLogEntry('SOW Generation Complete', 'Complete scope of work has been generated using AI analysis and is ready for review and export.', 'indigo');

                // Mark final step as completed
                briefStep.classList.remove('active');
                briefStep.classList.add('completed');

                // Enable export
                exportBtn.disabled = false;

                console.log('SOW generation completed:', sowData);
            } catch (error) {
                console.error('SOW generation failed:', error);
                const errorMessage = `Failed to generate SOW. Error: ${error.message}`;
                updateLastLogEntry('SOW Generation Failed', errorMessage, 'red');
            } finally {
                // Reset UI state
                generateBtn.disabled = false;
                finalLoading.classList.add('hidden');
            }
        }

        // =============================================================================
        // RESEARCH LOG MANAGEMENT FUNCTIONS
        // =============================================================================

        /**
         * Adds a new entry to the research log
         */
        function addToResearchLog(title, content, color = 'gray') {
            // Clear placeholder if this is the first entry
            if (researchLogContent.querySelector('.text-center')) {
                researchLogContent.innerHTML = '';
            }

            const colorClasses = {
                'blue': 'border-blue-200 bg-blue-50',
                'purple': 'border-purple-200 bg-purple-50', 
                'indigo': 'border-indigo-200 bg-indigo-50',
                'green': 'border-green-200 bg-green-50',
                'red': 'border-red-200 bg-red-50',
                'gray': 'border-gray-200 bg-gray-50'
            };

            const entry = document.createElement('div');
            entry.className = `border-l-4 ${colorClasses[color]} p-4 rounded-r-lg research-log-entry`;
            entry.innerHTML = `
                <h4 class="font-semibold text-gray-900 research-log-title">${title}</h4>
                <p class="text-sm text-gray-700 mt-1 research-log-content">${content}</p>
                <p class="text-xs text-gray-500 mt-2">${new Date().toLocaleTimeString()}</p>
            `;
            
            researchLogContent.appendChild(entry);
            
            // Scroll to bottom
            researchLogContent.scrollTop = researchLogContent.scrollHeight;
        }

        /**
         * Updates the last entry in the research log (for updating status)
         */
        function updateLastLogEntry(newTitle, newContent, color = 'gray') {
            const lastEntry = researchLogContent.lastElementChild;
            if (lastEntry && lastEntry.classList.contains('research-log-entry')) {
                const titleElement = lastEntry.querySelector('.research-log-title');
                const contentElement = lastEntry.querySelector('.research-log-content');
                
                if (titleElement) titleElement.textContent = newTitle;
                if (contentElement) contentElement.textContent = newContent;

                // Update color classes
                const colorClasses = {
                    'blue': 'border-blue-200 bg-blue-50',
                    'purple': 'border-purple-200 bg-purple-50',
                    'indigo': 'border-indigo-200 bg-indigo-50',
                    'green': 'border-green-200 bg-green-50',
                    'red': 'border-red-200 bg-red-50',
                    'gray': 'border-gray-200 bg-gray-50'
                };

                // Remove old color classes
                Object.values(colorClasses).forEach(cls => {
                    lastEntry.classList.remove(...cls.split(' '));
                });
                
                // Add new color classes
                lastEntry.classList.add(...colorClasses[color].split(' '));
            }
        }

        // =============================================================================
        // SOW RENDERING FUNCTIONS
        // =============================================================================

        /**
         * Renders the complete SOW in the main content area
         */
        function renderCompleteSOW(sowData) {
            // Update title and project info
            sowTitle.textContent = `Scope of Work: ${sowData.clientName}`;
            sowProject.innerHTML = `<strong>Project:</strong> ${sowData.serviceType}`;
            
            // Update project overview
            projectOverview.value = sowData.overview;
            
            // Render pricing table
            renderTable(sowData.roles);
            
            // Calculate initial totals
            updateTotals();
            
            // Show the SOW content
            sowContent.classList.remove('hidden');
        }

        /**
         * Generates a comprehensive project overview based on all research data
         */
        function generateProjectOverview(clientName, serviceType, clientResearch, serviceResearch, brief) {
            return `This scope of work details Social Garden's proposed approach to support ${clientName} with their ${serviceType} project.

Based on our research:
• Client Profile: ${clientResearch.substring(0, 120)}...
• Service Best Practices: ${serviceResearch.substring(0, 120)}...

Project Brief: ${brief.substring(0, 200)}...

Our structured approach will ensure successful project delivery with measurable outcomes and maximum ROI.`;
        }

        // =============================================================================
        // INTERACTIVE PRICING TABLE FUNCTIONS
        // =============================================================================

        /**
         * Renders the pricing table with editable hours inputs
         * @param {Array} roles - Array of role objects with name, hours, and rate
         */
        function renderTable(roles) {
            if (!pricingTableBody) return;
            
            // Clear existing table content
            pricingTableBody.innerHTML = '';
            
            // Create rows for each role
            roles.forEach((role, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${role.name}</td>
                    <td class="px-6 py-4">
                        <input type="number" 
                               id="role-${index}-hours" 
                               value="${role.hours}" 
                               oninput="updateTotals()" 
                               class="w-full text-sm">
                    </td>
                    <td class="px-6 py-4 text-right text-sm text-gray-900">$${role.rate.toFixed(2)}</td>
                    <td class="px-6 py-4 text-right text-sm font-medium text-gray-900" id="role-${index}-total">$0.00</td>
                `;
                pricingTableBody.appendChild(row);
            });
        }

        /**
         * Core function to update all pricing calculations
         * Called after table render and on any input change
         */
        function updateTotals() {
            if (!pricingTableBody) return;
            
            const rows = pricingTableBody.getElementsByTagName('tr');
            let subTotal = 0;

            // Calculate line totals and sub-total
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                const hoursInput = cells[1].getElementsByTagName('input')[0];
                const hours = parseFloat(hoursInput.value) || 0;
                const rateText = cells[2].textContent.replace('$', '');
                const rate = parseFloat(rateText);
                const totalCell = cells[3];
                
                const lineTotal = hours * rate;
                totalCell.textContent = '$' + lineTotal.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
                subTotal += lineTotal;
            }

            // Calculate discount and grand total
            const discountPercent = parseFloat(document.getElementById('discount')?.value) || 0;
            const discountAmount = subTotal * (discountPercent / 100);
            const grandTotal = subTotal - discountAmount;

            // Update summary totals in DOM
            const subTotalElement = document.getElementById('sub-total');
            const discountAmountElement = document.getElementById('discount-amount');
            const grandTotalElement = document.getElementById('grand-total');

            if (subTotalElement) {
                subTotalElement.textContent = '$' + subTotal.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
            }
            
            if (discountAmountElement) {
                discountAmountElement.textContent = '-$' + discountAmount.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
            }
            
            if (grandTotalElement) {
                grandTotalElement.textContent = '$' + grandTotal.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
            }
        }

        // =============================================================================
        // PDF EXPORT FUNCTIONALITY
        // =============================================================================

        /**
         * Exports the SOW as a branded PDF using jsPDF and html2canvas
         */
        async function exportToPDF() {
            try {
                exportBtn.disabled = true;
                exportBtn.textContent = 'Generating PDF...';

                // Initialize jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                // Add header with logo
                addPDFHeader(pdf, pageWidth);

                // Capture SOW content using html2canvas
                const sowElement = document.getElementById('sow-content');
                if (sowElement) {
                    const canvas = await html2canvas(sowElement, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff'
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = pageWidth - 20; // 10mm margins
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    // Add content to PDF (starting below header)
                    pdf.addImage(imgData, 'PNG', 10, 35, imgWidth, imgHeight);

                    // Add footer
                    addPDFFooter(pdf, pageWidth, pageHeight);
                }

                // Generate filename
                const clientName = clientNameInput.value.trim() || 'Client';
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `sow-${clientName.toLowerCase().replace(/\s+/g, '-')}-${timestamp}.pdf`;

                // Save PDF
                pdf.save(filename);

                addToResearchLog('PDF Export Complete', `SOW exported as ${filename}`, 'green');
                console.log(`PDF exported as: ${filename}`);
            } catch (error) {
                console.error('PDF export failed:', error);
                addToResearchLog('PDF Export Failed', 'An error occurred during PDF export. Please try again.', 'red');
            } finally {
                exportBtn.disabled = false;
                exportBtn.textContent = 'Export as Branded PDF';
            }
        }

        /**
         * Adds header with Social Garden branding to PDF
         */
        function addPDFHeader(pdf, pageWidth) {
            // Add company name/logo
            pdf.setFontSize(18);
            pdf.setTextColor(79, 70, 229); // Indigo color
            pdf.text('Social Garden', 10, 15);
            
            pdf.setFontSize(12);
            pdf.setTextColor(100, 100, 100);
            pdf.text('Professional Services - Statement of Work', 10, 22);
            
            // Add header line
            pdf.setDrawColor(79, 70, 229);
            pdf.setLineWidth(0.5);
            pdf.line(10, 28, pageWidth - 10, 28);
        }

        /**
         * Adds footer with branding to PDF
         */
        function addPDFFooter(pdf, pageWidth, pageHeight) {
            // Add footer line
            pdf.setDrawColor(79, 70, 229);
            pdf.setLineWidth(0.5);
            pdf.line(10, pageHeight - 20, pageWidth - 10, pageHeight - 20);
            
            // Add footer text
            pdf.setFontSize(9);
            pdf.setTextColor(100, 100, 100);
            pdf.text('Social Garden Professional Services', 10, pageHeight - 12);
            pdf.text(`Generated: ${new Date().toLocaleDateString()}`, 10, pageHeight - 6);
            pdf.text('Page 1', pageWidth - 20, pageHeight - 12);
        }

        // =============================================================================
        // EVENT LISTENERS
        // =============================================================================
        
        // Step A: Client research
        clientSearchBtn.addEventListener('click', performClientResearch);
        clientNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performClientResearch();
        });
        
        // Step B: Service research
        serviceSearchBtn.addEventListener('click', performServiceResearch);
        serviceResearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performServiceResearch();
        });
        
        // Step C: Final SOW generation
        generateBtn.addEventListener('click', generateCompleteSOW);
        
        // PDF Export
        exportBtn.addEventListener('click', exportToPDF);

        // =============================================================================
        // INITIALIZATION
        // =============================================================================
        
        console.log('SOW Generator initialized successfully');
        console.log('Available functions:', {
            performClientResearch,
            performServiceResearch,
            generateCompleteSOW,
            renderTable,
            updateTotals,
            exportToPDF
        });

    </script>

</body>
</html>
