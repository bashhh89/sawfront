<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced SOW Generator - Example Integration</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Enhanced research indicators */
        .research-depth-indicator {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        .research-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #e5e7eb;
            transition: background-color 0.3s ease;
        }
        .research-dot.active { background-color: #3b82f6; }
        .research-dot.completed { background-color: #10b981; }
        
        /* Personalization insights styling */
        .personalization-insight {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }
        
        /* Enhanced progress visualization */
        .research-network {
            position: relative;
            padding: 20px;
            border: 2px dashed #e5e7eb;
            border-radius: 12px;
            background: #f9fafb;
        }
        
        .research-node {
            display: inline-block;
            padding: 8px 12px;
            margin: 4px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .research-node.pending { background: #f3f4f6; color: #6b7280; }        .research-node.active { background: #3b82f6; color: white; animation: pulse 2s infinite; }
        .research-node.completed { background: #10b981; color: white; }
        .research-node.failed { background: #ef4444; color: white; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Enhanced visual indicators for processing */
        .processing-indicator {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Progress bar styling */
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            margin: 12px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        /* Toast notification styling */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast-success {
            background-color: #10b981;
            color: white;
        }
        
        .toast-error {
            background-color: #ef4444;
            color: white;
        }
        
        .toast-info {
            background-color: #3b82f6;
            color: white;
        }
        
        /* Export button styling */
        .export-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .export-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.5s ease;
        }
        
        .export-btn:hover::after {
            left: 100%;
        }

        /* Enhanced visual indicators for processing */
        .processing-indicator {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Progress bar styling */
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            margin: 12px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        /* Toast notification styling */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast-success {
            background-color: #10b981;
            color: white;
        }
        
        .toast-error {
            background-color: #ef4444;
            color: white;
        }
        
        .toast-info {
            background-color: #3b82f6;
            color: white;
        }
        
        /* Export button styling */
        .export-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .export-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.5s ease;
        }
        
        .export-btn:hover::after {
            left: 100%;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header with Enhancement Badge -->
            <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Enhanced SOW Generator</h1>
                        <p class="text-gray-600 mt-2">AI-Powered Multi-Dimensional Research & Personalization</p>
                    </div>
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-2 rounded-full text-sm font-semibold">
                        üß† INTELLIGENCE ENHANCED
                    </div>
                </div>
            </div>            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Panel: Enhanced Research Controls -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <!-- Header -->
                        <div class="flex items-center mb-6">
                            <div class="w-10 h-10 rounded-full mr-3 flex items-center justify-center text-white font-bold text-lg" style="background-color: #3b82f6;">SG</div>
                            <h2 class="text-xl font-bold text-gray-900">AI Research Engine</h2>
                        </div>
                        
                        <!-- Client Research with Visual Progress -->
                        <div class="mb-8">
                            <div class="research-step p-4 rounded-lg bg-gray-50" id="client-research-step">
                                <h3 class="text-lg font-semibold text-gray-900 mb-3">Step A: Multi-Dimensional Client Analysis</h3>
                                <label for="client-name" class="block text-sm font-medium text-gray-700 mb-2">Client Name</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="client-name" class="flex-1 p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., Microsoft, Apple, Local Healthcare">
                                    <button id="enhanced-client-research" class="bg-blue-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                                        üß† Deep Research
                                    </button>
                                </div>
                                
                                <!-- Progress indicator -->
                                <div id="client-search-loading" class="hidden mt-3 slide-in">
                                    <div class="flex items-center space-x-2">
                                        <svg class="animate-spin h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span class="text-sm text-blue-600" id="client-status">Researching client...</span>
                                    </div>
                                    <div class="progress-bar-container mt-2">
                                        <div class="progress-bar" id="client-progress" style="width: 0%;"></div>
                                    </div>
                                </div>
                                
                                <!-- Research Depth Visualization -->
                                <div class="research-network mt-4" id="client-research-network">
                                    <div class="text-xs font-semibold text-gray-600 mb-2">Research Dimensions:</div>
                                    <div class="research-node pending" data-type="company">Company Profile</div>
                                    <div class="research-node pending" data-type="industry">Industry Context</div>
                                    <div class="research-node pending" data-type="technology">Tech Landscape</div>
                                    <div class="research-node pending" data-type="competitive">Competition</div>
                                    <div class="research-node pending" data-type="compliance">Compliance</div>
                                </div>
                            </div>
                        </div>

                        <!-- Service Research with Intelligence Indicator -->
                        <div class="mb-8">
                            <div class="research-step p-4 rounded-lg bg-gray-50" id="service-research-step">
                                <h3 class="text-lg font-semibold text-gray-900 mb-3">Step B: Service Intelligence Analysis</h3>
                                <label for="service-type" class="block text-sm font-medium text-gray-700 mb-2">Service Type</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="service-type" class="flex-1 p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., CRM Implementation, Cloud Migration">
                                    <button id="enhanced-service-research" class="bg-purple-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-purple-700 transition-colors">
                                        üõ†Ô∏è Analyze Service
                                    </button>
                                </div>
                                
                                <!-- Progress indicator -->
                                <div id="service-search-loading" class="hidden mt-3 slide-in">
                                    <div class="flex items-center space-x-2">
                                        <svg class="animate-spin h-4 w-4 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span class="text-sm text-purple-600" id="service-status">Researching best practices...</span>
                                    </div>
                                    <div class="progress-bar-container mt-2">
                                        <div class="progress-bar" id="service-progress" style="width: 0%;"></div>
                                    </div>
                                </div>
                                
                                <!-- Service Research Network -->
                                <div class="research-network mt-4" id="service-research-network">
                                    <div class="text-xs font-semibold text-gray-600 mb-2">Service Analysis:</div>
                                    <div class="research-node pending" data-type="practices">Best Practices</div>
                                    <div class="research-node pending" data-type="industry-specific">Industry Specific</div>
                                    <div class="research-node pending" data-type="roi">ROI Metrics</div>
                                    <div class="research-node pending" data-type="resources">Resource Needs</div>
                                </div>
                            </div>
                        </div>

                        <!-- Project Brief -->
                        <div class="mb-8">
                            <div class="research-step p-4 rounded-lg bg-gray-50" id="brief-step">
                                <h3 class="text-lg font-semibold text-gray-900 mb-3">Step C: Project Brief</h3>
                                <label for="project-brief" class="block text-sm font-medium text-gray-700 mb-2">Detailed Requirements</label>
                                <textarea id="project-brief" rows="6" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Describe the project requirements, objectives, timeline, and any specific constraints..."></textarea>
                            </div>
                        </div>

                        <!-- Enhanced Generation Button -->
                        <button id="generate-enhanced-sow" class="w-full bg-gradient-to-r from-green-500 to-blue-600 text-white font-bold py-4 px-6 rounded-lg hover:from-green-600 hover:to-blue-700 transition-all duration-200 shadow-lg">
                            üöÄ Generate Hyper-Personalized SOW
                        </button>
                        
                        <!-- Final Loading -->
                        <div id="final-loading" class="hidden text-center mt-4">
                            <svg class="animate-spin h-6 w-6 mx-auto text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="text-sm mt-1 text-green-600">Generating complete SOW...</p>
                        </div>

                        <!-- Export Section -->
                        <div class="mt-8 pt-6 border-t">
                            <h3 class="text-lg font-semibold mb-4">Export Options</h3>
                            <div class="space-y-2">
                                <div class="flex space-x-2">
                                    <button id="export-btn" class="flex-1 bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                                        üìÑ Export PDF
                                    </button>
                                    <button id="export-advanced-btn" class="flex-1 bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                                        ‚ú® Advanced PDF
                                    </button>
                                </div>
                                <div class="flex space-x-2">
                                    <button id="export-excel-btn" class="flex-1 bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                                        üìä Export Excel
                                    </button>
                                    <button id="share-btn" class="flex-1 bg-purple-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                                        üîó Share SOW
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Research Results & SOW Output -->
                <div class="lg:col-span-2">
                    <!-- Research Intelligence Dashboard -->
                    <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">üß† Research Intelligence Dashboard</h2>
                        <div id="research-dashboard" class="space-y-4">
                            <div class="text-gray-500 text-center py-8">
                                Start research to see intelligent insights appear here...
                            </div>
                        </div>
                    </div>

                    <!-- Personalization Insights -->
                    <div id="personalization-insights" class="bg-white rounded-lg shadow-sm border p-6 mb-8 hidden">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">üéØ Personalization Applied</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Opportunities Identified -->
                            <div class="personalization-insight p-4 rounded-lg">
                                <h3 class="font-semibold text-blue-800 mb-2">üìà Opportunities Identified</h3>
                                <ul id="opportunities-list" class="text-sm text-blue-700 space-y-1">
                                    <!-- Dynamic content -->
                                </ul>
                            </div>
                            
                            <!-- Risk Mitigation -->
                            <div class="personalization-insight p-4 rounded-lg">
                                <h3 class="font-semibold text-blue-800 mb-2">üõ°Ô∏è Risk Mitigation</h3>
                                <ul id="risks-list" class="text-sm text-blue-700 space-y-1">
                                    <!-- Dynamic content -->
                                </ul>
                            </div>
                            
                            <!-- Custom Approach -->
                            <div class="personalization-insight p-4 rounded-lg">
                                <h3 class="font-semibold text-blue-800 mb-2">‚öôÔ∏è Customized Approach</h3>
                                <ul id="approach-list" class="text-sm text-blue-700 space-y-1">
                                    <!-- Dynamic content -->
                                </ul>
                            </div>
                            
                            <!-- Success Metrics -->
                            <div class="personalization-insight p-4 rounded-lg">
                                <h3 class="font-semibold text-blue-800 mb-2">üìä Success Metrics</h3>
                                <ul id="metrics-list" class="text-sm text-blue-700 space-y-1">
                                    <!-- Dynamic content -->
                                </ul>
                            </div>
                        </div>
                    </div>                    <!-- Generated SOW Content -->
                    <div id="sow-output" class="bg-white rounded-lg shadow-sm border p-8 hidden">
                        <div class="border-b pb-4 mb-6">
                            <h2 id="sow-title" class="text-3xl font-bold text-gray-900"></h2>
                            <p id="sow-subtitle" class="text-gray-600 mt-2"></p>
                            <div class="flex items-center mt-4 space-x-4">
                                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">‚ú® AI-Enhanced</span>
                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">üîç Research-Driven</span>
                                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">üéØ Personalized</span>
                            </div>
                        </div>

                        <!-- Project Overview Section -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Project Overview</h3>
                            <div class="relative">
                                <textarea id="project-overview" class="w-full p-3 border rounded-md resize-none" rows="3"></textarea>
                                <div class="resize-handle absolute bottom-0 right-0 w-4 h-4 cursor-se-resize bg-gray-300 hover:bg-gray-400 transition-colors duration-200" style="clip-path: polygon(100% 0%, 0% 100%, 100% 100%);"></div>
                            </div>
                        </div>

                        <!-- Research Insights Section -->
                        <div id="research-insights" class="mb-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-blue-800 mb-3">üîç Research-Based Personalization</h3>
                            <div class="space-y-3 text-sm">
                                <div id="client-insights" class="hidden">
                                    <strong class="text-blue-700">Client Insights:</strong>
                                    <p class="text-blue-600 mt-1"></p>
                                </div>
                                <div id="service-insights" class="hidden">
                                    <strong class="text-blue-700">Best Practices Applied:</strong>
                                    <p class="text-blue-600 mt-1"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Research-Based Objectives -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Project Objectives</h3>
                            <div id="objectives-container" class="space-y-2"></div>
                            <button onclick="addObjective()" class="mt-2 text-sm text-blue-600 hover:underline">+ Add Objective</button>
                        </div>

                        <!-- Intelligent Deliverables -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Key Deliverables</h3>
                            <div id="deliverables-container" class="space-y-2"></div>
                            <button onclick="addDeliverable()" class="mt-2 text-sm text-blue-600 hover:underline">+ Add Deliverable</button>
                        </div>

                        <!-- Project Scope -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Project Scope</h3>
                            <div id="scope-container" class="space-y-2"></div>
                            <button onclick="addScopeItem()" class="mt-2 text-sm text-blue-600 hover:underline">+ Add Scope Item</button>
                        </div>

                        <!-- Timeline Section -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Project Timeline</h3>
                            <div class="relative">
                                <textarea id="project-timeline" class="w-full p-3 border rounded-md resize-none" rows="3"></textarea>
                                <div class="resize-handle absolute bottom-0 right-0 w-4 h-4 cursor-se-resize bg-gray-300 hover:bg-gray-400 transition-colors duration-200" style="clip-path: polygon(100% 0%, 0% 100%, 100% 100%);"></div>
                            </div>
                        </div>

                        <!-- Interactive Pricing Table -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Investment Structure</h3>
                            <p class="text-sm text-gray-600 mb-4">You can modify the hours and rates directly in the table below. Totals will update instantly.</p>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 editable-table">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Hours</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Rate</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="pricing-table-body">
                                        <!-- Dynamic pricing content -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="mt-6 flex justify-end">
                                <div class="w-full max-w-sm space-y-3">
                                    <div>
                                        <label for="discount" class="block text-sm font-medium text-gray-700">Discount (%)</label>
                                        <input type="number" id="discount" value="0" oninput="updateTotals()" class="mt-1 w-full p-2 border rounded-md">
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <dl class="space-y-2">
                                            <div class="flex justify-between text-sm">
                                                <dt>Sub-total</dt>
                                                <dd id="sub-total">$0.00</dd>
                                            </div>
                                            <div class="flex justify-between text-sm text-red-600">
                                                <dt>Discount</dt>
                                                <dd id="discount-amount">$0.00</dd>
                                            </div>
                                            <div class="flex justify-between text-lg font-bold text-gray-900 border-t pt-2">
                                                <dt>Grand Total</dt>
                                                <dd id="grand-total">$0.00</dd>
                                            </div>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Export Options -->
                        <div class="border-t pt-6">
                            <div class="flex space-x-4">
                                <button onclick="exportToPDF()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                                    üìÑ Export PDF
                                </button>
                                <button onclick="exportAdvancedPDF()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                                    ‚ú® Advanced PDF
                                </button>
                                <button onclick="exportToExcel()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                                    üìä Export Excel
                                </button>
                                <button onclick="shareSOW()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors">
                                    üîó Share SOW
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>    <!-- Enhanced JavaScript Integration -->
    <script src="enhanced-search-personalization.js"></script>
    <script>
        // --- AnythingLLM API Configuration ---
        const ANYTHINGLLM_CONFIG = {
            baseUrl: 'https://socialgarden-anything-llm.vo0egb.easypanel.host',
            apiKey: 'F7C84WV-75N4QWH-P9ERFRV-CWJ146T',
            workspace: 'main'
        };        // --- Global Application State ---
        let clientResearchData = {};
        let serviceResearchData = {};
        let personalizationInsights = {};

        // --- AnythingLLM API Helper Functions ---
        /**
         * Makes a chat request to AnythingLLM API with retry logic
         */
        async function callAnythingLLM(message) {
            const maxRetries = 3;
            let lastError;

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`API Call Attempt ${attempt}:`, message.substring(0, 100) + '...');
                    
                    const response = await fetch(`${ANYTHINGLLM_CONFIG.baseUrl}/api/v1/workspace/${ANYTHINGLLM_CONFIG.workspace}/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${ANYTHINGLLM_CONFIG.apiKey}`,
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            mode: 'chat'
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    const result = data.textResponse || data.message || 'No response received';
                    console.log('API Response received:', result.substring(0, 200) + '...');
                    return result;

                } catch (error) {
                    console.warn(`Attempt ${attempt} failed:`, error.message);
                    lastError = error;
                    
                    if (attempt < maxRetries) {
                        // Exponential backoff
                        const delay = Math.pow(2, attempt) * 1000;
                        console.log(`Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            throw new Error(`All ${maxRetries} attempts failed. Last error: ${lastError.message}`);        }

        // --- Enhanced UI Event Handlers with Real API Integration ---
        
        document.getElementById('enhanced-client-research').addEventListener('click', async function() {
            const clientName = document.getElementById('client-name').value.trim();
            if (!clientName) {
                showToast('Please enter a client name first.', 'error');
                return;
            }

            // Visual feedback
            this.disabled = true;
            this.innerHTML = '<div class="processing-indicator"></div> Researching...';
            
            // Show progress bar
            const progressContainer = document.createElement('div');
            progressContainer.className = 'progress-bar-container';
            progressContainer.innerHTML = '<div class="progress-bar" style="width: 0%"></div>';
            this.parentNode.appendChild(progressContainer);
            
            // Define research dimensions with real prompts
            const researchDimensions = [
                {
                    node: 'company',
                    prompt: `@agent Research ${clientName}: company background, size, revenue, key executives, recent news, strategic initiatives, business model, and current market position. Focus on information that would help create a personalized business proposal.`,
                    title: 'Company Profile'
                },
                {
                    node: 'industry',
                    prompt: `@agent Research ${clientName}'s industry: current trends, digital transformation patterns, common challenges, emerging technologies, regulatory environment, and market pressures affecting similar companies.`,
                    title: 'Industry Context'
                },
                {
                    node: 'technology',
                    prompt: `@agent Research ${clientName}'s technology landscape: current tech stack, recent technology investments, digital initiatives, system integrations, technology partnerships, and IT infrastructure capabilities.`,
                    title: 'Technology Analysis'
                },
                {
                    node: 'competitive',
                    prompt: `@agent Research ${clientName}'s competitive landscape: main competitors, market positioning, competitive advantages, technology differentiation, and market share dynamics.`,
                    title: 'Competitive Analysis'
                },
                {
                    node: 'compliance',
                    prompt: `@agent Research regulatory and compliance requirements for ${clientName}'s industry and specific company: data privacy laws, industry regulations, security standards, and compliance frameworks that would impact technology implementations.`,
                    title: 'Compliance Requirements'
                }
            ];
            
            // Clear previous research data
            clientResearchData = {};
            
            // Execute research phases
            const researchNodes = document.querySelectorAll('#client-research-network .research-node');
            
            showToast(`Starting comprehensive research for ${clientName}...`, 'info');
            
            for (let i = 0; i < researchDimensions.length; i++) {
                const dimension = researchDimensions[i];
                const node = researchNodes[i];
                
                // Update progress bar
                const progressBar = progressContainer.querySelector('.progress-bar');
                progressBar.style.width = `${(i / researchDimensions.length) * 100}%`;
                
                try {
                    // Update UI
                    node.className = 'research-node active';
                    addResearchToDashboard(dimension.node, `Starting ${dimension.title} research for ${clientName}...`, 'blue');
                    
                    // Send exit command to ensure clean agent state
                    try {
                        await callAnythingLLM('/exit');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } catch (e) {
                        console.log("Exit command handled");
                    }
                    
                    // Make real API call
                    const research = await Promise.race([
                        callAnythingLLM(dimension.prompt),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error(`${dimension.title} search timed out after 45 seconds`)), 45000)
                        )
                    ]);
                    
                    // Store research data
                    clientResearchData[dimension.node] = {
                        data: research,
                        title: dimension.title,
                        timestamp: new Date()
                    };
                    
                    // Update UI
                    node.className = 'research-node completed';
                    addResearchToDashboard(dimension.node, `${dimension.title} analysis completed - ${research.substring(0, 100)}...`, 'green');
                    
                    // Exit agent mode after each search
                    try {
                        await callAnythingLLM('/exit');
                        await new Promise(resolve => setTimeout(resolve, 1500));
                    } catch (e) {
                        console.log("Agent exit handled");
                    }
                    
                } catch (error) {
                    console.error(`${dimension.title} research failed:`, error);
                    node.className = 'research-node failed';
                    addResearchToDashboard(dimension.node, `${dimension.title} research failed: ${error.message}`, 'red');
                    showToast(`${dimension.title} research failed: ${error.message}`, 'error');
                    
                    // Store error as research data
                    clientResearchData[dimension.node] = {
                        data: `Research failed: ${error.message}`,
                        title: dimension.title,
                        error: true,
                        timestamp: new Date()
                    };
                }
                
                // Delay between requests to prevent rate limiting
                if (i < researchDimensions.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }

            // Complete progress bar
            const progressBar = progressContainer.querySelector('.progress-bar');
            progressBar.style.width = '100%';
            
            // Remove progress bar after completion
            setTimeout(() => {
                progressContainer.remove();
            }, 2000);

            this.disabled = false;
            this.innerHTML = '‚úÖ Research Complete';
            showToast('Client research completed successfully!', 'success');
            
            console.log('Client research completed:', clientResearchData);
        });
        
        document.getElementById('enhanced-service-research').addEventListener('click', async function() {
            const serviceType = document.getElementById('service-type').value.trim();
            if (!serviceType) {
                alert('Please enter a service type first.');
                return;
            }

            // Visual feedback
            this.disabled = true;
            this.innerHTML = 'üîÑ Analyzing...';
            
            // Show loading indicators
            const loadingDiv = document.getElementById('service-search-loading');
            const progressBar = document.getElementById('service-progress');
            const statusText = document.getElementById('service-status');
            const serviceStep = document.getElementById('service-research-step');
            
            loadingDiv.classList.remove('hidden');
            serviceStep.classList.add('active');
            
            // Define service research dimensions with real prompts
            const serviceDimensions = [
                {
                    node: 'practices',
                    prompt: `@agent Research best practices for "${serviceType}" implementation: methodology, typical phases, timeline estimates, success factors, common challenges, industry standards, and proven approaches. Include specific recommendations.`,
                    title: 'Best Practices'
                },
                {
                    node: 'industry-specific',
                    prompt: `@agent Research industry-specific considerations for "${serviceType}" implementation: unique requirements by sector, compliance considerations, specialized approaches, and industry-specific challenges and solutions.`,
                    title: 'Industry Specialization'
                },
                {
                    node: 'roi',
                    prompt: `@agent Research ROI metrics and success measurements for "${serviceType}" projects: typical KPIs, industry benchmarks, expected outcomes, payback periods, and quantifiable benefits that justify investment.`,
                    title: 'ROI & Metrics'
                },
                {
                    node: 'resources',
                    prompt: `@agent Research typical resource requirements for "${serviceType}" projects: team structure, required skill sets, tools and technologies needed, realistic hour estimates by role, and staffing recommendations.`,
                    title: 'Resource Planning'
                }
            ];
            
            // Clear previous service research data
            serviceResearchData = {};
            
            const researchNodes = document.querySelectorAll('#service-research-network .research-node');
            
            for (let i = 0; i < serviceDimensions.length; i++) {
                const dimension = serviceDimensions[i];
                const node = researchNodes[i];
                
                try {
                    // Update progress
                    const progress = (i / serviceDimensions.length) * 100;
                    progressBar.style.width = `${progress}%`;
                    statusText.textContent = `Analyzing ${dimension.title.toLowerCase()}...`;
                    
                    // Update UI
                    node.className = 'research-node active';
                    addResearchToDashboard(dimension.node, `Starting ${dimension.title} analysis for ${serviceType}...`);
                    
                    // Send exit command to ensure clean agent state
                    try {
                        await callAnythingLLM('/exit');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } catch (e) {
                        console.log("Exit command handled");
                    }
                    
                    // Make real API call
                    const research = await Promise.race([
                        callAnythingLLM(dimension.prompt),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error(`${dimension.title} analysis timed out after 45 seconds`)), 45000)
                        )
                    ]);
                    
                    // Store research data
                    serviceResearchData[dimension.node] = {
                        data: research,
                        title: dimension.title,
                        timestamp: new Date()
                    };
                    
                    // Update UI
                    node.className = 'research-node completed';
                    addResearchToDashboard(dimension.node, `${dimension.title} analysis completed - ${research.substring(0, 100)}...`);
                    
                    // Exit agent mode after each search
                    try {
                        await callAnythingLLM('/exit');
                        await new Promise(resolve => setTimeout(resolve, 1500));
                    } catch (e) {
                        console.log("Agent exit handled");
                    }
                    
                } catch (error) {
                    console.error(`${dimension.title} research failed:`, error);
                    node.className = 'research-node failed';
                    addResearchToDashboard(dimension.node, `${dimension.title} analysis failed: ${error.message}`);
                    
                    // Store error as research data
                    serviceResearchData[dimension.node] = {
                        data: `Analysis failed: ${error.message}`,
                        title: dimension.title,
                        error: true,
                        timestamp: new Date()
                    };
                }
                
                // Delay between requests to prevent rate limiting
                if (i < serviceDimensions.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }

            // Complete progress
            progressBar.style.width = '100%';
            statusText.textContent = 'Analysis complete!';
            serviceStep.classList.remove('active');
            serviceStep.classList.add('completed');
            
            this.disabled = false;
            this.innerHTML = '‚úÖ Analysis Complete';
            
            // Hide loading after a moment
            setTimeout(() => {
                loadingDiv.classList.add('hidden');
            }, 2000);
            
            console.log('Service research completed:', serviceResearchData);
        });        document.getElementById('generate-enhanced-sow').addEventListener('click', async function() {
            const clientName = document.getElementById('client-name').value.trim();
            const serviceType = document.getElementById('service-type').value.trim();
            const brief = document.getElementById('project-brief').value.trim();

            if (!clientName || !serviceType || !brief) {
                alert('Please complete all research steps and enter a project brief.');
                return;
            }

            // Check if we have research data
            const hasClientResearch = Object.keys(clientResearchData).length > 0;
            const hasServiceResearch = Object.keys(serviceResearchData).length > 0;

            if (!hasClientResearch || !hasServiceResearch) {
                alert('Please complete both client and service research before generating SOW.');
                return;
            }

            // Visual feedback
            this.disabled = true;
            this.innerHTML = 'üß† Generating Personalized SOW...';
            
            // Show loading indicators
            const loadingDiv = document.getElementById('final-loading');
            const briefStep = document.getElementById('brief-step');
            
            loadingDiv.classList.remove('hidden');
            briefStep.classList.add('active');

            try {
                // Create comprehensive prompt using real research data
                const clientResearchSummary = Object.values(clientResearchData)
                    .map(r => `${r.title}: ${r.data}`)
                    .join('\n\n');

                const serviceResearchSummary = Object.values(serviceResearchData)
                    .map(r => `${r.title}: ${r.data}`)
                    .join('\n\n');

                const comprehensivePrompt = `Create a comprehensive Statement of Work (SOW) based on the following research and requirements:

CLIENT: ${clientName}
SERVICE: ${serviceType}

CLIENT RESEARCH FINDINGS:
${clientResearchSummary}

SERVICE RESEARCH FINDINGS:
${serviceResearchSummary}

PROJECT BRIEF:
${brief}

Please generate a detailed SOW that includes:

1. EXECUTIVE SUMMARY: Personalized based on the client research, highlighting how this project aligns with their specific business context and challenges.

2. PROJECT OBJECTIVES: Specific, measurable objectives that address the client's unique situation and leverage the service best practices identified.

3. KEY DELIVERABLES: Detailed deliverables that are tailored to the client's technology landscape and business requirements.

4. PROJECT SCOPE: Clear scope items that address the specific challenges and opportunities identified in the research.

5. INVESTMENT STRUCTURE: Realistic hour estimates and pricing for:
   - Tech - Sr. Consultant ($295/hour)
   - Tech - Specialist ($180/hour)  
   - Project Coordination ($110/hour)
   - Account Management ($210/hour)

Base the hour estimates on the complexity identified in the research and service best practices.

6. TIMELINE: Realistic timeline based on the service research best practices and client-specific factors.

7. SUCCESS METRICS: Specific KPIs and success measurements based on the ROI research conducted.

Format the response with clear sections and include specific references to the research findings to show how they influenced the recommendations.`;

                console.log('Generating SOW with comprehensive prompt...');
                
                // Generate SOW using real API
                const sowResponse = await Promise.race([
                    callAnythingLLM(comprehensivePrompt),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('SOW generation timed out after 60 seconds')), 60000)
                    )
                ]);

                console.log('SOW generated successfully');

                // Generate personalization insights from real data
                generateRealPersonalizationInsights();
                
                // Parse and display the real SOW with enhanced functionality
                parseAndDisplayEnhancedSOW(clientName, serviceType, sowResponse);

                // Show personalization insights
                showPersonalizationInsights();
                
                // Enable export buttons
                enableExportButtons();

            } catch (error) {
                console.error('SOW generation failed:', error);
                alert(`SOW generation failed: ${error.message}`);
            } finally {
                // Complete progress
                briefStep.classList.remove('active');
                briefStep.classList.add('completed');
                loadingDiv.classList.add('hidden');
                
                this.disabled = false;
                this.innerHTML = 'üöÄ Generate New SOW';
            }
        });

        function addResearchToDashboard(type, message, color = 'gray') {
            const dashboard = document.getElementById('research-dashboard');
            
            // Clear placeholder if first item
            if (dashboard.querySelector('.text-gray-500')) {
                dashboard.innerHTML = '';
            }

            const researchItem = document.createElement('div');
            researchItem.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg';
            researchItem.innerHTML = `
                <div class="w-2 h-2 bg-${color}-500 rounded-full"></div>
                <div class="flex-1">
                    <div class="text-sm font-medium text-gray-900">${type.charAt(0).toUpperCase() + type.slice(1)} Research</div>
                    <div class="text-xs text-gray-600">${message}</div>
                </div>
                <div class="text-xs text-gray-400">${new Date().toLocaleTimeString()}</div>
            `;
            dashboard.appendChild(researchItem);
        }        function showPersonalizationInsights() {
            const insights = document.getElementById('personalization-insights');
            insights.classList.remove('hidden');
            
            // Use real personalization insights generated from research data
            document.getElementById('opportunities-list').innerHTML = 
                personalizationInsights.opportunities.map(opp => `<li>‚Ä¢ ${opp}</li>`).join('');
            
            document.getElementById('risks-list').innerHTML = 
                personalizationInsights.risks.map(risk => `<li>‚Ä¢ ${risk}</li>`).join('');
            
            document.getElementById('approach-list').innerHTML = 
                personalizationInsights.approach.map(app => `<li>‚Ä¢ ${app}</li>`).join('');
            
            document.getElementById('metrics-list').innerHTML = 
                personalizationInsights.metrics.map(metric => `<li>‚Ä¢ ${metric}</li>`).join('');
        }function parseAndDisplayRealSOW(clientName, serviceType, sowResponse) {
            const sowOutput = document.getElementById('sow-output');
            sowOutput.classList.remove('hidden');
            
            document.getElementById('sow-title').textContent = `Statement of Work: ${clientName}`;
            document.getElementById('sow-subtitle').textContent = `Project: ${serviceType}`;
            
            // Parse the SOW response and extract key sections
            const sections = parseSOWResponse(sowResponse);
            
            // Display executive summary
            document.getElementById('executive-summary').innerHTML = 
                sections.executiveSummary || `This Statement of Work outlines Social Garden's approach to delivering ${serviceType} services for ${clientName}, based on comprehensive research and analysis.`;
            
            // Display objectives
            const objectives = document.getElementById('objectives-container');
            objectives.innerHTML = formatListItems(sections.objectives, 'green');
            
            // Display deliverables
            const deliverables = document.getElementById('deliverables-container');
            deliverables.innerHTML = formatListItems(sections.deliverables, 'blue');
            
            // Display pricing if available
            const pricingTable = document.getElementById('pricing-table');
            if (sections.pricing && sections.pricing.length > 0) {
                pricingTable.innerHTML = formatPricingTable(sections.pricing);
            } else {
                // Fallback pricing based on research complexity
                pricingTable.innerHTML = generatePricingFromResearch();
            }
            
            document.getElementById('pricing-justification').textContent = 
                sections.pricingJustification || "Pricing based on comprehensive research analysis, service complexity, and industry best practices identified during the research phase.";
            
            sowOutput.scrollIntoView({ behavior: 'smooth' });
        }

        // Enhanced SOW parsing and display function
        function parseAndDisplayEnhancedSOW(clientName, serviceType, sowResponse) {
            const sowOutput = document.getElementById('sow-output');
            sowOutput.classList.remove('hidden');
            
            document.getElementById('sow-title').textContent = `Statement of Work: ${clientName}`;
            document.getElementById('sow-subtitle').textContent = `Project: ${serviceType}`;
            
            // Parse the SOW response and extract key sections
            const sections = parseSOWResponse(sowResponse);
            
            // Display project overview
            document.getElementById('project-overview').value = 
                sections.overview || generateProjectOverview(clientName, serviceType, sowResponse);
            
            // Display objectives
            populateEditableContainer('objectives-container', sections.objectives, 'objective');
            
            // Display deliverables
            populateEditableContainer('deliverables-container', sections.deliverables, 'deliverable');
            
            // Display scope items
            populateEditableContainer('scope-container', sections.scope, 'scope');
            
            // Display timeline
            document.getElementById('project-timeline').value = 
                sections.timeline || extractTimeline(sowResponse);
            
            // Generate and display pricing
            generateInteractivePricing();
            
            // Show research insights
            populateResearchInsights();
            
            sowOutput.scrollIntoView({ behavior: 'smooth' });
        }

        // Enhanced SOW response parser
        function parseSOWResponse(sowResponse) {
            const sections = {
                overview: '',
                objectives: [],
                deliverables: [],
                scope: [],
                timeline: ''
            };

            try {
                const lines = sowResponse.split('\n');
                let currentSection = '';
                let currentContent = [];

                for (const line of lines) {
                    const trimmed = line.trim();
                    
                    if (trimmed.toLowerCase().includes('overview') || trimmed.toLowerCase().includes('summary')) {
                        if (currentSection && currentContent.length > 0) {
                            processSection(sections, currentSection, currentContent);
                        }
                        currentSection = 'overview';
                        currentContent = [];
                    } else if (trimmed.toLowerCase().includes('objective') || trimmed.toLowerCase().includes('goal')) {
                        if (currentSection && currentContent.length > 0) {
                            processSection(sections, currentSection, currentContent);
                        }
                        currentSection = 'objectives';
                        currentContent = [];
                    } else if (trimmed.toLowerCase().includes('deliverable') || trimmed.toLowerCase().includes('outcome')) {
                        if (currentSection && currentContent.length > 0) {
                            processSection(sections, currentSection, currentContent);
                        }
                        currentSection = 'deliverables';
                        currentContent = [];
                    } else if (trimmed.toLowerCase().includes('scope') || trimmed.toLowerCase().includes('include')) {
                        if (currentSection && currentContent.length > 0) {
                            processSection(sections, currentSection, currentContent);
                        }
                        currentSection = 'scope';
                        currentContent = [];
                    } else if (trimmed.toLowerCase().includes('timeline') || trimmed.toLowerCase().includes('schedule')) {
                        if (currentSection && currentContent.length > 0) {
                            processSection(sections, currentSection, currentContent);
                        }
                        currentSection = 'timeline';
                        currentContent = [];
                    } else if (trimmed && !trimmed.startsWith('#') && !trimmed.startsWith('=')) {
                        currentContent.push(trimmed);
                    }
                }

                // Process the last section
                if (currentSection && currentContent.length > 0) {
                    processSection(sections, currentSection, currentContent);
                }

            } catch (error) {
                console.error('Error parsing SOW response:', error);
            }

            return sections;
        }

        function processSection(sections, sectionType, content) {
            const text = content.join(' ');
            
            if (sectionType === 'overview' || sectionType === 'timeline') {
                sections[sectionType] = text;
            } else {
                // Extract list items for objectives, deliverables, scope
                const items = extractListItems(text, [sectionType]);
                sections[sectionType] = items;
            }
        }

        function extractListItems(text, keywords) {
            const items = [];
            const lines = text.split('\n');
            
            const patterns = [
                /^\s*[-‚Ä¢*]\s+(.+)/,
                /^\s*\d+\.\s+(.+)/,
                /^\s*[a-zA-Z]\.\s+(.+)/
            ];
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed.length > 10) { // Ignore very short lines
                    for (const pattern of patterns) {
                        const match = trimmed.match(pattern);
                        if (match) {
                            items.push(match[1]);
                            break;
                        }
                    }
                    
                    // If no pattern matched but line seems substantial, include it
                    if (trimmed.length > 30 && !trimmed.includes(':') && items.length < 5) {
                        items.push(trimmed);
                    }
                }
            }
            
            return items.slice(0, 6); // Limit to 6 items
        }

        function extractTimeline(text) {
            const lines = text.split('\n');
            const timelineKeywords = ['timeline', 'duration', 'week', 'month', 'phase', 'schedule'];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].toLowerCase();
                if (timelineKeywords.some(keyword => line.includes(keyword))) {
                    // Look for the next few lines that might contain timeline info
                    const timelineLines = lines.slice(i, i + 5).filter(l => l.trim().length > 10);
                    if (timelineLines.length > 0) {
                        return timelineLines.join(' ').substring(0, 300);
                    }
                }
            }
            
            return 'Timeline to be determined based on project complexity and client requirements.';
        }

        function populateEditableContainer(containerId, items, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            // Add extracted items
            items.forEach((item, index) => {
                container.appendChild(createEditableItem(item, type));
            });
            
            // Add at least 2 empty fields if we have fewer than 2 items
            while (container.children.length < 2) {
                container.appendChild(createEditableItem('', type));
            }
        }

        function createEditableItem(text, type) {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';
            div.innerHTML = `
                <input type="text" value="${text}" class="flex-1 p-2 border rounded-md" placeholder="Enter ${type}...">
                <button onclick="removeItem(this)" class="text-red-500 hover:text-red-700 text-sm px-2 py-1 rounded hover:bg-red-50">Remove</button>
            `;
            return div;
        }

        function generateProjectOverview(clientName, serviceType, sowResponse) {
            // Try to extract overview from the response first
            const overviewMatch = sowResponse.match(/overview[:\s]+(.*?)(?=\n\n|\n[A-Z]|$)/is);
            if (overviewMatch && overviewMatch[1].length > 50) {
                return overviewMatch[1].trim();
            }
            
            // Fallback to generated overview
            return `This Statement of Work outlines Social Garden's comprehensive approach to delivering ${serviceType} services for ${clientName}. Our solution is informed by extensive research into ${clientName}'s business context, industry requirements, and proven best practices. The project is designed to deliver measurable value while addressing the specific challenges and opportunities identified through our research process.`;
        }

        function generateInteractivePricing() {
            // Calculate hours based on research complexity
            const roles = calculatePricingFromResearch();
            renderInteractivePricingTable(roles);
            updateTotals();
        }

        function calculatePricingFromResearch() {
            const hasComplexIntegration = Object.values(clientResearchData).some(r => 
                r.data && r.data.toLowerCase().includes('legacy') || r.data.toLowerCase().includes('integration')
            );
            const isLargeOrganization = Object.values(clientResearchData).some(r => 
                r.data && (r.data.toLowerCase().includes('enterprise') || r.data.toLowerCase().includes('large'))
            );
            const hasComplexCompliance = Object.values(clientResearchData).some(r => 
                r.data && r.data.toLowerCase().includes('compliance')
            );
            
            let roles = [
                { name: 'Tech - Sr. Consultant', hours: 40, rate: 295 },
                { name: 'Tech - Specialist', hours: 30, rate: 180 },
                { name: 'Project Coordination', hours: 15, rate: 110 },
                { name: 'Account Management', hours: 10, rate: 210 }
            ];

            // Adjust based on research findings
            if (hasComplexIntegration) {
                roles[0].hours += 25; // Senior consultant
                roles[1].hours += 20; // Specialist
            }
            if (isLargeOrganization) {
                roles[0].hours += 15;
                roles[2].hours += 10; // More coordination needed
                roles[3].hours += 8;  // More account management
            }
            if (hasComplexCompliance) {
                roles[0].hours += 15;
                roles[1].hours += 10;
            }

            return roles;
        }

        function renderInteractivePricingTable(roles) {
            const tableBody = document.getElementById('pricing-table-body');
            tableBody.innerHTML = '';
            
            roles.forEach((role, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${role.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <input type="number" value="${role.hours}" min="0" max="500" 
                               class="hours-input w-20 text-right border rounded px-2 py-1" 
                               onchange="updateTotals()">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">$${role.rate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium total-cell">$${(role.hours * role.rate).toLocaleString()}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateTotals() {
            const tableBody = document.getElementById('pricing-table-body');
            if (!tableBody) return;
            
            const rows = tableBody.getElementsByTagName('tr');
            let subTotal = 0;

            // Calculate line totals and sub-total
            for (let row of rows) {
                const hoursInput = row.querySelector('.hours-input');
                const totalCell = row.querySelector('.total-cell');
                
                if (hoursInput && totalCell) {
                    const hours = parseFloat(hoursInput.value) || 0;
                    const rateText = row.cells[2].textContent;
                    const rate = parseFloat(rateText.replace('$', '')) || 0;
                    const lineTotal = hours * rate;
                    
                    totalCell.textContent = `$${lineTotal.toLocaleString()}`;
                    subTotal += lineTotal;
                }
            }

            // Calculate discount and grand total
            const discountPercent = parseFloat(document.getElementById('discount')?.value) || 0;
            const discountAmount = subTotal * (discountPercent / 100);
            const grandTotal = subTotal - discountAmount;

            // Update summary totals
            const subTotalElement = document.getElementById('sub-total');
            const discountAmountElement = document.getElementById('discount-amount');
            const grandTotalElement = document.getElementById('grand-total');

            if (subTotalElement) subTotalElement.textContent = `$${subTotal.toLocaleString()}`;
            if (discountAmountElement) discountAmountElement.textContent = `-$${discountAmount.toLocaleString()}`;
            if (grandTotalElement) grandTotalElement.textContent = `$${grandTotal.toLocaleString()}`;
        }

        function populateResearchInsights() {
            const clientInsightsDiv = document.getElementById('client-insights');
            const serviceInsightsDiv = document.getElementById('service-insights');
            
            // Show client insights if we have client data
            if (Object.keys(clientResearchData).length > 0) {
                const insights = extractClientInsights();
                clientInsightsDiv.querySelector('p').textContent = insights;
                clientInsightsDiv.classList.remove('hidden');
            }
            
            // Show service insights if we have service data
            if (Object.keys(serviceResearchData).length > 0) {
                const insights = extractServiceInsights();
                serviceInsightsDiv.querySelector('p').textContent = insights;
                serviceInsightsDiv.classList.remove('hidden');
            }
        }

        function extractClientInsights() {
            const insights = [];
            
            Object.values(clientResearchData).forEach(research => {
                if (research.data && !research.error) {
                    const data = research.data.toLowerCase();
                    if (data.includes('cloud') && insights.length < 3) {
                        insights.push('Cloud infrastructure opportunities identified');
                    }
                    if (data.includes('digital transformation') && insights.length < 3) {
                        insights.push('Digital transformation initiatives aligned');
                    }
                    if (data.includes('competitive') && insights.length < 3) {
                        insights.push('Competitive advantages potential identified');
                    }
                }
            });
            
            return insights.length > 0 ? insights.join('. ') + '.' : 'Comprehensive client analysis completed to inform project approach.';
        }

        function extractServiceInsights() {
            const insights = [];
            
            Object.values(serviceResearchData).forEach(research => {
                if (research.data && !research.error) {
                    const data = research.data.toLowerCase();
                    if (data.includes('best practice') && insights.length < 3) {
                        insights.push('Industry best practices incorporated');
                    }
                    if (data.includes('roi') && insights.length < 3) {
                        insights.push('ROI metrics and success measurements defined');
                    }
                    if (data.includes('phased') && insights.length < 3) {
                        insights.push('Phased implementation approach recommended');
                    }
                }
            });
            
            return insights.length > 0 ? insights.join('. ') + '.' : 'Service research completed to ensure optimal delivery approach.';
        }

        function enableExportButtons() {
            document.getElementById('export-btn').disabled = false;
            document.getElementById('export-advanced-btn').disabled = false;
            document.getElementById('export-excel-btn').disabled = false;
            document.getElementById('share-btn').disabled = false;
        }

        // Helper functions for dynamic content management
        function addObjective() { addItemToContainer('objectives-container', 'objective'); }
        function addDeliverable() { addItemToContainer('deliverables-container', 'deliverable'); }
        function addScopeItem() { addItemToContainer('scope-container', 'scope'); }

        function addItemToContainer(containerId, type) {
            const container = document.getElementById(containerId);
            container.appendChild(createEditableItem('', type));
        }

        function removeItem(button) {
            const container = button.closest('[id$="-container"]');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }
    </script>
    <script>
        // --- Toast Notification System ---
        /**
         * Shows a toast notification message
         * @param {string} message - The message to display
         * @param {string} type - The type of toast (success, error, info)
         */
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="mr-3">
                    ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}
                </div>
                <div>${message}</div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Force reflow for animation
            toast.offsetHeight;
            toast.classList.add('show');
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }
        
        // --- Export Functionality ---
        /**
         * Exports the SOW to PDF
         */
        async function exportToPDF() {
            showToast('Preparing PDF for download...', 'info');
            
            try {
                const { jsPDF } = window.jspdf;
                
                // Create a new jsPDF instance
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                
                // Clone the SOW output element for export
                const sowElement = document.getElementById('sow-output').cloneNode(true);
                sowElement.style.display = 'block';
                sowElement.style.width = '210mm';
                sowElement.style.margin = '0';
                sowElement.style.padding = '20px';
                
                // Temporarily append it to the body
                document.body.appendChild(sowElement);
                
                // Use html2canvas to capture the element
                const canvas = await html2canvas(sowElement);
                
                // Remove the cloned element
                document.body.removeChild(sowElement);
                
                // Calculate the number of pages needed
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = pageWidth - 20;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const pageCount = Math.ceil(imgHeight / (pageHeight - 20));
                
                // Add the header
                doc.setFontSize(18);
                doc.setTextColor(20, 50, 90);
                doc.text('Social Garden - Statement of Work', 10, 15);
                
                // Add content for each page
                let heightLeft = imgHeight;
                let position = 30;
                
                // Add the image to the first page
                doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                
                // Add page numbers
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Page ${i} of ${pageCount}`, pageWidth - 30, pageHeight - 10);
                    
                    if (i < pageCount) {
                        doc.addPage();
                        doc.setFontSize(18);
                        doc.setTextColor(20, 50, 90);
                        doc.text('Social Garden - Statement of Work', 10, 15);
                        doc.addImage(
                            imgData, 
                            'PNG', 
                            10, 
                            30, 
                            imgWidth, 
                            imgHeight, 
                            '', 
                            'FAST', 
                            0, 
                            -i * (pageHeight - 20)
                        );
                    }
                }
                
                // Save the PDF
                doc.save('social-garden-sow.pdf');
                showToast('PDF downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('PDF export failed:', error);
                showToast('PDF export failed: ' + error.message, 'error');
            }
        }
        
        /**
         * Creates a more advanced PDF with formatted content
         */
        async function exportAdvancedPDF() {
            showToast('Preparing enhanced PDF for download...', 'info');
            
            try {
                const clientName = document.getElementById('client-name').value;
                const serviceType = document.getElementById('service-type').value;
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                
                // Add header with logo
                const logo = new Image();
                logo.src = 'Logo Dark-Green.png';
                
                // Wait for the logo to load
                await new Promise((resolve) => {
                    logo.onload = resolve;
                    // Set a timeout in case the image fails to load
                    setTimeout(resolve, 3000);
                });
                
                // Add logo
                try {
                    doc.addImage(logo, 'PNG', 10, 10, 50, 20);
                } catch (e) {
                    console.warn('Logo could not be added:', e);
                }
                
                // Add title
                doc.setFontSize(20);
                doc.setTextColor(20, 80, 60);
                doc.text('Statement of Work', pageWidth / 2, 25, { align: 'center' });
                
                // Add client and service info
                doc.setFontSize(12);
                doc.setTextColor(60, 60, 60);
                doc.text(`Client: ${clientName}`, pageWidth / 2, 35, { align: 'center' });
                doc.text(`Service: ${serviceType}`, pageWidth / 2, 42, { align: 'center' });
                
                // Add separator line
                doc.setDrawColor(20, 80, 60);
                doc.setLineWidth(0.5);
                doc.line(10, 45, pageWidth - 10, 45);
                
                // Add Executive Summary
                doc.setFontSize(16);
                doc.setTextColor(20, 80, 60);
                doc.text('Executive Summary', 10, 55);
                
                doc.setFontSize(10);
                doc.setTextColor(60, 60, 60);
                const summary = document.getElementById('executive-summary').innerText;
                const summaryLines = doc.splitTextToSize(summary, pageWidth - 20);
                doc.text(summaryLines, 10, 62);
                
                // Add content sections...
                let currentY = 62 + summaryLines.length * 5;
                
                // Add more content sections as needed
                
                // Add page number
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Page ${i} of ${pageCount}`, pageWidth - 30, pageHeight - 10);
                }
                
                // Save the PDF
                doc.save(`${clientName}-SOW.pdf`);
                showToast('Enhanced PDF downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('Advanced PDF export failed:', error);
                showToast('Advanced PDF export failed: ' + error.message, 'error');
            }
        }
        
        /**
         * Export SOW data to Excel
         */
        async function exportToExcel() {
            showToast('Preparing Excel export...', 'info');
            
            try {
                const clientName = document.getElementById('client-name').value;
                const serviceType = document.getElementById('service-type').value;
                
                // Create CSV content
                let csvContent = "data:text/csv;charset=utf-8,";
                
                // Add header
                csvContent += "Statement of Work - " + clientName + "\n";
                csvContent += "Service: " + serviceType + "\n\n";
                
                // Add pricing table
                csvContent += "INVESTMENT STRUCTURE\n";
                csvContent += "Role,Hours,Rate,Total\n";
                
                const pricingRows = document.querySelectorAll('#pricing-table tr');
                pricingRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length) {
                        const rowData = Array.from(cells).map(cell => `"${cell.textContent.trim()}"`);
                        csvContent += rowData.join(',') + '\n';
                    }
                });
                
                // Add grand total
                const grandTotal = document.getElementById('grand-total')?.textContent || 
                                  document.querySelector('#pricing-table tr:last-child td:last-child')?.textContent || 
                                  "$0.00";
                csvContent += "\nTotal Investment," + grandTotal + "\n\n";
                
                // Add executive summary
                csvContent += "EXECUTIVE SUMMARY\n";
                csvContent += document.getElementById('executive-summary').textContent.trim() + "\n\n";
                
                // Add objectives
                csvContent += "PROJECT OBJECTIVES\n";
                const objectives = document.querySelectorAll('#objectives-container > div');
                objectives.forEach((obj, index) => {
                    csvContent += (index + 1) + ". " + obj.textContent.trim() + "\n";
                });
                
                // Encode and download
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${clientName}-SOW.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Excel file downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('Excel export failed:', error);
                showToast('Excel export failed: ' + error.message, 'error');
            }
        }
        
        /**
         * Generates a shareable link for the SOW
         */
        function shareSOW() {
            const clientName = document.getElementById('client-name').value;
            const serviceType = document.getElementById('service-type').value;
            
            // In a real implementation, this would save the SOW to a database
            // and generate a unique URL. For demo purposes, we'll simulate this.
            const shareId = Math.random().toString(36).substring(2, 10);
            const shareUrl = `${window.location.origin}/sow-view.html?id=${shareId}`;
            
            // Show a modal with the share link
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 shadow-xl max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">Share SOW with Client</h3>
                    <p class="text-gray-600 mb-3">Your SOW for ${clientName} is ready to share!</p>
                    <div class="bg-gray-100 p-3 rounded mb-4 overflow-x-auto">
                        <code class="text-sm">${shareUrl}</code>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="copyToClipboard('${shareUrl}')" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                            Copy Link
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            showToast('Share link generated!', 'success');
            
            // Auto-remove after 20 seconds
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 20000);
        }
        
        /**
         * Copy text to clipboard
         */
        async function copyToClipboard(text) {
            try {
               
                await navigator.clipboard.writeText(text);
                showToast('Link copied to clipboard!', 'success');
            } catch (error) {
                console.error('Failed to copy:', error);
                showToast('Failed to copy: ' + error.message, 'error');
            }
        }    </script>
    
    <!-- Toast Notification Container -->
    <div class="toast-container" id="toast-container"></div>
</body>
</html>
