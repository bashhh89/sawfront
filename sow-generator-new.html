<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Garden - SOW Generator</title>
    <!-- Tailwind CSS - Pre-compiled version for production use -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Custom styles to override Tailwind as needed -->    <style>
        /* Add any custom styles here */
        /* Social Garden Color Scheme */
        .client-input:focus,
        .service-input:focus,
        .brief-input:focus {
            outline: none;
            border-color: #10373a;
            box-shadow: 0 0 0 2px rgba(16, 55, 58, 0.2);
        }
        
        .btn-primary {
            background-color: #10373a;
            border-color: #10373a;
        }
        
        .btn-primary:hover {
            background-color: #0d2d30;
            border-color: #0d2d30;
        }        .btn-primary:focus {
            box-shadow: 0 0 0 2px rgba(16, 55, 58, 0.2);
        }
        
        /* Share button styling */
        .btn-share {
            background-color: #2563eb;
            border-color: #2563eb;
        }
        
        .btn-share:hover {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }
        
        .btn-share:focus {
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }        .editable-table input[type="number"] {
            width: 80px;
            text-align: right;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 0.5rem;
            transition: all 0.2s;
        }
        .editable-table input[type="number"]:focus {
            outline: none;
            border-color: #10373a;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        .research-step {
            border-left: 4px solid #e5e7eb;
            transition: border-color 0.3s ease;
        }
        .research-step.completed {
            border-left-color: #10b981;
        }
        .research-step.active {
            border-left-color: #3b82f6;
        }
        .research-step.error {
            border-left-color: #ef4444;
        }

        /* Cool progress bar animations */
        .progress-bar {
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        /* Preserve line breaks in research log so lists display clearly */
        .research-log-content {
            white-space: pre-wrap;   /* keep numbered/bulleted items on separate lines */
        }

        /* Cool animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Resizable textarea styles */
        .resize-handle {
            background: linear-gradient(-45deg, transparent 0%, transparent 40%, #9ca3af 40%, #9ca3af 60%, transparent 60%);
        }
        .resize-handle:hover {
            background: linear-gradient(-45deg, transparent 0%, transparent 40%, #6b7280 40%, #6b7280 60%, transparent 60%);
        }
        .resize-handle::before {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 0 16px 16px;
            border-color: transparent transparent currentColor transparent;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="flex flex-col lg:flex-row min-h-screen">
        <!-- Left Panel: Research Steps and Inputs -->
        <aside class="w-full lg:w-1/3 bg-white p-6 border-r border-gray-200 flex flex-col">
            <header class="flex items-center mb-8">
                <div class="w-10 h-10 rounded-full mr-3 flex items-center justify-center text-white font-bold text-lg" style="background-color: #10373a;">SG</div>
                <h1 class="text-2xl font-bold text-gray-900">SOW Generator</h1>
            </header>

            <div class="space-y-6">
                <!-- Step A: Client Research -->
                <div class="research-step p-4 rounded-lg bg-gray-50" id="client-research-step">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Step A: Client Research</h3>
                    <label for="client-name-input" class="block text-sm font-medium text-gray-700 mb-2">Client Name</label>
                    <div class="flex space-x-2">
                        <input type="text" id="client-name-input" class="flex-1 p-3 border border-gray-300 rounded-lg shadow-sm client-input">
                        <button id="client-search-btn" class="text-white font-semibold px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 shadow-sm btn-primary">
                            Search Client
                        </button>
                    </div>                    <div id="client-search-loading" class="hidden mt-3 slide-in">
                        <div class="flex items-center space-x-2">
                            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style="color: #10373a;">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-sm" id="client-status" style="color: #10373a;">Researching client...</span>
                        </div>
                        <div class="progress-bar mt-2">
                            <div class="progress-fill" id="client-progress" style="width: 0%; background-color: #10373a;"></div>
                        </div>
                    </div>
                </div>

                <!-- Step B: Service Research -->
                <div class="research-step p-4 rounded-lg bg-gray-50" id="service-research-step">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Step B: Service Research</h3>
                    <label for="service-research-input" class="block text-sm font-medium text-gray-700 mb-2">Service Type</label>
                    <div class="flex space-x-2">
                        <input type="text" id="service-research-input" class="flex-1 p-3 border border-gray-300 rounded-lg shadow-sm service-input">
                        <button id="service-search-btn" class="text-white font-semibold px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 shadow-sm btn-primary">
                            Search Service
                        </button>
                    </div>
                    <div id="service-search-loading" class="hidden mt-3 slide-in">
                        <div class="flex items-center space-x-2">                            <svg class="animate-spin h-4 w-4 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-sm text-purple-600" id="service-status">Researching best practices...</span>
                        </div>
                        <div class="progress-bar mt-2">
                            <div class="progress-fill" id="service-progress" style="width: 0%; background-color: #10373a;"></div>
                        </div>
                    </div>
                </div>

                <!-- Step C: Detailed Brief -->
                <div class="research-step p-4 rounded-lg bg-gray-50" id="brief-step">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Step C: Detailed Brief</h3>
                    <label for="client-brief" class="block text-sm font-medium text-gray-700 mb-2">Project Requirements</label>
                    <textarea id="client-brief" rows="6" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm brief-input"></textarea>
                </div>

                <!-- Final Generation Button -->                <button id="generate-btn" class="w-full text-white font-semibold py-4 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 shadow-sm text-lg btn-primary">
                    Generate Full Scope
                </button>
                
                <div id="final-loading" class="hidden text-center mt-4">
                    <svg class="animate-spin h-6 w-6 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style="color: #10373a;">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-sm mt-1" style="color: #10373a;">Generating complete SOW...</p>
                </div>
            </div>            <!-- Export Section -->
            <div class="mt-auto pt-6">
                <h2 class="text-lg font-semibold mb-2">Export</h2>
                <div class="space-y-2">
                    <div class="flex space-x-2">
                        <button id="export-btn" class="flex-1 bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200 shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            Export as PDF
                        </button>
                        <button id="export-advanced-btn" class="flex-1 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed btn-primary" disabled>
                            Advanced PDF
                        </button>
                    </div>
                    <div class="flex space-x-2">
                        <button id="export-excel-btn" class="flex-1 bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200 shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            Export to Excel
                        </button>
                        <button id="share-btn" class="flex-1 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed btn-share" disabled>
                            Share SOW
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Right Panel: Research Log and SOW Output -->
        <main class="w-full lg:w-2/3 p-8 overflow-y-auto bg-gray-100">
            <!-- Research Log Section -->
            <div id="research-log" class="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-8">
                <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #10373a;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    Research Log
                </h2>                <div id="research-log-content" class="space-y-4"></div>
            </div>

            <!-- Final SOW Content Section -->
            <div id="sow-content" class="hidden bg-white p-8 rounded-xl shadow-md border border-gray-200 fade-in">
                <div class="border-b pb-4 mb-6">                    <h2 class="text-3xl font-bold" id="sow-title" style="color: #10373a;"></h2>
                    <p class="text-gray-600" id="sow-project"></p>
                </div>                <div class="prose prose-indigo max-w-none">                    <!-- Project Overview Section -->
                    <div class="mb-8">
                        <h3 class="font-semibold text-lg mb-3" style="color: #10373a;">Project Overview</h3>
                        <div class="relative">
                            <textarea id="project-overview" class="w-full p-3 border rounded-md resize-none" rows="3"></textarea>
                            <div class="resize-handle absolute bottom-0 right-0 w-4 h-4 cursor-se-resize bg-gray-300 hover:bg-gray-400 transition-colors duration-200" style="clip-path: polygon(100% 0%, 0% 100%, 100% 100%);"></div>
                        </div>
                    </div>

                    <!-- Research Insights Section (shows personalization) -->
                    <div id="research-insights" class="mb-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold text-lg mb-3 text-blue-800">üîç Research-Based Personalization</h3>
                        <div class="space-y-3 text-sm">
                            <div id="client-insights" class="hidden">
                                <strong class="text-blue-700">Client Insights:</strong>
                                <p class="text-blue-600 mt-1"></p>
                            </div>
                            <div id="service-insights" class="hidden">
                                <strong class="text-blue-700">Best Practices Applied:</strong>
                                <p class="text-blue-600 mt-1"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Objectives Section -->
                    <div class="mb-8">
                        <h3 class="font-semibold text-lg mb-3" style="color: #10373a;">Project Objectives</h3>
                        <div id="objectives-container" class="space-y-2">
                            <!-- Dynamic objectives will be inserted here -->
                        </div>
                        <button onclick="addObjective()" class="mt-2 text-sm hover:underline" style="color: #10373a;">+ Add Objective</button>
                    </div>

                    <!-- Deliverables Section -->
                    <div class="mb-8">
                        <h3 class="font-semibold text-lg mb-3" style="color: #10373a;">Key Deliverables</h3>
                        <div id="deliverables-container" class="space-y-2">
                            <!-- Dynamic deliverables will be inserted here -->
                        </div>
                        <button onclick="addDeliverable()" class="mt-2 text-sm hover:underline" style="color: #10373a;">+ Add Deliverable</button>
                    </div>

                    <!-- Scope Section -->
                    <div class="mb-8">
                        <h3 class="font-semibold text-lg mb-3" style="color: #10373a;">Project Scope</h3>
                        <div id="scope-container" class="space-y-2">
                            <!-- Dynamic scope items will be inserted here -->
                        </div>
                        <button onclick="addScopeItem()" class="mt-2 text-sm hover:underline" style="color: #10373a;">+ Add Scope Item</button>
                    </div>                    <!-- Timeline Section -->
                    <div class="mb-8">
                        <h3 class="font-semibold text-lg mb-3" style="color: #10373a;">Project Timeline</h3>
                        <div class="relative">
                            <textarea id="project-timeline" class="w-full p-3 border rounded-md resize-none" rows="3"></textarea>
                            <div class="resize-handle absolute bottom-0 right-0 w-4 h-4 cursor-se-resize bg-gray-300 hover:bg-gray-400 transition-colors duration-200" style="clip-path: polygon(100% 0%, 0% 100%, 100% 100%);"></div>
                        </div>
                    </div>

                    <!-- Investment Summary Section --><h3 class="font-semibold mt-6" style="color: #10373a;">Investment Summary</h3>
                    <p class="text-sm text-gray-600 mb-4">You can modify the hours and rates directly in the table below. Totals will update instantly.</p>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 editable-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Hours</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Rate</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="pricing-table-body">
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <div class="w-full max-w-sm space-y-3">
                            <div>
                                <label for="discount" class="block text-sm font-medium text-gray-700">Discount (%)</label>
                                <input type="number" id="discount" value="0" oninput="updateTotals()" class="mt-1 w-full p-2 border rounded-md">
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <dl class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <dt>Sub-total</dt>
                                        <dd id="sub-total">$0.00</dd>
                                    </div>
                                    <div class="flex justify-between text-sm text-red-600">
                                        <dt>Discount</dt>
                                        <dd id="discount-amount">$0.00</dd>
                                    </div>
                                    <div class="flex justify-between text-lg font-bold text-gray-900 border-t pt-2">
                                        <dt>Grand Total</dt>
                                        <dd id="grand-total">$0.00</dd>
                                    </div>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Hidden PDF Template -->
    <div id="pdf-template" style="display: none; width: 210mm; min-height: 297mm; background: white; font-family: 'Inter', sans-serif; position: absolute; top: -10000px; margin: 0; padding: 0;">        <!-- PDF Header - Full Width Only -->
        <div style="background-color: #10373a; width: 100%; margin: 0; padding: 8mm 0 5mm 0;">
            <div style="padding: 0 5mm;">
            <div style="display: flex; justify-content: center; margin-bottom: 5mm;">
                <img id="pdf-logo" src="SocialGarden.svg" style="height: 10mm; width: auto;">
            </div>
            </div>
        </div><!-- PDF Content -->
        <div style="padding: 0; background: white; margin: 0;">
            <!-- Document Title -->
            <div style="margin: 0; padding: 5mm;">
                <h2 id="pdf-title" style="font-size: 28px; color: #1f2937; margin: 0 0 5mm 0; font-weight: 700;">Statement of Work</h2>
                <p id="pdf-subtitle" style="font-size: 16px; color: #10373a; margin: 0; font-weight: 600;"></p>
            </div>

            <!-- Project Overview -->
            <div style="margin: 0; padding: 5mm;">
                <h3 style="font-size: 18px; color: #10373a; margin: 0 0 5mm 0; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 2mm;">Project Overview</h3>
                <p id="pdf-overview" style="font-size: 12px; color: #374151; line-height: 1.6; margin: 0;"></p>
            </div>

            <!-- Objectives -->
            <div style="margin: 0; padding: 5mm;">
                <h3 style="font-size: 18px; color: #10373a; margin: 0 0 5mm 0; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 2mm;">Project Objectives</h3>
                <ul id="pdf-objectives" style="font-size: 12px; color: #374151; line-height: 1.6; margin: 0; padding-left: 5mm;">
                    <!-- Objectives will be populated here -->
                </ul>
            </div>

            <!-- Deliverables -->
            <div style="margin: 0; padding: 5mm;">
                <h3 style="font-size: 18px; color: #10373a; margin: 0 0 5mm 0; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 2mm;">Key Deliverables</h3>
                <ul id="pdf-deliverables" style="font-size: 12px; color: #374151; line-height: 1.6; margin: 0; padding-left: 5mm;">
                    <!-- Deliverables will be populated here -->
                </ul>
            </div>

            <!-- Scope -->
            <div style="margin: 0; padding: 5mm;">
                <h3 style="font-size: 18px; color: #10373a; margin: 0 0 5mm 0; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 2mm;">Project Scope</h3>
                <ul id="pdf-scope" style="font-size: 12px; color: #374151; line-height: 1.6; margin: 0; padding-left: 5mm;">
                    <!-- Scope items will be populated here -->
                </ul>
            </div>

            <!-- Timeline -->
            <div style="margin: 0; padding: 5mm;">
                <h3 style="font-size: 18px; color: #10373a; margin: 0 0 5mm 0; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 2mm;">Project Timeline</h3>
                <p id="pdf-timeline" style="font-size: 12px; color: #374151; line-height: 1.6; margin: 0;"></p>
            </div>

            <!-- Investment Summary -->
            <div style="margin: 0; padding: 5mm;">
                <h3 style="font-size: 18px; color: #10373a; margin: 0 0 5mm 0; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 2mm;">Investment Summary</h3>
                <table id="pdf-pricing-table" style="width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 8mm;">
                    <thead>
                        <tr style="background-color: #f9fafb;">
                            <th style="border: 1px solid #e5e7eb; padding: 3mm; text-align: left; font-weight: 600; color: #374151;">Role</th>
                            <th style="border: 1px solid #e5e7eb; padding: 3mm; text-align: right; font-weight: 600; color: #374151;">Hours</th>
                            <th style="border: 1px solid #e5e7eb; padding: 3mm; text-align: right; font-weight: 600; color: #374151;">Rate</th>
                            <th style="border: 1px solid #e5e7eb; padding: 3mm; text-align: right; font-weight: 600; color: #374151;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="pdf-pricing-rows">
                        <!-- Pricing rows will be populated here -->
                    </tbody>
                </table>

                <!-- Totals -->
                <div style="text-align: right; font-size: 12px;">
                    <div style="margin-bottom: 2mm;">
                        <span style="color: #6b7280;">Sub-total: </span>
                        <span id="pdf-subtotal" style="color: #374151; font-weight: 600;">$0.00</span>
                    </div>
                    <div id="pdf-discount-row" style="margin-bottom: 2mm; display: none;">
                        <span style="color: #ef4444;">Discount: </span>
                        <span id="pdf-discount-amount" style="color: #ef4444; font-weight: 600;">$0.00</span>
                    </div>                    <div style="border-top: 2px solid #10373a; padding-top: 2mm; margin-top: 2mm;">
                        <span style="color: #10373a; font-size: 16px; font-weight: 700;">Grand Total: </span>
                        <span id="pdf-grandtotal" style="color: #10373a; font-size: 16px; font-weight: 700;">$0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- PDF Footer -->
        <div style="position: absolute; bottom: 10mm; left: 15mm; right: 15mm; border-top: 2px solid #10373a; padding-top: 5mm; font-size: 10px; color: #6b7280;">
            <div style="display: flex; justify-content: space-between;">                <div>
                    <div>www.socialgarden.co</div>
                </div>
                <div style="text-align: right;">
                    <div id="pdf-date">Generated: Loading...</div>
                    <div>Page 1</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- AnythingLLM API Configuration ---
        const ANYTHINGLLM_CONFIG = {
            baseUrl: 'https://socialgarden-anything-llm.vo0egb.easypanel.host',
            apiKey: 'F7C84WV-75N4QWH-P9ERFRV-CWJ146T',
            workspace: 'main'        };
        
        // --- Global Application State ---
        let clientData = ""; // Stores client research results
        let serviceData = ""; // Stores service research results
        
        // --- AnythingLLM API Helper Functions ---
        // Makes a chat request to AnythingLLM API with retry logic
        async function callAnythingLLM(message) {
            // Maximum number of retries - reduced for faster failure
            const MAX_RETRIES = 2; // Only 2 retries instead of 6
            // Delay between retries - shorter delays
            const INITIAL_RETRY_DELAY = 5000; // 5 seconds initial delay instead of 15
            
            let retryCount = 0;
            let lastError = null;
            
            while (retryCount < MAX_RETRIES) {
                try {
                    console.log(`Attempt ${retryCount + 1} to call AnythingLLM API`);
                    
                    const response = await fetch(`${ANYTHINGLLM_CONFIG.baseUrl}/api/v1/workspace/${ANYTHINGLLM_CONFIG.workspace}/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${ANYTHINGLLM_CONFIG.apiKey}`,
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            mode: 'chat'
                        })
                    });                    if (!response.ok) {
                        // Try to get error details first
                        let errorBody = '';
                        
                        try {
                            errorBody = await response.text();
                        } catch (e) {
                            // Ignore error reading body
                        }
                        
                        // Check for rate limiting - either 429 status or 429 mentioned in error body
                        if (response.status === 429 || 
                            (errorBody && (errorBody.includes('rate limit') || 
                                          errorBody.includes('Rate limit') ||
                                          errorBody.includes('429 status code')))) {
                            const waitTime = INITIAL_RETRY_DELAY * Math.pow(2, retryCount);
                            console.warn(`Rate limit detected (${response.status}). Waiting ${waitTime}ms before retry...`);
                            await new Promise(resolve => setTimeout(resolve, waitTime));
                            retryCount++;
                            continue;
                        }
                        
                        // For other errors, throw immediately without retrying
                        throw new Error(`API error ${response.status}: ${errorBody || response.statusText}`);
                    }
                    
                    // Parse response
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(`API error: ${data.error}`);
                    }
                    
                    return data.textResponse || data.message || 'No response received';                } catch (error) {
                    console.error(`API call attempt ${retryCount + 1} failed:`, error);
                    lastError = error;
                    
                    // Check for rate limiting in error messages (including "429 status code")
                    const isRetryableError = error.message.includes('429') || 
                                           error.message.includes('rate limit') ||
                                           error.message.includes('Rate limit') ||
                                           error.message.includes('429 status code');
                    
                    retryCount++;
                    
                    // If this was the last attempt or not a retryable error, break
                    if (retryCount >= MAX_RETRIES || !isRetryableError) {
                        console.warn(`Stopping retries. Attempts: ${retryCount}/${MAX_RETRIES}, Retryable: ${isRetryableError}`);
                        break;
                    }
                    
                    // Use exponential backoff for rate limiting only
                    const delay = INITIAL_RETRY_DELAY * Math.pow(2, retryCount - 1);
                    console.log(`Rate limiting detected. Waiting ${delay}ms before retry ${retryCount + 1}...`);
                    await new Promise(resolve => setTimeout(resolve, delay));                }
            }
            // If we've exhausted all retries, throw an error instead of using fallbacks
            throw new Error(`AI research service unavailable after ${MAX_RETRIES} attempts. Please try again later.`);
        }

        /**
         * Extracts structured data from AI response for SOW generation
         * @param {string} aiResponse - The raw AI response
         * @returns {Object} - Structured SOW data
         */        function parseSOWResponse(aiResponse) {
            // Parse roles from AI response only - no defaults
            const roles = [];

            // Try to extract role information from markdown table format
            const tableRowPattern = /\|\s*([^|]+?)\s*\|\s*(\d+)\s*\|\s*\$?(\d+)\s*\|\s*\$?[\d,]+\s*\|/gi;
            
            let match;
            while ((match = tableRowPattern.exec(aiResponse)) !== null) {
                const name = match[1].trim();
                const hours = parseInt(match[2]);
                const rate = parseInt(match[3]);
                
                // Skip header rows and ensure valid data
                if (name && hours > 0 && rate > 0 && 
                    !name.toLowerCase().includes('role') && 
                    !name.toLowerCase().includes('sub-total') &&
                    !name.toLowerCase().includes('grand total') &&
                    !name.toLowerCase().includes('discount')) {
                    roles.push({ name, hours, rate });
                }
            }

            return {
                roles: roles,
                rawResponse: aiResponse
            };
        }
        
        // --- DOM Element References ---
        const clientNameInput = document.getElementById('client-name-input');
        const clientSearchBtn = document.getElementById('client-search-btn');
        const clientSearchLoading = document.getElementById('client-search-loading');
        const clientResearchStep = document.getElementById('client-research-step');
        
        const serviceResearchInput = document.getElementById('service-research-input');
        const serviceSearchBtn = document.getElementById('service-search-btn');
        const serviceSearchLoading = document.getElementById('service-search-loading');
        const serviceResearchStep = document.getElementById('service-research-step');
        
        const clientBrief = document.getElementById('client-brief');
        const briefStep = document.getElementById('brief-step');
          const generateBtn = document.getElementById('generate-btn');
        const finalLoading = document.getElementById('final-loading');
        const exportBtn = document.getElementById('export-btn');
        const shareBtn = document.getElementById('share-btn');
        
        const researchLogContent = document.getElementById('research-log-content');
        const sowContent = document.getElementById('sow-content');
        const sowTitle = document.getElementById('sow-title');        const sowProject = document.getElementById('sow-project');
        const projectOverview = document.getElementById('project-overview');
        const pricingTableBody = document.getElementById('pricing-table-body');

        // =============================================================================
        // STEP A: CLIENT RESEARCH WORKFLOW
        // =============================================================================

        /**
         * Handles client research when user clicks "Search Client" button
         * Makes real API call to AnythingLLM
         */
        async function performClientResearch() {
            const clientName = clientNameInput.value.trim();
            if (!clientName) {
                alert('Please enter a client name to research.');
                return;
            }

            // Update UI state
            clientSearchBtn.disabled = true;
            clientSearchLoading.classList.remove('hidden');
            clientResearchStep.classList.add('active');            // Add searching message to research log
            addToResearchLog('Searching...', `Searching for "${clientName}"...`, 'blue');
            
            try {
                // First send /exit to ensure any previous agent session is terminated
                try {
                    await callAnythingLLM('/exit');
                    console.log("Sent /exit command to ensure clean agent state");
                    // Small delay to ensure command is processed
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (exitError) {
                    // Ignore errors from exit command
                    console.log("Exit command response (can be ignored):", exitError);
                }
                  // Add status message about potential delays
                addToResearchLog('Status', 'Connecting to AI research service... This may take longer due to high demand.', 'orange');                  // Make real API call to AnythingLLM with @agent prefix to activate web search
                const prompt = `@agent Research "${clientName}". Brief summary only: industry, size, recent news, challenges. Max 200 words.`;
                
                // Set up longer timeout for search operations
                const research = await Promise.race([
                    callAnythingLLM(prompt),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error("Search timed out after 45 seconds")), 45000)
                    )
                ]);
                
                clientData = research;// Update research log with results
                updateLastLogEntry('Client Research Complete', research, 'blue');                // Mark step as completed
                clientResearchStep.classList.remove('active');
                clientResearchStep.classList.add('completed');
                
                // Exit agent mode after completing search
                try {
                    await callAnythingLLM('/exit');
                    console.log("Successfully exited agent mode after client research");
                } catch (exitError) {
                    console.log("Error exiting agent mode (can be ignored):", exitError);
                }
                
                console.log('Client research completed:', clientData);
            } catch (error) {
                console.error('Client research failed:', error);
                const errorMessage = `Failed to research ${clientName}. Error: ${error.message}`;
                updateLastLogEntry('Client Research Failed', errorMessage, 'red');
            } finally {
                // Reset UI state
                clientSearchBtn.disabled = false;
                clientSearchLoading.classList.add('hidden');
            }
        }        // =============================================================================
        // STEP B: SERVICE RESEARCH WORKFLOW
        // =============================================================================

        /**
         * Handles service research when user clicks "Search Service" button
         * Makes real API call to AnythingLLM
         */
        async function performServiceResearch() {
            const serviceType = serviceResearchInput.value.trim();
            if (!serviceType) {
                alert('Please enter a service type to research.');
                return;
            }

            // Update UI state
            serviceSearchBtn.disabled = true;
            serviceSearchLoading.classList.remove('hidden');
            serviceResearchStep.classList.add('active');

            // Add searching message to research log
            addToResearchLog('Searching...', `Searching for best practices for "${serviceType}"...`, 'purple');            try {
                // First send /exit to ensure any previous agent session is terminated
                try {
                    await callAnythingLLM('/exit');
                    console.log("Sent /exit command to ensure clean agent state");
                    // Small delay to ensure command is processed
                    await new Promise(resolve => setTimeout(resolve, 1500));
                } catch (exitError) {
                    // Ignore errors from exit command as it might not be in an agent session
                    console.log("Exit command response (can be ignored):", exitError);
                }                  // Add @agent prefix to activate web search for service best practices
                const prompt = `@agent "${serviceType}" project phases and best practices. List 4-5 key points. Max 150 words.`;
                
                console.log("Sending service research prompt:", prompt);
                
                // Set up longer timeout for search operations
                const research = await Promise.race([
                    callAnythingLLM(prompt),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error("Search timed out after 45 seconds")), 45000)
                    )
                ]);
                
                serviceData = research;

                // Update research log with results
                updateLastLogEntry('Service Research Complete', research, 'purple');                // Mark step as completed
                serviceResearchStep.classList.remove('active');
                serviceResearchStep.classList.add('completed');

                // Exit agent mode after completing search
                try {
                    await callAnythingLLM('/exit');
                    console.log("Successfully exited agent mode after service research");
                } catch (exitError) {
                    console.log("Error exiting agent mode (can be ignored):", exitError);
                }

                console.log('Service research completed:', serviceData);
            } catch (error) {
                console.error('Service research failed:', error);
                
                // Create a detailed error message that includes all relevant info
                const errorMessage = `Failed to research ${serviceType}. 
                Error: ${error.message}
                
                This appears to be an issue with the AnythingLLM API. You could try:
                1. Refreshing the page and trying again
                2. Using a different service type with simpler wording
                3. Checking if AnythingLLM service is under high load
                
                The service research error does not affect the rest of the application.
                You can still continue generating your SOW.`;
                
                updateLastLogEntry('Service Research Failed', errorMessage, 'red');
            } finally {
                // Reset UI state
                serviceSearchBtn.disabled = false;
                serviceSearchLoading.classList.add('hidden');
            }
        }

        // =============================================================================
        // STEP C: FINAL SOW GENERATION WORKFLOW
        // =============================================================================

        /**
         * Generates the complete SOW by combining client data, service data, and brief
         * Makes real API call that processes all three data sources
         */
        async function generateCompleteSOW() {
            const brief = clientBrief.value.trim();
            const clientName = clientNameInput.value.trim();
            const serviceType = serviceResearchInput.value.trim();

            if (!brief) {
                alert('Please enter a detailed brief before generating the scope.');
                return;
            }

            // Update UI state
            generateBtn.disabled = true;
            finalLoading.classList.remove('hidden');
            briefStep.classList.add('active');

            // Add generation message to research log
            addToResearchLog('Generating...', 'Generating complete SOW using client research, service research, and detailed brief...', 'indigo');            try {
                // Let ScopeArchitect AI handle the complete SOW generation with web research
                let sowPrompt = `@agent Please create a SOW for this brief: ${brief}`;

                // If we have research data, include it as context
                if (clientData || serviceData) {
                    sowPrompt += `\n\nAdditional context:`;
                    if (clientData) sowPrompt += `\nClient: ${clientData.substring(0, 200)}...`;
                    if (serviceData) sowPrompt += `\nService: ${serviceData.substring(0, 200)}...`;
                }

                // Make real API call for SOW generation
                const sowResponse = await callAnythingLLM(sowPrompt);
                
                // Parse the response to extract structured data
                const parsedSOW = parseSOWResponse(sowResponse);
                
                // Generate the SOW using all collected data
                const sowData = {
                    clientName: clientName || 'Client',
                    serviceType: serviceType,
                    overview: generateProjectOverview(clientName, serviceType, clientData, serviceData, brief, sowResponse),
                    roles: parsedSOW.roles,
                    rawResponse: sowResponse
                };                // Render the complete SOW
                renderCompleteSOW(sowData);                // Update research log with completion
                const personalizationNote = (clientData || serviceData) ? 
                    `Complete SOW generated with personalization based on ${clientData ? 'client research' : ''}${(clientData && serviceData) ? ' and ' : ''}${serviceData ? 'service best practices' : ''}.` :
                    'Complete scope of work has been generated and is ready for review and export.';
                
                updateLastLogEntry('SOW Generation Complete', personalizationNote, 'indigo');                // Enable all export buttons
                exportBtn.disabled = false;
                document.getElementById('export-advanced-btn').disabled = false;
                document.getElementById('export-excel-btn').disabled = false;
                shareBtn.disabled = false;

                console.log('SOW generation completed:', sowData);
            } catch (error) {
                console.error('SOW generation failed:', error);
                const errorMessage = `Failed to generate SOW. Error: ${error.message}`;
                updateLastLogEntry('SOW Generation Failed', errorMessage, 'red');
            } finally {
                // Reset UI state
                generateBtn.disabled = false;
                finalLoading.classList.add('hidden');
            }
        }

        // =============================================================================
        // RESEARCH LOG MANAGEMENT FUNCTIONS
        // =============================================================================

        /**
         * Adds a new entry to the research log
         */
        function addToResearchLog(title, content, color = 'gray') {
            // Clear placeholder if this is the first entry
            if (researchLogContent.querySelector('.text-center')) {
                researchLogContent.innerHTML = '';
            }            const colorClasses = {
                'blue': 'border-blue-200 bg-blue-50',
                'purple': 'border-purple-200 bg-purple-50', 
                'indigo': 'border-green-200 bg-green-50',
                'green': 'border-green-200 bg-green-50',
                'red': 'border-red-200 bg-red-50',
                'gray': 'border-gray-200 bg-gray-50'
            };

            // Clean the content to remove markdown formatting
            const cleanContent = cleanMarkdownText(content);

            const entry = document.createElement('div');
            entry.className = `border-l-4 ${colorClasses[color]} p-4 rounded-r-lg research-log-entry`;
            
            // Check if this is a research result that should have accordion functionality
            const isResearchResult = title.includes('Research Complete') && cleanContent.length > 200;
            
            if (isResearchResult) {
                // Create accordion-style entry for research results
                const entryId = `research-${Date.now()}`;
                const preview = cleanContent.substring(0, 150) + '...';
                
                entry.innerHTML = `
                    <div class="flex items-center justify-between cursor-pointer" onclick="toggleAccordion('${entryId}')">
                        <h4 class="font-semibold text-gray-900 research-log-title">${title}</h4>
                        <svg id="${entryId}-icon" class="w-5 h-5 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-gray-700 mt-1">
                        <div id="${entryId}-preview" class="research-preview">${preview}</div>
                        <div id="${entryId}-full" class="research-full hidden research-log-content">${cleanContent}</div>                        <button onclick="toggleAccordion('${entryId}')" class="text-xs mt-2 hover:underline" style="color: #10373a;">
                            <span id="${entryId}-toggle-text">Show full research</span>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">${new Date().toLocaleTimeString()}</p>
                `;
            } else {
                // Regular entry for non-research items
                entry.innerHTML = `
                    <h4 class="font-semibold text-gray-900 research-log-title">${title}</h4>
                    <div class="text-sm text-gray-700 mt-1 research-log-content">${cleanContent}</div>
                    <p class="text-xs text-gray-500 mt-2">${new Date().toLocaleTimeString()}</p>
                `;
            }
            
            researchLogContent.appendChild(entry);
            
            // Scroll to bottom
            researchLogContent.scrollTop = researchLogContent.scrollHeight;
        }

        /**
         * Cleans markdown formatting and converts to proper HTML
         */
        function cleanMarkdownText(text) {
            if (!text) return '';
            
            // Remove unwanted technical prefixes and agent responses
            let cleaned = text
                // Remove tool_code blocks and search results
                .replace(/``tool_code[\s\S]*?``/g, '')
                .replace(/print\(search_internet\(.*?\)\)/g, '')
                .replace(/Based on the search results[,:]?\s*/gi, '')
                .replace(/Here is a comprehensive research report[^.]*\./gi, '')
                .replace(/I will use the search tool[^.]*\./gi, '')
                // Remove extra technical language
                .replace(/According to various reports[^.]*\./gi, '')
                .replace(/More recent estimates[^.]*\./gi, '')
                .replace(/While exact current figures[^.]*\./gi, '')
                // Clean up markdown formatting
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Convert bullet points to proper list items
                .replace(/^\*\s+(.+)$/gm, '‚Ä¢ $1')
                // Convert numbered lists to proper format
                .replace(/^\d+\.\s+(.+)$/gm, '$1')
                // Clean up extra spaces and line breaks
                .replace(/\n\s*\n\s*\n/g, '<br><br>')
                .replace(/\n\s*\n/g, '<br><br>')
                .replace(/\n/g, '<br>')
                // Remove any remaining markdown characters
                .replace(/#{1,6}\s*/g, '')
                .replace(/`([^`]+)`/g, '$1')
                // Clean up multiple spaces
                .replace(/\s+/g, ' ')
                .trim();
            
            return cleaned;
        }

        /**
         * Updates the last entry in the research log (for updating status)
         */
        function updateLastLogEntry(newTitle, newContent, color = 'gray') {
            const lastEntry = researchLogContent.lastElementChild;
            if (lastEntry && lastEntry.classList.contains('research-log-entry')) {
                const titleElement = lastEntry.querySelector('.research-log-title');
                
                if (titleElement) titleElement.textContent = newTitle;

                // Update color classes
                const colorClasses = {
                    'blue': 'border-blue-200 bg-blue-50',                    'purple': 'border-purple-200 bg-purple-50',
                    'indigo': 'border-green-200 bg-green-50',
                    'green': 'border-green-200 bg-green-50',
                    'red': 'border-red-200 bg-red-50',
                    'gray': 'border-gray-200 bg-gray-50'
                };

                // Remove old color classes
                Object.values(colorClasses).forEach(cls => {
                    lastEntry.classList.remove(...cls.split(' '));
                });
                
                // Add new color classes
                lastEntry.classList.add(...colorClasses[color].split(' '));

                // Check if this is a research completion that needs accordion functionality
                const isResearchResult = newTitle.includes('Research Complete') && newContent.length > 200;
                
                if (isResearchResult) {
                    // Replace the entire entry content with accordion structure
                    const entryId = `research-${Date.now()}`;
                    const cleanContent = cleanMarkdownText(newContent);
                    const preview = cleanContent.substring(0, 150) + '...';
                    
                    // Replace the entire inner HTML with proper accordion structure
                    lastEntry.innerHTML = `
                        <div class="flex items-center justify-between cursor-pointer" onclick="toggleAccordion('${entryId}')">
                            <h4 class="font-semibold text-gray-900 research-log-title">${newTitle}</h4>
                            <svg id="${entryId}-icon" class="w-5 h-5 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        <div class="text-sm text-gray-700 mt-1">
                            <div id="${entryId}-preview" class="research-preview">${preview}</div>
                            <div id="${entryId}-full" class="research-full hidden research-log-content">${cleanContent}</div>                            <button onclick="toggleAccordion('${entryId}')" class="text-xs mt-2 hover:underline" style="color: #10373a;">
                                <span id="${entryId}-toggle-text">Show full research</span>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">${new Date().toLocaleTimeString()}</p>
                    `;
                } else {
                    // Regular entry update
                    const contentElement = lastEntry.querySelector('.research-log-content');
                    if (contentElement) {
                        const cleanContent = cleanMarkdownText(newContent);
                        contentElement.innerHTML = cleanContent;
                    }
                }

                // Add action buttons for failed entries
                if (color === 'red') {
                    addFailureActions(lastEntry, newTitle.includes('Client') ? 'client' : 'service');
                }
            }
        }

        /**
         * Toggles accordion display for research results
         */
        function toggleAccordion(entryId) {
            const preview = document.getElementById(`${entryId}-preview`);
            const full = document.getElementById(`${entryId}-full`);
            const icon = document.getElementById(`${entryId}-icon`);
            const toggleText = document.getElementById(`${entryId}-toggle-text`);
            
            if (preview && full && icon && toggleText) {
                const isExpanded = !full.classList.contains('hidden');
                
                if (isExpanded) {
                    // Collapse
                    full.classList.add('hidden');
                    preview.classList.remove('hidden');
                    icon.style.transform = 'rotate(0deg)';
                    toggleText.textContent = 'Show full research';
                } else {
                    // Expand
                    full.classList.remove('hidden');
                    preview.classList.add('hidden');
                    icon.style.transform = 'rotate(180deg)';
                    toggleText.textContent = 'Hide full research';
                }
            }
        }

        /**
         * Adds retry and remove buttons to failed research entries
         */
        function addFailureActions(entryElement, type) {
            // Check if actions already exist
            if (entryElement.querySelector('.failure-actions')) return;
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'failure-actions mt-3 flex space-x-2';
            actionsDiv.innerHTML = `
                <button onclick="retryResearch('${type}')" class="px-3 py-1 text-white text-xs rounded transition-colors btn-primary">
                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Retry
                </button>
                <button onclick="removeLogEntry(this)" class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition-colors">
                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Remove
                </button>
            `;
            entryElement.appendChild(actionsDiv);
        }

        /**
         * Retries failed research
         */
        function retryResearch(type) {
            if (type === 'client') {
                performClientResearch();
            } else if (type === 'service') {
                performServiceResearch();
            }
        }        /**
         * Removes a failed log entry
         */
        function removeLogEntry(button) {
            const entry = button.closest('.research-log-entry');
            if (entry) {
                entry.style.opacity = '0';
                entry.style.transform = 'translateX(-100%)';
                entry.style.transition = 'all 0.3s ease';
                
                setTimeout(() => {
                    entry.remove();
                    
                    // If no entries left, clear log
                    if (researchLogContent.children.length === 0) {
                        researchLogContent.innerHTML = '';
                    }
                }, 300);
            }
        }

        // =============================================================================
        // SOW RENDERING FUNCTIONS
        // =============================================================================

        /**
         * Renders the complete SOW in the main content area
         */        function renderCompleteSOW(sowData) {
            // Update title and project info
            sowTitle.textContent = `Scope of Work: ${sowData.clientName}`;
            sowProject.innerHTML = `<strong>Project:</strong> ${sowData.serviceType}`;
            
            // Populate research insights section to show personalization
            populateResearchInsights(sowData);
            
            // Parse and populate structured sections
            populateSOWSections(sowData.rawResponse, sowData.overview);
            
            // Render pricing table
            renderTable(sowData.roles);
            
            // Calculate initial totals
            updateTotals();
            
            // Show the SOW content
            sowContent.classList.remove('hidden');
        }

        /**
         * Populates the research insights section to show how research was used for personalization
         */
        function populateResearchInsights(sowData) {
            const clientInsightsDiv = document.getElementById('client-insights');
            const serviceInsightsDiv = document.getElementById('service-insights');
            
            // Show client insights if we have client data
            if (clientData && clientData.trim()) {
                const clientSummary = clientData.substring(0, 150) + (clientData.length > 150 ? '...' : '');
                clientInsightsDiv.querySelector('p').textContent = clientSummary;
                clientInsightsDiv.classList.remove('hidden');
            }
            
            // Show service insights if we have service data
            if (serviceData && serviceData.trim()) {
                const serviceSummary = serviceData.substring(0, 150) + (serviceData.length > 150 ? '...' : '');
                serviceInsightsDiv.querySelector('p').textContent = serviceSummary;
                serviceInsightsDiv.classList.remove('hidden');
            }
            
            // Hide the entire insights section if no research data
            const researchInsights = document.getElementById('research-insights');
            if (!clientData && !serviceData) {
                researchInsights.style.display = 'none';
            } else {
                researchInsights.style.display = 'block';
            }
        }

        /**
         * Parses AI response and populates structured SOW sections
         */
        function populateSOWSections(aiResponse, overview) {
            console.log('=== DEBUG: SOW GENERATION ===');
            console.log('Raw AI Response:', aiResponse);
            console.log('Overview:', overview);
            
            // Clean up any markdown formatting
            const cleanText = (text) => text.replace(/[*#`]/g, '').trim();
            
            // Populate project overview
            document.getElementById('project-overview').value = cleanText(overview);
            
            // Extract and populate objectives
            console.log('Extracting objectives...');
            const objectives = extractListItems(aiResponse, ['objective', 'goal', 'aim']);
            console.log('Found objectives:', objectives);
            populateContainer('objectives-container', objectives, 'objective');
            
            // Extract and populate deliverables
            console.log('Extracting deliverables...');
            const deliverables = extractListItems(aiResponse, ['deliverable', 'output', 'result']);
            console.log('Found deliverables:', deliverables);
            populateContainer('deliverables-container', deliverables, 'deliverable');
            
            // Extract and populate scope items
            console.log('Extracting scope items...');
            const scopeItems = extractListItems(aiResponse, ['scope', 'include', 'cover', 'phase']);
            console.log('Found scope items:', scopeItems);
            populateContainer('scope-container', scopeItems, 'scope');
            
            // Extract timeline information
            const timelineText = extractTimeline(aiResponse);
            document.getElementById('project-timeline').value = cleanText(timelineText);
            
            console.log('=== END DEBUG ===');
        }

        /**
         * Extracts list items from AI response based on keywords
         */
        function extractListItems(text, keywords) {
            const items = [];
            const lines = text.split('\n');
            
            // More comprehensive search patterns
            const patterns = [
                /^[-‚Ä¢*]\s*(.+)$/,  // Bullet points
                /^\d+\.\s*(.+)$/,  // Numbered lists
                /^[a-zA-Z]\)\s*(.+)$/,  // Letter lists (a), b), etc.
                /^\s*[-‚Ä¢*]\s*(.+)$/,  // Indented bullet points
                /^[IVX]+\.\s*(.+)$/,  // Roman numerals
            ];
            
            // First, try to find sections that contain our keywords
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].toLowerCase();
                
                // Check if line contains any of the keywords
                if (keywords.some(keyword => line.includes(keyword))) {
                    // Look for items in the next 15 lines (increased from 10)
                    for (let j = i + 1; j < Math.min(i + 15, lines.length); j++) {
                        const nextLine = lines[j].trim();
                        
                        // Try each pattern
                        for (const pattern of patterns) {
                            const match = nextLine.match(pattern);
                            if (match && match[1]) {
                                const cleanItem = match[1]
                                    .replace(/[*#`]/g, '')  // Remove markdown
                                    .replace(/\s+/g, ' ')   // Normalize spaces
                                    .trim();
                                
                                if (cleanItem.length > 10 && cleanItem.length < 200) { // Sanity check
                                    items.push(cleanItem);
                                }
                            }
                        }
                        
                        // Stop if we hit another section or empty lines
                        if (nextLine === '' || nextLine.match(/^[A-Z\s]+:$/)) {
                            break;
                        }
                    }
                    
                    if (items.length >= 3) break; // Stop after finding enough items
                }
            }
            
            // If no specific sections found, try a broader search
            if (items.length === 0) {
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Try each pattern on every line
                    for (const pattern of patterns) {
                        const match = line.match(pattern);
                        if (match && match[1]) {
                            const cleanItem = match[1]
                                .replace(/[*#`]/g, '')
                                .replace(/\s+/g, ' ')
                                .trim();
                            
                            // Filter for relevant content based on keywords
                            const isRelevant = keywords.some(keyword => {
                                return cleanItem.toLowerCase().includes(keyword.substring(0, 4)) ||
                                       cleanItem.toLowerCase().includes('implement') ||
                                       cleanItem.toLowerCase().includes('deliver') ||
                                       cleanItem.toLowerCase().includes('develop') ||
                                       cleanItem.toLowerCase().includes('provide') ||
                                       cleanItem.toLowerCase().includes('ensure') ||
                                       cleanItem.toLowerCase().includes('complete') ||
                                       cleanItem.toLowerCase().includes('establish') ||
                                       cleanItem.toLowerCase().includes('create') ||
                                       cleanItem.toLowerCase().includes('analyze');
                            });
                            
                            if (cleanItem.length > 15 && cleanItem.length < 200 && isRelevant) {
                                items.push(cleanItem);
                            }
                        }
                    }
                }
            }
            
            // Remove duplicates and return unique items
            const uniqueItems = [...new Set(items)];
            return uniqueItems.slice(0, 5); // Limit to 5 items
        }        /**
         * Extracts timeline information from AI response
         */
        function extractTimeline(text) {
            const timelineKeywords = ['timeline', 'duration', 'week', 'month', 'phase', 'schedule'];
            const lines = text.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].toLowerCase();
                if (timelineKeywords.some(keyword => line.includes(keyword))) {
                    // Look for the next few lines that might contain timeline info
                    const timelineLines = lines.slice(i, Math.min(i + 5, lines.length))
                        .filter(l => l.trim().length > 10)
                        .map(l => l.replace(/[*#`]/g, '').trim());
                    
                    if (timelineLines.length > 0) {
                        return timelineLines.join('\n');
                    }
                }
            }
            
            return ''; // No fallback - return empty if no timeline found
        }

        /**
         * Populates a container with editable list items
         */
        function populateContainer(containerId, items, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                div.innerHTML = `
                    <input type="text" value="${item}" class="flex-1 p-2 border rounded-md text-sm">
                    <button onclick="removeItem(this)" class="text-red-500 hover:text-red-700 text-sm">Remove</button>
                `;
                container.appendChild(div);
            });
            
            // Add at least one empty field if no items
            if (items.length === 0) {
                addItemToContainer(containerId, type);
            }
        }

        // Helper functions for dynamic content management
        function addObjective() { addItemToContainer('objectives-container', 'objective'); }
        function addDeliverable() { addItemToContainer('deliverables-container', 'deliverable'); }
        function addScopeItem() { addItemToContainer('scope-container', 'scope item'); }

        function addItemToContainer(containerId, type) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';
            div.innerHTML = `
                <input type="text" class="flex-1 p-2 border rounded-md text-sm">
                <button onclick="removeItem(this)" class="text-red-500 hover:text-red-700 text-sm">Remove</button>
            `;
            container.appendChild(div);
        }

        function removeItem(button) {
            button.parentElement.remove();        }
        
        /**
         * Generates a comprehensive project overview based on all research data
         */        function generateProjectOverview(clientName, serviceType, clientResearch, serviceResearch, brief, sowResponse) {
            // Use only the AI-generated SOW response - no fallbacks
            if (sowResponse && sowResponse.length > 100) {
                // Extract the overview part from the SOW response
                const overviewMatch = sowResponse.match(/project overview[:\s]*([^]*?)(?=hour|role|deliverable|\d+\s*hours?)/i);
                if (overviewMatch && overviewMatch[1]) {
                    return overviewMatch[1].trim();
                }
                // If no specific overview section found, return the full response
                return sowResponse;
            }
            
            // No fallback - return empty if no AI response
            return '';
        }

        // =============================================================================
        // INTERACTIVE PRICING TABLE FUNCTIONS
        // =============================================================================

        /**
         * Renders the pricing table with editable hours inputs
         * @param {Array} roles - Array of role objects with name, hours, and rate
         */
        function renderTable(roles) {
            if (!pricingTableBody) return;
            
            // Clear existing table content
            pricingTableBody.innerHTML = '';
            
            // Create rows for each role
            roles.forEach((role, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${role.name}</td>
                    <td class="px-6 py-4">
                        <input type="number" 
                               id="role-${index}-hours" 
                               value="${role.hours}" 
                               oninput="updateTotals()" 
                               class="w-full text-sm">
                    </td>
                    <td class="px-6 py-4">
                        <input type="number" 
                               id="role-${index}-rate" 
                               value="${role.rate}" 
                               oninput="updateTotals()" 
                               class="w-full text-sm text-right" 
                               step="0.01"
                               min="0">
                    </td>
                    <td class="px-6 py-4 text-right text-sm font-medium text-gray-900" id="role-${index}-total">$0.00</td>
                `;
                pricingTableBody.appendChild(row);
            });
        }

        /**
         * Core function to update all pricing calculations
         * Called after table render and on any input change
         */
        function updateTotals() {
            if (!pricingTableBody) return;
            
            const rows = pricingTableBody.getElementsByTagName('tr');
            let subTotal = 0;

            // Calculate line totals and sub-total
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                const hoursInput = cells[1].getElementsByTagName('input')[0];
                const rateInput = cells[2].getElementsByTagName('input')[0];
                const hours = parseFloat(hoursInput.value) || 0;
                const rate = parseFloat(rateInput.value) ||  0;
                const totalCell = cells[3];
                
                const lineTotal = hours * rate;
                totalCell.textContent = '$' + lineTotal.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
                subTotal += lineTotal;
            }

            // Calculate discount and grand total
            const discountPercent = parseFloat(document.getElementById('discount')?.value) || 0;
            const discountAmount = subTotal * (discountPercent / 100);
            const grandTotal = subTotal - discountAmount;

            // Update summary totals in DOM
            const subTotalElement = document.getElementById('sub-total');
            const discountAmountElement = document.getElementById('discount-amount');
            const grandTotalElement = document.getElementById('grand-total');

            if (subTotalElement) {
                subTotalElement.textContent = '$' + subTotal.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
            }
              if (discountAmountElement) {
                discountAmountElement.textContent = '-$' + discountAmount.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
            }            if (grandTotalElement) {
                grandTotalElement.textContent = '$' + grandTotal.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2
                });
            }
              // Update chat widget context if it exists
            updateChatWidgetContext();
        }
        
        /**
         * Updates the chat widget context when SOW data changes
         */
        function updateChatWidgetContext() {
            // Only update if chat widget is loaded and SOW content is visible
            if (window.sowContextData && sowContent && !sowContent.classList.contains('hidden')) {
                setTimeout(() => {
                    injectSOWContext();
                }, 500); // Small delay to ensure DOM updates are complete
            }
        }
        
        // =============================================================================
        // PDF EXPORT FUNCTIONALITY
        // =============================================================================

        /**
         * Exports SOW as PDF using the dedicated PDF template
         */
        async function exportToPDF() {
            try {
                exportBtn.disabled = true;
                exportBtn.textContent = 'Generating PDF...';

                // Populate the PDF template with current data
                populatePDFTemplate();

                // Show the PDF template temporarily
                const pdfTemplate = document.getElementById('pdf-template');
                pdfTemplate.style.display = 'block';
                pdfTemplate.style.position = 'fixed';
                pdfTemplate.style.top = '0';
                pdfTemplate.style.left = '0';                pdfTemplate.style.zIndex = '9999';

                // Wait a moment for images to load
                await new Promise(resolve => setTimeout(resolve, 2000));

                console.log('About to capture PDF template...');                // Capture the PDF template
                const canvas = await html2canvas(pdfTemplate, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    foreignObjectRendering: false,
                    ignoreElements: (element) => {
                        // Skip elements that might cause issues
                        return element.classList && element.classList.contains('no-pdf');
                    }
                });

                console.log('Canvas captured successfully:', canvas.width, 'x', canvas.height);

                // Hide the template again
                pdfTemplate.style.display = 'none';                // Create PDF with proper dimensions
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Calculate proper scaling to maintain aspect ratio
                const a4Width = 210; // mm
                const a4Height = 297; // mm
                const canvasAspect = canvas.width / canvas.height;
                const a4Aspect = a4Width / a4Height;
                
                let pdfWidth, pdfHeight, offsetX = 0, offsetY = 0;
                
                // Balanced approach - full width with minimal margins to avoid stretching
                if (canvasAspect > a4Aspect) {
                    // Canvas is wider - fit to width with small margins
                    pdfWidth = a4Width - 4; // Very small 2mm margin on each side
                    pdfHeight = pdfWidth / canvasAspect;
                    offsetX = 2; // Small margin
                    offsetY = Math.max(0, (a4Height - pdfHeight) / 2);
                } else {
                    // Canvas is taller - scale to fit height with small margins
                    pdfHeight = a4Height - 8; // Small margins top/bottom
                    pdfWidth = pdfHeight * canvasAspect;
                    offsetX = Math.max(2, (a4Width - pdfWidth) / 2); // Minimum 2mm margin
                    offsetY = 4; // Small top margin
                }
                
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', offsetX, offsetY, pdfWidth, pdfHeight);

                // Generate filename
                const clientName = clientNameInput.value.trim() || 'Client';
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `SOW-${clientName.replace(/\s+/g, '-')}-${timestamp}.pdf`;

                // Save PDF
                pdf.save(filename);

                addToResearchLog('PDF Export Complete', `Professional SOW exported as ${filename}`, 'green');
                console.log(`PDF exported as: ${filename}`);
            } catch (error) {
                console.error('PDF export failed:', error);
                addToResearchLog('PDF Export Failed', 'An error occurred during PDF export. Please try again.', 'red');            } finally {
                exportBtn.disabled = false;
                exportBtn.textContent = 'Export as Branded PDF';
            }
        }
        
        /**
         * Populates the hidden PDF template with current SOW data
         */        function populatePDFTemplate() {
            const clientName = clientNameInput.value.trim() || 'Client';
            const serviceType = serviceResearchInput.value.trim();

            // Update title and subtitle
            document.getElementById('pdf-title').textContent = `Statement of Work: ${clientName}`;
            document.getElementById('pdf-subtitle').textContent = `Project: ${serviceType}`;

            // Update overview
            const overview = document.getElementById('project-overview').value;
            document.getElementById('pdf-overview').textContent = overview;

            // Update objectives - CLIENT READY (no UI controls)
            const objectives = getListItems('objectives-container');
            const objectivesList = document.getElementById('pdf-objectives');
            objectivesList.innerHTML = '';
            objectives.forEach(obj => {
                if (obj.trim()) {
                    const li = document.createElement('li');
                    li.textContent = obj;
                    li.style.marginBottom = '2mm';
                    objectivesList.appendChild(li);
                }
            });

            // Update deliverables - CLIENT READY (no UI controls)
            const deliverables = getListItems('deliverables-container');
            const deliverablesList = document.getElementById('pdf-deliverables');
            deliverablesList.innerHTML = '';
            deliverables.forEach(del => {
                if (del.trim()) {
                    const li = document.createElement('li');
                    li.textContent = del;
                    li.style.marginBottom = '2mm';
                    deliverablesList.appendChild(li);
                }
            });

            // Update scope - CLIENT READY (no UI controls)
            const scopeItems = getListItems('scope-container');
            const scopeList = document.getElementById('pdf-scope');
            scopeList.innerHTML = '';
            scopeItems.forEach(scope => {
                if (scope.trim()) {
                    const li = document.createElement('li');
                    li.textContent = scope;
                    li.style.marginBottom = '2mm';
                    scopeList.appendChild(li);
                }
            });            // Update timeline
            const timeline = document.getElementById('project-timeline').value;
            document.getElementById('pdf-timeline').textContent = timeline;

            // Update pricing table - CLIENT READY (no UI controls)
            const pricingRows = document.getElementById('pdf-pricing-rows');
            pricingRows.innerHTML = '';
            
            const rows = pricingTableBody.getElementsByTagName('tr');
            let subTotal = 0;

            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                const roleName = cells[0].textContent;
                const hours = parseFloat(cells[1].getElementsByTagName('input')[0].value) || 0;
                const rate = parseFloat(cells[2].getElementsByTagName('input')[0].value) || 0;
                const total = hours * rate;
                subTotal += total;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="border: 1px solid #e5e7eb; padding: 3mm; color: #374151;">${roleName}</td>
                    <td style="border: 1px solid #e5e7eb; padding: 3mm; text-align: right; color: #374151;">${hours}</td>
                    <td style="border: 1px solid #e5e7eb; padding: 3mm; text-align: right; color: #374151;">$${rate.toFixed(2)}</td>
                    <td style="border: 1px solid #e5e7eb; padding: 3mm; text-align: right; color: #374151; font-weight: 600;">$${total.toFixed(2)}</td>
                `;
                pricingRows.appendChild(tr);
            }

            // Update totals
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const discountAmount = subTotal * (discount / 100);
            const grandTotal = subTotal - discountAmount;

            document.getElementById('pdf-subtotal').textContent = `$${subTotal.toFixed(2)}`;
            document.getElementById('pdf-grandtotal').textContent = `$${grandTotal.toFixed(2)}`;

            if (discount > 0) {
                document.getElementById('pdf-discount-row').style.display = 'block';
                document.getElementById('pdf-discount-amount').textContent = `-$${discountAmount.toFixed(2)}`;
            } else {
                document.getElementById('pdf-discount-row').style.display = 'none';
            }            // Update date
            document.getElementById('pdf-date').textContent = `Generated: ${new Date().toLocaleDateString()}`;
        }
          /**
         * Advanced PDF Export - Creates a stunning, professional PDF 
         * Angelina Jolie level beauty! üåü‚ú®
         */
        async function exportAdvancedPDF() {
            try {
                const advancedBtn = document.getElementById('export-advanced-btn');
                advancedBtn.disabled = true;
                advancedBtn.textContent = 'Creating Stunning PDF...';

                // Import jsPDF with high quality settings
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: false,
                    precision: 2
                });

                // Get SOW data
                const clientName = clientNameInput.value.trim() || 'Valued Client';
                const serviceType = serviceResearchInput.value.trim() || 'Professional Services';
                const overview = document.getElementById('project-overview').value.trim();
                
                // Brand colors (exact Social Garden colors)
                const colors = {
                    primary: [34, 197, 94],      // #22c55e - Social Garden Green
                    dark: [15, 23, 42],          // #0f172a - Slate 900
                    gray: [71, 85, 105],         // #475569 - Slate 600
                    light: [248, 250, 252],      // #f8fafc - Slate 50
                    white: [255, 255, 255]
                };

                // Page setup with perfect dimensions
                const page = {
                    width: 210,
                    height: 297,
                    margin: 25,
                    contentWidth: 160
                };
                let yPos = 30;
                const spacing = {
                    line: 6,
                    section: 12,
                    title: 8
                };                // Helper to load and convert image to base64 (LOGO PROTECTION PROTOCOL ACTIVATED! üõ°Ô∏è)
                async function loadImageAsBase64(imagePath) {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        img.onload = function() {
                            try {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                
                                // Get original dimensions
                                const originalWidth = this.naturalWidth || this.width;
                                const originalHeight = this.naturalHeight || this.height;
                                
                                console.log(`Original image dimensions: ${originalWidth}x${originalHeight}`);
                                
                                // NO STRETCHING ALLOWED! Calculate proper aspect ratio
                                const aspectRatio = originalWidth / originalHeight;
                                
                                // Set reasonable canvas size while preserving aspect ratio
                                let canvasWidth, canvasHeight;
                                const maxDimension = 800; // High quality but not massive
                                
                                if (originalWidth > originalHeight) {
                                    canvasWidth = Math.min(originalWidth, maxDimension);
                                    canvasHeight = canvasWidth / aspectRatio;
                                } else {
                                    canvasHeight = Math.min(originalHeight, maxDimension);
                                    canvasWidth = canvasHeight * aspectRatio;
                                }
                                
                                // Set canvas dimensions - CRITICAL: Don't stretch!
                                canvas.width = canvasWidth;
                                canvas.height = canvasHeight;
                                
                                console.log(`Canvas dimensions: ${canvasWidth}x${canvasHeight}, aspect ratio: ${aspectRatio}`);
                                
                                // Clear and draw with EXACT aspect ratio preservation
                                ctx.clearRect(0, 0, canvasWidth, canvasHeight);
                                ctx.drawImage(this, 0, 0, canvasWidth, canvasHeight);
                                
                                resolve({
                                    dataUrl: canvas.toDataURL('image/png', 0.95),
                                    width: canvasWidth,
                                    height: canvasHeight,
                                    aspectRatio: aspectRatio,
                                    originalWidth: originalWidth,
                                    originalHeight: originalHeight
                                });
                            } catch (e) {
                                console.warn('Error processing image:', e);
                                resolve(null);
                            }
                        };
                        img.onerror = () => {
                            console.warn('Failed to load image:', imagePath);
                            resolve(null);
                        };
                        
                        // Try different path formats for local files
                        if (imagePath.includes('Logo Dark-Green.png')) {
                            // Try multiple possible paths
                            const possiblePaths = [
                                'Logo Dark-Green.png',
                                './Logo Dark-Green.png',
                                'file:///c:/Users/ahmad/ttestt/Logo Dark-Green.png',
                                'C:/Users/ahmad/ttestt/Logo Dark-Green.png'
                            ];
                            
                            let pathIndex = 0;
                            const tryNextPath = () => {
                                if (pathIndex < possiblePaths.length) {
                                    img.src = possiblePaths[pathIndex];
                                    pathIndex++;
                                } else {
                                    resolve(null);
                                }
                            };
                            
                            img.onerror = tryNextPath;
                            tryNextPath();
                        } else {
                            img.src = imagePath;
                        }
                    });
                }

                // Load logo and pattern with better error handling
                const logoData = await loadImageAsBase64('Logo Dark-Green.png');
                const patternData = await loadImageAsBase64('Copy of Pattern 8.jpg');                // Perfect header function with ANTI-STRETCH LOGO PROTECTION! üõ°Ô∏è
                function addHeader() {
                    // Clean header background
                    pdf.setFillColor(...colors.white);
                    pdf.rect(0, 0, page.width, 35, 'F');
                    
                    // Add logo if available and protected from superhero damage
                    if (logoData && logoData.dataUrl && logoData.aspectRatio) {
                        try {
                            // CRITICAL: Use the preserved aspect ratio from image processing
                            const maxLogoWidth = 35;  // Slightly bigger for better visibility
                            const maxLogoHeight = 16; // But not too tall
                            
                            let logoWidth, logoHeight;
                            
                            // Calculate dimensions using PRESERVED aspect ratio
                            const logoAspectRatio = logoData.aspectRatio;
                            console.log(`Logo aspect ratio: ${logoAspectRatio}`);
                            
                            // Fit within bounds while maintaining exact aspect ratio
                            if (logoAspectRatio > (maxLogoWidth / maxLogoHeight)) {
                                // Logo is wider - constrain by width
                                logoWidth = maxLogoWidth;
                                logoHeight = logoWidth / logoAspectRatio;
                            } else {
                                // Logo is taller - constrain by height
                                logoHeight = maxLogoHeight;
                                logoWidth = logoHeight * logoAspectRatio;
                            }
                            
                            console.log(`Final logo dimensions: ${logoWidth}x${logoHeight}`);
                            
                            // Center the logo vertically in header
                            const logoY = 10 + (15 - logoHeight) / 2;
                            
                            // RENDER WITH EXACT DIMENSIONS - NO STRETCHING!
                            pdf.addImage(logoData.dataUrl, 'PNG', page.margin, logoY, logoWidth, logoHeight);                            // Company name positioning (removed text)
                            const textX = page.margin + logoWidth + 10;
                            
                        } catch (e) {
                            console.warn('Logo rendering failed, using fallback:', e);
                            // Fallback to text-only header
                            addTextOnlyHeader();
                        }
                    } else {
                        console.warn('Logo data missing or corrupted, using text-only header');
                        // Beautiful text-only header if logo fails
                        addTextOnlyHeader();
                    }
                    
                    // Date - perfectly aligned
                    const today = new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(9);
                    pdf.setTextColor(...colors.gray);
                    const dateWidth = pdf.getTextWidth(`Generated: ${today}`);
                    pdf.text(`Generated: ${today}`, page.width - page.margin - dateWidth, 18);
                    
                    // Perfect header line
                    pdf.setDrawColor(...colors.primary);
                    pdf.setLineWidth(1.5);
                    pdf.line(page.margin, 32, page.width - page.margin, 32);
                }
                  // Fallback header for when logo gets destroyed by superheroes
                function addTextOnlyHeader() {
                    // Beautiful brand square instead of broken logo (no text)
                    pdf.setFillColor(...colors.primary);                    pdf.rect(page.margin, 12, 12, 12, 'F');
                }

                // Smart page break function
                function checkPageBreak(neededSpace) {
                    if (yPos + neededSpace > page.height - 40) {
                        pdf.addPage();
                        addHeader();
                        yPos = 45;
                        return true;
                    }
                    return false;
                }

                // Add header to first page
                addHeader();
                yPos = 50;

                // ===== STUNNING TITLE SECTION =====
                checkPageBreak(35);
                
                // Main title with perfect typography
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(32);
                pdf.setTextColor(...colors.dark);
                pdf.text('Statement of Work', page.margin, yPos);
                yPos += 15;

                // Client name - elegant styling
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(18);
                pdf.setTextColor(...colors.primary);
                pdf.text(`Prepared for ${clientName}`, page.margin, yPos);
                yPos += 10;

                // Service type
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(14);
                pdf.setTextColor(...colors.gray);
                pdf.text(`Service: ${serviceType}`, page.margin, yPos);
                yPos += spacing.section + 5;

                // ===== ONLY SHOW SECTIONS WITH CONTENT =====
                
                // Project Overview (only if content exists)
                if (overview && overview.length > 0) {
                    checkPageBreak(25);
                    
                    // Section header with perfect styling
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(16);
                    pdf.setTextColor(...colors.dark);
                    pdf.text('Project Overview', page.margin, yPos);
                    yPos += spacing.title;

                    // Beautiful underline
                    pdf.setDrawColor(...colors.primary);
                    pdf.setLineWidth(2);
                    pdf.line(page.margin, yPos, page.margin + 55, yPos);
                    yPos += spacing.title;

                    // Content with perfect line spacing
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(11);
                    pdf.setTextColor(...colors.dark);
                    const overviewLines = pdf.splitTextToSize(overview, page.contentWidth);
                    overviewLines.forEach(line => {
                        checkPageBreak(spacing.line);
                        pdf.text(line, page.margin, yPos);
                        yPos += spacing.line;
                    });
                    yPos += spacing.section;
                }

                // Helper function for list sections (only show if items exist)
                function addListSection(title, containerId) {
                    const items = getListItems(containerId);
                    if (items.length === 0) return; // Skip empty sections
                    
                    checkPageBreak(25);
                    
                    // Section title
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(16);
                    pdf.setTextColor(...colors.dark);
                    pdf.text(title, page.margin, yPos);
                    yPos += spacing.title;

                    // Beautiful underline
                    pdf.setDrawColor(...colors.primary);
                    pdf.setLineWidth(2);
                    pdf.line(page.margin, yPos, page.margin + 55, yPos);
                    yPos += spacing.title;

                    // List items with perfect bullets
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(11);
                    pdf.setTextColor(...colors.dark);
                    
                    items.forEach(item => {
                        checkPageBreak(spacing.line + 2);
                        
                        // Perfect bullet
                        pdf.setTextColor(...colors.primary);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text('‚ñ∂', page.margin + 2, yPos);
                        
                        // Item text with proper wrapping
                        pdf.setTextColor(...colors.dark);
                        pdf.setFont('helvetica', 'normal');
                        const itemLines = pdf.splitTextToSize(item, page.contentWidth - 15);
                        itemLines.forEach((line, index) => {
                            if (index > 0) {
                                checkPageBreak(spacing.line);
                                yPos += spacing.line;
                            }
                            pdf.text(line, page.margin + 10, yPos);
                        });
                        yPos += spacing.line + 1;
                    });
                    yPos += spacing.section;
                }

                // Add sections (only non-empty ones)
                addListSection('Project Objectives', 'objectives-list');
                addListSection('Key Deliverables', 'deliverables-list');
                addListSection('Project Scope', 'scope-list');

                // ===== PERFECT INVESTMENT SUMMARY =====
                checkPageBreak(80);
                
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(16);
                pdf.setTextColor(...colors.dark);
                pdf.text('Investment Summary', page.margin, yPos);
                yPos += spacing.title;

                pdf.setDrawColor(...colors.primary);
                pdf.setLineWidth(2);
                pdf.line(page.margin, yPos, page.margin + 55, yPos);
                yPos += spacing.section;

                // Perfect table with no overlaps
                const table = {
                    x: page.margin,
                    width: page.contentWidth,
                    rowHeight: 10,
                    cols: [
                        { title: 'Role', width: 80, align: 'left' },
                        { title: 'Hours', width: 25, align: 'center' },
                        { title: 'Rate', width: 25, align: 'center' },
                        { title: 'Total', width: 30, align: 'right' }
                    ]
                };

                // Table header with perfect styling
                pdf.setFillColor(...colors.primary);
                pdf.rect(table.x, yPos, table.width, table.rowHeight + 2, 'F');
                
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(11);
                pdf.setTextColor(...colors.white);
                
                let colX = table.x;
                table.cols.forEach(col => {
                    const textX = col.align === 'center' ? colX + col.width / 2 : 
                                  col.align === 'right' ? colX + col.width - 2 : colX + 2;
                    pdf.text(col.title, textX, yPos + 7, { align: col.align });
                    colX += col.width;
                });
                yPos += table.rowHeight + 2;

                // Table rows with perfect spacing
                const rows = pricingTableBody.getElementsByTagName('tr');
                let subTotal = 0;
                let validRows = 0;
                
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(10);
                pdf.setTextColor(...colors.dark);

                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const cells = row.getElementsByTagName('td');
                    if (cells.length >= 4) {
                        const roleName = cells[0].textContent.trim();
                        const hoursInput = cells[1].querySelector('input');
                        const rateInput = cells[2].querySelector('input');
                        
                        if (hoursInput && rateInput) {
                            const hours = parseFloat(hoursInput.value) || 0;
                            const rate = parseFloat(rateInput.value) || 0;
                            const total = hours * rate;

                            if (hours > 0) { // Only show rows with actual hours
                                checkPageBreak(table.rowHeight);
                                
                                subTotal += total;
                                
                                // Alternating row backgrounds
                                if (validRows % 2 === 0) {
                                    pdf.setFillColor(...colors.light);
                                    pdf.rect(table.x, yPos, table.width, table.rowHeight, 'F');
                                }

                                // Row border
                                pdf.setDrawColor(220, 220, 220);
                                pdf.setLineWidth(0.5);
                                pdf.rect(table.x, yPos, table.width, table.rowHeight, 'S');

                                // Perfect cell content with no overlaps
                                colX = table.x;
                                const rowData = [roleName, hours.toString(), `$${rate.toFixed(0)}`, `$${total.toFixed(2)}`];
                                
                                table.cols.forEach((col, index) => {
                                    const textX = col.align === 'center' ? colX + col.width / 2 : 
                                                  col.align === 'right' ? colX + col.width - 2 : colX + 2;
                                    
                                    if (index === 3) { // Total column - make bold
                                        pdf.setFont('helvetica', 'bold');
                                    }
                                    
                                    pdf.text(rowData[index], textX, yPos + 6, { align: col.align });
                                    
                                    if (index === 3) {
                                        pdf.setFont('helvetica', 'normal');
                                    }
                                    
                                    colX += col.width;
                                });
                                
                                yPos += table.rowHeight;
                                validRows++;
                            }
                        }
                    }
                }

                // Perfect totals section
                yPos += 8;
                const discount = parseFloat(document.getElementById('discount').value) || 0;
                const discountAmount = subTotal * (discount / 100);
                const grandTotal = subTotal - discountAmount;

                // Totals box with perfect styling
                const totalsBox = {
                    x: table.x + 100,
                    width: 60,
                    height: discount > 0 ? 28 : 20
                };

                pdf.setFillColor(240, 249, 255);
                pdf.rect(totalsBox.x, yPos, totalsBox.width, totalsBox.height, 'F');
                pdf.setDrawColor(...colors.primary);
                pdf.setLineWidth(1);
                pdf.rect(totalsBox.x, yPos, totalsBox.width, totalsBox.height, 'S');

                // Totals content with perfect alignment
                let totalsY = yPos + 8;
                
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(10);
                pdf.setTextColor(...colors.dark);
                pdf.text('Subtotal:', totalsBox.x + 3, totalsY);
                pdf.setFont('helvetica', 'bold');
                pdf.text(`$${subTotal.toFixed(2)}`, totalsBox.x + totalsBox.width - 3, totalsY, { align: 'right' });

                if (discount > 0) {
                    totalsY += 7;
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(220, 38, 38);
                    pdf.text(`Discount (${discount}%):`, totalsBox.x + 3, totalsY);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(`-$${discountAmount.toFixed(2)}`, totalsBox.x + totalsBox.width - 3, totalsY, { align: 'right' });
                }

                // Grand total with perfect emphasis
                totalsY += 7;
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(12);
                pdf.setTextColor(...colors.primary);                pdf.text('Total:', totalsBox.x + 3, totalsY);
                pdf.text(`$${grandTotal.toFixed(2)}`, totalsBox.x + totalsBox.width - 3, totalsY, { align: 'right' });

                // Perfect filename
                const fileName = `SOW-${clientName.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

            } catch (error) {
                console.error('Advanced PDF export error:', error);
                alert('Error creating PDF. Please try again.');
            } finally {
                const advancedBtn = document.getElementById('export-advanced-btn');
                if (advancedBtn) {
                    advancedBtn.disabled = false;
                    advancedBtn.textContent = 'Advanced PDF';
                }
            }
        }

        /**
         * Helper function to get list items from containers
         */
        function getListItems(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return [];
            const inputs = container.querySelectorAll('input[type="text"]');
            return Array.from(inputs)
                .map(input => input.value.trim())
                .filter(value => value.length > 0);        }

        /**
         * Creates a beautifully formatted HTML template with embedded styles for WeasyPrint
                const pdf = new jsPDF('p', 'mm', 'a4');                const clientName = clientNameInput.value.trim() || 'Client';
                const serviceType = serviceResearchInput.value.trim();
                
                let yPosition = 25;
                const lineHeight = 6;
                const pageWidth = 170;
                const margin = 20;
                const pageHeight = 297;
                let pageCount = 1;

                // Function to add header with logo to each page
                async function addPageHeader() {
                    // Teal background header
                    pdf.setFillColor(20, 184, 166); // Teal-500
                    pdf.rect(0, 0, 210, 25, 'F');
                    
                    // Add logo
                    try {
                        const logoImg = new Image();
                        logoImg.crossOrigin = 'anonymous';
                        logoImg.src = './SocialGarden.svg';
                        await new Promise((resolve) => {
                            logoImg.onload = () => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                canvas.width = 40;
                                canvas.height = 20;
                                ctx.drawImage(logoImg, 0, 0, 40, 20);
                                const logoData = canvas.toDataURL('image/png');
                                pdf.addImage(logoData, 'PNG', margin, 3, 20, 10);
                                resolve();
                            };
                            logoImg.onerror = () => resolve(); // Continue without logo if failed
                        });
                    } catch (e) {
                        console.warn('Logo failed to load');
                    }
                    
                    // Header text
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFontSize(14);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('SOCIAL GARDEN', margin + 25, 10);
                    pdf.setFontSize(9);
                    pdf.text('Professional Services - Statement of Work', margin + 25, 16);
                    
                    // Page number
                    pdf.setFontSize(8);
                    pdf.text(`Page ${pageCount}`, 180, 10);
                }                // Function to add footer with pattern to each page
                async function addPageFooter() {
                    try {
                        // Always add dark teal background first
                        pdf.setFillColor(14, 46, 51); // #0e2e33 - Dark teal
                        pdf.rect(0, 277, 210, 20, 'F');
                        
                        const patternImg = new Image();
                        patternImg.crossOrigin = 'anonymous';
                        patternImg.src = './Copy of Pattern 8.jpg';
                        await new Promise((resolve) => {
                            patternImg.onload = () => {
                                try {
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    canvas.width = 210;
                                    canvas.height = 20;
                                    // Create a tiled pattern for the footer
                                    const pattern = ctx.createPattern(patternImg, 'repeat');
                                    ctx.fillStyle = pattern;
                                    ctx.fillRect(0, 0, 210, 20);
                                    const patternData = canvas.toDataURL('image/png');
                                    pdf.addImage(patternData, 'PNG', 0, 277, 210, 20);
                                } catch (e) {
                                    console.warn('Pattern overlay failed, using solid dark teal');
                                }
                                resolve();
                            };
                            patternImg.onerror = () => {
                                console.warn('Pattern image failed to load, using solid dark teal');
                                resolve();
                            };
                        });
                    } catch (e) {
                        console.warn('Footer pattern failed, using solid dark teal');
                        // Dark teal background is already set above
                    }
                      // Footer text with better positioning
                    pdf.setTextColor(255, 255, 255); // White text on dark footer
                    pdf.setFontSize(8);
                    pdf.text(`Generated: ${new Date().toLocaleDateString()}`, margin, 290);
                    pdf.text('¬© Social Garden', margin, 293);
                }

                // Function to check if we need a new page with better spacing
                async function checkPageBreak(additionalHeight = 25) {
                    // More conservative page break at 265mm to avoid footer overlap
                    if (yPosition + additionalHeight > 265) {
                        await addPageFooter();
                        pdf.addPage();
                        pageCount++;
                        await addPageHeader();
                        yPosition = 40; // Start content lower to avoid header overlap
                        return true;
                    }
                    return false;
                }

                // Add header to first page
                await addPageHeader();
                pdf.setTextColor(0, 0, 0);
                yPosition = 35;

                // Document Title Section - Consistent Hierarchy
                pdf.setFontSize(28);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(16, 55, 58); // Social Garden dark green
                pdf.text('STATEMENT OF WORK', margin, yPosition);
                yPosition += 8;

                pdf.setFontSize(16);
                pdf.setTextColor(34, 197, 94); // Accent color
                pdf.text(data.serviceType || 'Professional Services', margin, yPosition);
                yPosition += 15;

                // Add Social Garden brand line under title
                pdf.setDrawColor(16, 55, 58); // Social Garden dark green
                pdf.setLineWidth(1.2);
                pdf.line(margin, yPosition - 8, margin + 80, yPosition - 8);

                // Client info box with consistent styling
                pdf.setFillColor(248, 250, 252); // Very light blue-gray
                pdf.rect(margin, yPosition, pageWidth, 30, 'F');
                pdf.setDrawColor(16, 55, 58); // Social Garden dark green border
                pdf.setLineWidth(0.5);
                pdf.rect(margin, yPosition, pageWidth, 30, 'S');

                yPosition += 10;
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(16, 55, 58); // Social Garden dark green
                pdf.text('CLIENT INFORMATION', margin + 8, yPosition);
                
                yPosition += 8;
                pdf.setFontSize(11);
                pdf.setTextColor(55, 65, 81);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Client: ${clientName}`, margin + 8, yPosition);
                yPosition += 6;
                pdf.text(`Service: ${serviceType}`, margin + 8, yPosition);
                yPosition += 6;
                pdf.text(`Date: ${new Date().toLocaleDateString()}`, margin + 8, yPosition);
                yPosition += 18;

                // Project Overview Section - Consistent Styling
                await checkPageBreak(40);
                pdf.setTextColor(16, 55, 58); // Social Garden dark green
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('PROJECT OVERVIEW', margin, yPosition);
                pdf.setDrawColor(16, 55, 58); // Social Garden dark green underline
                pdf.setLineWidth(0.5);
                pdf.line(margin, yPosition + 3, margin + 50, yPosition + 3);
                yPosition += 12;

                pdf.setTextColor(55, 65, 81);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                const overview = document.getElementById('project-overview').value;
                if (overview) {
                    const overviewLines = pdf.splitTextToSize(overview, pageWidth - 10);
                    
                    for (let i = 0; i < overviewLines.length; i++) {
                        await checkPageBreak(8);
                        pdf.text(overviewLines[i], margin, yPosition);
                        yPosition += lineHeight + 1;
                    }
                    yPosition += 18;
                }

                // Project Objectives Section - Consistent Styling
                await checkPageBreak(40);
                pdf.setTextColor(16, 55, 58); // Social Garden dark green
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('PROJECT OBJECTIVES', margin, yPosition);
                pdf.setDrawColor(16, 55, 58); // Social Garden dark green underline
                pdf.setLineWidth(0.5);
                pdf.line(margin, yPosition + 3, margin + 50, yPosition + 3);
                yPosition += 12;

                pdf.setTextColor(55, 65, 81);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                const objectives = getListItems('objectives-container');
                
                for (let i = 0; i < objectives.length; i++) {
                    if (objectives[i].trim()) {
                        await checkPageBreak(15);
                        pdf.text(`‚Ä¢ ${objectives[i]}`, margin + 5, yPosition);
                        yPosition += 10;
                    }
                }
                yPosition += 18;

                // Key Deliverables Section - Consistent Styling
                await checkPageBreak(40);
                pdf.setTextColor(16, 55, 58); // Social Garden dark green
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('KEY DELIVERABLES', margin, yPosition);
                pdf.setDrawColor(16, 55, 58); // Social Garden dark green underline
                pdf.setLineWidth(0.5);
                pdf.line(margin, yPosition + 3, margin + 50, yPosition + 3);
                yPosition += 12;

                pdf.setTextColor(55, 65, 81);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                const deliverables = getListItems('deliverables-container');
                
                for (let i = 0; i < deliverables.length; i++) {
                    if (deliverables[i].trim()) {
                        await checkPageBreak(15);
                        pdf.text(`‚Ä¢ ${deliverables[i]}`, margin + 5, yPosition);
                        yPosition += 10;
                    }
                }
                yPosition += 18;

                // Project Scope Section - Consistent Styling
                await checkPageBreak(40);
                pdf.setTextColor(16, 55, 58); // Social Garden dark green
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('PROJECT SCOPE', margin, yPosition);
                pdf.setDrawColor(16, 55, 58); // Social Garden dark green underline
                pdf.setLineWidth(0.5);
                pdf.line(margin, yPosition + 3, margin + 50, yPosition + 3);
                yPosition += 12;

                pdf.setTextColor(55, 65, 81);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                const scopeItems = getListItems('scope-container');
                
                for (let i = 0; i < scopeItems.length; i++) {
                    if (scopeItems[i].trim()) {
                        await checkPageBreak(15);
                        pdf.text(`‚Ä¢ ${scopeItems[i]}`, margin + 5, yPosition);
                        yPosition += 10;
                    }
                }
                yPosition += 18;

                // Project Timeline Section - Consistent Styling
                await checkPageBreak(40);
                pdf.setTextColor(16, 55, 58); // Social Garden dark green
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('PROJECT TIMELINE', margin, yPosition);
                pdf.setDrawColor(16, 55, 58); // Social Garden dark green underline
                pdf.setLineWidth(0.5);
                pdf.line(margin, yPosition + 3, margin + 50, yPosition + 3);
                yPosition += 12;

                pdf.setTextColor(55, 65, 81);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');                const timeline = document.getElementById('project-timeline').value;
                if (timeline) {
                    const timelineLines = pdf.splitTextToSize(timeline, pageWidth - 10);
                    
                    for (let i = 0; i < timelineLines.length; i++) {
                        await checkPageBreak(8);
                        pdf.text(timelineLines[i], margin, yPosition);
                        yPosition += lineHeight + 1;
                    }
                    yPosition += 18;
                }

                // Investment Breakdown Section - Professional Styling
                const tableRows = pricingTableBody.getElementsByTagName('tr');
                const estimatedTableHeight = 40 + (tableRows.length * 12) + 50; // Header + rows + totals
                await checkPageBreak(estimatedTableHeight);
                
                // Consistent section title styling
                pdf.setTextColor(16, 55, 58); // Social Garden dark green
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('INVESTMENT SUMMARY', margin, yPosition);
                pdf.setDrawColor(16, 55, 58); // Social Garden dark green underline
                pdf.setLineWidth(0.5);
                pdf.line(margin, yPosition + 3, margin + 50, yPosition + 3);
                yPosition += 15;

                // Professional table styling
                const tableWidth = 120;
                const colWidths = [60, 20, 20, 20]; // Role, Hours, Rate, Total
                const tableStartY = yPosition;
                
                // Table border
                pdf.setDrawColor(16, 55, 58);
                pdf.setLineWidth(0.8);
                pdf.rect(margin, yPosition - 2, tableWidth, 12, 'S');
                
                // Table headers with better alignment
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'bold');
                pdf.setFillColor(16, 55, 58); // Social Garden dark green header
                pdf.rect(margin, yPosition - 2, tableWidth, 12, 'F');
                
                pdf.text('Role', margin + 3, yPosition + 6);
                pdf.text('Hours', margin + 63, yPosition + 6, { align: 'center' });
                pdf.text('Rate', margin + 83, yPosition + 6, { align: 'center' });
                pdf.text('Total', margin + 103, yPosition + 6, { align: 'center' });
                yPosition += 15;

                // Table rows with proper alignment
                pdf.setTextColor(55, 65, 81);
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                const rows = pricingTableBody.getElementsByTagName('tr');
                let subTotal = 0;
                let rowIndex = 0;

                for (let row of rows) {
                    if (rowIndex === 0) {
                        await checkPageBreak(40);
                    }
                    
                    const cells = row.getElementsByTagName('td');
                    const roleName = cells[0].textContent;
                    const hours = parseFloat(cells[1].getElementsByTagName('input')[0].value) || 0;
                    const rate = parseFloat(cells[2].getElementsByTagName('input')[0].value) || 0;
                    const total = hours * rate;
                    subTotal += total;

                    // Alternating row background
                    if (rowIndex % 2 === 0) {
                        pdf.setFillColor(248, 250, 252);
                        pdf.rect(margin, yPosition - 3, tableWidth, 10, 'F');
                    }

                    // Row border
                    pdf.setDrawColor(200, 200, 200);
                    pdf.setLineWidth(0.2);
                    pdf.rect(margin, yPosition - 3, tableWidth, 10, 'S');

                    // Properly aligned content
                    pdf.text(roleName, margin + 3, yPosition + 3);
                    pdf.text(hours.toString(), margin + 73, yPosition + 3, { align: 'right' });
                    pdf.text(`$${rate.toFixed(0)}`, margin + 93, yPosition + 3, { align: 'right' });
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(`$${total.toFixed(2)}`, margin + 117, yPosition + 3, { align: 'right' });
                    pdf.setFont('helvetica', 'normal');
                    
                    yPosition += 10;
                    rowIndex++;
                }

                // Totals section with professional styling
                yPosition += 8;
                const totalsBoxY = yPosition;
                const discount = parseFloat(document.getElementById('discount').value) || 0;
                const discountAmount = subTotal * (discount / 100);
                const grandTotal = subTotal - discountAmount;

                // Totals box
                const totalsHeight = discount > 0 ? 30 : 22;
                pdf.setFillColor(248, 250, 252);
                pdf.rect(margin + 60, yPosition - 2, rightMargin - leftMargin - 90, totalsHeight, 'F');
                pdf.setDrawColor(16, 55, 58);
                pdf.setLineWidth(0.5);
                pdf.rect(margin + 60, yPosition - 2, rightMargin - leftMargin - 90, totalsHeight, 'S');
                
                // Subtotal
                pdf.setFontSize(10);
                pdf.setTextColor(55, 65, 81);
                pdf.setFont('helvetica', 'normal');
                pdf.text('Subtotal:', margin + 65, yPosition + 4);
                pdf.setFont('helvetica', 'bold');
                pdf.text(`$${subTotal.toFixed(2)}`, margin + 115, yPosition + 4, { align: 'right' });
                yPosition += 8;

                // Discount if applicable
                if (discount > 0) {
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(220, 50, 50); // Red for discount
                    pdf.text(`Discount (${discount}%):`, margin + 65, yPosition + 4);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(`-$${discountAmount.toFixed(2)}`, margin + 115, yPosition + 4, { align: 'right' });
                    yPosition += 8;
                }

                // Grand total with more emphasis
                pdf.setFontSize(12);
                pdf.setTextColor(79, 70, 229);
                pdf.setFont('helvetica', 'bold');                pdf.text('Grand Total:', margin + 65, yPosition + 2);                pdf.text(`$${grandTotal.toFixed(2)}`, margin + 115, yPosition + 2, { align: 'right' });

                return yPosition + 20;
            } catch (error) {
                console.error('Advanced PDF export error:', error);
                alert('Error creating PDF. Please try again.');
            } finally {
                const advancedBtn = document.getElementById('export-advanced-btn');
                if (advancedBtn) {
                    advancedBtn.disabled = false;
                    advancedBtn.textContent = 'Advanced PDF';
                }
            }
        }
        
        /**
         * Creates a beautifully formatted HTML template with embedded styles for WeasyPrint
         * NEW PASSPORT AND TICKET TO MEXICO APPROVED! üá≤üáΩ‚ú®
         */
        function createWeasyPrintTemplate(data) {
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statement of Work - ${data.clientName} | Social Garden</title>
    <style>
        /* ===========================================
           PROFESSIONAL PDF STYLING FOR WEASYPRINT
           Social Garden Brand Guidelines Applied
           =========================================== */
        
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* Page Setup */
        @page {
            size: A4;
            margin: 2.5cm 2cm 3cm 2cm;
            
            @top-center {
                content: element(header);
                margin-bottom: 1cm;
            }
            
            @bottom-center {
                content: element(footer);
                margin-top: 1cm;
            }
        }
        
        /* Base Typography */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #1f2937;
            background: #ffffff;
        }
        
        /* Header & Footer */
        .page-header {
            position: running(header);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 0 20px 0;
            border-bottom: 3px solid #22c55e;
            margin-bottom: 30px;
        }
        
        .page-footer {
            position: running(footer);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0 0 0;
            border-top: 1px solid #e5e7eb;
            font-size: 12px;
            color: #6b7280;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .company-info h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }
        
        .company-info .tagline {
            font-size: 14px;
            color: #22c55e;
            font-weight: 500;
            margin: 0;
        }
        
        .header-meta {
            text-align: right;
            font-size: 12px;
            color: #6b7280;
        }
        
        /* Document Structure */
        .main-content {
            max-width: 100%;
            margin: 0 auto;
        }
        
        /* Title Section */
        .document-title {
            text-align: center;
            margin: 40px 0 50px 0;
            page-break-after: avoid;
        }
        
        .document-title h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
            letter-spacing: -0.5px;
        }
        
        .document-title .subtitle {
            font-size: 18px;
            color: #22c55e;
            font-weight: 500;
            margin-bottom: 20px;
        }
        
        .document-title .client-info {
            font-size: 16px;
            color: #6b7280;
            padding: 15px 30px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #22c55e;
            display: inline-block;
        }
        
        /* Section Styling */
        .section {
            margin-bottom: 35px;
            page-break-inside: avoid;
        }
        
        .section h2 {
            font-size: 22px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
            position: relative;
        }
        
        .section h2::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: #22c55e;
        }
        
        .section h3 {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin: 25px 0 15px 0;
        }
        
        /* Content Styling */
        p {
            margin-bottom: 16px;
            line-height: 1.7;
            text-align: justify;
        }
        
        ul {
            margin: 15px 0;
            padding-left: 0;
            list-style: none;
        }
        
        li {
            margin-bottom: 12px;
            position: relative;
            padding-left: 25px;
            line-height: 1.6;
        }
        
        li::before {
            content: '‚ñ∏';
            position: absolute;
            left: 0;
            color: #22c55e;
            font-weight: 600;
            font-size: 16px;
        }
        
        /* Pricing Table */
        .pricing-section {
            background: #f9fafb;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            margin: 30px 0;
        }
        
        .pricing-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .pricing-table th {
            background: #22c55e;
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        
        .pricing-table th:last-child,
        .pricing-table td:last-child {
            text-align: right;
        }
        
        .pricing-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }
        
        .pricing-table tr:last-child td {
            border-bottom: none;
        }
        
        .pricing-table .total-row {
            background: #f0f9ff;
            font-weight: 600;
            border-top: 2px solid #22c55e;
        }
        
        /* Summary Box */
        .summary-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #22c55e;
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 16px;
        }
        
        .summary-row.total {
            font-weight: 700;
            font-size: 20px;
            color: #22c55e;
            border-top: 2px solid #22c55e;
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .discount-row {
            color: #dc2626;
            font-weight: 600;
        }
        
        /* Timeline Styling */
        .timeline-item {
            border-left: 3px solid #22c55e;
            padding-left: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 5px;
            width: 9px;
            height: 9px;
            border-radius: 50%;
            background: #22c55e;
        }
        
        /* Call-to-Action Box */
        .cta-box {
            background: #1f2937;
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            margin: 40px 0;
        }
        
        .cta-box h3 {
            color: #22c55e;
            margin-bottom: 15px;
        }
        
        /* Page Breaks */
        .page-break {
            page-break-before: always;
        }
        
        .avoid-break {
            page-break-inside: avoid;
        }
        
        /* Print Optimizations */
        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .pricing-table,
            .summary-box,
            .cta-box {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- Header for all pages -->
    <div class="page-header">
        <div class="logo-container">
            <svg width="50" height="40" viewBox="0 0 193.54 60.57" style="fill: #22c55e;">
                <path d="M37.74,20.91H15.33a2.1,2.1,0,0,1-2.1-2.1H.56V41.76H13.78a2.1,2.1,0,0,1,2.1-2.1H37.74a2.1,2.1,0,0,1,2.1,2.1H52.59V18.81H39.84A2.1,2.1,0,0,1,37.74,20.91Z"/>
            </svg>            <div class="company-info">
                <h1>Social Garden</h1>
            </div>
        </div>
        <div class="header-meta">
            <div><strong>Statement of Work</strong></div>
            <div>Generated: ${data.generatedDate || new Date().toLocaleDateString()}</div>
        </div>
    </div>
    
    <!-- Footer for all pages -->
    <div class="page-footer">        <div>
            <div><strong>Social Garden</strong></div>
            <div>www.socialgarden.co | contact@socialgarden.co</div>
        </div>
        <div style="text-align: right;">
            <div><strong>CONFIDENTIAL</strong></div>
            <div>Page <span class="page-number"></span></div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Document Title -->        <div class="document-title avoid-break">
            <h1>Statement of Work</h1>
            <div class="client-info">
                Prepared for <strong>${data.clientName}</strong><br>
                Service: <strong>${data.serviceType || 'Professional Services'}</strong>
            </div>
        </div>
        
        <!-- Project Overview -->
        <div class="section avoid-break">
            <h2>Project Overview</h2>
            <p>${data.overview || 'Project overview to be determined based on client requirements and consultation.'}</p>
        </div>
        
        <!-- Project Objectives -->
        <div class="section avoid-break">
            <h2>Project Objectives</h2>
            <ul>
                ${(data.objectives || []).map(obj => `<li>${obj}</li>`).join('')}
                ${(data.objectives || []).length === 0 ? '<li>Objectives to be defined during project kickoff meeting</li>' : ''}
            </ul>
        </div>
        
        <!-- Key Deliverables -->
        <div class="section avoid-break">
            <h2>Key Deliverables</h2>
            <ul>
                ${(data.deliverables || []).map(del => `<li>${del}</li>`).join('')}
                ${(data.deliverables || []).length === 0 ? '<li>Deliverables to be specified based on final project scope</li>' : ''}
            </ul>
        </div>
        
        <!-- Project Scope -->
        <div class="section avoid-break">
            <h2>Project Scope</h2>
            <ul>
                ${(data.scopeItems || []).map(scope => `<li>${scope}</li>`).join('')}
                ${(data.scopeItems || []).length === 0 ? '<li>Scope items to be detailed in project planning phase</li>' : ''}
            </ul>
        </div>
        
        <!-- Project Timeline -->
        <div class="section avoid-break">
            <h2>Project Timeline</h2>
            <p>${data.timeline || 'Project timeline will be established based on final scope and resource availability. Typical projects range from 2-12 weeks depending on complexity and requirements.'}</p>
        </div>
        
        <!-- Investment Summary -->
        <div class="section page-break">
            <h2>Investment Summary</h2>
            <div class="pricing-section">
                <table class="pricing-table">
                    <thead>
                        <tr>
                            <th>Role/Service</th>
                            <th>Hours</th>
                            <th>Rate</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(data.pricingRows || []).map(row => `
                            <tr>
                                <td>${row.roleName || 'Professional Services'}</td>
                                <td>${row.hours || 0}</td>
                                <td>$${(row.rate || 0).toFixed(2)}</td>
                                <td><strong>$${(row.total || 0).toFixed(2)}</strong></td>
                            </tr>
                        `).join('')}
                        ${(data.pricingRows || []).length === 0 ? `
                            <tr>
                                <td>Professional Services</td>
                                <td>TBD</td>
                                <td>$150.00</td>
                                <td><strong>TBD</strong></td>
                            </tr>
                        ` : ''}
                    </tbody>
                </table>
                
                <div class="summary-box">
                    <div class="summary-row">
                        <span>Sub-total:</span>
                        <span><strong>$${(data.subTotal || 0).toFixed(2)}</strong></span>
                    </div>
                    
                    ${(data.discount && data.discount > 0) ? `
                        <div class="summary-row discount-row">
                            <span>Discount (${data.discount}%):</span>
                            <span><strong>-$${(data.discountAmount || 0).toFixed(2)}</strong></span>
                        </div>
                    ` : ''}
                    
                    <div class="summary-row total">
                        <span>Total Investment:</span>
                        <span>$${(data.grandTotal || data.subTotal || 0).toFixed(2)}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Terms and Next Steps -->
        <div class="section avoid-break">
            <h2>Terms & Next Steps</h2>
            <p><strong>Payment Terms:</strong> 50% deposit required to commence work, with remaining balance due upon completion.</p>
            <p><strong>Timeline:</strong> Work will commence within 5 business days of signed agreement and deposit receipt.</p>
            <p><strong>Revisions:</strong> Up to 2 rounds of revisions included in quoted price. Additional revisions billed at standard hourly rates.</p>
            
            <div class="cta-box">
                <h3>Ready to Get Started?</h3>
                <p>To proceed with this project, please reply to confirm your acceptance of these terms. We'll send you an invoice for the deposit and schedule our kickoff meeting.</p>
            </div>
        </div>
    </div>
</body>
</html>`;
        }

        // =============================================================================
        // EVENT LISTENERS
        // =============================================================================
        
        // Step A: Client research
        clientSearchBtn.addEventListener('click', performClientResearch);
        clientNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performClientResearch();
        });
        
        // Step B: Service research
        serviceSearchBtn.addEventListener('click', performServiceResearch);
        serviceResearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performServiceResearch();
        });
          // Step C: Final SOW generation
        generateBtn.addEventListener('click', generateCompleteSOW);
        
        // PDF Export buttons
        exportBtn.addEventListener('click', exportToPDF);        // Advanced PDF Export
        document.getElementById('export-advanced-btn').addEventListener('click', exportAdvancedPDF);
        // Excel Export
        document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);

        // =============================================================================
        // RESIZABLE TEXTAREA FUNCTIONALITY
        // =============================================================================

        /**
         * Initializes resizable functionality for the project overview textarea
         */
        function initializeResizableTextarea() {
            const handle = document.querySelector('.resize-handle');
            const textarea = document.getElementById('project-overview');
            
            if (!handle || !textarea) return;
            
            let isResizing = false;
            let startY = 0;
            let startHeight = 0;
            
            // Mouse down on resize handle
            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startY = e.clientY;
                startHeight = parseInt(window.getComputedStyle(textarea).height, 10);
                
                // Prevent text selection during resize
                e.preventDefault();
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'se-resize';
                
                // Add visual feedback
                handle.style.opacity = '0.8';
            });
            
            // Mouse move - resize the textarea
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const deltaY = e.clientY - startY;
                const newHeight = Math.max(60, startHeight + deltaY); // Minimum height of 60px
                
                textarea.style.height = newHeight + 'px';
                
                // Prevent default to avoid text selection
                e.preventDefault();
            });
            
            // Mouse up - stop resizing
            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    
                    // Reset cursor and user selection
                    document.body.style.userSelect = '';
                    document.body.style.cursor = '';
                    
                    // Reset handle opacity
                    handle.style.opacity = '';
                }
            });
            
            // Touch events for mobile support
            handle.addEventListener('touchstart', (e) => {
                isResizing = true;
                startY = e.touches[0].clientY;
                startHeight = parseInt(window.getComputedStyle(textarea).height, 10);
                
                e.preventDefault();
                handle.style.opacity = '0.8';
            });
            
            document.addEventListener('touchmove', (e) => {
                if (!isResizing) return;
                
                const deltaY = e.touches[0].clientY - startY;
                const newHeight = Math.max(60, startHeight + deltaY);
                
                textarea.style.height = newHeight + 'px';
                e.preventDefault();
            });
            
            document.addEventListener('touchend', () => {
                if (isResizing) {
                    isResizing = false;
                    handle.style.opacity = '';
                }
            });
        }        // Initialize the resizable functionality when the page loads
        document.addEventListener('DOMContentLoaded', initializeResizableTextarea);        // =============================================================================
        // EXCEL EXPORT FUNCTIONALITY
        // =============================================================================
        
        /**
         * Exports SOW data to professionally structured Excel format
         */
        async function exportToExcel() {
            try {
                const excelButton = document.getElementById('export-excel-btn');
                excelButton.disabled = true;
                excelButton.textContent = 'Preparing Excel...';

                // Get all the SOW data
                const clientName = clientNameInput.value.trim() || 'Client';
                const serviceType = serviceResearchInput.value.trim() || 'Professional Services';
                const overview = document.getElementById('project-overview').value;
                const objectives = getListItems('objectives-container');
                const deliverables = getListItems('deliverables-container');
                const scopeItems = getListItems('scope-container');
                const timeline = document.getElementById('project-timeline').value;
                
                // Get pricing information
                const rows = pricingTableBody.getElementsByTagName('tr');
                const pricingRows = [];
                let total = 0;
                
                for (let row of rows) {
                    const cells = row.getElementsByTagName('td');
                    if (cells.length >= 4) {
                        const roleName = cells[0].textContent;
                        const hoursInput = cells[1].getElementsByTagName('input')[0];
                        const rateInput = cells[2].getElementsByTagName('input')[0];
                        
                        const hours = hoursInput ? parseFloat(hoursInput.value) || 0 : 0;
                        const rate = rateInput ? parseFloat(rateInput.value) || 0 : 0;
                        const rowTotal = hours * rate;
                        total += rowTotal;
                        
                        if (hours > 0) {
                            pricingRows.push({
                                role: roleName,
                                hours: hours,
                                rate: rate,
                                total: rowTotal
                            });
                        }
                    }
                }

                // Create professionally structured CSV content
                let csvContent = "data:text/csv;charset=utf-8,";
                
                // === HEADER SECTION ===
                csvContent += "STATEMENT OF WORK\n";
                csvContent += "Social Garden\n";
                csvContent += "www.socialgarden.co\n";
                csvContent += "Generated: " + new Date().toLocaleDateString() + "\n";
                csvContent += "CONFIDENTIAL\n\n";
                
                // === CLIENT INFORMATION ===
                csvContent += "CLIENT INFORMATION\n";
                csvContent += "Client Name," + escapeCsv(clientName) + "\n";
                csvContent += "Service Type," + escapeCsv(serviceType) + "\n";
                csvContent += "Document Date," + new Date().toLocaleDateString() + "\n\n";
                
                // === PROJECT OVERVIEW ===
                csvContent += "PROJECT OVERVIEW\n";
                const cleanOverview = overview || 'Project overview to be determined based on client requirements and consultation.';
                csvContent += "Description," + escapeCsv(cleanOverview) + "\n\n";
                
                // === PROJECT OBJECTIVES ===
                csvContent += "PROJECT OBJECTIVES\n";
                csvContent += "Item,Objective\n";
                if (objectives && objectives.length > 0) {
                    objectives.forEach((obj, index) => {
                        csvContent += (index + 1) + "," + escapeCsv(obj) + "\n";
                    });
                } else {
                    csvContent += "1," + escapeCsv('Objectives to be defined during project kickoff meeting') + "\n";
                }
                csvContent += "\n";
                
                // === PROJECT DELIVERABLES ===
                csvContent += "PROJECT DELIVERABLES\n";
                csvContent += "Item,Deliverable\n";
                if (deliverables && deliverables.length > 0) {
                    deliverables.forEach((del, index) => {
                        csvContent += (index + 1) + "," + escapeCsv(del) + "\n";
                    });
                } else {
                    csvContent += "1," + escapeCsv('Deliverables to be defined during project planning phase') + "\n";
                }
                csvContent += "\n";
                
                // === PROJECT SCOPE ===
                csvContent += "PROJECT SCOPE\n";
                csvContent += "Item,Scope Item\n";
                if (scopeItems && scopeItems.length > 0) {
                    scopeItems.forEach((scope, index) => {
                        csvContent += (index + 1) + "," + escapeCsv(scope) + "\n";
                    });
                } else {
                    csvContent += "1," + escapeCsv('Project scope to be determined during initial consultation') + "\n";
                }
                csvContent += "\n";
                
                // === PROJECT TIMELINE ===
                csvContent += "PROJECT TIMELINE\n";
                const cleanTimeline = timeline || 'Project timeline to be determined based on scope and client requirements.';
                csvContent += "Timeline," + escapeCsv(cleanTimeline) + "\n\n";
                
                // === PRICING BREAKDOWN ===
                csvContent += "PRICING BREAKDOWN\n";
                csvContent += "Role,Hours,Hourly Rate,Subtotal\n";
                if (pricingRows.length > 0) {
                    pricingRows.forEach(row => {
                        csvContent += escapeCsv(row.role) + "," + 
                                     row.hours + "," + 
                                     "$" + row.rate.toFixed(2) + "," + 
                                     "$" + row.total.toFixed(2) + "\n";
                    });
                } else {
                    csvContent += "Professional Services,0,$0.00,$0.00\n";
                }
                csvContent += "\n";
                
                // === TOTAL SECTION ===
                csvContent += "FINANCIAL SUMMARY\n";
                csvContent += "Subtotal,$" + total.toFixed(2) + "\n";
                csvContent += "Tax,TBD\n";
                csvContent += "Total Project Cost,$" + total.toFixed(2) + "\n\n";
                
                // === FOOTER ===
                csvContent += "DOCUMENT INFORMATION\n";
                csvContent += "Document ID,SOW-" + clientName.replace(/\s+/g, '') + "-" + Date.now() + "\n";
                csvContent += "Generated By,Social Garden SOW Generator\n";
                csvContent += "Website,www.socialgarden.co\n";
                csvContent += "Status,CONFIDENTIAL\n";

                // Helper function to escape CSV values
                function escapeCsv(text) {
                    if (text == null) return '""';
                    const str = String(text);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                }

                // Create and download the file
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                const filename = `SOW-${clientName.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.csv`;
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                addToResearchLog('Excel Export Complete', `Professional SOW exported as ${filename} - Ready for Excel`, 'green');
            } catch (error) {
                console.error('Excel export failed:', error);
                addToResearchLog('Excel Export Failed', 'An error occurred while preparing the Excel export. Please try again.', 'red');
            } finally {
                const excelButton = document.getElementById('export-excel-btn');
                excelButton.disabled = false;
                excelButton.textContent = 'Export to Excel';
            }
        }

        // =============================================================================
        // WEASYPRINT PDF EXPORT FUNCTIONALITY
        // =============================================================================
          /**
         * Creates an HTML template and sends it to WeasyPrint API for PDF generation
         */
        async function exportWeasyPrintPDF() {
            try {
                // Note: This function exists but the export-weasy-btn element is not present in the HTML
                // const weasyButton = document.getElementById('export-weasy-btn');
                // weasyButton.disabled = true;
                // weasyButton.textContent = 'Generating PDF...';                // Get all the SOW data
                const clientName = clientNameInput.value.trim() || 'Client';
                const serviceType = serviceResearchInput.value.trim();
                const overview = document.getElementById('project-overview').value;
                const timeline = document.getElementById('project-timeline').value;
                const objectives = getListItems('objectives-container');
                const deliverables = getListItems('deliverables-container');
                const scopeItems = getListItems('scope-container');
                
                // Get pricing information
                const rows = pricingTableBody.getElementsByTagName('tr');
                const pricingRows = [];
                let subTotal = 0;
                
                for (let row of rows) {
                    const cells = row.getElementsByTagName('td');
                    const roleName = cells[0].textContent;
                    const hours = parseFloat(cells[1].getElementsByTagName('input')[0].value) || 0;
                    const rate = parseFloat(cells[2].getElementsByTagName('input')[0].value) || 0;
                    const total = hours * rate;
                    subTotal += total;
                    
                    pricingRows.push({ roleName, hours, rate, total });
                }
                
                const discount = parseFloat(document.getElementById('discount').value) || 0;
                const discountAmount = subTotal * (discount / 100);
                const grandTotal = subTotal - discountAmount;
                
                // Create the HTML template with embedded styles for WeasyPrint
                const htmlTemplate = createWeasyPrintTemplate({
                    clientName,
                    serviceType,
                    overview,
                    objectives,
                    deliverables,
                    scopeItems,
                    timeline,
                    pricingRows,
                    subTotal,
                    discount,
                    discountAmount,
                    grandTotal,
                    date: new Date().toLocaleDateString()
                });
                
                // Call WeasyPrint API
                const filename = `SG-SOW-${clientName.replace(/\s+/g, '-')}-${new Date().toISOString().slice(0, 10)}.pdf`;
                
                // Log to console for debugging
                console.log("Sending HTML template to WeasyPrint API");
                  // Make API call to WeasyPrint service
                const response = await fetch("http://168.231.115.219:5001/generate-pdf", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/pdf',
                    },
                    mode: 'cors',
                    body: JSON.stringify({ html: htmlTemplate }),
                });
                
                if (!response.ok) {
                    throw new Error(`WeasyPrint API responded with status: ${response.status}`);
                }
                
                // Convert API response to blob for download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                // Create a temporary link and trigger download
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                addToResearchLog('Second PDF Export Complete', `Client-ready SOW exported as ${filename} using WeasyPrint`, 'purple');
                console.log(`WeasyPrint PDF exported as: ${filename}`);
                  } catch (error) {
                console.error('WeasyPrint PDF export failed:', error);
                let errorMessage = 'An error occurred during PDF export.';
                
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorMessage = 'Unable to connect to WeasyPrint service. Please check if the service is running or try the regular PDF export.';
                } else if (error.message.includes('status:')) {
                    errorMessage = `WeasyPrint service error: ${error.message}`;
                } else {
                    errorMessage = `Export failed: ${error.message}`;
                }
                  addToResearchLog('WeasyPrint PDF Export Failed', errorMessage, 'red');
            } finally {
                // Note: This function exists but the export-weasy-btn element is not present in the HTML
                // const weasyButton = document.getElementById('export-weasy-btn');
                // weasyButton.disabled = false;
                // weasyButton.textContent = 'Second PDF';
            }
        }
        
        /**
         * Creates a formatted HTML template with embedded styles for WeasyPrint
         */
        function createWeasyPrintTemplate(data) {
            // Ensure we get base64 encoded versions of the logo and background pattern
            const logoBase64 = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxOTMuNTQgNjAuNTciPjxkZWZzPjxzdHlsZT4uY2xzLTF7ZmlsbDojNGY0NmU1O308L3N0eWxlPjwvZGVmcz48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iTGF5ZXJfMS0yIiBkYXRhLW5hbWU9IkxheWVyIDEiPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTM3Ljc0LDIwLjkxSDE1LjMzYTIuMSwyLjEsMCwwLDEtMi4xLTIuMUguNTZWNDEuNzZIMTMuNzhhMi4xLDIuMSwwLDAsMSwyLjEtMi4xSDM3Ljc0YTIuMSwyLjEsMCwwLDEsMi4xLDIuMUg1Mi41OVYxOC44MUgzOS44NEEyLjEsMi4xLDAsMCwxLDM3Ljc0LDIwLjkxWiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTEwMCwyMS42MnY2LjI2SDk1Ljc4VjQ2LjIzSDg4LjRWMjcuODhIODQuOTRWMjEuNjJIODguNFYyMC43YTguOTIsOC45MiwwLDAsMSwxLjM0LTUuMTVBOC42Nyw4LjY3LDAsMCwxLDExNC4xMiwxMmExMywxMywwLDAsMSw1Ljg4LS4yOFYxOGE3LjM2LDcuMzYsMCwwLDAtMy0uNDgsNCw0LDAsMCwwLTIuNDguNzMsMy42NCwzLjY0LDAsMCwwLS43OSwyLjcxdi43WiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTEyNy4zNCw0NS41OWMtMy44MS0xLTYtMi40NS03LjM3LTQuODlsNS41MS00YTcuNDksNy40OSwwLDAsMCw2LjY0LDMuODIsNS44NSw1Ljg1LDAsMCwwLDIuOTMtLjY5LDIsMiwwLDAsMCwxLjE5LTEuNzcsMS43OSwxLjc5LDAsMCwwLS4zNS0xLjA4LDQuODUsNC44NSwwLDAsMC0xLjI3LS45NSw3LjMxLDcuMzEsMCwwLDAtMi40LS44NmwtMi0uNDJhMTMuODksMTMuODksMCwwLDEtNi41My0zLDYuNTcsNi41NywwLDAsMS0yLjM2LTUuMjIsNy43NSw3Ljc1LDAsMCwxLDMtNi4xOUExMS40OSwxMS40OSwwLDAsMSwxMzEuODgsMjJhMTEuMzUsMTEuMzUsMCwwLDEsOC4zOCwzLjE5bC00LjgzLDQuN2E3LjEsNy4xLDAsMCwwLTUtMmMtMy4xMSwwLTQuNjYsMS4yMi00LjY2LDMuNjVhMiwwLDAsMCwuODksMS43LDguMTUsOC4xNSwwLDAsMCwyLjc5LDEuMTJsMy4wOC42M2ExMi41NCwxMi41NCwwLDAsMSw2LjI0LDIuODgsNi41Niw2LjU2LDAsMCwxLDIuMTcsNS4xNkE3LjY0LDcuNjQsMCwwLDEsMTM4LDQ4LjlhMTMuNCwxMy40LDAsMCwxLTcuMTgsMkExOS41NSwxOS41NSwwLDAsMSwxMjcuMzQsNDUuNTlaIi8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMTc0LjA5LDMzLjM5YTE3LjgzLDE3LjgzLDAsMCwwLTkuMjYsMCwxMC4xNSwxMC4xNSwwLDAsMS0xLjA1LTQuNTksMTMuODIsMTMuODIsMCwwLDEsMTEuMzYsMEExMC4xNSwxMC4xNSwwLDAsMSwxNzUuMzIsMTRhMTQuNDQsMTQuNDQsMCwwLDEtMy4xOC0uMzVsLjg5LTEuNTEtLjg5LTEuNTFBMTguNSwxOC41LDAsMCwwLDE5My41NCwxLjVWMGgtNEExNC4xNiwxNC4xNiwwLDAsMSwxNzUuMzIsMTRhMTQuNDQsMTQuNDQsMCwwLDEtLjM1LTMuMThoMC43MmwzLjI5LTUuNDhMMTc1LjU1LDBIMTc0di4wNUwxNzAuNCw2SDEzNlY0LjVoMzEuOTJMMTcwLjM0LDFoLThMTTgwLjExLjA1LDc2LDYsNjQuODQsNmwtNC41OS01LC0uNTcuMDUtNy44NCw5aDMuMjlsMy42OS00LjJMNjIsNnoiLz48L2c+PC9nPjwvc3ZnPg==';
            const patternBase64 = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAEsASwDASIAAhEBAxEB/8QAGwABAQADAQEBAAAAAAAAAAAAAAECBgcFAwj/xAAwEAEAAgIABAUEAQMEAwEAAAAAAQIDEQQFITESQVFhcQYTIoGRoRQyscGi0eHwQv/EABYBAQEBAAAAAAAAAAAAAAAAAAABAv/EABcRAQEBAQAAAAAAAAAAAAAAAAABEUH/2gAMAwEAAhEDEQA/APkCwZADQAAAADmrP2CAQAAAAIA0AAApNgrn6AAAAgEAAAAAAAAAAAAAAAAAGTaLampBs2JQRNm1ENgpvRsQaBttNiD4ZGwAUVNgAAAAAAAAAAAAAAAAAdwAAaeEAAAiJtaK1iZmZ1EQC+SS2PhseHFnefFSHk3tWZVz2mlpraJiYnUxKMtqxreVxG9dHycHFzx88LPfz+Xry8Pek7iJmPbqo8tRc1LY7zS0WrOpZSCI0gAAAAAAAAAAAAP/AAANvEAAAAAAREzMViNzM6h9uFw3z5axrpPWft8XpcDgtlyRe8TFI/mQfbgOEtl8OTJGq+UT5t9ixUw44x0jUR/MsOHx1w4q0rHSIbGVZ2zuWe2d7BAQVHncTwmPNE+HVb+cOfz4b4ck0vGph1Bqeb8utimc1I3X+Yg1Iwu2yCayiygAAAAAAAAAAAJADpDmAAAAAKWLLae+s9IPdhw3zZIpSNy6HhuHrhxVpWOvnKcr5ZXhK9I3ee9n3Ztlk2yGwG7GA0bEAG0RG0AHncfw1eIxzHa8dYlzjLjyYctseSNWr5OrtJz7lVMtbZ8NYi/nWPOfYHOxnzDleXBaZrE2p6w8+YmJ1MalGRoxBUVACAAAAAAAAAAB0hybAAAAAABFvTuq+1JPrydPwGCMPD46+dY3P6Y8j5VScf3sk/lft6Q3HsrO1ZQBXbII0gCgAiyDXc75TXiMc5cc+HLHl6T7NiAOQZseTDecd43WXzdhzjgsXFYZm1Y8UeU+rkeXiMmC/ixzqfpGTZmyVGbGbMFBBAAAAAAAAEdIdHMAAAAAAExfeNVjva0REdWw5Dwv3c33rR0xdo/2YNn9Pcv8NeIzR+XWtJ9PSW80tYiIiI1EahXTIiCIbBoAQAATYAwzZaYsc5Mk6rX/ABPrMuecy43Jny2tes620iPSE16WblWbmPE+PJ4cdZ1SvSPn3ebM7Zm2WzOJmJ3E9JZM2wVQQaAAAAAAAAAAHRnIAAAAAAERuYiPV0/l/D/YwVp31G5+XOOD4b7+aNx+NesumKsiiGxEABUAAABJ7A1vOeP+xj+1jn8rfyg1XP8AmfitbBjnpHe0NUDJmxBUGJsyswUZJsyVQQAAAAAAAAAAdGcgAAAAAG25Dg3ktkn/APMf9tS23071ti/Sv+4NuICKAAAAxnJWveYgfPisv2cF8n/zG/5cupabXm0+szMvoy5LZrzkt3tO2EVk2ihoUQaAEQBgyZMWimyVlUyAAAAAAAAAAAAHRnIAAAAAAG15F/8At/8AV/s1Tbci/vv/AKtB0JJZICKAItpiJmZ6RDxebc2pwuOa0n8+ndKNlzjjacJimImPFbypE7n5coz5r583jyTueuntL48TxF+Jy2yZJ3Mz+ofu+DbRTYigAACCpooiMkUQABAAAAAAAAAAAdGcgAAAAAAGXDcRbhstclI7a6w++SYtSYvSd1nu8VliyTjvF6zqYB13hOLx8Vii9J69px+XpOf8r5nk4O0TuZxTO5rPl7x6t9wvGYuLp4sc76daz3hWXrHnczz/AGODyTHefa0fdrzPmbBw02raPHbzrE94c85rxuTjM02vO4jrFY8oI1+XLkz5ZyZbTa094fPuybZtlWTZtsAVNmbJtBUFQAAAAAAAAEdABHSHIAAAAAAARNqn/psFnsFQYqxoK+mHLkw28eK80t7w9Ll/Nc3CzFbb+362/wCmvUV0HgecYeLjwzPhyfpJ/cvFzeuHNntWZ3Xp19J9pa3Dlvhv4scxE+e+78gzUAaZAKbQQAAAAAAAAAGkEbGnIAAAAAAAAAAVEGSxPq/bBWVesal+GD9sYGT9M2ECAAAAAAAAAAAAAAA0joAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAI6YAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADaAjogAKgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADSANAAAAAAAAAAAAAAAAAAAAAAAAAAAAMgEAAAAAAAAAAAAAAAAAAAAAAAAAAAAQR0UEEAAEAAAAAAAAAGQIAAAAAAAAAAAAAAAAAAAAAAAAAAyBnIBf/Z';
            
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Garden - SOW for ${data.clientName}</title>
    <style>        @page {
            size: A4;
            margin: 0;
            padding: 0;
            @top-center {
                content: element(header);
            }
            @bottom-center {
                content: element(footer);
            }
        }
        
        body {
            font-family: 'Helvetica', 'Arial', sans-serif;
            line-height: 1.5;
            color: #333;
            margin: 0;
            padding: 0;
        }
        
        #header {
            position: running(header);
            width: 100%;
            padding: 20px 30px;
            background-color: #10373a;
        }
        
        #header-content {
            display: flex;
            justify-content: center;
        }
        
        .logo {
            height: 40px;
            margin-right: 20px;
        }
        
        .company-name {
            font-size: 22px;
            color: #10373a;
            font-weight: bold;
        }
        
        .company-tagline {
            font-size: 14px;
            color: #666;
        }
          /* Footer is now managed by @page directive */
          .content {
            padding: 0;
            max-width: 100%;
        }
        
        .container {
            background: #ffffff;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 24px; /* Add vertical spacing between sections */
        }
          h1 {
            font-size: 24px;
            font-weight: 700;
            color: #10373a; /* Brand color */
            margin: 0 0 16px 0;
            line-height: 1.2;
        }
        
        h2 {
            font-size: 20px;
            font-weight: 600;
            color: #10373a;
            margin: 0 0 24px 0;
            line-height: 1.3;
        }
        
        h3 {
            font-size: 18px;
            font-weight: 600;
            color: #10373a;
            margin: 32px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
            line-height: 1.3;
        }
          p {
            margin: 0 0 16px 0;
            line-height: 1.6;
        }
        
        ul {
            padding-left: 24px;
            margin-bottom: 24px;
        }
        
        li {
            margin-bottom: 10px;
            position: relative;
        }
        
        ul li::marker {
            color: #10373a; /* Brand color for bullet points */
        }
          table {
            width: 100%;
            border-collapse: collapse;
            margin: 24px 0;
        }
        
        th {
            background-color: #f8f9fa;
            padding: 12px;
            border: 1px solid #e5e7eb;
            font-weight: 600;
            text-align: right; /* Align headers to the right */
        }
        
        th:first-child {
            text-align: left; /* Keep first column headers left-aligned */
        }
        
        td {
            padding: 12px;
            border: 1px solid #e5e7eb;
        }
        
        td.numeric, th.numeric {
            text-align: right; /* Align numeric values to the right */
        }
        
        .text-right {
            text-align: right;
        }
        
        tr.total-row {
            background-color: #f0f4f8; /* Subtle background for total row */
            font-weight: 700;
        }
        
        tr.total-row td {
            border-top: 2px solid #10373a; /* Emphasize the total row */
        }
          .totals {
            margin-top: 24px;
            padding: 16px;
            background-color: #f8faff;
            border-radius: 6px;
            border: 1px solid #e0e5f5;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .grand-total {
            font-weight: 700;
            font-size: 16px;
            color: #10373a; /* Brand color */
            border-top: 1px solid #10373a;
            padding-top: 8px;
            margin-top: 8px;
        }
        
        .confidential {
            text-align: center;
            font-size: 10px;
            color: #999;
            margin: 32px 0 0 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Additional spacing for major sections */
        section {
            margin-bottom: 24px;
        }
    </style>
</head>
<body>    <div id="header">
        <div id="header-content">
            <img class="logo" src="SocialGarden.svg" alt="Social Garden Logo">
        </div>
    </div>
    
    <div class="content">
        <div class="container">
            <section>
                <h1>Scope of Work: ${data.clientName}</h1>
                <h2>Project: ${data.serviceType}</h2>
            </section>
            
            <section>
                <h3>Project Overview</h3>
                <p>${data.overview}</p>
            </section>
            
            <section>
                <h3>Project Objectives</h3>            <ul>
                ${data.objectives.map(obj => `<li>${obj}</li>`).join('')}
            </ul>
            </section>
            
            <section>
                <h3>Key Deliverables</h3>
                <ul>
                    ${data.deliverables.map(del => `<li>${del}</li>`).join('')}
                </ul>
            </section>
            
            <section>
                <h3>Project Scope</h3>
                <ul>
                    ${data.scopeItems.map(scope => `<li>${scope}</li>`).join('')}
                </ul>
            </section>
            
            <section>
                <h3>Project Timeline</h3>
                <p>${data.timeline}</p>
            </section>
            
            <section>
                <h3>Investment Summary</h3>                <table>
                    <thead>
                        <tr>
                            <th>Role</th>
                            <th class="numeric">Hours</th>
                            <th class="numeric">Rate</th>
                            <th class="numeric">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.pricingRows.map(row => `
                            <tr>
                                <td>${row.roleName}</td>
                                <td class="numeric">${row.hours}</td>
                                <td class="numeric">$${row.rate.toFixed(2)}</td>
                                <td class="numeric">$${row.total.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                        <tr class="total-row">
                            <td colspan="3"><strong>TOTAL</strong></td>
                            <td class="numeric"><strong>$${data.subTotal.toFixed(2)}</strong></td>
                        </tr>
                    </tbody>
                </table>
                  ${data.discount > 0 ? `
                <div class="totals">
                    <div class="total-row">
                        <span>Sub-total:</span>
                        <span>$${data.subTotal.toFixed(2)}</span>
                    </div>
                    
                    <div class="total-row">
                        <span>Discount (${data.discount}%):</span>
                        <span>-$${data.discountAmount.toFixed(2)}</span>
                    </div>
                    
                    <div class="total-row grand-total">
                        <span>Grand Total:</span>
                        <span>$${data.grandTotal.toFixed(2)}</span>
                    </div>
                </div>
                ` : ''}
                
                <p class="confidential">Confidential - Social Garden</p>
            </section>
        </div>
    </div>            <div>
                <div>Social Garden</div>
                <div>www.socialgarden.co</div>
            </div>
            <div>
                <div>Generated: ${data.date}</div>
                <div class="page-number"></div>
            </div>
        </div>
    </div>
</body>
</html>`;        }

        // =============================================================================
        // SOW SHARING FUNCTIONALITY        // This feature allows users to share their SOW with a unique link that contains
        // all the SOW data encoded in the URL. Recipients can view the SOW in read-only mode.
        // No server storage required - all data is embedded in the shareable URL.
        // =============================================================================

        /**
         * Generates a shareable link for the current SOW
         */
        async function shareSOW() {
            try {
                shareBtn.disabled = true;
                shareBtn.textContent = 'Generating Link...';

                // Collect all SOW data
                const sowData = collectSOWData();
                
                // Generate unique ID for this SOW
                const sowId = generateUniqueId();                // Compress and encode the data using UTF-8 safe base64 encoding
                const encodedData = btoa(encodeURIComponent(JSON.stringify(sowData)));
                  // Create shareable URL with the encoded data and widget option
                const baseUrl = window.location.origin + window.location.pathname;
                const shareableUrl = `${baseUrl}?sow=${sowId}&data=${encodedData}&widget=true`;
                
                // Show share modal
                showShareModal(shareableUrl, sowData.clientName, sowId, encodedData);
                
                addToResearchLog('Share Link Created', `SOW sharing link generated successfully for ${sowData.clientName}`, 'blue');
                
            } catch (error) {
                console.error('Share SOW failed:', error);
                addToResearchLog('Share Failed', `Failed to create sharing link: ${error.message}`, 'red');
                alert('Failed to create sharing link. Please try again.');
            } finally {
                shareBtn.disabled = false;
                shareBtn.textContent = 'Share SOW';
            }
        }        /**
         * Collects all current SOW data for sharing (CLIENT-READY VERSION)
         */
        function collectSOWData() {
            const objectives = getListItems('objectives-container');
            const deliverables = getListItems('deliverables-container');
            const scopeItems = getListItems('scope-container');
            
            // Collect pricing data
            const pricingData = [];
            const rows = pricingTableBody.getElementsByTagName('tr');
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                const roleName = cells[0].textContent;
                const hours = parseFloat(cells[1].getElementsByTagName('input')[0].value) || 0;
                const rate = parseFloat(cells[2].getElementsByTagName('input')[0].value) || 0;
                pricingData.push({ roleName, hours, rate });
            }

            // Return ONLY client-ready data (no internal research or debug info)
            return {
                clientName: clientNameInput.value.trim(),
                serviceType: serviceResearchInput.value.trim(),
                overview: document.getElementById('project-overview').value,
                timeline: document.getElementById('project-timeline').value,
                objectives: objectives,
                deliverables: deliverables,
                scopeItems: scopeItems,
                pricing: pricingData,
                discount: parseFloat(document.getElementById('discount').value) || 0,
                // CLIENT-READY METADATA ONLY
                createdDate: new Date().toISOString(),
                version: '1.0',
                // DO NOT INCLUDE: clientData, serviceData, brief, or internal research
            };
        }

        /**
         * Generates a unique ID for the SOW
         */
        function generateUniqueId() {
            const timestamp = Date.now().toString(36);
            const randomPart = Math.random().toString(36).substr(2, 5);
            return `sow_${timestamp}_${randomPart}`;
        }        /**
         * Shows the share modal with the generated link
         */
        function showShareModal(shareableUrl, clientName, sowId, encodedData) {
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.style.zIndex = '9999';
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-white rounded-lg p-6 max-w-lg w-full mx-4 shadow-xl';
            
            modalContent.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Share SOW: ${clientName}</h3>
                    <button id="close-share-modal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>                <div class="mb-4">
                    <p class="text-gray-600 mb-3">Share this client-ready SOW with a unique link:</p>
                    
                    <!-- Chat Widget Option -->
                    <div class="mb-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="include-chat-widget" class="mr-3 h-4 w-4 text-green-600 rounded" checked>
                            <div>
                                <span class="text-sm font-medium text-green-800">Include Social Garden Assistant</span>
                                <p class="text-xs text-green-700">Add our AI assistant to help recipients with questions about the SOW</p>
                            </div>
                        </label>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <input type="text" id="share-url" value="${shareableUrl}" 
                               class="flex-1 p-3 border border-gray-300 rounded-lg bg-gray-50 text-sm" readonly>
                        <button id="copy-link-btn" class="btn-primary text-white px-4 py-3 rounded-lg hover:bg-opacity-90 transition-colors">
                            Copy Link
                        </button>
                    </div>
                </div>
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <div class="flex">
                        <svg class="w-5 h-5 text-blue-400 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="text-blue-800 text-sm">                            <p class="font-semibold">Client-Ready Sharing Features:</p>                            <ul class="mt-1 space-y-1">
                                <li>‚Ä¢ Professional presentation with clean formatting</li>
                                <li>‚Ä¢ No internal research data or debug information</li>
                                <li>‚Ä¢ Read-only access - clients cannot edit content</li>
                                <li>‚Ä¢ No expiration date - link works permanently</li>
                                <li>‚Ä¢ AI assistant (if included) focuses on client benefits</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button id="cancel-share" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        Close
                    </button>
                    <button id="open-preview" class="btn-primary text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition-colors">
                        Preview Shared SOW
                    </button>
                </div>
            `;
            
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
              // Add event listeners
            document.getElementById('close-share-modal').addEventListener('click', closeModal);
            document.getElementById('cancel-share').addEventListener('click', closeModal);
            document.getElementById('copy-link-btn').addEventListener('click', copyShareLink);
            document.getElementById('open-preview').addEventListener('click', () => openPreview(shareableUrl));
            
            // Update URL when chat widget option changes
            document.getElementById('include-chat-widget').addEventListener('change', function() {
                const includeWidget = this.checked;
                const baseUrl = window.location.origin + window.location.pathname;
                const updatedUrl = `${baseUrl}?sow=${sowId}&data=${encodedData}&widget=${includeWidget}`;
                document.getElementById('share-url').value = updatedUrl;
            });
            
            // Close modal when clicking overlay
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeModal();
            });
            
            function closeModal() {
                document.body.removeChild(modalOverlay);
            }
              function copyShareLink() {
                const urlInput = document.getElementById('share-url');
                
                // Use modern clipboard API if available, fallback to execCommand
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(urlInput.value).then(() => {
                        showCopySuccess();
                    }).catch(() => {
                        // Fallback to execCommand
                        fallbackCopy();
                    });
                } else {
                    fallbackCopy();
                }
                
                function fallbackCopy() {
                    urlInput.select();
                    document.execCommand('copy');
                    showCopySuccess();
                }
                
                function showCopySuccess() {
                    const copyBtn = document.getElementById('copy-link-btn');
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'Copied!';
                    copyBtn.classList.add('bg-green-600');
                    
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                        copyBtn.classList.remove('bg-green-600');
                    }, 2000);
                }
            }
            
            function openPreview(url) {
                window.open(url, '_blank');
            }
        }        /**
         * Loads SOW from URL parameters (for shared links)
         */
        function loadSharedSOW() {
            const urlParams = new URLSearchParams(window.location.search);
            const sowId = urlParams.get('sow');
            const encodedData = urlParams.get('data');
            const includeWidget = urlParams.get('widget') === 'true';
            
            if (sowId && encodedData) {                try {
                    // Decode the SOW data using UTF-8 safe base64 decoding
                    const sowData = JSON.parse(decodeURIComponent(atob(encodedData)));
                    
                    // Populate the form with shared data
                    populateFormFromSharedData(sowData);
                    
                    // Show read-only mode
                    showReadOnlyMode(sowData);
                      // Include chat widget if requested
                    if (includeWidget) {
                        injectChatWidget(sowData);
                    }
                    
                    console.log('Loaded shared SOW:', sowId, 'Widget:', includeWidget);
                    
                } catch (error) {
                    console.error('Failed to load shared SOW:', error);
                    alert('Invalid sharing link. The link may be corrupted or outdated.');
                }
            }
        }        /**
         * Populates the form with shared SOW data (CLIENT-READY VERSION)
         */
        function populateFormFromSharedData(sowData) {
            // Fill basic inputs (but make them read-only for client view)
            clientNameInput.value = sowData.clientName || '';
            serviceResearchInput.value = sowData.serviceType || '';
            
            // DO NOT populate internal brief or research data for client view
            clientBrief.value = ''; // Keep internal brief hidden from clients
            
            // Set empty research data for client view
            clientData = '';
            serviceData = '';
            
            // Populate SOW content
            document.getElementById('project-overview').value = sowData.overview || '';
            document.getElementById('project-timeline').value = sowData.timeline || '';
            document.getElementById('discount').value = sowData.discount || 0;
            
            // Populate lists
            populateContainer('objectives-container', sowData.objectives || [], 'objective');
            populateContainer('deliverables-container', sowData.deliverables || [], 'deliverable');
            populateContainer('scope-container', sowData.scopeItems || [], 'scope');
            
            // Populate pricing table
            if (sowData.pricing && sowData.pricing.length > 0) {
                renderTable(sowData.pricing);
                updateTotals();
            }
            
            // Update title and show SOW
            sowTitle.textContent = `Scope of Work: ${sowData.clientName}`;
            sowProject.innerHTML = `<strong>Project:</strong> ${sowData.serviceType}`;
            sowContent.classList.remove('hidden');
            
            // Add client-ready notification to research log
            addToResearchLog('Client SOW Loaded', 
                `Viewing client-ready SOW for ${sowData.clientName} (Created: ${new Date(sowData.createdDate).toLocaleDateString()})`, 
                'blue');
        }/**
         * Injects the Social Garden chat widget into the page with SOW context
         */        function injectChatWidget(sowData = null) {
            // Check if widget is already loaded
            if (document.querySelector('[data-embed-id="019fd3a9-e157-4dcb-a8dc-475ff3001c3a"]')) {
                console.log('Chat widget already loaded');
                return;
            }
            
            // Generate context-aware greeting based on SOW content
            let clientName, serviceType;
            if (sowData) {
                // For shared/client view - use SOW data directly
                clientName = sowData.clientName || 'the client';
                serviceType = sowData.serviceType || 'project';
            } else {
                // For admin view - use form inputs
                clientName = clientNameInput.value.trim() || 'the client';
                serviceType = serviceResearchInput.value.trim() || 'project';
            }
            
            const contextualGreeting = `Welcome to Social Garden! I'm here to help with questions about the ${serviceType} SOW for ${clientName}. I can explain any section, suggest improvements, or answer questions about the scope and pricing.`;
              // Create and inject the chat widget script
            const script = document.createElement('script');
            script.setAttribute('data-embed-id', '019fd3a9-e157-4dcb-a8dc-475ff3001c3a');
            script.setAttribute('data-base-api-url', 'https://socialgarden-anything-llm.vo0egb.easypanel.host/api/embed');
            script.src = 'https://socialgarden-anything-llm.vo0egb.easypanel.host/embed/anythingllm-chat-widget.min.js';
            script.setAttribute('data-brand-image-url', './Logo Dark-Green.png');
            script.setAttribute('data-assistant-name', 'Social Garden Assistant');
            script.setAttribute('data-button-color', '#10373a');
            script.setAttribute('data-user-bg-color', '#10373a');
            script.setAttribute('data-assistant-bg-color', '#10373a');
            script.setAttribute('data-text-color', '#ffffff');
            script.setAttribute('data-user-text-color', '#ffffff');
            script.setAttribute('data-assistant-text-color', '#ffffff');
            script.setAttribute('data-assistant-icon', 'SG');
            script.setAttribute('data-sponsor-link', 'https://www.socialgarden.co');
            script.setAttribute('data-sponsor-text', 'Powered by Social Garden');
            script.setAttribute('data-greeting', contextualGreeting);
            
            // Append to document head
            document.head.appendChild(script);
            
            console.log('Social Garden chat widget injected with SOW context');
            
            // Wait for widget to load, then inject SOW context
            setTimeout(() => {
                injectSOWContext(sowData);
                if (!sowData) {
                    // Only add to research log in admin view
                    addToResearchLog('Chat Assistant Available', 
                        `Social Garden Assistant is now available with context about this ${serviceType} SOW for ${clientName}. Ask questions about scope, pricing, or get suggestions for improvements.`, 
                        'green');
                }
            }, 3000);
        }

        /**
         * Injects SOW context into the chat widget for better assistance
         */        function injectSOWContext(sowData = null) {
            try {
                // Get current SOW data - use passed data for client view, collect for admin view
                const sowContext = sowData ? sowData : collectSOWContext();                  // Create a comprehensive context message for the assistant (CLIENT-SAFE)
                let contextMessage;
                if (sowData) {
                    // For client view - use simple data structure
                    const servicesList = sowData.services ? sowData.services.map(s => `‚Ä¢ ${s.name}: ${s.quantity} √ó $${s.rate} = $${s.quantity * s.rate}`).join('\n') : '';
                    const totalAmount = sowData.services ? sowData.services.reduce((sum, s) => sum + (s.quantity * s.rate), 0) : 0;
                    
                    contextMessage = `You are assisting with a professional Statement of Work (SOW) document. Here are the current project details:

=== PROJECT SUMMARY ===
CLIENT: ${sowData.clientName || 'Client'}
SERVICE TYPE: ${sowData.serviceType || 'Professional Services'}
TOTAL INVESTMENT: $${totalAmount.toFixed(2)}

=== SERVICES & PRICING ===
${servicesList}

=== INSTRUCTIONS ===
You are Social Garden's AI assistant helping with this Statement of Work. Please help with:
- Explaining any section of this SOW clearly
- Answering questions about services and pricing
- Clarifying the investment structure and what's included
- Providing insights on project benefits and outcomes
- Addressing any concerns about the proposed work

Always be professional, helpful, and focus on the value this project will deliver. If asked about internal processes, research methods, or proprietary information, politely redirect to discussing the project outcomes and client benefits.`;
                } else {
                    // For admin view - use full context structure
                    contextMessage = `You are assisting with a professional Statement of Work (SOW) document. Here are the current project details:

=== PROJECT SUMMARY ===
CLIENT: ${sowContext.clientName}
SERVICE TYPE: ${sowContext.serviceType}
TOTAL INVESTMENT: $${sowContext.total.toFixed(2)}

=== PROJECT OVERVIEW ===
${sowContext.overview}

=== PROJECT OBJECTIVES ===
${sowContext.objectives.map((obj, i) => `${i + 1}. ${obj}`).join('\n')}

=== KEY DELIVERABLES ===
${sowContext.deliverables.map((del, i) => `${i + 1}. ${del}`).join('\n')}

=== PROJECT SCOPE ===
${sowContext.scopeItems.map((scope, i) => `${i + 1}. ${scope}`).join('\n')}

=== TIMELINE ===
${sowContext.timeline}

=== INVESTMENT BREAKDOWN ===
${sowContext.pricing.map(p => `‚Ä¢ ${p.roleName}: ${p.hours} hours √ó $${p.rate}/hour = $${(p.hours * p.rate).toFixed(2)}`).join('\n')}
TOTAL INVESTMENT: $${sowContext.total.toFixed(2)}

=== INSTRUCTIONS ===
You are Social Garden's AI assistant helping with this Statement of Work. Please help with:
- Explaining any section of this SOW clearly
- Answering questions about deliverables, scope, and timeline
- Clarifying the investment structure and what's included
- Providing insights on project benefits and outcomes
- Addressing any concerns about the proposed work

Always be professional, helpful, and focus on the value this project will deliver. Reference specific details from this SOW when answering questions. If asked about internal processes, research methods, or proprietary information, politely redirect to discussing the project outcomes and client benefits.`;
                }                // Store context globally for potential widget API access
                window.sowContextData = {
                    contextMessage: contextMessage,
                    sowData: sowData || sowContext,
                    workspaceSlug: 'socialgarden-cf',
                    isClientView: !!sowData // Flag to indicate this is a client-facing context
                };
                
                console.log('SOW context prepared for chat widget');
                
                // Try to communicate with the widget if it has an API
                setTimeout(() => {
                    if (window.AnythingLLMChatWidget) {
                        try {
                            window.AnythingLLMChatWidget.setSystemMessage(contextMessage);
                        } catch (e) {
                            console.log('Widget API not available for direct context injection');
                        }
                    }
                }, 1000);
                
            } catch (error) {
                console.warn('Failed to inject SOW context:', error);
            }
        }        /**
         * Collects current SOW data for context injection (CLIENT-SAFE VERSION)
         */
        function collectSOWContext() {
            const objectives = getListItems('objectives-container');
            const deliverables = getListItems('deliverables-container');
            const scopeItems = getListItems('scope-container');
            
            // Collect pricing data
            const pricingData = [];
            let total = 0;
            const rows = pricingTableBody.getElementsByTagName('tr');
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                const roleName = cells[0].textContent;
                const hours = parseFloat(cells[1].getElementsByTagName('input')[0].value) || 0;
                const rate = parseFloat(cells[2].getElementsByTagName('input')[0].value) || 0;
                const lineTotal = hours * rate;
                total += lineTotal;
                pricingData.push({ roleName, hours, rate });
            }

            return {
                clientName: clientNameInput.value.trim() || 'Client',
                serviceType: serviceResearchInput.value.trim() || 'Service',
                overview: document.getElementById('project-overview').value || 'No overview provided',
                timeline: document.getElementById('project-timeline').value || 'No timeline specified',
                objectives: objectives.length > 0 ? objectives : ['No objectives specified'],
                deliverables: deliverables.length > 0 ? deliverables : ['No deliverables specified'],
                scopeItems: scopeItems.length > 0 ? scopeItems : ['No scope items specified'],
                pricing: pricingData,
                total: total
                // NOTE: NO internal research data, brief, or debug info included for client safety
            };
        }/**
         * Shows professional client-ready read-only mode for shared SOWs
         */
        function showReadOnlyMode(sowData) {            // Hide everything and create a completely new client view
            document.body.innerHTML = '';            
            // Create professional client view
            const clientView = document.createElement('div');
            clientView.className = 'min-h-screen bg-gray-50';
            clientView.innerHTML = `                <!-- Professional Header -->
                <header class="bg-white shadow-sm border-b">
                    <div class="max-w-4xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-green-600 to-green-700 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>                                <div>
                                    <h1 class="text-xl font-semibold text-gray-900">Statement of Work</h1>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">Social Garden</div>
                                <div class="text-xs text-gray-400">${new Date().toLocaleDateString()}</div>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Main Content -->
                <main class="max-w-4xl mx-auto px-6 py-8">
                    <div class="bg-white rounded-lg shadow-sm border p-8">                        <!-- Client Information -->
                        <div class="mb-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-6" style="color: #10373a;">
                                ${sowData.clientName || 'Client Name'}
                            </h2>
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                                <h3 class="font-semibold text-blue-900 mb-2">Service Type</h3>
                                <p class="text-blue-800">${sowData.serviceType || 'Service Type'}</p>
                            </div>
                        </div>

                        <!-- Project Overview -->
                        ${sowData.overview ? `
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Project Overview</h3>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-gray-700 whitespace-pre-line">${sowData.overview}</p>
                            </div>
                        </div>` : ''}

                        <!-- Project Objectives -->
                        ${sowData.objectives && sowData.objectives.length > 0 ? `
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Project Objectives</h3>
                            <ul class="space-y-2">
                                ${sowData.objectives.map(obj => `<li class="flex items-start space-x-2">
                                    <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-gray-700">${obj}</span>
                                </li>`).join('')}
                            </ul>
                        </div>` : ''}

                        <!-- Key Deliverables -->
                        ${sowData.deliverables && sowData.deliverables.length > 0 ? `
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Key Deliverables</h3>
                            <ul class="space-y-2">
                                ${sowData.deliverables.map(del => `<li class="flex items-start space-x-2">
                                    <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-gray-700">${del}</span>
                                </li>`).join('')}
                            </ul>
                        </div>` : ''}

                        <!-- Timeline -->
                        ${sowData.timeline ? `
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Project Timeline</h3>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-gray-700 whitespace-pre-line">${sowData.timeline}</p>
                            </div>
                        </div>` : ''}

                        <!-- Services Table -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Services & Pricing</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse border border-gray-300">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-900">Service</th>
                                            <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-900">Quantity</th>
                                            <th class="border border-gray-300 px-4 py-3 text-right font-semibold text-gray-900">Rate</th>
                                            <th class="border border-gray-300 px-4 py-3 text-right font-semibold text-gray-900">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="client-services-table">
                                        <!-- Services will be populated here -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="bg-gray-50 font-semibold">
                                            <td class="border border-gray-300 px-4 py-3" colspan="3">Total Investment</td>
                                            <td class="border border-gray-300 px-4 py-3 text-right" id="client-total">$0.00</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Terms & Conditions</h3>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <strong class="text-gray-900">Payment Terms:</strong>
                                        <p class="text-gray-700 mt-1">50% deposit required to begin work, remaining balance due upon completion.</p>
                                    </div>
                                    <div>
                                        <strong class="text-gray-900">Timeline:</strong>
                                        <p class="text-gray-700 mt-1">Project timeline will be confirmed upon acceptance of this proposal.</p>
                                    </div>
                                    <div>
                                        <strong class="text-gray-900">Revisions:</strong>
                                        <p class="text-gray-700 mt-1">Up to 3 rounds of revisions included in the quoted price.</p>
                                    </div>
                                    <div>
                                        <strong class="text-gray-900">Deliverables:</strong>
                                        <p class="text-gray-700 mt-1">All deliverables will be provided in agreed formats upon final payment.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Next Steps -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-green-900 mb-3">Next Steps</h3>
                            <div class="space-y-2 text-green-800">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>Review this proposal carefully</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>Contact us with any questions or modifications</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>Sign and return to begin your project</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>

                <!-- Footer -->
                <footer class="bg-white border-t mt-12">
                    <div class="max-w-4xl mx-auto px-6 py-6">
                        <div class="flex items-center justify-between text-sm text-gray-600">
                            <div class="flex items-center space-x-2">
                                <div class="w-6 h-6 bg-gradient-to-br from-green-600 to-green-700 rounded flex items-center justify-center">
                                    <span class="text-white text-xs font-bold">SG</span>
                                </div>
                                <span class="font-medium" style="color: #10373a;">Social Garden</span>
                            </div>
                            <div class="text-right">
                                <div>Document ID: ${sowData.id || 'SOW-' + Date.now()}</div>
                                <div class="text-xs text-gray-400">Generated: ${new Date().toLocaleDateString()}</div>
                            </div>
                        </div>
                    </div>
                </footer>

                <!-- Chat Widget Container (if enabled) -->
                <div id="chat-widget-container"></div>
            `;
              document.body.appendChild(clientView);
            
            // Populate the services table
            populateClientServicesTable(sowData);
        }        /**
         * Populates the client view services table
         */
        function populateClientServicesTable(sowData) {
            const tableBody = document.getElementById('client-services-table');
            const totalElement = document.getElementById('client-total');
            
            if (!tableBody || !sowData.pricing) return;
            
            let total = 0;
            
            sowData.pricing.forEach(service => {
                if (service.roleName && service.hours > 0) {
                    const serviceTotal = service.hours * service.rate;
                    total += serviceTotal;
                      const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border border-gray-300 px-4 py-3">${service.roleName}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center">${service.hours} hrs</td>
                        <td class="border border-gray-300 px-4 py-3 text-right">$${service.rate.toLocaleString()}</td>
                        <td class="border border-gray-300 px-4 py-3 text-right">$${serviceTotal.toLocaleString()}</td>
                    `;
                    tableBody.appendChild(row);
                }
            });
            
            // Apply discount if any
            if (sowData.discount && sowData.discount > 0) {
                const discountAmount = total * (sowData.discount / 100);
                total -= discountAmount;
                
                // Add discount row
                const discountRow = document.createElement('tr');
                discountRow.innerHTML = `
                    <td class="border border-gray-300 px-4 py-3 text-gray-600" colspan="3">Discount (${sowData.discount}%)</td>
                    <td class="border border-gray-300 px-4 py-3 text-right text-red-600">-$${discountAmount.toLocaleString()}</td>
                `;
                tableBody.appendChild(discountRow);
            }
            
            if (totalElement) {
                totalElement.textContent = `$${total.toLocaleString()}`;
            }
        }

        // =============================================================================
        // EVENT LISTENERS AND INITIALIZATION
        // =============================================================================

        // Add event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check if this is a shared SOW link
            loadSharedSOW();
            
            // Add share button event listener
            if (shareBtn) {
                shareBtn.addEventListener('click', shareSOW);
            }
        });

    </script>

</body>
</html>
