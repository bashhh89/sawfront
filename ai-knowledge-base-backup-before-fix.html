<!DOCTYPE html>
<html lang="en">
<head>    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Garden - AI Knowledge Base</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"><style>
        :root {
            --primary-color: #10373a;
            --primary-light: #1a5a5f;
            --primary-dark: #0a2326;
            --accent-color: #34d399;
            --accent-light: #6ee7b7;
            --background-gradient: linear-gradient(135deg, #10373a 0%, #1a5a5f 100%);
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        
        /* Enhanced Visual Components */
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .primary-gradient {
            background: var(--background-gradient);
        }
        
        .primary-gradient-light {
            background: linear-gradient(135deg, #1a5a5f 0%, #2dd4bf 100%);
        }
          .card-elevated {
            box-shadow: 0 10px 25px rgba(16, 55, 58, 0.15);
            border: 1px solid rgba(16, 55, 58, 0.05);
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(16, 55, 58, 0.15);
        }
        
        /* Knowledge Base Visual Styles */
        .service-node {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid #e5e7eb;
            background: rgba(255, 255, 255, 0.98);
        }
        
        .service-node:hover {
            transform: translateY(-4px) scale(1.02);
            border-color: var(--primary-color);
            box-shadow: 0 15px 35px rgba(16, 55, 58, 0.2);
        }
        
        .service-connection {
            stroke: #e5e7eb;
            stroke-width: 2;
            opacity: 0.6;
        }
        
        .service-connection.highlighted {
            stroke: var(--primary-color);
            stroke-width: 3;
            opacity: 1;
        }
        
        /* Enhanced Service Category Colors */
        .category-marketing { 
            border-left: 4px solid var(--primary-color); 
            background: linear-gradient(135deg, rgba(16, 55, 58, 0.05) 0%, rgba(52, 211, 153, 0.05) 100%);
        }
        .category-audit { 
            border-left: 4px solid #f59e0b; 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(251, 191, 36, 0.05) 100%);
        }
        .category-strategy { 
            border-left: 4px solid #8b5cf6; 
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%);
        }
        .category-managed { 
            border-left: 4px solid #06b6d4; 
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.05) 0%, rgba(34, 211, 238, 0.05) 100%);
        }
        .category-advisory { 
            border-left: 4px solid #ef4444; 
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(248, 113, 113, 0.05) 100%);
        }
        .category-configuration { 
            border-left: 4px solid #84cc16; 
            background: linear-gradient(135deg, rgba(132, 204, 22, 0.05) 0%, rgba(163, 230, 53, 0.05) 100%);
        }
        .category-implementation { 
            border-left: 4px solid #f97316; 
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.05) 0%, rgba(251, 146, 60, 0.05) 100%);
        }
        .category-project { 
            border-left: 4px solid #ec4899; 
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.05) 0%, rgba(244, 114, 182, 0.05) 100%);
        }
        .category-bundles { 
            border-left: 4px solid #6366f1; 
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(129, 140, 248, 0.05) 100%);
        }
        .category-custom { 
            border-left: 4px solid #14b8a6; 
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.05) 0%, rgba(45, 212, 191, 0.05) 100%);
        }
        
        /* Enhanced Chat Interface */
        .user-message {
            background: var(--background-gradient);
            color: white;
            margin-left: 20%;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(16, 55, 58, 0.3);
        }
        
        .ai-message {
            background: rgba(255, 255, 255, 0.95);
            color: #374151;
            margin-right: 20%;
            margin-bottom: 12px;
            border: 1px solid rgba(16, 55, 58, 0.1);
            box-shadow: 0 2px 10px rgba(16, 55, 58, 0.08);
        }
        
        .chat-message {
            border-radius: 20px;
            padding: 16px 20px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.6;
            animation: slideInMessage 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideInMessage {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        /* Enhanced Button Styles */
        .btn-primary {
            background: var(--background-gradient);
            color: white;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(16, 55, 58, 0.2);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 55, 58, 0.3);
            background: linear-gradient(135deg, #1a5a5f 0%, #10373a 100%);
        }
        
        .btn-secondary {
            background: rgba(16, 55, 58, 0.1);
            color: var(--primary-color);
            border: 1px solid rgba(16, 55, 58, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-secondary:hover {
            background: rgba(16, 55, 58, 0.15);
            transform: translateY(-1px);
        }
        
        /* Enhanced Modal Styles */
        .modal-overlay {
            background: rgba(16, 55, 58, 0.7);
            backdrop-filter: blur(8px);
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px rgba(16, 55, 58, 0.3);
        }
        
        /* Form Enhancement */
        .form-input {
            border: 2px solid rgba(16, 55, 58, 0.1);
            background: rgba(255, 255, 255, 0.95);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(16, 55, 58, 0.1);
            background: white;
        }
        
        /* Tab Enhancement */
        .tab-active {
            background: var(--background-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 55, 58, 0.2);
        }
        
        .tab-inactive {
            background: rgba(16, 55, 58, 0.05);
            color: var(--primary-color);
            border: 1px solid rgba(16, 55, 58, 0.1);
        }        
        .tab-inactive:hover {
            background: rgba(16, 55, 58, 0.1);
        }
        
        /* Loading indicators */
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #f3f4f6;
            border-radius: 16px;
            margin-right: 20%;
            width: fit-content;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* Client Profile Cards */
        .client-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .client-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .client-status-cold { border-left: 4px solid #ef4444; }
        .client-status-warm { border-left: 4px solid #f59e0b; }
        .client-status-hot { border-left: 4px solid #10b981; }
        
        /* Tab Navigation */
        .tab-active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        
        .tab-inactive {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        /* Service Innovation Suggestions */
        .innovation-card {
            border: 2px dashed #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .innovation-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .add-to-kb-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            transition: all 0.3s ease;
        }        
        .add-to-kb-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }
    </style>
    
    <!-- Animation and AI Effects Styles -->
    <style>
        /* Animations for AI Effects */
        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.5; }
        }
        
        .pulse-animation {
            animation: pulse 1.5s infinite ease-in-out;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .float-animation {
            animation: float 3s infinite ease-in-out;
        }
        
        @keyframes particle-movement {
            0% { transform: translate(0, 0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) rotate(var(--r)); opacity: 0; }
        }
        
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            pointer-events: none;
            animation: particle-movement var(--duration, 10s) infinite;
            animation-delay: var(--delay, 0s);
            opacity: 0;
        }
        
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .animated-gradient {
            background: linear-gradient(270deg, #3b82f6, #8b5cf6, #ec4899);
            background-size: 600% 600%;
            animation: gradient-shift 8s ease infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-brain svg {
            animation: spin 3s linear infinite;
        }
        
        /* Typing animation */
        .typing-animation::after {
            content: '|';
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->    <header class="primary-gradient shadow-lg border-b border-opacity-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <img src="Logo Dark-Green.png" alt="Social Garden" class="h-8 w-auto mr-3 filter brightness-0 invert">
                    <h1 class="text-xl font-bold text-white">AI Knowledge Base</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-green-200">Connected</span>
                    <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse shadow-sm"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tab Navigation -->
        <div class="mb-8">
            <nav class="flex space-x-4">
                <button id="tab-knowledge" class="tab-active px-6 py-3 rounded-lg font-medium transition-all">
                    üìö Knowledge Repository
                </button>
                <button id="tab-clients" class="tab-inactive px-6 py-3 rounded-lg font-medium transition-all">
                    üë• Client Profiles
                </button>
                <button id="tab-sow" class="tab-inactive px-6 py-3 rounded-lg font-medium transition-all">
                    üìÑ SOW Generator
                </button>
                <button id="tab-innovation" class="tab-inactive px-6 py-3 rounded-lg font-medium transition-all">
                    üí° Service Innovation
                </button>
            </nav>
        </div>        <!-- Knowledge Repository Tab -->
        <div id="content-knowledge" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Visual Knowledge Map -->
                <div class="lg:col-span-2">
                    <div class="glass-effect rounded-xl shadow-lg card-elevated p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-gray-900 flex items-center">
                                <span class="w-8 h-8 primary-gradient rounded-lg flex items-center justify-center mr-3">
                                    üó∫Ô∏è
                                </span>
                                Service Map
                            </h2>
                            <div class="flex space-x-2">
                                <button id="view-tree" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium">üå≥ Tree View</button>
                                <button id="view-network" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">üï∏Ô∏è Network View</button>
                                <button id="view-categories" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">üìÇ Categories</button>
                            </div>
                        </div>
                        <div id="knowledge-visualization" class="w-full h-96 border-2 border-dashed border-gray-200 rounded-xl bg-gradient-to-br from-gray-50 to-white"></div>
                        
                        <!-- Service Details Panel -->
                        <div id="service-details" class="mt-6 hidden">
                            <h3 id="service-title" class="text-lg font-semibold mb-2"></h3>
                            <div id="service-info" class="space-y-2 text-sm text-gray-600"></div>
                        </div>
                    </div>
                </div>

                <!-- AI Chat Interface -->
                <div class="lg:col-span-1">
                    <div class="glass-effect rounded-xl shadow-lg card-elevated p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-8 h-8 primary-gradient rounded-lg flex items-center justify-center mr-3">
                                ü§ñ
                            </span>
                            AI Assistant
                        </h2>                        
                        <!-- Chat Messages -->
                        <div id="chat-messages" class="h-80 overflow-y-auto mb-6 space-y-3 p-4 bg-gradient-to-b from-gray-50 to-white rounded-xl border border-gray-100">
                            <div class="ai-message chat-message">
                                <p><strong>Hello!</strong> I'm your AI assistant for the Knowledge Base. Ask me anything about your services, pricing, or how to improve them! üöÄ</p>
                            </div>
                        </div>
                        
                        <!-- Chat Input -->
                        <div class="flex space-x-3">                            <input 
                                type="text" 
                                id="chat-input" 
                                placeholder="Ask about services, pricing, improvements..."
                                class="form-input flex-1 px-4 py-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-opacity-50"
                            >
                            <button 
                                id="send-chat" 
                                class="btn-primary px-6 py-3 rounded-xl hover:scale-105 transition-transform font-medium"
                            >
                                <span class="hidden sm:inline">Send</span>
                                <span class="sm:hidden">üì§</span>
                            </button>
                        </div>
                        
                        <!-- Quick Questions -->
                        <div class="mt-6">
                            <p class="text-xs text-gray-500 mb-3 font-medium">üí° Quick questions:</p>
                            <div class="space-y-2">
                                <button class="quick-question w-full text-left text-xs p-3 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg hover:from-gray-100 hover:to-gray-200 transition-all border border-gray-200 hover:border-gray-300">
                                    What's the average pricing for Marketing Automation services?
                                </button>
                                <button class="quick-question w-full text-left text-xs p-3 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg hover:from-gray-100 hover:to-gray-200 transition-all border border-gray-200 hover:border-gray-300">
                                    How can AI enhance our current service offerings?
                                </button>
                                <button class="quick-question w-full text-left text-xs p-3 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg hover:from-gray-100 hover:to-gray-200 transition-all border border-gray-200 hover:border-gray-300">
                                    What services work best together for enterprise clients?
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>        <!-- Client Profiles Tab -->
        <div id="content-clients" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Client Management -->
                <div class="lg:col-span-2">
                    <div class="glass-effect rounded-xl shadow-lg card-elevated p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-gray-900 flex items-center">
                                <span class="w-8 h-8 primary-gradient rounded-lg flex items-center justify-center mr-3">
                                    üë•
                                </span>
                                Client Profiles
                            </h2>
                            <button id="add-client" class="btn-primary px-6 py-3 rounded-xl hover:scale-105 transition-transform font-medium">
                                <span class="mr-2">+</span> Add Client
                            </button>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input 
                                type="text" 
                                id="client-search" 
                                placeholder="üîç Search clients..."
                                class="form-input px-4 py-3 rounded-xl"
                            >
                            <select id="status-filter" class="form-input px-4 py-3 rounded-xl">
                                <option value="">üìä All Statuses</option>
                                <option value="cold">‚ùÑÔ∏è Cold Lead</option>
                                <option value="warm">üå°Ô∏è Warm Lead</option>
                                <option value="hot">üî• Hot Lead</option>
                                <option value="client">‚úÖ Active Client</option>
                            </select>
                        </div>
                        
                        <!-- Client Cards -->
                        <div id="client-list" class="space-y-4">
                            <!-- Client cards will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Client Analysis -->
                <div class="lg:col-span-1">
                    <div class="glass-effect rounded-xl shadow-lg card-elevated p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-8 h-8 primary-gradient rounded-lg flex items-center justify-center mr-3">
                                üìä
                            </span>
                            Client Analysis
                        </h2>
                        <div id="client-analysis" class="text-center text-gray-500 py-8 bg-gradient-to-br from-gray-50 to-white rounded-xl border-2 border-dashed border-gray-200">
                            <div class="w-16 h-16 primary-gradient rounded-full flex items-center justify-center mx-auto mb-4 opacity-50">
                                <span class="text-2xl text-white">ü§ñ</span>
                            </div>
                            <p class="font-medium">Select a client to see AI-powered analysis</p>
                            <p class="text-sm mt-2">Personalized insights & service recommendations</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>        <!-- SOW Generator Tab -->
        <div id="content-sow" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- SOW Form -->
                <div class="space-y-6">
                    <!-- Client Selection -->
                    <div class="glass-effect rounded-xl shadow-lg card-elevated p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-8 h-8 primary-gradient rounded-lg flex items-center justify-center mr-3">
                                ÔøΩ
                            </span>
                            Client Selection
                        </h2>
                        <div class="space-y-4">
                            <select id="sow-client-select" class="form-input w-full px-4 py-3 rounded-lg text-sm">
                                <option value="">Select a client...</option>
                            </select>
                            <div id="selected-client-info" class="hidden bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4">
                                <!-- Client info will be populated here -->
                            </div>
                            <button id="auto-research-btn" class="w-full btn-primary px-4 py-3 rounded-lg text-sm font-medium hidden">
                                üîç Auto-Research Client & Industry
                            </button>
                        </div>
                    </div>
                    
                    <!-- Project Details -->
                    <div class="glass-effect rounded-xl shadow-lg card-elevated p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-8 h-8 primary-gradient rounded-lg flex items-center justify-center mr-3">
                                üìã
                            </span>
                            Project Details
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Project Title</label>
                                <input type="text" id="sow-project-title" class="form-input w-full px-4 py-3 rounded-lg text-sm" placeholder="e.g., Marketing Automation Implementation">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Project Type</label>
                                    <select id="sow-project-type" class="form-input w-full px-4 py-3 rounded-lg text-sm">
                                        <option value="">Select type...</option>
                                        <option value="marketing-automation">Marketing Automation</option>
                                        <option value="web-development">Web Development</option>
                                        <option value="ai-implementation">AI Implementation</option>
                                        <option value="crm-setup">CRM Setup</option>
                                        <option value="digital-transformation">Digital Transformation</option>
                                        <option value="consulting">Consulting</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Estimated Budget</label>
                                    <input type="number" id="sow-budget" class="form-input w-full px-4 py-3 rounded-lg text-sm" placeholder="10000" min="0" step="1000">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Project Brief</label>
                                <textarea id="sow-project-brief" rows="4" class="form-input w-full px-4 py-3 rounded-lg text-sm" placeholder="Describe the project objectives, scope, and requirements..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Service Selection -->
                    <div class="glass-effect rounded-xl shadow-lg card-elevated p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-8 h-8 primary-gradient rounded-lg flex items-center justify-center mr-3">
                                ‚öôÔ∏è
                            </span>
                            Service Selection
                        </h2>
                        <div id="service-selection" class="space-y-3">
                            <!-- Services will be populated from KB -->
                        </div>
                        <button id="ai-suggest-services" class="w-full mt-4 btn-secondary px-4 py-3 rounded-lg text-sm font-medium">
                            ü§ñ AI Suggest Services
                        </button>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex space-x-4">
                        <button id="generate-sow" class="flex-1 btn-primary px-6 py-4 rounded-lg font-medium text-lg">
                            üöÄ Generate AI-Powered SOW
                        </button>
                        <button id="save-sow-draft" class="btn-secondary px-6 py-4 rounded-lg font-medium text-lg">
                            üíæ Save Draft
                        </button>
                    </div>
                </div>
                
                <!-- SOW Preview -->
                <div class="space-y-6">
                    <div class="glass-effect rounded-xl shadow-lg card-elevated p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-900 flex items-center">
                                <span class="w-8 h-8 primary-gradient rounded-lg flex items-center justify-center mr-3">
                                    üìÑ
                                </span>
                                SOW Preview
                            </h2>
                            <div class="flex space-x-2">
                                <button id="export-pdf" class="btn-secondary px-4 py-2 rounded text-sm font-medium hidden">
                                    üì• Export PDF
                                </button>
                                <button id="copy-sow" class="btn-secondary px-4 py-2 rounded text-sm font-medium hidden">
                                    üìã Copy
                                </button>
                            </div>
                        </div>
                        <div id="sow-preview" class="bg-white rounded-lg border p-6 min-h-96">
                            <div class="text-center text-gray-500 py-12">
                                <div class="w-16 h-16 primary-gradient rounded-full flex items-center justify-center mx-auto mb-4 opacity-50">
                                    <span class="text-2xl text-white">üìÑ</span>
                                </div>
                                <p class="font-medium">SOW Preview</p>
                                <p class="text-sm mt-2">Fill out the form and click "Generate" to see your personalized SOW</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Research Progress -->
                    <div id="research-progress" class="glass-effect rounded-xl shadow-lg card-elevated p-6 hidden">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-6 h-6 primary-gradient rounded flex items-center justify-center mr-2">
                                üîç
                            </span>
                            AI Research Progress
                        </h3>
                        <div id="research-steps" class="space-y-3">
                            <!-- Research steps will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Innovation Tab -->
        <div id="content-innovation" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Innovation Suggestions -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">üí° AI Enhancement Suggestions</h2>
                    <div id="innovation-suggestions" class="space-y-4">
                        <!-- Innovation cards will be populated here -->
                    </div>
                    <button id="generate-innovations" class="w-full mt-6 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        Generate New AI Enhancement Ideas
                    </button>
                </div>
                
                <!-- Service Evolution -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">üìà Service Evolution</h2>
                    <div id="service-evolution" class="space-y-4">
                        <p class="text-gray-600">Track how your services evolve with AI suggestions</p>
                        <!-- Evolution timeline will be shown here -->
                    </div>
                </div>
            </div>
        </div>    </div>    <!-- Add Client Modal -->    <div id="add-client-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-2 backdrop-blur-md">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[95vh] overflow-hidden flex flex-col border border-teal-200">
            <!-- Modal Header with AI Branding -->
            <div class="relative primary-gradient px-4 py-3 text-white overflow-hidden">
                <!-- Animated background particles -->
                <div class="absolute inset-0 opacity-30">
                    <div class="absolute top-2 left-10 w-2 h-2 bg-white rounded-full animate-pulse"></div>
                    <div class="absolute top-8 left-32 w-1 h-1 bg-teal-300 rounded-full animate-ping"></div>
                    <div class="absolute top-4 right-20 w-1.5 h-1.5 bg-green-300 rounded-full animate-bounce"></div>
                    <div class="absolute bottom-3 left-24 w-1 h-1 bg-white rounded-full animate-pulse"></div>
                    <div class="absolute bottom-2 right-16 w-2 h-2 bg-teal-200 rounded-full animate-ping" style="animation-delay: 1s;"></div>
                </div>
                
                <div class="relative flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-white/20 to-white/5 rounded-xl flex items-center justify-center backdrop-blur-sm border border-white/20">
                            <span class="text-xl">üß†</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold flex items-center">
                                AI-Powered Client Intelligence
                                <span class="ml-2 text-xs bg-white text-green-600 px-2 py-0.5 rounded-full font-medium">SMART</span>
                            </h3>
                            <p class="text-teal-100 text-xs">Advanced data extraction ‚Ä¢ Real-time analysis ‚Ä¢ Intelligent insights</p>
                        </div>
                    </div>
                    <button type="button" id="cancel-add-client" class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center hover:bg-white/20 transition-all border border-white/20">
                        <span class="text-sm">‚úï</span>
                    </button>
                </div>
            </div>
            
            <!-- Modal Content: Split Screen Layout -->
            <div class="flex-grow flex flex-col lg:flex-row overflow-hidden">                <!-- Left Panel: AI Control Center -->
                <div id="client-url-panel" class="w-full lg:w-2/5 bg-gradient-to-br from-slate-800 via-teal-900 to-teal-800 p-4 flex flex-col relative overflow-hidden border-r border-teal-300/20">
                    <!-- Animated Background Effect -->
                    <div class="absolute inset-0 opacity-20" id="particles-container">
                        <!-- Particles will be generated by JS -->
                        <div class="particle" style="--tx: 100px; --ty: -50px; --r: 45deg; --duration: 8s; --delay: 0s;"></div>
                        <div class="particle" style="--tx: -80px; --ty: 70px; --r: 90deg; --duration: 10s; --delay: 0.5s;"></div>
                        <div class="particle" style="--tx: 60px; --ty: 80px; --r: 180deg; --duration: 12s; --delay: 1s;"></div>
                        <div class="particle" style="--tx: -120px; --ty: -60px; --r: 270deg; --duration: 9s; --delay: 1.5s;"></div>
                        <div class="particle" style="--tx: 90px; --ty: 120px; --r: 135deg; --duration: 11s; --delay: 2s;"></div>
                        <div class="particle" style="--tx: -70px; --ty: -100px; --r: 225deg; --duration: 14s; --delay: 2.5s;"></div>
                        <div class="particle" style="--tx: 110px; --ty: -70px; --r: 315deg; --duration: 13s; --delay: 3s;"></div>
                        <div class="particle" style="--tx: -90px; --ty: 90px; --r: 180deg; --duration: 15s; --delay: 3.5s;"></div>
                    </div>
                    
                    <div class="relative z-10">
                        <div class="flex items-center space-x-2 mb-4">
                            <div class="w-6 h-6 bg-gradient-to-r from-teal-400 to-green-500 rounded-lg flex items-center justify-center">
                                <span class="text-xs">‚ö°</span>
                            </div>
                            <h3 class="text-white text-lg font-bold">AI Intelligence Hub</h3>
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                <div class="w-2 h-2 bg-teal-400 rounded-full animate-pulse" style="animation-delay: 0.5s;"></div>
                                <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse" style="animation-delay: 1s;"></div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-white/5 rounded-xl p-4 border border-white/10 backdrop-blur-sm">
                                <label class="block text-sm font-medium text-teal-300 mb-2 uppercase tracking-wide flex items-center">
                                    üåê Company Website Analysis
                                    <span class="ml-2 text-xs bg-teal-500/20 text-teal-200 px-2 py-1 rounded-full">Required</span>
                                </label>
                                <input type="url" id="company-website" class="w-full px-4 py-3 rounded-xl bg-black/20 text-white border border-teal-500/30 focus:border-teal-400 focus:ring-2 focus:ring-teal-400/20 text-sm placeholder-gray-400 transition-all" placeholder="https://company.com">
                                <p class="text-xs text-teal-200/70 mt-2">AI will extract company profile, industry insights, and business intelligence</p>
                            </div>
                            
                            <div class="bg-white/5 rounded-xl p-4 border border-white/10 backdrop-blur-sm">
                                <label class="block text-sm font-medium text-green-300 mb-2 uppercase tracking-wide flex items-center">
                                    üìÑ Additional Company Resources
                                    <span class="ml-2 text-xs bg-green-500/20 text-green-200 px-2 py-1 rounded-full">Optional</span>
                                </label>
                                <div class="space-y-2">
                                    <input type="url" id="company-linkedin" class="w-full px-3 py-2 rounded-lg bg-black/20 text-white border border-green-500/30 focus:border-green-400 focus:ring-2 focus:ring-green-400/20 text-xs placeholder-gray-400" placeholder="LinkedIn company page (optional)">
                                    <input type="url" id="company-annual-report" class="w-full px-3 py-2 rounded-lg bg-black/20 text-white border border-green-500/30 focus:border-green-400 focus:ring-2 focus:ring-green-400/20 text-xs placeholder-gray-400" placeholder="Annual report or investor relations (optional)">
                                    <input type="url" id="company-news" class="w-full px-3 py-2 rounded-lg bg-black/20 text-white border border-green-500/30 focus:border-green-400 focus:ring-2 focus:ring-green-400/20 text-xs placeholder-gray-400" placeholder="Recent news or press releases (optional)">
                                </div>
                                <p class="text-xs text-green-200/70 mt-2">Additional sources for deeper company analysis and context</p>
                            </div>
                            
                            <div class="pt-3">
                                <button id="ai-autofill-client" type="button" class="w-full primary-gradient hover:from-teal-600 hover:via-teal-700 hover:to-green-600 text-white font-semibold py-3 px-4 rounded-xl flex items-center justify-center space-x-2 shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5 duration-300 border border-white/20">
                                    <span class="text-lg animate-bounce">üß†</span>
                                    <span class="text-sm">AI ANALYZE & EXTRACT</span>
                                    <span class="text-xs bg-white/20 px-2 py-0.5 rounded-full">BETA</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- AI Processing Animation (Hidden by default) -->
                        <div id="ai-processing-animation" class="hidden mt-4 bg-gradient-to-br from-black/30 to-blue-900/30 rounded-xl p-3 border border-cyan-500/30 backdrop-blur-sm">
                            <div class="text-center mb-3">
                                <div class="inline-flex items-center space-x-2 bg-cyan-500/20 px-3 py-1 rounded-full border border-cyan-400/30">
                                    <div class="w-2 h-2 bg-cyan-400 rounded-full animate-ping"></div>
                                    <span class="text-cyan-300 text-xs font-medium">AI PROCESSING</span>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div>
                                        <span class="text-purple-200 text-xs typing-animation" data-text="Company Research">Company Research</span>
                                    </div>
                                    <div class="w-12 h-1 bg-gray-700 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-purple-500 to-pink-400 rounded-full animate-pulse"></div>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                                        <span class="text-blue-200 text-xs typing-animation" data-text="Market Analysis">Market Analysis</span>
                                    </div>
                                    <div class="w-12 h-1 bg-gray-700 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-blue-500 to-cyan-400 rounded-full animate-pulse"></div>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                        <span class="text-green-200 text-xs typing-animation" data-text="Intelligence Synthesis">Intelligence Synthesis</span>
                                    </div>
                                    <div class="w-12 h-1 bg-gray-700 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-green-500 to-emerald-400 rounded-full animate-pulse"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3 flex justify-center">
                                <div class="w-8 h-8 border-2 border-cyan-400/30 border-t-cyan-400 rounded-full animate-spin"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Status Message -->
                    <div id="ai-autofill-status" class="hidden mt-auto pt-4 text-center text-blue-200"></div>
                </div>
                
                <!-- Right Panel: AI Intelligence Display -->
                <div class="w-full lg:w-3/5 flex flex-col bg-gradient-to-br from-slate-50 to-blue-50">
                    <!-- Tab Navigation -->
                    <div class="bg-white/80 backdrop-blur-sm border-b border-teal-200/50 px-3 pt-2">
                        <div class="flex space-x-1 overflow-x-auto">
                            <button type="button" id="tab-company-analysis" class="client-tab-btn active px-3 py-2 text-xs font-medium rounded-lg primary-gradient text-white shadow-sm">
                                <span class="flex items-center"><span class="mr-1 text-sm">üè¢</span> Company Intelligence</span>
                            </button>
                            <button type="button" id="tab-service-recommendations" class="client-tab-btn px-3 py-2 text-xs font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all">
                                <span class="flex items-center"><span class="mr-1 text-sm">‚ö°</span> AI Services</span>
                            </button>
                            <button type="button" id="tab-market-analysis" class="client-tab-btn px-3 py-2 text-xs font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all">
                                <span class="flex items-center"><span class="mr-1 text-sm">üìä</span> Market Insights</span>
                            </button>
                            <button type="button" id="tab-client-form" class="client-tab-btn px-3 py-2 text-xs font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all">
                                <span class="flex items-center"><span class="mr-1 text-sm">üìù</span> Form</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tab Content -->
                    <div class="flex-grow overflow-y-auto p-3">
                        <!-- Company Analysis Tab (Visible by default) -->
                        <div id="company-analysis-content" class="client-tab-content">
                            <div id="company-loading" class="text-center py-16 text-gray-500">
                                <p class="text-lg">Enter company website and click "AI Autofill & Analyze" to begin</p>
                            </div>
                            <div id="company-content" class="hidden">
                                <!-- Company Header -->
                                <div class="flex items-start mb-6 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl p-4 border border-gray-200">
                                    <div class="w-20 h-20 rounded-xl bg-gradient-to-br from-blue-100 to-indigo-100 flex items-center justify-center mr-4 overflow-hidden shadow-md" id="company-logo">
                                        <span class="text-3xl">üè¢</span>
                                    </div>
                                    <div class="flex-grow">
                                        <h3 class="text-2xl font-bold text-gray-900" id="company-name">-</h3>
                                        <p class="text-lg text-blue-600 font-medium" id="company-industry">-</p>
                                        <div class="mt-3 flex items-center flex-wrap gap-3 text-sm text-gray-600">
                                            <span class="flex items-center bg-white px-3 py-1 rounded-full shadow-sm border">
                                                <span class="mr-1">üë•</span>
                                                <span id="company-size">-</span>
                                            </span>
                                            <span class="flex items-center bg-white px-3 py-1 rounded-full shadow-sm border">
                                                <span class="mr-1">üìÖ</span>
                                                <span>Founded <span id="company-founded">-</span></span>
                                            </span>
                                            <span class="flex items-center bg-white px-3 py-1 rounded-full shadow-sm border">
                                                <span class="mr-1">üåç</span>
                                                <span id="company-location">-</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Company Overview Section -->
                                <div class="mb-6">
                                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6 border border-indigo-100 shadow-sm">
                                        <h4 class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                                            <span class="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center mr-3">
                                                <span class="text-white text-sm">üìã</span>
                                            </span>
                                            Company Overview
                                        </h4>
                                        <div id="company-overview" class="text-sm text-gray-700 leading-relaxed"></div>
                                    </div>
                                </div>
                                
                                <!-- Key Metrics Grid -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <div class="bg-gradient-to-r from-emerald-50 to-green-50 rounded-xl p-4 border border-emerald-100 shadow-sm">
                                        <h4 class="font-bold text-gray-900 mb-2 flex items-center">
                                            <span class="w-6 h-6 bg-emerald-500 rounded flex items-center justify-center mr-2">
                                                <span class="text-white text-xs">üíº</span>
                                            </span>
                                            Business Model
                                        </h4>
                                        <div id="company-business-model" class="text-sm text-gray-700"></div>
                                    </div>
                                    <div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-4 border border-blue-100 shadow-sm">
                                        <h4 class="font-bold text-gray-900 mb-2 flex items-center">
                                            <span class="w-6 h-6 bg-blue-500 rounded flex items-center justify-center mr-2">
                                                <span class="text-white text-xs">üéØ</span>
                                            </span>
                                            Target Market
                                        </h4>
                                        <div id="company-target-market" class="text-sm text-gray-700"></div>
                                    </div>
                                    <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-4 border border-orange-100 shadow-sm">
                                        <h4 class="font-bold text-gray-900 mb-2 flex items-center">
                                            <span class="w-6 h-6 bg-orange-500 rounded flex items-center justify-center mr-2">
                                                <span class="text-white text-xs">üí∞</span>
                                            </span>
                                            Revenue Model
                                        </h4>
                                        <div id="company-revenue-model" class="text-sm text-gray-700"></div>
                                    </div>
                                </div>
                                
                                <!-- Market Analysis & Competitive Landscape -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div class="bg-gradient-to-r from-yellow-50 to-amber-50 rounded-xl p-4 border border-yellow-100 shadow-sm">
                                        <h4 class="font-bold text-gray-900 mb-3 flex items-center">
                                            <span class="w-6 h-6 bg-yellow-500 rounded flex items-center justify-center mr-2">
                                                <span class="text-white text-xs">üìà</span>
                                            </span>
                                            Market Position & Trends
                                        </h4>
                                        <div id="company-market" class="text-sm text-gray-700"></div>
                                    </div>
                                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4 border border-purple-100 shadow-sm">
                                        <h4 class="font-bold text-gray-900 mb-3 flex items-center">
                                            <span class="w-6 h-6 bg-purple-500 rounded flex items-center justify-center mr-2">
                                                <span class="text-white text-xs">‚öîÔ∏è</span>
                                            </span>
                                            Competitive Landscape
                                        </h4>
                                        <div id="company-competition" class="text-sm text-gray-700"></div>
                                    </div>
                                </div>
                                
                                <!-- Technology & Innovation -->
                                <div class="mb-6">
                                    <div class="bg-gradient-to-r from-teal-50 to-cyan-50 rounded-xl p-4 border border-teal-100 shadow-sm">
                                        <h4 class="font-bold text-gray-900 mb-3 flex items-center">
                                            <span class="w-6 h-6 bg-teal-500 rounded flex items-center justify-center mr-2">
                                                <span class="text-white text-xs">üöÄ</span>
                                            </span>
                                            Technology Stack & Innovation
                                        </h4>
                                        <div id="company-technology" class="text-sm text-gray-700"></div>
                                    </div>
                                </div>
                                
                                <!-- Challenges & Opportunities -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-gradient-to-r from-red-50 to-rose-50 rounded-xl p-4 border border-red-100 shadow-sm">
                                        <h4 class="font-bold text-gray-900 mb-3 flex items-center">
                                            <span class="w-6 h-6 bg-red-500 rounded flex items-center justify-center mr-2">
                                                <span class="text-white text-xs">‚ö†Ô∏è</span>
                                            </span>
                                            Key Challenges
                                        </h4>
                                        <div id="company-challenges" class="text-sm text-gray-700"></div>
                                    </div>
                                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 border border-green-100 shadow-sm">
                                        <h4 class="font-bold text-gray-900 mb-3 flex items-center">
                                            <span class="w-6 h-6 bg-green-500 rounded flex items-center justify-center mr-2">
                                                <span class="text-white text-xs">üí°</span>
                                            </span>
                                            Growth Opportunities
                                        </h4>
                                        <div id="company-opportunities" class="text-sm text-gray-700"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Service Recommendations Tab (Hidden by default) -->
                        <div id="service-recommendations-content" class="client-tab-content hidden">
                            <div id="services-loading" class="text-center py-16 text-gray-500">
                                <p class="text-lg">AI will analyze and recommend services after profile data is extracted</p>
                            </div>
                            <div id="services-content" class="hidden">
                                <h3 class="text-lg font-bold mb-4">AI-Recommended Services for <span id="rec-client-name">this client</span></h3>
                                
                                <div class="mb-6 bg-blue-50 rounded-lg p-4 border border-blue-100">
                                    <h4 class="font-medium text-gray-900 mb-2">Recommendation Basis</h4>
                                    <p class="text-sm text-gray-600" id="recommendation-basis"></p>
                                </div>
                                
                                <div id="recommended-services" class="space-y-4">
                                    <!-- Service recommendations will be inserted here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Client Form Tab (Hidden by default) -->                        <div id="client-form-content" class="client-tab-content hidden">
                            <form id="client-form-tab-form" class="space-y-4">
                                <!-- Section 1: Basic Information -->
                                <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 shadow-sm">
                                    <h4 class="font-medium text-gray-900 mb-3 flex items-center text-sm">
                                        <span class="w-4 h-4 primary-gradient rounded flex items-center justify-center mr-2 text-white text-xs">üë§</span>
                                        Basic Information
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Client Name *</label>
                                            <input type="text" id="client-name" class="form-input w-full px-2 py-1.5 rounded text-sm border-gray-300" required placeholder="John Smith">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Company</label>
                                            <input type="text" id="client-company" class="form-input w-full px-2 py-1.5 rounded text-sm border-gray-300" placeholder="Acme Corp">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Status *</label>
                                            <select id="client-status" class="form-select w-full px-2 py-1.5 rounded text-sm border-gray-300" required>
                                                <option value="cold">‚ùÑÔ∏è Cold Lead</option>
                                                <option value="warm">üå°Ô∏è Warm Lead</option>
                                                <option value="hot">üî• Hot Lead</option>
                                                <option value="client">‚úÖ Active Client</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Priority</label>
                                            <select id="client-priority" class="form-select w-full px-2 py-1.5 rounded text-sm border-gray-300">
                                                <option value="low">üü¢ Low</option>
                                                <option value="medium" selected>üü° Medium</option>
                                                <option value="high">üî¥ High</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Section 2: Contact & Business Details -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <div class="bg-gradient-to-r from-green-50 to-teal-50 rounded-lg p-4 shadow-sm h-full">
                                            <h4 class="font-medium text-gray-900 mb-3 flex items-center text-sm">
                                                <span class="w-4 h-4 primary-gradient rounded flex items-center justify-center mr-2 text-white text-xs">üìû</span>
                                                Contact Details
                                            </h4>
                                            <div class="space-y-3">
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-700 mb-1">Email</label>
                                                    <input type="email" id="client-email" class="form-input w-full px-2 py-1.5 rounded text-sm border-gray-300" placeholder="john@acme.com">
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-700 mb-1">Phone</label>
                                                    <input type="tel" id="client-phone" class="form-input w-full px-2 py-1.5 rounded text-sm border-gray-300" placeholder="+1 (555) 123-4567">
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-700 mb-1">Location</label>
                                                    <input type="text" id="client-location" class="form-input w-full px-2 py-1.5 rounded text-sm border-gray-300" placeholder="City, Country">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-4 shadow-sm h-full">
                                            <h4 class="font-medium text-gray-900 mb-3 flex items-center text-sm">
                                                <span class="w-4 h-4 primary-gradient rounded flex items-center justify-center mr-2 text-white text-xs">üè¢</span>
                                                Business Details
                                            </h4>
                                            <div class="space-y-3">
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-700 mb-1">Industry</label>
                                                    <select id="client-industry" class="form-select w-full px-2 py-1.5 rounded text-sm border-gray-300">
                                                        <option value="">Select Industry</option>
                                                        <option value="technology">üíª Technology</option>
                                                        <option value="healthcare">üè• Healthcare</option>
                                                        <option value="finance">üí∞ Finance</option>
                                                        <option value="retail">üõçÔ∏è Retail</option>
                                                        <option value="manufacturing">üè≠ Manufacturing</option>
                                                        <option value="education">üéì Education</option>
                                                        <option value="real-estate">üè† Real Estate</option>
                                                        <option value="other">üåê Other</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-700 mb-1">Company Size</label>
                                                    <select id="client-size" class="form-select w-full px-2 py-1.5 rounded text-sm border-gray-300">
                                                        <option value="">Select Size</option>
                                                        <option value="1-10">1-10 employees</option>
                                                        <option value="11-50">11-50 employees</option>
                                                        <option value="51-200">51-200 employees</option>
                                                        <option value="201-500">201-500 employees</option>
                                                        <option value="501-1000">501-1000 employees</option>
                                                        <option value="1000+">1000+ employees</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-700 mb-1">Deal Value ($)</label>
                                                    <input type="number" id="client-deal-value" class="form-input w-full px-2 py-1.5 rounded text-sm border-gray-300" min="0" step="1000" placeholder="50000">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Section 3: Notes & Documents -->
                                <div class="bg-gradient-to-r from-gray-50 to-slate-50 rounded-lg p-4 shadow-sm">
                                    <h4 class="font-medium text-gray-900 mb-3 flex items-center text-sm">
                                        <span class="w-4 h-4 primary-gradient rounded flex items-center justify-center mr-2 text-white text-xs">üìù</span>
                                        Notes & Requirements
                                    </h4>
                                    <textarea id="client-description" rows="3" class="form-textarea w-full px-2 py-1.5 rounded text-sm border-gray-300" 
                                              placeholder="Business needs, pain points, objectives..."></textarea>
                                              
                                    <div class="mt-3">
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Documents Upload</label>
                                        <input type="file" id="client-docs" multiple 
                                               accept=".pdf,.txt,.doc,.docx,.ppt,.pptx,.csv,.xlsx" 
                                               class="form-input w-full px-2 py-1.5 rounded text-sm border-gray-300">
                                        <p class="text-xs text-gray-500 mt-1">
                                            Upload RFPs, business plans - AI will analyze automatically
                                        </p>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
              <!-- Modal Footer -->
            <div class="bg-gradient-to-r from-slate-800 via-blue-900 to-indigo-900 px-4 py-3 flex items-center justify-between border-t border-blue-500/20">
                <button type="button" id="cancel-add-client-footer" class="px-4 py-2 rounded-lg text-sm font-medium text-gray-300 hover:text-white hover:bg-white/10 transition-all border border-gray-600 hover:border-gray-500">
                    Cancel
                </button>
                <div class="flex items-center space-x-2">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.5s;"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse" style="animation-delay: 1s;"></div>
                    </div>
                    <p class="text-xs text-blue-200">AI Analysis Complete ‚Ä¢ Ready for Review</p>
                </div>
                <button type="submit" id="update-client-info-btn" form="client-form-tab-form" class="bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-500 hover:to-emerald-600 text-white px-6 py-2 rounded-lg text-sm font-semibold shadow-lg hover:shadow-xl transition-all flex items-center space-x-2 border border-green-500/30">
                    <span class="text-lg">üöÄ</span>
                    <span>CREATE CLIENT</span>
                    <span class="text-xs bg-white/20 px-2 py-0.5 rounded-full">AI</span>
                </button>
            </div>
        </div>
    </div>
                    </div>
                    <button type="button" id="cancel-add-client" class="w-6 h-6 bg-white bg-opacity-20 rounded flex items-center justify-center hover:bg-opacity-30 transition-all">
                        <span class="text-sm">‚úï</span>
                    </button>
                </div>            </div>
            
            <!-- Modal Content -->
            <div class="p-4 overflow-y-auto flex-grow" style="max-height: calc(90vh - 120px);">
                <form id="add-client-form" class="space-y-4">
                    <!-- Section 1: Basic Information -->
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 shadow-sm">
                        <h4 class="font-medium text-gray-900 mb-3 flex items-center text-sm">
                            <span class="w-4 h-4 primary-gradient rounded flex items-center justify-center mr-2 text-white text-xs">üë§</span>
                            Basic Information
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Client Name *</label>
                                <input type="text" id="client-name" class="form-input w-full px-2 py-1.5 rounded text-sm" required placeholder="John Smith">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Company</label>
                                <input type="text" id="client-company" class="form-input w-full px-2 py-1.5 rounded text-sm" placeholder="Acme Corp">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Status *</label>
                                <select id="client-status" class="form-input w-full px-2 py-1.5 rounded text-sm" required>
                                    <option value="cold">‚ùÑÔ∏è Cold Lead</option>
                                    <option value="warm">üå°Ô∏è Warm Lead</option>
                                    <option value="hot">üî• Hot Lead</option>
                                    <option value="client">‚úÖ Active Client</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Priority</label>
                                <select id="client-priority" class="form-input w-full px-2 py-1.5 rounded text-sm">
                                    <option value="low">üü¢ Low</option>
                                    <option value="medium" selected>üü° Medium</option>
                                    <option value="high">üî¥ High</option>
                                </select>
                            </div>
                        </div>
                    </div>                    <!-- Section 2: Contact & Business Details -->
                    <div class="bg-gradient-to-r from-green-50 to-teal-50 rounded-lg p-4 shadow-sm">
                        <h4 class="font-medium text-gray-900 mb-3 flex items-center text-sm">
                            <span class="w-4 h-4 primary-gradient rounded flex items-center justify-center mr-2 text-white text-xs">üè¢</span>
                            Contact & Business Details
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="client-email" class="form-input w-full px-2 py-1.5 rounded text-sm" placeholder="john@acme.com">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Phone</label>
                                <input type="tel" id="client-phone" class="form-input w-full px-2 py-1.5 rounded text-sm" placeholder="+1 (555) 123-4567">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">LinkedIn URL</label>
                                <input type="url" id="client-linkedin" class="form-input w-full px-2 py-1.5 rounded text-sm" placeholder="https://linkedin.com/in/username">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Company Website</label>
                                <input type="url" id="client-website" class="form-input w-full px-2 py-1.5 rounded text-sm" placeholder="https://company.com">
                            </div>                        </div>
                        
                        <div class="flex flex-wrap items-center justify-between gap-3 mb-4 bg-blue-50 p-3 rounded-md border border-blue-100">
                            <button id="ai-autofill-client" type="button" class="btn-primary bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-xs px-4 py-2 rounded-md flex items-center space-x-2 shadow hover:shadow-md transition-all">
                                <span>ü§ñ</span>
                                <span>AI Autofill from URLs</span>
                            </button>
                            <div id="ai-autofill-status" class="text-xs text-gray-600 hidden p-2 bg-white rounded-md shadow-sm">
                                <div class="flex items-center">
                                    <svg class="animate-spin h-4 w-4 text-indigo-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span>Analyzing profiles...</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Industry</label>
                                <select id="client-industry" class="form-input w-full px-2 py-1.5 rounded text-sm">
                                    <option value="">Select Industry</option>
                                    <option value="technology">üíª Technology</option>
                                    <option value="healthcare">üè• Healthcare</option>
                                    <option value="finance">üí∞ Finance</option>
                                    <option value="retail">üõçÔ∏è Retail</option>
                                    <option value="manufacturing">üè≠ Manufacturing</option>
                                    <option value="education">üéì Education</option>
                                    <option value="real-estate">üè† Real Estate</option>
                                    <option value="other">üåê Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Deal Value ($)</label>
                                <input type="number" id="client-deal-value" class="form-input w-full px-2 py-1.5 rounded text-sm" min="0" step="1000" placeholder="50000">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Location</label>
                                <input type="text" id="client-location" class="form-input w-full px-2 py-1.5 rounded text-sm" placeholder="City, Country">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Company Size</label>
                                <select id="client-size" class="form-input w-full px-2 py-1.5 rounded text-sm">
                                    <option value="">Select Size</option>
                                    <option value="1-10">1-10 employees</option>
                                    <option value="11-50">11-50 employees</option>
                                    <option value="51-200">51-200 employees</option>
                                    <option value="201-500">201-500 employees</option>
                                    <option value="501-1000">501-1000 employees</option>
                                    <option value="1000+">1000+ employees</option>
                                </select>
                            </div>
                        </div>
                    </div>
                      <!-- Section 3: Documents & Notes -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-lg p-4 shadow-sm">
                            <h4 class="font-medium text-gray-900 mb-3 flex items-center text-sm">
                                <span class="w-4 h-4 primary-gradient rounded flex items-center justify-center mr-2 text-white text-xs">üìÑ</span>
                                Documents Upload
                            </h4>
                            <input type="file" id="client-docs" multiple 
                                   accept=".pdf,.txt,.doc,.docx,.ppt,.pptx,.csv,.xlsx" 
                                   class="form-input w-full px-2 py-1.5 rounded text-sm border border-gray-300">
                            <p class="text-xs text-gray-500 mt-2">
                                Upload RFPs, business plans - AI will analyze automatically
                            </p>
                        </div>
                        
                        <div class="bg-gradient-to-r from-gray-50 to-slate-50 rounded-lg p-4 shadow-sm">
                            <h4 class="font-medium text-gray-900 mb-3 flex items-center text-sm">
                                <span class="w-4 h-4 primary-gradient rounded flex items-center justify-center mr-2 text-white text-xs">üìù</span>
                                Notes & Requirements
                            </h4>
                            <textarea id="client-description" rows="3" class="form-input w-full px-2 py-1.5 rounded text-sm" 
                                      placeholder="Business needs, pain points, objectives..."></textarea>
                        </div>
                    </div>
                      <!-- AI Features Highlight -->
                    <div class="primary-gradient rounded-lg p-4 text-white shadow-md">
                        <h4 class="font-medium mb-3 flex items-center text-sm">
                            <span class="w-5 h-5 bg-white bg-opacity-20 rounded flex items-center justify-center mr-2 text-xs">ü§ñ</span>
                            AI-Powered Features Included
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                            <div class="flex items-center space-x-2 bg-white bg-opacity-10 rounded-md p-1.5">
                                <span class="w-4 h-4 bg-green-400 rounded-full flex items-center justify-center text-xs">‚úì</span>
                                <span>Dedicated AI workspace creation</span>
                            </div>
                            <div class="flex items-center space-x-2 bg-white bg-opacity-10 rounded-md p-1.5">
                                <span class="w-4 h-4 bg-green-400 rounded-full flex items-center justify-center text-xs">‚úì</span>
                                <span>Automatic document processing & embedding</span>
                            </div>
                            <div class="flex items-center space-x-2 bg-white bg-opacity-10 rounded-md p-1.5">
                                <span class="w-4 h-4 bg-green-400 rounded-full flex items-center justify-center text-xs">‚úì</span>
                                <span>AI analysis of client needs & service matching</span>
                            </div>
                            <div class="flex items-center space-x-2 bg-white bg-opacity-10 rounded-md p-1.5">
                                <span class="w-4 h-4 bg-green-400 rounded-full flex items-center justify-center text-xs">‚úì</span>
                                <span>Persistent data storage & activity tracking</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <!-- Modal Footer -->
            <div class="bg-gray-50 px-4 py-3 flex space-x-3 border-t border-gray-200">
                <button type="button" id="cancel-add-client-footer" class="flex-1 btn-secondary px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-200 transition-colors">
                    Cancel
                </button>
                <button type="submit" form="add-client-form" class="flex-2 btn-primary px-4 py-2 rounded-md text-sm font-medium shadow-sm hover:shadow-md transition-all">
                    üöÄ Create Client & AI Workspace
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const ANYTHINGLLM_CONFIG = {
            baseUrl: 'https://socialgarden-anything-llm.vo0egb.easypanel.host',
            apiKey: 'F7C84WV-75N4QWH-P9ERFRV-CWJ146T',
            workspace: 'main'
        };        // --- Application State ---
        let currentTab = 'knowledge';        let clients = [];
        let services = [];
        let selectedClient = null;
        let clientWorkspaces = new Map(); // Track client workspaces
        
        // --- UNIFIED DATA STRUCTURES ---
        
        // Unified Client Data Structure (CRM + SOW compatible)
        class UnifiedClient {
            constructor(data = {}) {
                // Basic Info                this.id = data.id || Date.now().toString();
                this.name = data.name || '';
                this.company = data.company || '';
                this.email = data.email || '';
                this.phone = data.phone || '';
                this.websiteUrl = data.websiteUrl || '';
                this.linkedinUrl = data.linkedinUrl || '';
                this.location = data.location || '';
                
                // Business Context
                this.industry = data.industry || '';
                this.companySize = data.companySize || '';
                this.annualRevenue = data.annualRevenue || '';
                this.businessModel = data.businessModel || '';
                
                // CRM Fields
                this.status = data.status || 'cold'; // cold, warm, hot, client
                this.priority = data.priority || 'medium'; // low, medium, high
                this.dealValue = data.dealValue || 0;
                this.source = data.source || '';
                this.assignedTo = data.assignedTo || '';
                
                // SOW-Specific Fields
                this.projectType = data.projectType || '';
                this.serviceNeeds = data.serviceNeeds || [];
                this.budget = data.budget || '';
                this.timeline = data.timeline || '';
                this.decisionMakers = data.decisionMakers || [];
                this.currentChallenges = data.currentChallenges || '';
                this.successMetrics = data.successMetrics || '';
                
                // AI Research Data
                this.researchData = data.researchData || {
                    companyProfile: null,
                    industryContext: null,
                    technologyLandscape: null,
                    competitiveAnalysis: null,
                    complianceRequirements: null,
                    lastResearchDate: null
                };
                
                // Documents & Attachments
                this.documents = data.documents || [];
                this.notes = data.notes || '';
                this.tags = data.tags || [];
                
                // SOW History
                this.sowHistory = data.sowHistory || [];
                this.activeSOW = data.activeSOW || null;
                
                // AI Workspace Integration
                this.workspaceSlug = data.workspaceSlug || null;
                this.workspaceId = data.workspaceId || null;
                
                // Timestamps
                this.createdAt = data.createdAt || new Date().toISOString();
                this.updatedAt = data.updatedAt || new Date().toISOString();
                this.lastContactDate = data.lastContactDate || null;
                this.nextFollowUpDate = data.nextFollowUpDate || null;
            }
            
            // Helper Methods
            updateTimestamp() {
                this.updatedAt = new Date().toISOString();
            }
            
            addSOW(sowData) {
                const sow = new UnifiedSOW(sowData);
                sow.clientId = this.id;
                this.sowHistory.push(sow);
                this.activeSOW = sow.id;
                this.updateTimestamp();
                return sow;
            }
            
            addNote(note) {
                this.notes += `\n[${new Date().toLocaleDateString()}] ${note}`;
                this.updateTimestamp();
            }
            
            addDocument(doc) {
                this.documents.push({
                    id: Date.now().toString(),
                    name: doc.name,
                    type: doc.type,
                    size: doc.size,
                    uploadDate: new Date().toISOString(),
                    data: doc.data || null
                });
                this.updateTimestamp();
            }
        }
          // NEW, UPGRADED SOW DATA MODEL
        class UnifiedSOW {
            constructor(data = {}) {
                this.id = data.id || `sow_${Date.now()}`;
                this.clientId = data.clientId || null;
                this.title = data.title || 'Untitled Scope of Work';
                this.status = data.status || 'draft';

                // Core SOW Content Sections
                this.overview = data.overview || '';
                this.projectOutcomes = data.projectOutcomes || []; // Array of strings
                this.scopeAssumptions = data.scopeAssumptions || []; // Array of strings
                
                // This is the most important change: An array to hold phase objects
                this.phases = data.phases || []; 
                /*
                Example of a phase object that will go in this array:
                { 
                  title: 'Phase 1: Discovery & Design', 
                  deliverables: ['Deliverable 1 text', 'Deliverable 2 text'],
                  pricingTable: [
                    { role: 'Tech - Sr. Consultant', hours: 10, rate: 295, cost: 2950 },
                    { role: 'Account Manager', hours: 4, rate: 180, cost: 720 }
                  ],
                  phaseTotal: 3670
                }
                */

                // Financial Summary
                this.subTotal = data.subTotal || 0;
                this.budgetNotes = data.budgetNotes || '';
                this.finalSummary = data.finalSummary || {
                    discountAmount: 0,
                    totalAfterDiscount: 0,
                    gstAmount: 0,
                    grandTotal: 0
                };

                // Legacy compatibility fields
                this.version = data.version || '1.0';
                this.executiveSummary = data.executiveSummary || '';
                this.projectOverview = data.projectOverview || '';
                this.scope = data.scope || '';
                this.deliverables = data.deliverables || [];
                this.timeline = data.timeline || '';
                this.pricing = data.pricing || {
                    subtotal: 0,
                    tax: 0,
                    total: 0,
                    currency: 'USD'
                };
                this.assumptions = data.assumptions || '';
                this.risks = data.risks || '';
                this.nextSteps = data.nextSteps || '';
                this.selectedServices = data.selectedServices || [];
                this.teamMembers = data.teamMembers || [];                this.estimatedHours = data.estimatedHours || 0;
                
                // Research Integration
                this.researchUsed = data.researchUsed || [];
                this.personalizationLevel = data.personalizationLevel || 'basic';
                
                // Metadata
                this.createdAt = data.createdAt || new Date().toISOString();
                this.updatedAt = data.updatedAt || new Date().toISOString();
                this.createdBy = data.createdBy || 'System';
            }
            
            updateTimestamp() {
                this.updatedAt = new Date().toISOString();
            }
        }
        
        // Data Storage & Synchronization
        const DataManager = {
            // Save all data to localStorage
            saveToStorage() {
                localStorage.setItem('socialgarden_unified_clients', JSON.stringify(clients));
                localStorage.setItem('socialgarden_client_workspaces', JSON.stringify([...clientWorkspaces]));
                localStorage.setItem('socialgarden_services', JSON.stringify(services));
            },
            
            // Load data from localStorage
            loadFromStorage() {
                try {
                    const savedClients = localStorage.getItem('socialgarden_unified_clients');
                    if (savedClients) {
                        const clientData = JSON.parse(savedClients);
                        clients = clientData.map(data => new UnifiedClient(data));
                    }
                    
                    const savedWorkspaces = localStorage.getItem('socialgarden_client_workspaces');
                    if (savedWorkspaces) {
                        clientWorkspaces = new Map(JSON.parse(savedWorkspaces));
                    }
                    
                    const savedServices = localStorage.getItem('socialgarden_services');
                    if (savedServices) {
                        services = JSON.parse(savedServices);
                    }
                } catch (error) {
                    console.error('Error loading data from storage:', error);
                }
            },
            
            // Find client by ID
            getClientById(id) {
                return clients.find(client => client.id === id);
            },
            
            // Add or update client
            saveClient(clientData) {
                const existingIndex = clients.findIndex(c => c.id === clientData.id);
                const client = new UnifiedClient(clientData);
                
                if (existingIndex >= 0) {
                    clients[existingIndex] = client;
                } else {
                    clients.push(client);
                }
                
                this.saveToStorage();
                return client;
            },
              // Delete client
            deleteClient(id) {
                clients = clients.filter(c => c.id !== id);
                this.saveToStorage();
            },
            
            // Get service catalog
            getServiceCatalog() {
                // Try to load from localStorage if not already loaded
                if (!this.serviceCatalog) {
                    const savedCatalog = localStorage.getItem('socialgarden_service_catalog');
                    if (savedCatalog) {
                        try {
                            this.serviceCatalog = JSON.parse(savedCatalog);
                        } catch (e) {
                            console.error('Error parsing saved service catalog:', e);
                            this.serviceCatalog = { categories: [], services: [] };
                        }
                    } else {
                        this.serviceCatalog = { categories: [], services: [] };
                    }
                }
                return this.serviceCatalog;
            },
            
            // Set service catalog
            setServiceCatalog(catalog) {
                this.serviceCatalog = catalog;
                localStorage.setItem('socialgarden_service_catalog', JSON.stringify(catalog));
            },
            
            // Get service by ID
            getServiceById(id) {
                const catalog = this.getServiceCatalog();
                return catalog.services.find(service => service.id === id);
            },
              // Get services by category
            getServicesByCategory(categoryId) {
                const catalog = this.getServiceCatalog();
                return catalog.services.filter(service => service.category === categoryId);
            },
            
            // Search clients
            searchClients(query) {
                const searchTerm = query.toLowerCase();
                return clients.filter(client => 
                    client.name.toLowerCase().includes(searchTerm) ||
                    client.company.toLowerCase().includes(searchTerm) ||
                    client.email.toLowerCase().includes(searchTerm) ||                    client.industry.toLowerCase().includes(searchTerm)
                );
            }
        };
        
        // Initialize particle effects in the client modal
        function initializeParticleEffects() {
            const container = document.getElementById('particles-container');
            if (!container) return;
            
            // Create additional random particles
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Set random transform values
                const tx = (Math.random() * 200 - 100) + 'px';
                const ty = (Math.random() * 200 - 100) + 'px';
                const r = Math.random() * 360 + 'deg';
                const duration = (Math.random() * 10 + 5) + 's';
                const delay = (Math.random() * 5) + 's';
                
                particle.style.setProperty('--tx', tx);
                particle.style.setProperty('--ty', ty);
                particle.style.setProperty('--r', r);
                particle.style.setProperty('--duration', duration);
                particle.style.setProperty('--delay', delay);
                
                // Set random position
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                
                // Set random size
                const size = Math.random() * 6 + 2;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                
                // Add to container                container.appendChild(particle);
            }
        }
        
        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            initializeKnowledgeVisualization();
            initializeChatInterface();
            initializeViewToggles();
            initializeClientManagement();
            initializeParticleEffects();
            loadServicesFromKB();
              // Load all data using unified DataManager
            DataManager.loadFromStorage();
            renderClientList(); // Re-render clients with new data structure
        });

        // --- Tab Management ---
        function initializeTabs() {
            const tabs = ['knowledge', 'clients', 'sow', 'innovation'];
            
            tabs.forEach(tab => {
                document.getElementById(`tab-${tab}`).addEventListener('click', () => {
                    switchTab(tab);
                });
            });
        }

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {                btn.className = btn.id === `tab-${tab}` ? 
                    'tab-active px-6 py-3 rounded-lg font-medium transition-all' :
                    'tab-inactive px-6 py-3 rounded-lg font-medium transition-all';
            });
            
            // Update content
            document.querySelectorAll('[id^="content-"]').forEach(content => {                if (content.id === `content-${tab}`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
            
            currentTab = tab;
        }
        
        // --- Knowledge Visualization ---
        function initializeKnowledgeVisualization() {
            // Set default view to grid and render when services are loaded
            console.log('Initializing knowledge visualization...');
        }

        // --- Chat Interface ---
        function initializeChatInterface() {
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-chat');
            
            sendButton.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });

            // Quick questions
            document.querySelectorAll('.quick-question').forEach(btn => {
                btn.addEventListener('click', () => {
                    chatInput.value = btn.textContent;
                    sendChatMessage();
                });
            });
        }        // --- Markdown Helper ---
        function parseMarkdown(text) {
            // Simple markdown parser for basic formatting
            let html = text
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Bold
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/__(.*?)__/gim, '<strong>$1</strong>')
                // Italic
                .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                .replace(/_(.*?)_/gim, '<em>$1</em>')
                // Code blocks
                .replace(/```([\s\S]*?)```/gim, '<pre><code>$1</code></pre>')
                // Inline code
                .replace(/`([^`]+)`/gim, '<code>$1</code>')
                // Lists
                .replace(/^\* (.*$)/gim, '<li>$1</li>')
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
                // Line breaks
                .replace(/\n\n/gim, '</p><p>')
                .replace(/\n/gim, '<br>');
            
            // Wrap in paragraphs and handle lists
            html = '<p>' + html + '</p>';
            html = html.replace(/<p>(<li>.*<\/li>)<\/p>/gim, '<ul>$1</ul>');
            html = html.replace(/<\/li><br><li>/gim, '</li><li>');
            html = html.replace(/<p><\/p>/gim, '');
            
            return html;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            const chatMessages = document.getElementById('chat-messages');
            
            // Add user message
            const userMessage = document.createElement('div');
            userMessage.className = 'user-message chat-message';
            userMessage.innerHTML = `<p>${message}</p>`;
            chatMessages.appendChild(userMessage);
            
            // Clear input
            input.value = '';
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator chat-message';
            typingIndicator.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            chatMessages.appendChild(typingIndicator);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // Call AnythingLLM API
                const response = await callAnythingLLM(message);
                
                // Remove typing indicator
                typingIndicator.remove();
                
                // Add AI response with markdown parsing
                const aiMessage = document.createElement('div');
                aiMessage.className = 'ai-message chat-message';
                aiMessage.innerHTML = parseMarkdown(response);
                chatMessages.appendChild(aiMessage);
                
            } catch (error) {
                typingIndicator.remove();
                const errorMessage = document.createElement('div');
                errorMessage.className = 'ai-message chat-message border border-red-200';
                errorMessage.innerHTML = `<p class="text-red-600">Sorry, I encountered an error: ${error.message}</p>`;
                chatMessages.appendChild(errorMessage);
            }
              // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // --- Client Management ---
        function initializeClientManagement() {
            document.getElementById('add-client').addEventListener('click', () => {
                document.getElementById('add-client-modal').classList.remove('hidden');
                document.getElementById('add-client-modal').classList.add('flex');
            });
            
            document.getElementById('cancel-add-client').addEventListener('click', () => {
                document.getElementById('add-client-modal').classList.add('hidden');
                document.getElementById('add-client-modal').classList.remove('flex');
            });
            
            document.getElementById('cancel-add-client-footer').addEventListener('click', () => {
                document.getElementById('add-client-modal').classList.add('hidden');
                document.getElementById('add-client-modal').classList.remove('flex');
            });
            
            document.getElementById('add-client-form').addEventListener('submit', addClient);
            
            // AI Autofill from LinkedIn and Website
            document.getElementById('ai-autofill-client').addEventListener('click', aiAutofillClientData);
            
            // Search functionality
            document.getElementById('client-search').addEventListener('input', filterClients);
            document.getElementById('status-filter').addEventListener('change', filterClients);
            
            // Client modal tab switching
            document.querySelectorAll('.client-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Remove active class from all tabs
                    document.querySelectorAll('.client-tab-btn').forEach(tab => {
                        tab.classList.remove('active');
                        tab.classList.remove('border-blue-500');
                        tab.classList.add('text-gray-500');
                    });
                    
                    // Add active class to clicked tab
                    e.currentTarget.classList.add('active');
                    e.currentTarget.classList.add('border-b-2');
                    e.currentTarget.classList.add('border-blue-500');
                    e.currentTarget.classList.remove('text-gray-500');
                    
                    // Hide all tab content
                    document.querySelectorAll('.client-tab-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show corresponding tab content
                    const tabId = e.currentTarget.id;
                    const contentId = tabId.replace('tab-', '') + '-content';
                    document.getElementById(contentId).classList.remove('hidden');
                });
            });
        }

        // Load clients from localStorage
        function loadClientsFromStorage() {
            const savedClients = localStorage.getItem('socialgarden_clients');
            const savedWorkspaces = localStorage.getItem('socialgarden_client_workspaces');
            
            if (savedClients) {
                clients = JSON.parse(savedClients);
                renderClientList();
            }
            
            if (savedWorkspaces) {
                clientWorkspaces = new Map(JSON.parse(savedWorkspaces));
            }
        }
        
        // Save clients to localStorage
        function saveClientsToStorage() {
            localStorage.setItem('socialgarden_clients', JSON.stringify(clients));
            localStorage.setItem('socialgarden_client_workspaces', JSON.stringify([...clientWorkspaces]));
        }
        
        async function addClient(e) {
            e.preventDefault();
            
            const clientName = document.getElementById('client-name').value;
            const clientStatus = document.getElementById('client-status').value;
            const clientDescription = document.getElementById('client-description').value;
            const clientDocs = document.getElementById('client-docs').files;
            
            // Get additional CRM fields
            const clientCompany = document.getElementById('client-company').value;
            const clientIndustry = document.getElementById('client-industry').value;
            const clientEmail = document.getElementById('client-email').value;
            const clientPhone = document.getElementById('client-phone').value;
            const clientDealValue = parseInt(document.getElementById('client-deal-value').value) || 0;
            const clientPriority = document.getElementById('client-priority').value;
            const clientLocation = document.getElementById('client-location').value;
            const clientSize = document.getElementById('client-size').value;
            const linkedinUrl = document.getElementById('linkedin-url').value;
            const websiteUrl = document.getElementById('company-website').value;
              
            // Show loading state
            const submitBtn = document.querySelector('button[form="add-client-form"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating Client & Workspace...';
            submitBtn.disabled = true;
            
            try {
                // Create workspace in AnythingLLM for this client
                const workspaceSlug = await createClientWorkspace(clientName);
                
                // Upload documents to the client's workspace
                const uploadedDocs = [];
                if (clientDocs.length > 0) {
                    for (let file of clientDocs) {
                        try {
                            const docResult = await uploadDocumentToWorkspace(file, workspaceSlug);
                            uploadedDocs.push(docResult);
                        } catch (error) {
                            console.error('Error uploading document:', error);
                            showToast(`Warning: Failed to upload ${file.name}`, 'warning');
                        }
                    }
                }
                  const newClient = {
                    id: Date.now(),
                    name: clientName,
                    company: clientCompany,
                    industry: clientIndustry,
                    email: clientEmail,
                    phone: clientPhone,
                    status: clientStatus,
                    priority: clientPriority,
                    notes: clientDescription,
                    location: clientLocation,
                    companySize: clientSize,
                    linkedinUrl: linkedinUrl,
                    websiteUrl: websiteUrl,
                    documents: uploadedDocs,
                    workspaceSlug: workspaceSlug,
                    dealValue: clientDealValue,
                    createdAt: new Date(),
                    lastContactDate: new Date(),
                    activities: [{
                        id: Date.now(),
                        activity: 'Client created with AI workspace',
                        timestamp: new Date(),
                        type: 'system'
                    }],
                    aiInsights: null,
                    lastAnalyzed: null,
                    sowHistory: []
                };

                clients.push(newClient);
                clientWorkspaces.set(newClient.id, workspaceSlug);
                
                // Save to localStorage
                saveClientsToStorage();
                
                renderClientList();
                
                // Close modal and reset form
                document.getElementById('add-client-modal').classList.add('hidden');
                document.getElementById('add-client-modal').classList.remove('flex');
                document.getElementById('add-client-form').reset();
                
                showToast(`‚úÖ Client "${clientName}" created with dedicated AI workspace!`, 'success');
                
                // Auto-select the new client for analysis
                selectClient(newClient.id);
                
            } catch (error) {
                console.error('Error creating client:', error);
                showToast('‚ùå Error creating client workspace. Please try again.', 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Create a workspace in AnythingLLM for the client
        async function createClientWorkspace(clientName) {
            const workspaceName = `Client: ${clientName}`;
            const workspaceSlug = `client-${clientName.toLowerCase().replace(/[^a-z0-9]/g, '-')}-${Date.now()}`;
            
            const response = await fetch(`${ANYTHINGLLM_CONFIG.baseUrl}/api/v1/workspace/new`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ANYTHINGLLM_CONFIG.apiKey}`,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    name: workspaceName,
                    similarityThreshold: 0.7,
                    openAiTemp: 0.7,
                    openAiHistory: 20,
                    openAiPrompt: `You are an AI assistant specialized in analyzing client information for Social Garden. You have access to client documents and should provide insights about their business needs, potential service matches, and strategic recommendations based on the uploaded materials.`,
                    queryRefusalResponse: "I can only provide insights based on the client information and documents available in this workspace.",
                    chatMode: "chat",
                    topN: 4
                })
            });

            if (!response.ok) {
                throw new Error(`Failed to create workspace: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            return data.workspace.slug;
        }

        // Upload document to client's workspace
        async function uploadDocumentToWorkspace(file, workspaceSlug) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('addToWorkspaces', workspaceSlug);

            const response = await fetch(`${ANYTHINGLLM_CONFIG.baseUrl}/api/v1/document/upload`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${ANYTHINGLLM_CONFIG.apiKey}`
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error(`Failed to upload document: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();            return {
                name: file.name,
                size: file.size,
                type: file.type,
                uploadedAt: new Date(),
                anythingLLMDoc: data.documents[0]
            };
        }
        
        function filterClients() {
            const searchTerm = document.getElementById('client-search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            
            const filteredClients = clients.filter(client => {
                const matchesSearch = client.name.toLowerCase().includes(searchTerm) || 
                                    client.notes.toLowerCase().includes(searchTerm);                const matchesStatus = !statusFilter || client.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            
            renderClientList(filteredClients);        }
          /*
        * IMPORTANT: AnythingLLM Agent Requirements
        * 
        * For this application to work properly with AnythingLLM, ensure:
        * 1. Your workspace has AI Agents enabled
        * 2. The Web Scraping tool is enabled for the agent (for company websites)
        * 3. Your LLM model supports tool calling (recommended: GPT-4, Claude, or Llama 70B+)
        * 4. The workspace has appropriate permissions for the API key
        * 
        * Company websites are directly scraped for comprehensive business intelligence
        * including company profile, market analysis, and competitive insights.
        * 
        * If agents are not available, the application will fall back to demo mode.
        */
        
        // AI Autofill Client Data
        async function aiAutofillClientData() {
            const websiteUrl = document.getElementById('company-website').value;
            
            // Validate if website URL is provided
            if (!websiteUrl) {
                showNotification('Please provide a company website URL', 'error');
                return;
            }
            
            // Show processing animation
            const processingAnimation = document.getElementById('ai-processing-animation');
            processingAnimation.classList.remove('hidden');
            
            // Show status indicator
            const statusEl = document.getElementById('ai-autofill-status');
            statusEl.classList.remove('hidden');
            statusEl.innerHTML = '<span class="animate-pulse">‚è≥ Processing URLs and extracting information...</span>';
            
            // Start typing animations
            const typingElements = document.querySelectorAll('.typing-animation');
            typingElements.forEach((el, index) => {
                setTimeout(() => {
                    startTypingAnimation(el, el.getAttribute('data-text'));
                }, index * 1000); // Stagger the typing effect
            });
              try {
                // Use existing main workspace for scraping
                const workspaceSlug = ANYTHINGLLM_CONFIG.workspace;
                
                statusEl.innerHTML = '<span class="animate-pulse">‚è≥ Analyzing company website and gathering intelligence...</span>';
                
                // Process Website URL
                let companyData = null;
                
                // Helper function to parse Company agent response
                function parseCompanyResponse(responseText) {
                    const data = {};
                    const lines = responseText.split('\n').filter(line => line.trim() !== '');

                    lines.forEach(line => {
                        if (line.startsWith('**Company Name:**')) {
                            data.name = line.replace('**Company Name:**', '').trim();
                        } else if (line.startsWith('**Industry:**')) {
                            data.industry = line.replace('**Industry:**', '').trim();
                        } else if (line.startsWith('**Size:**')) {
                            data.size = line.replace('**Size:**', '').trim();
                        } else if (line.startsWith('**Founded:**')) {
                            data.founded = line.replace('**Founded:**', '').trim();
                        } else if (line.startsWith('**Location:**')) {
                            data.location = line.replace('**Location:**', '').trim();
                        } else if (line.startsWith('**Overview:**')) {
                            data.overview = line.replace('**Overview:**', '').trim();
                        } else if (line.startsWith('**Business Model:**')) {
                            data.businessModel = line.replace('**Business Model:**', '').trim();
                        } else if (line.startsWith('**Target Market:**')) {
                            data.targetMarket = line.replace('**Target Market:**', '').trim();
                        } else if (line.startsWith('**Revenue Model:**')) {
                            data.revenueModel = line.replace('**Revenue Model:**', '').trim();
                        } else if (line.startsWith('**Market:**')) {
                            data.market = line.replace('**Market:**', '').trim();
                        } else if (line.startsWith('**Competition:**')) {
                            data.competition = line.replace('**Competition:**', '').trim();
                        } else if (line.startsWith('**Technology:**')) {
                            data.technology = line.replace('**Technology:**', '').trim();
                        } else if (line.startsWith('**Challenges:**')) {
                            data.challenges = line.replace('**Challenges:**', '').trim();
                        } else if (line.startsWith('**Opportunities:**')) {
                            data.opportunities = line.replace('**Opportunities:**', '').trim();
                        }
                    });
                    return data;
                }
                
                try {
                    statusEl.innerHTML = '<span class="animate-pulse">‚è≥ Analyzing company website...</span>';
                        
                        const linkedinResponse = await fetch(`${ANYTHINGLLM_CONFIG.baseUrl}/api/v1/workspace/${workspaceSlug}/chat`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${ANYTHINGLLM_CONFIG.apiKey}`
                            },
                            body: JSON.stringify({
                                message: `@agent search Google for information about this LinkedIn profile: ${linkedinUrl}

Search terms: "${linkedinUsername}" linkedin, "${linkedinUsername}" professional profile, "${linkedinUsername}" company

Find publicly available information about this person from company websites, press releases, professional directories, and news articles.

/exit

Based on the search results, provide:
1. Full name
2. Current job title and company  
3. Location/City
4. Professional background and experience summary
5. Key skills and expertise areas
6. Education background
7. Professional achievements or notable activities
8. Industry focus and specializations
9. Company information if available`,
                                mode: "chat"
                            })
                        });

                        if (!linkedinResponse.ok) {
                            throw new Error(`Web search failed: ${linkedinResponse.status}`);
                        }
                        
                        const linkedinResult = await linkedinResponse.json();
                          // Extract the response text from the agent
                        const agentResponse = linkedinResult.textResponse || linkedinResult.response || '';
                        console.log('LinkedIn Agent Response:', agentResponse);

                        // Helper function to parse LinkedIn agent response
                        function parseLinkedInResponse(responseText) {
                            const data = {};
                            const lines = responseText.split('\n').filter(line => line.trim() !== '');

                            lines.forEach(line => {
                                // Handle both old and new formats
                                if (line.includes('**Full Name**') || line.startsWith('**1. Full Name:**')) {
                                    data.name = line.replace(/\*\*.*?Full Name.*?\*\*:?\s*/i, '').trim();
                                } else if (line.includes('**Current Job Title and Company**') || line.startsWith('**2. Current Job Title and Company:**')) {
                                    data.headline = line.replace(/\*\*.*?Current Job Title and Company.*?\*\*:?\s*/i, '').trim();
                                } else if (line.includes('**Location**') || line.startsWith('**3. Location/City:**')) {
                                    data.location = line.replace(/\*\*.*?Location.*?\*\*:?\s*/i, '').trim();
                                } else if (line.includes('**Professional Background**') || line.startsWith('**4. Professional Background and Experience Summary:**')) {
                                    data.experience = line.replace(/\*\*.*?Professional Background.*?\*\*:?\s*/i, '').trim();
                                } else if (line.includes('**Key Skills**') || line.startsWith('**5. Key Skills and Expertise Areas:**')) {
                                    data.skills = line.replace(/\*\*.*?Key Skills.*?\*\*:?\s*/i, '').trim();
                                } else if (line.includes('**Education**') || line.startsWith('**6. Education Background:**')) {
                                    data.education = line.replace(/\*\*.*?Education.*?\*\*:?\s*/i, '').trim();
                                } else if (line.includes('**Professional Achievements**') || line.startsWith('**7. Professional Achievements or Notable Activities:**')) {
                                    data.insights = line.replace(/\*\*.*?Professional Achievements.*?\*\*:?\s*/i, '').trim();
                                } else if (line.includes('**Industry Focus**')) {
                                    data.industry = line.replace(/\*\*.*?Industry Focus.*?\*\*:?\s*/i, '').trim();
                                }
                            });

                            // Special handling for multi-line content
                            const text = responseText;
                            
                            // Extract name
                            if (!data.name) {
                                const nameMatch = text.match(/1\.\s*\*\*Full Name\*\*:?\s*(.+)/i);
                                if (nameMatch) data.name = nameMatch[1].trim();
                            }
                            
                            // Extract job title and company
                            if (!data.headline) {
                                const jobMatch = text.match(/2\.\s*\*\*Current Job Title and Company\*\*:?\s*(.+)/i);
                                if (jobMatch) data.headline = jobMatch[1].trim();
                            }
                            
                            // Extract location
                            if (!data.location) {
                                const locationMatch = text.match(/3\.\s*\*\*Location\/City\*\*:?\s*(.+)/i);
                                if (locationMatch) data.location = locationMatch[1].trim();
                            }
                            
                            // Extract experience
                            if (!data.experience) {
                                const expMatch = text.match(/4\.\s*\*\*Professional Background.*?\*\*:?\s*(.+?)(?=\n\d\.|\n\*\*|$)/is);
                                if (expMatch) data.experience = expMatch[1].trim();
                            }
                            
                            // Extract skills
                            if (!data.skills) {
                                const skillsMatch = text.match(/5\.\s*\*\*Key Skills.*?\*\*:?\s*(.+?)(?=\n\d\.|\n\*\*|$)/is);
                                if (skillsMatch) data.skills = skillsMatch[1].trim();
                            }
                            
                            return data;
                        }
                        
                          // Try to extract JSON from the agent response
                        let extractedProfileData = {};
                        try {
                            // Look for JSON in the response
                            const jsonMatch = agentResponse.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                extractedProfileData = JSON.parse(jsonMatch[0]);
                            } else {
                                // Fallback: parse the response manually
                                extractedProfileData = parseLinkedInResponse(agentResponse);
                            }
                        } catch (parseError) {
                            console.log('Could not parse agent response as JSON, using fallback parsing');
                            try {
                                extractedProfileData = parseLinkedInResponse(agentResponse);
                            } catch (fallbackError) {
                                console.error('Fallback parsing also failed:', fallbackError);
                                throw new Error('Failed to parse profile information');
                            }
                        }
                        
                        // Update the profile tab with real data
                        document.getElementById('profile-loading').classList.add('hidden');
                        document.getElementById('profile-content').classList.remove('hidden');
                        
                        // Switch to the profile tab
                        document.querySelectorAll('.client-tab-btn').forEach(btn => {
                            btn.classList.remove('active', 'border-b-2', 'border-blue-500');
                            btn.classList.add('text-gray-500');
                        });
                        document.getElementById('tab-profile-analysis').classList.add('active', 'border-b-2', 'border-blue-500');
                        document.getElementById('tab-profile-analysis').classList.remove('text-gray-500');
                        
                        document.querySelectorAll('.client-tab-content').forEach(content => {
                            content.classList.add('hidden');
                        });
                        document.getElementById('profile-analysis-content').classList.remove('hidden');
                        
                        // Fill in the profile data
                        document.getElementById('profile-name').textContent = extractedProfileData.name || "Name not found";
                        document.getElementById('profile-headline').textContent = extractedProfileData.headline || "Position not found";
                        document.getElementById('profile-location').textContent = extractedProfileData.location || "Location not found";
                        document.getElementById('profile-connections').textContent = extractedProfileData.connections || "Connections not found";
                        document.getElementById('profile-experience').innerHTML = extractedProfileData.experience || "Experience not found";
                        document.getElementById('profile-skills').innerHTML = extractedProfileData.skills || "Skills not found";
                        document.getElementById('profile-education').innerHTML = extractedProfileData.education || "Education not found";
                        document.getElementById('profile-insights').innerHTML = extractedProfileData.insights || "Insights not available";
                        
                        // Update form fields with the extracted data
                        document.getElementById('client-name').value = extractedProfileData.name || "";
                        document.getElementById('client-email').value = extractedProfileData.email || "";
                        document.getElementById('client-phone').value = extractedProfileData.phone || "";
                        document.getElementById('client-location').value = extractedProfileData.location || "";
                        
                        statusEl.innerHTML = '<span class="text-green-500">‚úÖ Profile information gathered via web search</span>';
                        
                    } catch (error) {
                        console.error("LinkedIn web search error:", error);
                        statusEl.innerHTML = `<span class="text-yellow-500">‚ö†Ô∏è Web search encountered an issue: ${error.message}</span>`;
                          // Fallback to error message - NO DEMO DATA

                    }
                }
                
                // Process Website URL if provided
                let companyData = null;
                if (websiteUrl) {
                    // Helper function to parse Company agent response
                    function parseCompanyResponse(responseText) {
                        const data = {};
                        const lines = responseText.split('\n').filter(line => line.trim() !== '');

                        lines.forEach(line => {
                            if (line.startsWith('**Company Name:**')) {
                                data.name = line.replace('**Company Name:**', '').trim();
                            } else if (line.startsWith('**Industry:**')) {
                                data.industry = line.replace('**Industry:**', '').trim();
                            } else if (line.startsWith('**Size:**')) {
                                data.size = line.replace('**Size:**', '').trim();
                            } else if (line.startsWith('**Founded:**')) {
                                data.founded = line.replace('**Founded:**', '').trim();
                            } else if (line.startsWith('**Overview:**')) {
                                data.overview = line.replace('**Overview:**', '').trim();
                            } else if (line.startsWith('**Market:**')) {
                                data.market = line.replace('**Market:**', '').trim();
                            } else if (line.startsWith('**Challenges:**')) {
                                data.challenges = line.replace('**Challenges:**', '').trim();
                            } else if (line.startsWith('**Opportunities:**')) {
                                data.opportunities = line.replace('**Opportunities:**', '').trim();
                            }
                        });
                        return data;
                    }
                    try {
                        statusEl.innerHTML = '<span class="animate-pulse">‚è≥ Analyzing company website...</span>';
                          // Use AnythingLLM's chat API with agent for scraping website
                        const websiteResponse = await fetch(`${ANYTHINGLLM_CONFIG.baseUrl}/api/v1/workspace/${workspaceSlug}/chat`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${ANYTHINGLLM_CONFIG.apiKey}`
                            },
                            body: JSON.stringify({
                                message: `@agent search Google and analyze the website ${websiteUrl}

Find information about this company from their website and other publicly available sources.

/exit

Extract the following company information in JSON format: name, industry, size, founded, overview, market, challenges, and opportunities. Please format as valid JSON.`,
                                mode: "chat"
                            })
                        });
                        
                        if (!websiteResponse.ok) {
                            throw new Error(`Website scraping failed: ${websiteResponse.status}`);
                        }
                        
                        const websiteResult = await websiteResponse.json();
                          // Extract the response text from the agent
                        const agentResponse = websiteResult.textResponse || websiteResult.response || '';
                        console.log('Company Website Agent Response:', agentResponse);
                        
                        // Try to extract JSON from the agent response
                        let extractedCompanyData = {};
                        try {
                            // Look for JSON in the response
                            const jsonMatch = agentResponse.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                extractedCompanyData = JSON.parse(jsonMatch[0]);
                            } else {
                                // Fallback: parse the response manually
                                extractedCompanyData = parseCompanyResponse(agentResponse);
                            }                        } catch (parseError) {
                            console.log('Could not parse agent response as JSON, using fallback parsing');
                            try {
                                extractedCompanyData = parseCompanyResponse(agentResponse);
                            } catch (fallbackError) {
                                console.error('Company fallback parsing also failed:', fallbackError);
                                throw new Error('Failed to parse company information');
                            }
                        }
                        
                        // Update the company tab with real data
                        document.getElementById('company-loading').classList.add('hidden');
                        document.getElementById('company-content').classList.remove('hidden');
                        
                        // Switch to the company tab
                        setTimeout(() => {
                            document.querySelectorAll('.client-tab-btn').forEach(btn => {
                                btn.classList.remove('active', 'border-b-2', 'border-blue-500');
                                btn.classList.add('text-gray-500');
                            });
                            document.getElementById('tab-company-analysis').classList.add('active', 'border-b-2', 'border-blue-500');
                            document.getElementById('tab-company-analysis').classList.remove('text-gray-500');
                            
                            document.querySelectorAll('.client-tab-content').forEach(content => {
                                content.classList.add('hidden');
                            });
                            document.getElementById('company-analysis-content').classList.remove('hidden');
                        }, 2000);
                          // Extract and fill in the company data
                        document.getElementById('company-name').textContent = extractedCompanyData.name || "Company name not found";
                        document.getElementById('company-industry').textContent = extractedCompanyData.industry || "Industry not found";
                        document.getElementById('company-size').textContent = extractedCompanyData.size || "Company size not found";
                        document.getElementById('company-founded').textContent = extractedCompanyData.founded || "Founded date not found";
                        document.getElementById('company-overview').innerHTML = extractedCompanyData.overview || "Overview not available";
                        document.getElementById('company-market').innerHTML = extractedCompanyData.market || "Market information not available";
                        document.getElementById('company-challenges').innerHTML = extractedCompanyData.challenges || "Challenges not identified";
                        
                        // Update form fields with the extracted data
                        document.getElementById('client-company').value = extractedCompanyData.name || "";
                        document.getElementById('client-industry').value = extractedCompanyData.industry || "";
                        document.getElementById('client-size').value = extractedCompanyData.size || "";
                        document.getElementById('client-description').value = extractedCompanyData.overview || "";} catch (error) {
                        console.error("Website scraping error:", error);
                        statusEl.innerHTML = `<span class="text-yellow-500">‚ö†Ô∏è Website scraping encountered an issue: ${error.message}</span>`;
                          // NO DEMO DATA - Show error message
                        if (websiteUrl) {
                            console.log('Company website scraping failed - no demo data fallback');
                            statusEl.innerHTML = '<span class="text-red-500">‚ùå Unable to extract company information. Please check the URL and try again.</span>';
                        }
                    }
                }
                  // Remove demo completion logic - no demo data anymore
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                    processingAnimation.classList.add('hidden');
                }, 2000);
                
            } catch (error) {
                console.error('AI Autofill error:', error);
                statusEl.innerHTML = '<span class="text-red-500">‚úó Failed to extract information</span>';
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                    processingAnimation.classList.add('hidden');
                }, 3000);
                
                showNotification('Failed to extract client information: ' + error.message, 'error');
            }
        }        
        // Helper function for typing animation
        function startTypingAnimation(element, text) {
            element.textContent = '';
            let i = 0;
            const speed = 50; // typing speed in milliseconds
            
            function typeWriter() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(typeWriter, speed);
                }
            }
            
            typeWriter();
        }
        
        function renderClientList(clientsToRender = clients) {
            const clientList = document.getElementById('client-list');
            
            if (clientsToRender.length === 0) {
                clientList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="mb-4">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.196-2.121M17 20H7m10 0v-2c0-5.523-4.477-10-10-10s-10 4.477-10 10v2m20 0v-2a5 5 0 00-10-10 5 5 0 00-10 10v2"/>
                            </svg>
                        </div>
                        <p>No clients yet. Add your first client to get started!</p>
                    </div>
                `;
                return;
            }

            clientList.innerHTML = clientsToRender.map(client => {
                const statusColors = {
                    'cold': 'bg-blue-50 border-blue-200 text-blue-800',
                    'warm': 'bg-yellow-50 border-yellow-200 text-yellow-800',
                    'hot': 'bg-red-50 border-red-200 text-red-800',
                    'client': 'bg-green-50 border-green-200 text-green-800'
                };
                
                const statusColor = statusColors[client.status] || 'bg-gray-50 border-gray-200 text-gray-800';
                  return `
                    <div class="client-card ${statusColor} p-4 rounded-lg border-2 cursor-pointer hover:shadow-md transition-all" 
                         data-client-id="${client.id}" onclick="selectClient('${client.id}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <h3 class="font-semibold text-gray-900">${client.name}</h3>
                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor}">
                                        ${client.status.charAt(0).toUpperCase() + client.status.slice(1)}
                                    </span>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-2 text-xs text-gray-600 mb-2">
                                    <div>üìÖ Created: ${new Date(client.createdAt).toLocaleDateString()}</div>
                                    <div>üìÑ Docs: ${client.documents?.length || 0}</div>
                                    <div>üí∞ Value: $${client.dealValue?.toLocaleString() || 0}</div>
                                    <div>ü§ñ Workspace: ${client.workspaceSlug ? '‚úÖ' : '‚ùå'}</div>
                                </div>
                                
                                ${client.notes ? `<p class="text-xs text-gray-500 mt-1 truncate">${client.notes}</p>` : ''}
                                
                                ${client.aiInsights ? `
                                    <div class="mt-2 p-2 bg-purple-50 rounded text-xs">
                                        <span class="text-purple-700 font-medium">üß† AI Insight:</span>
                                        <span class="text-purple-600">${client.aiInsights.slice(0, 100)}...</span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="flex flex-col items-end space-y-1">
                                <div class="text-xs text-gray-400">
                                    ${new Date(client.lastContactDate || client.createdAt).toLocaleDateString()}
                                </div>
                                <button onclick="event.stopPropagation(); deleteClient(${client.id})" 
                                        class="text-red-400 hover:text-red-600 text-xs">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }        function selectClient(clientIdOrEvent) {
            let clientId;
            let eventTarget = null;
            
            // Check if called with event or direct client ID
            if (typeof clientIdOrEvent === 'object' && clientIdOrEvent.currentTarget) {
                // Called from event handler
                clientId = clientIdOrEvent.currentTarget.dataset.clientId;
                eventTarget = clientIdOrEvent.currentTarget;
            } else {
                // Called directly with client ID
                clientId = clientIdOrEvent;
                // Find the corresponding card element
                eventTarget = document.querySelector(`[data-client-id="${clientId}"]`);
            }
            
            selectedClient = clients.find(c => c.id === clientId);
            if (selectedClient) {
                analyzeClient(selectedClient);
                
                // Update UI to show selected state
                document.querySelectorAll('.client-card').forEach(card => {
                    card.classList.remove('ring-2', 'ring-blue-500');
                });
                if (eventTarget) {
                    eventTarget.classList.add('ring-2', 'ring-blue-500');
                }
            }
        }

        async function analyzeClient(client) {
            const analysisDiv = document.getElementById('client-analysis');
            
            analysisDiv.innerHTML = `
                <div class="text-center">
                    <div class="animate-spin h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-sm text-gray-600">Analyzing ${client.name} with AI...</p>
                    <p class="text-xs text-gray-500 mt-1">Using dedicated workspace & documents</p>
                </div>
            `;

            try {
                let analysisPrompt = `Please provide a comprehensive client analysis for ${client.name}. Include:

1. üéØ Business Profile Summary
2. üìä Potential Service Matches (based on our service offerings)
3. üí° Strategic Recommendations
4. üöÄ Next Steps & Opportunities
5. ‚ö†Ô∏è Risk Assessment

Client Status: ${client.status}
Deal Value: $${client.dealValue || 0}
Documents Available: ${client.documents?.length || 0}
Notes: ${client.notes || 'None'}

Please analyze any uploaded documents and provide actionable insights.`;

                let analysisResult;
                
                if (client.workspaceSlug) {
                    // Use client-specific workspace for analysis
                    analysisResult = await callAnythingLLMWorkspace(analysisPrompt, client.workspaceSlug);
                } else {
                    // Fallback to general analysis
                    analysisResult = await callAnythingLLM(analysisPrompt);
                }
                
                // Update client with AI insights and save
                client.aiInsights = analysisResult;
                client.lastAnalyzed = new Date();
                saveClientsToStorage();
                
                analysisDiv.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-900 flex items-center">
                                üß† AI Analysis: ${client.name}
                            </h3>
                            <button onclick="refreshClientAnalysis(${client.id})" 
                                    class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200">
                                üîÑ Refresh
                            </button>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                            <div class="text-sm text-gray-700 whitespace-pre-wrap">${analysisResult}</div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="addClientActivity(${client.id}, 'AI Analysis Generated')" 
                                    class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200">
                                üìù Log Activity
                            </button>
                            <button onclick="generateSOWForClient(${client.id})" 
                                    class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded hover:bg-purple-200">
                                üìã Generate SOW
                            </button>
                            <button onclick="openClientWorkspace(${client.id})" 
                                    class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">
                                üöÄ Open Workspace
                            </button>
                        </div>
                        
                        ${client.documents && client.documents.length > 0 ? `
                            <div class="mt-4 p-3 bg-blue-50 rounded">
                                <h4 class="text-sm font-medium text-blue-900 mb-2">üìÑ Client Documents (${client.documents.length})</h4>
                                <div class="space-y-1">
                                    ${client.documents.map(doc => `
                                        <div class="text-xs text-blue-700 flex justify-between">
                                            <span>${doc.name}</span>
                                            <span>${(doc.size / 1024).toFixed(1)}KB</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="text-xs text-gray-500 text-center pt-2 border-t">
                            Last analyzed: ${new Date(client.lastAnalyzed || Date.now()).toLocaleString()}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Analysis error:', error);
                analysisDiv.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-500 mb-2">‚ùå Analysis Error</div>
                        <p class="text-sm text-gray-600 mb-4">${error.message}</p>
                        <button onclick="analyzeClient(selectedClient)" 
                                class="text-xs bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200">
                            Try Again
                        </button>
                    </div>                `;
            }
        }

        // Helper functions for enhanced CRM features
        async function callAnythingLLMWorkspace(message, workspaceSlug) {
            const response = await fetch(`${ANYTHINGLLM_CONFIG.baseUrl}/api/v1/workspace/${workspaceSlug}/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ANYTHINGLLM_CONFIG.apiKey}`,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    mode: 'chat'
                })
            });

            if (!response.ok) {
                throw new Error(`Workspace API request failed: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            return data.textResponse || data.message || 'No response received';
        }

        async function refreshClientAnalysis(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                await analyzeClient(client);
                showToast('üîÑ Client analysis refreshed!', 'success');
            }
        }

        function addClientActivity(clientId, activity) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                if (!client.activities) client.activities = [];
                client.activities.unshift({
                    id: Date.now(),
                    activity: activity,
                    timestamp: new Date(),
                    type: 'system'
                });
                saveClientsToStorage();
                showToast('üìù Activity logged!', 'success');
            }
        }

        function generateSOWForClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                // Open SOW generator with client context
                const sowUrl = `enhanced-sow-demo.html?clientId=${clientId}&clientName=${encodeURIComponent(client.name)}`;
                window.open(sowUrl, '_blank');
                addClientActivity(clientId, 'SOW Generation Initiated');
            }
        }

        function openClientWorkspace(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client && client.workspaceSlug) {
                // In a real implementation, this would open the AnythingLLM workspace
                const workspaceUrl = `${ANYTHINGLLM_CONFIG.baseUrl}/workspace/${client.workspaceSlug}`;
                window.open(workspaceUrl, '_blank');
                addClientActivity(clientId, 'Workspace Accessed');
            } else {
                showToast('‚ö†Ô∏è No workspace found for this client', 'warning');
            }
        }

        function deleteClient(clientId) {
            if (confirm('Are you sure you want to delete this client? This will also remove their dedicated workspace.')) {
                const clientIndex = clients.findIndex(c => c.id === clientId);
                if (clientIndex > -1) {
                    const client = clients[clientIndex];
                    clients.splice(clientIndex, 1);
                    clientWorkspaces.delete(clientId);
                    saveClientsToStorage();
                    renderClientList();
                    
                    // Clear analysis if this client was selected
                    if (selectedClient && selectedClient.id === clientId) {
                        selectedClient = null;
                        document.getElementById('client-analysis').innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                Select a client to see AI-powered analysis
                            </div>
                        `;
                    }
                    
                    showToast(`Client "${client.name}" deleted`, 'success');
                }
            }
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'warning': 'bg-yellow-500',
                'info': 'bg-blue-500'
            }[type] || 'bg-blue-500';
            
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-0`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }        // --- View Toggle Functions ---
        let currentView = 'grid';
        
        function initializeViewToggles() {
            const treeBtn = document.getElementById('view-tree');
            const networkBtn = document.getElementById('view-network');
            const categoriesBtn = document.getElementById('view-categories');
            
            treeBtn.addEventListener('click', () => switchView('tree'));
            networkBtn.addEventListener('click', () => switchView('network'));
            categoriesBtn.addEventListener('click', () => switchView('categories'));
        }
          function switchView(viewType) {
            currentView = viewType;
            
            // Update button states
            document.querySelectorAll('[id^="view-"]').forEach(btn => {
                btn.className = 'btn-secondary px-4 py-2 rounded-lg text-sm font-medium';
            });
            document.getElementById(`view-${viewType}`).className = 'btn-primary px-4 py-2 rounded-lg text-sm font-medium';
            
            // Render the visualization based on view type
            renderServiceVisualization();
        }
        
        function renderServiceVisualization() {
            const container = document.getElementById('knowledge-visualization');
            
            switch(currentView) {
                case 'tree':
                    renderTreeView(container);
                    break;
                case 'network':
                    renderNetworkView(container);
                    break;
                case 'categories':
                    renderCategoryView(container);
                    break;
                default:
                    renderGridView(container);
            }
        }
        
        function renderTreeView(container) {
            // Group services by category
            const categories = {};
            services.forEach(service => {
                if (!categories[service.category]) {
                    categories[service.category] = [];
                }
                categories[service.category].push(service);
            });
            
            container.innerHTML = `
                <div class="tree-view p-4 h-full overflow-y-auto">
                    <div class="space-y-4">
                        ${Object.entries(categories).map(([category, categoryServices]) => `
                            <div class="category-branch">
                                <div class="category-header flex items-center p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500 cursor-pointer" onclick="toggleCategory('${category}')">
                                    <span class="category-icon mr-2">üìÅ</span>
                                    <h3 class="font-semibold text-lg text-blue-900">${category}</h3>
                                    <span class="ml-auto text-sm text-blue-600">${categoryServices.length} services</span>
                                </div>
                                <div id="category-${category.replace(/\s+/g, '-')}" class="category-services ml-6 mt-2 space-y-2">                                    ${categoryServices.map(service => `
                                        <div class="service-leaf flex items-center p-2 bg-white rounded border hover:bg-gray-50 cursor-pointer" onclick="showServiceDetailsById(${service.id})">
                                            <span class="service-icon mr-2">üìÑ</span>
                                            <div class="flex-1">
                                                <span class="text-sm font-medium text-gray-900">${service.name}</span>
                                                <div class="text-xs text-gray-500">${service.pricing} ‚Ä¢ ${service.hours}h</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderNetworkView(container) {
            container.innerHTML = `
                <div class="network-view p-4 h-full relative">
                    <svg class="w-full h-full" viewBox="0 0 800 400">
                        <!-- Central Hub -->
                        <circle cx="400" cy="200" r="40" fill="#3B82F6" stroke="#1E40AF" stroke-width="2"/>
                        <text x="400" y="205" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Services</text>
                        
                        ${services.map((service, index) => {
                            const angle = (index / services.length) * 2 * Math.PI;
                            const x = 400 + 150 * Math.cos(angle);
                            const y = 200 + 150 * Math.sin(angle);
                            const color = service.category === 'Marketing Automation' ? '#10B981' : 
                                         service.category === 'Audit & Consultation' ? '#F59E0B' : '#8B5CF6';
                            return `
                                <!-- Connection Line -->
                                <line x1="400" y1="200" x2="${x}" y2="${y}" stroke="#E5E7EB" stroke-width="1"/>
                                  <!-- Service Node -->
                                <circle cx="${x}" cy="${y}" r="25" fill="${color}" stroke="#374151" stroke-width="1" 
                                        class="cursor-pointer hover:r-30" onclick="showServiceDetailsById(${service.id})"/>
                                <text x="${x}" y="${y-30}" text-anchor="middle" fill="#374151" font-size="10" class="max-w-20">
                                    ${service.name.split(' ').slice(0, 3).join(' ')}
                                </text>
                                <text x="${x}" y="${y+40}" text-anchor="middle" fill="#6B7280" font-size="8">
                                    ${service.pricing}
                                </text>
                            `;
                        }).join('')}
                    </svg>
                    
                    <!-- Legend -->
                    <div class="absolute bottom-4 right-4 bg-white p-3 rounded-lg shadow border text-xs">
                        <div class="space-y-1">
                            <div class="flex items-center"><div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>Marketing Automation</div>
                            <div class="flex items-center"><div class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>Audit & Consultation</div>
                            <div class="flex items-center"><div class="w-3 h-3 bg-purple-500 rounded-full mr-2"></div>Strategy & Consultation</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderCategoryView(container) {
            // Group services by category
            const categories = {};
            services.forEach(service => {
                if (!categories[service.category]) {
                    categories[service.category] = [];
                }
                categories[service.category].push(service);
            });
            
            container.innerHTML = `
                <div class="category-view p-4 h-full overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${Object.entries(categories).map(([category, categoryServices]) => {
                            const avgPrice = categoryServices.reduce((sum, s) => sum + parseInt(s.pricing.replace(/[$,]/g, '')), 0) / categoryServices.length;
                            const totalHours = categoryServices.reduce((sum, s) => sum + s.hours, 0);
                            return `
                                <div class="category-card bg-white border rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                    <div class="p-4 border-b bg-gradient-to-r from-blue-50 to-purple-50">
                                        <h3 class="font-bold text-lg text-gray-900">${category}</h3>
                                        <div class="text-sm text-gray-600 mt-1">
                                            ${categoryServices.length} services ‚Ä¢ $${Math.round(avgPrice).toLocaleString()} avg ‚Ä¢ ${totalHours}h total
                                        </div>
                                    </div>
                                    <div class="p-4 space-y-2">
                                        ${categoryServices.map(service => `                                            <div class="service-item p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer transition-colors" 
                                                 onclick="showServiceDetailsById(${service.id})">>
                                                <div class="text-sm font-medium text-gray-900">${service.name.length > 40 ? service.name.substring(0, 37) + '...' : service.name}</div>
                                                <div class="text-xs text-gray-500 flex justify-between">
                                                    <span>${service.pricing}</span>
                                                    <span>${service.hours}h</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        function toggleCategory(category) {
            const categoryId = 'category-' + category.replace(/\s+/g, '-');
            const element = document.getElementById(categoryId);
            const header = element.previousElementSibling;
            const icon = header.querySelector('.category-icon');
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                icon.textContent = 'üìÇ';
            } else {
                element.style.display = 'none';
                icon.textContent = 'üìÅ';
            }
        }

        // --- Service Loading ---
        async function loadServicesFromKB() {
            // Real services from KB.md
            services = [
                {
                    id: 1,
                    name: "Marketing Automation | Email Template Services",
                    category: "Marketing Automation",
                    pricing: "$9,350",
                    hours: 70,
                    avgRate: "$133.57",
                    description: "Email Template Design, Development & Deployment with UX Design, Testing & Rendering",
                    deliverables: [
                        "1x Email Template Design, Development & Deployment",
                        "Email Template Wireframe Design", 
                        "UX Design: Modular prototype in Figma (Max: 4 blocks, 30 modules)",
                        "Email Template Development & Testing",
                        "Email Template Deployment into Marketing Automation Platform"
                    ],
                    phases: ["Review existing template", "Objective setting", "Wireframe proposal", "User testing", "Go-live handover"],
                    roles: [
                        { role: "Tech - Producer - Email Production", hours: 8, rate: 120 },
                        { role: "Tech - Producer - Design", hours: 8, rate: 120 },
                        { role: "Tech - Producer - Development", hours: 16, rate: 120 },
                        { role: "Tech - Producer - Testing", hours: 16, rate: 120 },
                        { role: "Account Management - Account Manager", hours: 8, rate: 180 }
                    ]
                },
                {
                    id: 2, 
                    name: "Marketing Automation | Platform Audit Services",
                    category: "Audit & Consultation",
                    pricing: "$10,700",
                    hours: 56,
                    avgRate: "$196",
                    description: "Comprehensive Marketing Automation Platform Current State and Future State Audit",
                    deliverables: [
                        "Current State Assessment: Platform Overview & Usage Analysis",
                        "Technical Audit: Infrastructure Evaluation & Data Quality Check",
                        "Campaign and Content Assessment",
                        "Process and Workflow Analysis",
                        "Future State Recommendations",
                        "Final Documentation & Process Mapping via Google Slides & Lucid Charts"
                    ],
                    phases: ["Current State Assessment", "Technical Audit", "Campaign Analysis", "Future State Recommendations"],
                    roles: [
                        { role: "Tech - Head Of - Customer Experience Strategy", hours: 8, rate: 365 },
                        { role: "Tech - Sr. Consultant - Strategy", hours: 8, rate: 295 },
                        { role: "Tech - Producer - Documentation Setup", hours: 15, rate: 120 },
                        { role: "Tech - Specialist - Campaign Optimisation", hours: 5, rate: 180 }
                    ]
                },
                {
                    id: 3,
                    name: "Marketing Automation | Landing Page Services", 
                    category: "Marketing Automation",
                    pricing: "$7,470",
                    hours: 52,
                    avgRate: "$156.50",
                    description: "Landing Page Setup with Design, Development & Deployment (Max: 4 modules)",
                    deliverables: [
                        "1x Landing Page Setup (Max: 4 modules)",
                        "Landing Page Design & Client Review",
                        "Landing Page Development & Testing",
                        "Landing Page Deployment into Marketing Automation Platform",
                        "Landing Page Form Connection & UX Review"
                    ],
                    phases: ["Design", "Development", "Deployment"],
                    roles: [
                        { role: "Tech - Producer - Landing Page Production", hours: 8, rate: 120 },
                        { role: "Tech - Producer - Development", hours: 8, rate: 120 },
                        { role: "Tech - Specialist - Integration Services", hours: 4, rate: 190 },                        { role: "Tech - Producer - Testing", hours: 8, rate: 120 }
                    ]
                },
                {
                    id: 4,
                    name: "Marketing Automation | Customer Journey Mapping Services",
                    category: "Strategy & Consultation", 
                    pricing: "$9,900",
                    hours: 56,
                    avgRate: "$196",
                    description: "Customer Journey Mapping with Research, Strategy Development & Future State Recommendations",
                    deliverables: [
                        "1x Customer Journey Mapping Document (Figma or Lucid Chart)",
                        "Market research for each product category",
                        "Buyer personas for each product category", 
                        "MA Current State Assessment",
                        "Future State Recommendations with strategic insights",
                        "Final Documentation & Process Mapping"
                    ],
                    phases: ["Initial Research", "Current State Assessment", "Future State Recommendations", "Documentation"],
                    roles: [
                        { role: "Tech - Head Of - Customer Experience Strategy", hours: 6, rate: 365 },
                        { role: "Tech - Sr. Consultant - Strategy", hours: 6, rate: 295 },
                        { role: "Tech - Producer - Documentation Setup", hours: 20, rate: 120 },                        { role: "Tech - Specialist - Campaign Orchestration", hours: 6, rate: 180 }
                    ]
                },
                {
                    id: 5,
                    name: "Marketing Automation | 6 Month Support Retainer", 
                    category: "Managed Services",
                    pricing: "$24,112",
                    hours: 120,
                    avgRate: "$201/month",
                    description: "Monthly Support Retainer covering User Support, Campaign Management, Technical Support & More",
                    deliverables: [
                        "User Support: Assistance with questions, troubleshooting, and guidance",
                        "Technical Support: Resolving technical issues within the platform",
                        "Campaign Management: Setup, execution, and optimization",
                        "Lead Management and Sales Pipeline Optimization",
                        "Email Marketing Support with QA testing",
                        "Workflow and Automation Configuration"
                    ],
                    phases: ["Monthly Support", "Quarterly Reviews", "Ongoing Optimization"],
                    roles: [
                        { role: "Tech - Producer - Support & Monitoring", hours: 30, rate: 120 },
                        { role: "Tech - Specialist - Database Management", hours: 30, rate: 180 },
                        { role: "Tech - Sr. Consultant - Advisory & Consultation", hours: 30, rate: 295 }
                    ]
                },
                {
                    id: 6,
                    name: "Marketing Automation & CRM | 6-month Advisory & Consultation",
                    category: "Advisory & Consultation",
                    pricing: "$18,575", 
                    hours: 100,
                    avgRate: "$186",
                    description: "Comprehensive CRM Advisory and Implementation Support covering customization, data migration, and strategic planning",
                    deliverables: [
                        "Initial Discovery Meeting and requirements assessment",
                        "Assessment of Current Systems and Processes",
                        "Customization and Configuration Support",
                        "Data Migration & Mapping Strategy",
                        "Strategic Planning and Roadmap Development",
                        "Performance Monitoring and Reporting recommendations"
                    ],
                    phases: ["Discovery", "Assessment", "Configuration", "Strategic Planning", "Ongoing Support"],
                    roles: [
                        { role: "Tech - Head Of - Customer Experience Strategy", hours: 10, rate: 365 },
                        { role: "Tech - Sr. Architect - Data Strategy", hours: 5, rate: 365 },
                        { role: "Tech - Specialist - Database Management", hours: 10, rate: 180 },                        { role: "Tech - Producer - Services", hours: 25, rate: 120 }
                    ]
                },
                {
                    id: 7,
                    name: "Marketing Automation | Lead Scoring Model Setup",
                    category: "Configuration & Setup",
                    pricing: "$7,000", 
                    hours: 40,
                    avgRate: "$175",
                    description: "Lead Scoring Setup with criteria definition, technical configuration, and quality assurance",
                    deliverables: [
                        "1x Lead Scoring Setup based on engagement and profile",
                        "Definition Session for scoring criteria",
                        "Lead Scoring Field Setup (Profile and Behaviour)",
                        "Setup Lead Scoring Workflow Logic",
                        "Quality Assurance & Testing",
                        "Final Delivery & Go-live with documentation"
                    ],
                    phases: ["Definition Session", "Technical Configuration", "Quality Assurance", "Final Delivery"],
                    roles: [
                        { role: "Tech - Producer - Lead Scoring Setup", hours: 8, rate: 120 },
                        { role: "Tech - Specialist - Lead Scoring Setup", hours: 8, rate: 180 },
                        { role: "Tech - Sr. Consultant - Advisory & Consultation", hours: 8, rate: 295 },
                        { role: "Tech - Producer - Testing", hours: 6, rate: 120 }
                    ]
                },
                {
                    id: 8,
                    name: "Marketing Automation | HubSpot Implementation & Configuration",
                    category: "Implementation & Setup",
                    pricing: "$15,000", 
                    hours: 85,
                    avgRate: "$176",
                    description: "Complete HubSpot implementation to streamline marketing and sales operations",
                    deliverables: [
                        "Discovery Phase with objectives and timeline definition",
                        "Initial Account Customisation with user setup",
                        "Marketing Hub Implementation with tracking and domains",
                        "Sales Hub Implementation with pipelines and workflows",
                        "Reporting and Dashboards (4x custom reports max)",
                        "Go-Live, Deployment, Training Session and Resource Handover"
                    ],
                    phases: ["Discovery", "Account Setup", "Marketing Hub", "Sales Hub", "Reporting", "Go-Live"],
                    roles: [
                        { role: "Tech - Sr. Consultant - Implementation", hours: 20, rate: 295 },
                        { role: "Tech - Specialist - Configuration", hours: 25, rate: 180 },
                        { role: "Tech - Producer - Setup & Testing", hours: 15, rate: 120 },
                        { role: "Tech - Producer - Training & Documentation", hours: 10, rate: 120 }
                    ]
                },
                {
                    id: 9,
                    name: "Marketing Automation | 40-Hour Support Retainer",
                    category: "Managed Services",
                    pricing: "$5,490", 
                    hours: 40,
                    avgRate: "$137",
                    description: "2-Month Support Retainer for ongoing marketing automation assistance and optimization",
                    deliverables: [
                        "User Support for questions, troubleshooting, and guidance",
                        "Technical Support for platform issues",
                        "Lead Management Support for sales pipeline optimization",
                        "Reporting and Analysis with custom reports",
                        "List Segmentation and Management assistance",
                        "Workflow and Automation Configuration reviews",
                        "Documentation and Knowledge Base Maintenance"
                    ],
                    phases: ["Month 1 Support", "Month 2 Support", "Documentation"],
                    roles: [
                        { role: "Tech - Producer - Support & Monitoring", hours: 25, rate: 120 },
                        { role: "Tech - Producer - Reporting", hours: 5, rate: 120 },
                        { role: "Tech - Head Of - Senior Project Management", hours: 2, rate: 365 },                        { role: "Account Management - Account Manager", hours: 4, rate: 180 }
                    ]
                },
                {
                    id: 10,
                    name: "Marketing Automation | Account & Project Management",
                    category: "Project Management",
                    pricing: "$4,650", 
                    hours: 25,
                    avgRate: "$186",
                    description: "Dedicated Account and Project Management services for marketing automation projects",
                    deliverables: [
                        "Kick-Off Meeting: Align stakeholders and define objectives",
                        "Work In Progress Meetings: Regular progress tracking",
                        "Status Updates: Periodic project status communication",
                        "Change Management Discussions: Support for project changes",
                        "Internal Briefings: Team coordination and task management",
                        "Project Plan, Charter, and Quality Assurance Planning"
                    ],
                    phases: ["Project Initiation", "Progress Management", "Status Communication", "Project Delivery"],
                    roles: [
                        { role: "Account Management - Account Manager", hours: 10, rate: 180 },
                        { role: "Account Management - Senior Account Manager", hours: 10, rate: 210 },
                        { role: "Tech - Delivery - Project Management", hours: 5, rate: 150 }
                    ]
                },
                {
                    id: 11,
                    name: "Marketing Automation Services - Project Bundle A",
                    category: "Project Bundles",
                    pricing: "$18,937", 
                    hours: 140,
                    avgRate: "$135",
                    description: "Comprehensive Marketing Automation project bundle including Email Templates and additional services",
                    deliverables: [
                        "Complete Email Template Services package",
                        "Marketing Automation setup and configuration",
                        "User testing and approval workflows",
                        "Account and Project Management throughout",
                        "Technical assessment and quality assurance",
                        "Final delivery and go-live support"
                    ],
                    phases: ["Discovery & Planning", "Technical Setup", "Quality Assurance", "Final Delivery"],
                    roles: [
                        { role: "Tech - Producer - Email Production", hours: 18, rate: 120 },
                        { role: "Tech - Producer - Design", hours: 13, rate: 120 },
                        { role: "Tech - Producer - Development", hours: 17, rate: 120 },
                        { role: "Tech - Producer - Testing", hours: 16, rate: 120 },
                        { role: "Account Management - Account Manager", hours: 20, rate: 180 }
                    ]
                },
                {
                    id: 12,
                    name: "PROJECT NAME - Custom Service Package",
                    category: "Custom Services",
                    pricing: "$6,255", 
                    hours: 30,
                    avgRate: "$208",
                    description: "Custom monthly support package tailored to specific client needs and requirements",
                    deliverables: [
                        "User Support for platform questions and guidance",
                        "Technical Support for platform troubleshooting",
                        "Lead Management Support for sales pipeline",
                        "Reporting and Analysis with data model updates",
                        "List Segmentation and Management for targeted efforts",
                        "Workflow and Automation Configuration optimization"
                    ],
                    phases: ["Setup & Configuration", "Monthly Support", "Optimization"],
                    roles: [
                        { role: "Tech - Sr. Consultant - Services", hours: 6, rate: 295 },
                        { role: "Tech - Specialist - Services", hours: 6, rate: 180 },
                        { role: "Tech - Producer - Services", hours: 6, rate: 120 },                        { role: "Account Management - Senior Account Manager", hours: 6, rate: 210 }
                    ]
                },
                {
                    id: 13,
                    name: "Marketing Automation | Platform 6-Month Premium Support",
                    category: "Managed Services",
                    pricing: "$48,225", 
                    hours: 240,
                    avgRate: "$201",
                    description: "Premium 6-Month Support Retainer with enhanced services, platform updates, and comprehensive support",
                    deliverables: [
                        "All Standard Support Services plus Enhanced Features",
                        "Platform Updates and Maintenance recommendations",
                        "Advanced Campaign Management and Optimization",
                        "Enhanced Lead Management and Sales Pipeline Support",
                        "Advanced Reporting and Analytics with insights",
                        "Comprehensive Documentation and Knowledge Base",
                        "Ticketing System Setup with Google form to Asana integration"
                    ],
                    phases: ["Setup & Onboarding", "Monthly Support Cycles", "Quarterly Reviews", "Optimization"],
                    roles: [
                        { role: "Tech - Producer - Support & Monitoring", hours: 60, rate: 120 },
                        { role: "Tech - Specialist - Database Management", hours: 60, rate: 180 },
                        { role: "Tech - Sr. Consultant - Advisory & Consultation", hours: 60, rate: 295 },
                        { role: "Tech - Head Of - Senior Project Management", hours: 15, rate: 365 },
                        { role: "Account Management - Account Manager", hours: 30, rate: 180 }
                    ]
                },
                {
                    id: 14,
                    name: "Marketing Automation | Email Campaign Services",
                    category: "Campaign Management",
                    pricing: "$9,587", 
                    hours: 70,
                    avgRate: "$137",
                    description: "Complete Email Campaign setup including automation, SMS build, and landing page integration",
                    deliverables: [
                        "Email Production and Campaign Build",
                        "Landing Page Production and Integration", 
                        "Campaign Build and Automation Setup",
                        "Copywriting and Design services",
                        "Development and Deployment support",
                        "Testing across multiple devices and platforms",
                        "Account Management and Project Coordination"
                    ],
                    phases: ["Discovery & Planning", "Technical Setup", "Campaign Build", "Testing", "Deployment"],
                    roles: [
                        { role: "Tech - Producer - Email Production", hours: 10, rate: 120 },
                        { role: "Tech - Producer - Landing Page Production", hours: 10, rate: 120 },
                        { role: "Tech - Producer - Campaign Build", hours: 10, rate: 120 },
                        { role: "Tech - Producer - Copywriting", hours: 5, rate: 120 },
                        { role: "Tech - Producer - Design", hours: 5, rate: 120 },                        { role: "Account Management - Account Manager", hours: 10, rate: 180 }
                    ]
                },
                {
                    id: 15,
                    name: "Marketing Automation | Discovery & Strategy Package",
                    category: "Strategy & Consultation",
                    pricing: "$8,270", 
                    hours: 60,
                    avgRate: "$138",
                    description: "Comprehensive discovery and strategy development for marketing automation implementation",
                    deliverables: [
                        "Objective setting and requirements gathering",
                        "Review of existing systems and processes",
                        "Identification and understanding of current state",
                        "Setup and build recommendations",
                        "User testing strategy and approval workflows",
                        "Strategic roadmap and implementation plan"
                    ],
                    phases: ["Discovery Phase", "Technical Assessment", "Strategy Development", "Recommendations"],
                    roles: [
                        { role: "Tech - Head Of - Senior Project Management", hours: 2.5, rate: 365 },
                        { role: "Tech - Sr. Consultant - Strategy", hours: 15, rate: 295 },
                        { role: "Tech - Specialist - Assessment", hours: 12, rate: 180 },
                        { role: "Tech - Producer - Documentation", hours: 10, rate: 120 },
                        { role: "Account Management - Account Manager", hours: 10, rate: 180 }
                    ]
                },
                {
                    id: 16,
                    name: "Marketing Automation | Platform Audit Services",
                    category: "Audit & Assessment",
                    pricing: "$10,700", 
                    hours: 56,
                    avgRate: "$191",
                    description: "Current State and Future State Audit of Marketing Automation Platform with comprehensive assessment",
                    deliverables: [
                        "Platform Overview: Analysis of existing MA platform setup",
                        "Configuration Assessment: Review of configurations and CRM integration",
                        "Campaign Performance Analysis: Evaluation of past campaign effectiveness",
                        "Audience Segmentation Review: Assessment of list management and segmentation",
                        "MA Processes Review: Assessment of automation workflows and rules",
                        "Future State Recommendations: Best practice recommendations and roadmap"
                    ],
                    phases: ["Current State Assessment", "Performance Analysis", "Future State Planning", "Recommendations"],
                    roles: [
                        { role: "Tech - Head Of - Customer Experience Strategy", hours: 6, rate: 365 },
                        { role: "Tech - Sr. Consultant - Strategy", hours: 12, rate: 295 },
                        { role: "Tech - Specialist - Platform Assessment", hours: 18, rate: 180 },
                        { role: "Tech - Producer - Documentation", hours: 20, rate: 120 }
                    ]
                },
                {
                    id: 17,
                    name: "CRM | Pipedrive Implementation & Configuration",
                    category: "Implementation & Setup",
                    pricing: "$16,605", 
                    hours: 90,
                    avgRate: "$185",
                    description: "Complete Pipedrive CRM implementation and configuration for sales pipeline optimization",
                    deliverables: [
                        "Discovery Phase with objectives and timeline definition",
                        "Account Setup and User Configuration",
                        "Sales Pipeline Creation and Deal Stage Setup",
                        "Custom Fields and Property Configuration",
                        "Workflow and Automation Setup",
                        "Reporting and Dashboard Configuration",
                        "Training Session and Resource Handover"
                    ],
                    phases: ["Discovery", "Account Setup", "Pipeline Configuration", "Automation Setup", "Training"],
                    roles: [
                        { role: "Tech - Sr. Consultant - Implementation", hours: 25, rate: 295 },
                        { role: "Tech - Specialist - Configuration", hours: 30, rate: 180 },
                        { role: "Tech - Producer - Setup & Testing", hours: 20, rate: 120 },
                        { role: "Tech - Producer - Training & Documentation", hours: 15, rate: 120 }
                    ]
                },
                {
                    id: 18,
                    name: "Marketing Automation | MessageMedia SMS Implementation",
                    category: "Implementation & Setup",
                    pricing: "$6,399", 
                    hours: 38,
                    avgRate: "$168",
                    description: "MessageMedia SMS platform implementation and integration for marketing automation",
                    deliverables: [
                        "MessageMedia Account Setup and Configuration",
                        "SMS Template Development and Approval",
                        "Integration with Existing Marketing Automation Platform",
                        "SMS Workflow and Trigger Setup",
                        "Compliance and Opt-in Configuration",
                        "Testing and Quality Assurance",
                        "Go-Live Support and Documentation"
                    ],
                    phases: ["Setup", "Template Development", "Integration", "Testing", "Go-Live"],
                    roles: [
                        { role: "Tech - Specialist - Integration Services", hours: 15, rate: 190 },
                        { role: "Tech - Producer - Configuration", hours: 12, rate: 120 },
                        { role: "Tech - Producer - Testing", hours: 8, rate: 120 },
                        { role: "Account Management - Account Manager", hours: 3, rate: 180 }
                    ]
                },
                {
                    id: 19,
                    name: "Marketing Automation | SMS Setup & Configuration",
                    category: "Configuration & Setup",
                    pricing: "$4,525", 
                    hours: 25,
                    avgRate: "$181",
                    description: "SMS marketing setup and configuration within existing marketing automation platform",
                    deliverables: [
                        "SMS Campaign Configuration",
                        "Template Setup and Approval Workflow",
                        "Automation Trigger Configuration",
                        "Compliance and Consent Management Setup",
                        "Testing Across Multiple Devices",
                        "Quality Assurance and Final Approval"
                    ],
                    phases: ["Configuration", "Template Setup", "Testing", "Final Approval"],
                    roles: [
                        { role: "Tech - Specialist - SMS Configuration", hours: 10, rate: 180 },
                        { role: "Tech - Producer - Template Setup", hours: 8, rate: 120 },
                        { role: "Tech - Producer - Testing", hours: 5, rate: 120 },
                        { role: "Account Management - Account Manager", hours: 2, rate: 180 }
                    ]
                },
                {
                    id: 20,
                    name: "Marketing Automation | New Lead Welcome Nurture Setup",
                    category: "Campaign Management",
                    pricing: "$12,185", 
                    hours: 85,
                    avgRate: "$143",
                    description: "Complete welcome nurture sequence setup for new leads with email automation and workflows",
                    deliverables: [
                        "Welcome Series Strategy and Planning",
                        "Email Template Design and Development", 
                        "Automation Workflow Configuration",
                        "Lead Scoring Integration",
                        "Segmentation and Personalization Setup",
                        "A/B Testing Configuration",
                        "Performance Tracking and Analytics Setup"
                    ],
                    phases: ["Strategy Planning", "Email Development", "Workflow Setup", "Testing", "Launch"],
                    roles: [
                        { role: "Tech - Sr. Consultant - Strategy", hours: 15, rate: 295 },
                        { role: "Tech - Producer - Email Development", hours: 25, rate: 120 },
                        { role: "Tech - Specialist - Automation Setup", hours: 20, rate: 180 },
                        { role: "Tech - Producer - Testing", hours: 15, rate: 120 },
                        { role: "Account Management - Account Manager", hours: 10, rate: 180 }
                    ]
                },
                {
                    id: 21,
                    name: "Marketing Automation | Re-engagement Nurture Setup",
                    category: "Campaign Management",
                    pricing: "$6,450", 
                    hours: 45,
                    avgRate: "$143",
                    description: "Re-engagement campaign setup to reactivate dormant leads and improve engagement rates",
                    deliverables: [
                        "Re-engagement Strategy Development",
                        "Audience Segmentation for Inactive Leads",
                        "Email Template Design and Copywriting",
                        "Automation Workflow Configuration",
                        "Win-back Campaign Setup",
                        "Performance Tracking and Optimization"
                    ],
                    phases: ["Strategy Development", "Segmentation", "Campaign Development", "Launch"],
                    roles: [
                        { role: "Tech - Sr. Consultant - Strategy", hours: 8, rate: 295 },
                        { role: "Tech - Producer - Email Development", hours: 15, rate: 120 },
                        { role: "Tech - Specialist - Automation Setup", hours: 12, rate: 180 },
                        { role: "Tech - Producer - Testing", hours: 6, rate: 120 },
                        { role: "Account Management - Account Manager", hours: 4, rate: 180 }
                    ]
                },
                {
                    id: 22,
                    name: "Marketing Automation | Re-engagement Nurture & Landing Page Setup",
                    category: "Campaign Management",
                    pricing: "$16,060", 
                    hours: 110,
                    avgRate: "$146",
                    description: "Complete re-engagement campaign with custom landing page development and automation setup",
                    deliverables: [
                        "Re-engagement Strategy and Landing Page Planning",
                        "Custom Landing Page Design and Development",
                        "Email Template Series Development",
                        "Automation Workflow Configuration", 
                        "A/B Testing Setup for Landing Pages and Emails",
                        "Conversion Tracking and Analytics Integration",
                        "Performance Optimization and Reporting"
                    ],                    phases: ["Strategy & Planning", "Landing Page Development", "Email Campaign Setup", "Testing", "Launch"],
                    roles: [
                        { role: "Tech - Sr. Consultant - Strategy", hours: 12, rate: 295 },
                        { role: "Tech - Producer - Landing Page Development", hours: 30, rate: 120 },
                        { role: "Tech - Producer - Email Development", hours: 25, rate: 120 },
                        { role: "Tech - Specialist - Automation Setup", hours: 20, rate: 180 },
                        { role: "Tech - Producer - Testing", hours: 15, rate: 120 },
                        { role: "Account Management - Account Manager", hours: 8, rate: 180 }
                    ]
                },
                {
                    id: 23,
                    name: "Marketing Automation | Automated Appointment Booking Setup",
                    category: "Implementation & Setup",
                    pricing: "$8,030", 
                    hours: 52,
                    avgRate: "$154",
                    description: "Automated appointment booking solution with landing page integration for streamlined lead capture",
                    deliverables: [
                        "Assessment of Requirements and Tool Selection",
                        "System Configuration and Setup",
                        "Integration with Lead Generation System",
                        "Customization and Branding Implementation",
                        "Landing Page Design and Development",
                        "Testing and Quality Assurance",
                        "Deployment and Post-Launch Monitoring"
                    ],
                    phases: ["Requirements Assessment", "System Configuration", "Integration & Customization", "Testing", "Deployment"],
                    roles: [
                        { role: "Tech - Head Of - Program Strategy", hours: 4, rate: 365 },
                        { role: "Tech - Producer - Landing Page Production", hours: 9, rate: 120 },
                        { role: "Tech - Producer - Services", hours: 9, rate: 120 },
                        { role: "Tech - Specialist - Integration Services", hours: 3, rate: 190 },
                        { role: "Tech - Producer - Testing", hours: 9, rate: 120 },
                        { role: "Account Management - Account Manager", hours: 5, rate: 180 }
                    ]
                },
                {
                    id: 24,
                    name: "Marketing Automation | Appointment Automation Workflow Setup",
                    category: "Campaign Management",
                    pricing: "$9,700", 
                    hours: 62,
                    avgRate: "$156",
                    description: "Complete appointment automation workflow with reminder emails and follow-up sequences",
                    deliverables: [
                        "Email Program Build (Reminder, Non-attendee, Follow-up)",
                        "Campaign Automation Strategy Development",
                        "Email and SMS Template Design and Development",
                        "Workflow and Trigger Configuration",
                        "List Management and Segmentation Setup",
                        "Testing and Peer Review",
                        "Go-Live Support and Monitoring"
                    ],
                    phases: ["Strategy Development", "Email/SMS Development", "Workflow Setup", "Testing", "Go-Live"],
                    roles: [
                        { role: "Tech - Sr. Consultant - Campaign Strategy", hours: 6, rate: 295 },
                        { role: "Tech - Producer - Email Production", hours: 9, rate: 120 },
                        { role: "Tech - Producer - Campaign Build", hours: 9, rate: 120 },
                        { role: "Tech - Specialist - Integration Services", hours: 3, rate: 190 },
                        { role: "Tech - Producer - Testing", hours: 9, rate: 120 },
                        { role: "Account Management - Account Manager", hours: 9, rate: 180 }
                    ]
                },
                {
                    id: 25,
                    name: "Marketing Automation | Preference Centre Setup",
                    category: "Configuration & Setup",
                    pricing: "$6,960", 
                    hours: 48,
                    avgRate: "$145",
                    description: "Custom preference centre design, development and deployment for subscription management",
                    deliverables: [
                        "Preference Centre Planning and Conception",
                        "Wireframe Design and Layout Creation",
                        "Subscription Management Configuration",
                        "Preference Options and Categories Setup",
                        "Data Field Mapping and Integration",
                        "Functionality and User Experience Testing",
                        "Deployment and Go-Live Support"
                    ],
                    phases: ["Planning & Design", "Configuration", "Testing", "Deployment"],
                    roles: [
                        { role: "Tech - Producer - Landing Page Production", hours: 12, rate: 120 },
                        { role: "Tech - Producer - Design", hours: 6, rate: 120 },
                        { role: "Tech - Producer - Development", hours: 12, rate: 120 },
                        { role: "Tech - Producer - Testing", hours: 12, rate: 120 },                        { role: "Tech - Producer - Deployment", hours: 6, rate: 120 }
                    ]
                },
                {
                    id: 26,
                    name: "Marketing Automation | Chatbot Setup & Configuration",
                    category: "Implementation & Setup",
                    pricing: "$8,000", 
                    hours: 56,
                    avgRate: "$143",
                    description: "Complete ChatBot implementation with conversational flows, integration, and quality assurance",
                    deliverables: [
                        "Discovery & Planning Phase with goals and objectives",
                        "Technical Setup and Platform Integration",
                        "Chatbot Logic and Conversational Flow Design",
                        "Copy Prompts and Customer Interaction Scripting",
                        "Quality Assurance & Multi-Device Testing",
                        "Final Review and Go-Live Integration",
                        "Documentation and Maintenance Guidelines"
                    ],
                    phases: ["Discovery & Planning", "Technical Setup", "Quality Assurance & Testing", "Final Delivery"],
                    roles: [
                        { role: "Tech - Producer - Chat Bot / Live Chat", hours: 25, rate: 120 },
                        { role: "Tech - Producer - Copywriting", hours: 5, rate: 120 },
                        { role: "Tech - Producer - Integration Assistance", hours: 5, rate: 120 },
                        { role: "Tech - Producer - Testing", hours: 5, rate: 120 },
                        { role: "Tech - Sr. Consultant - Strategy", hours: 2, rate: 295 },
                        { role: "Account Management - Account Manager", hours: 8, rate: 180 }
                    ]
                },
                {
                    id: 27,
                    name: "Marketing Automation | Triggered Customer Renewal Campaign",
                    category: "Campaign Management",
                    pricing: "$8,530", 
                    hours: 60,
                    avgRate: "$142",
                    description: "Automated customer renewal program with triggered campaigns for existing customer retention",
                    deliverables: [
                        "Email Program Build (4x Messages for Different Events)",
                        "Campaign Automation Strategy for Renewal Triggers",
                        "Email Copy, Design, and Development",
                        "List Management and Customer Segmentation",
                        "Automation Workflow Configuration",
                        "Testing and Peer Review",
                        "Go-Live Scheduling and Monitoring"
                    ],
                    phases: ["Strategy Development", "Email Campaign Build", "Automation Setup", "Testing", "Go-Live"],
                    roles: [
                        { role: "Tech - Producer - Email Production", hours: 8, rate: 120 },
                        { role: "Tech - Producer - Copywriting", hours: 8, rate: 120 },
                        { role: "Tech - Producer - Design", hours: 4, rate: 120 },
                        { role: "Tech - Specialist - Campaign Orchestration", hours: 4, rate: 180 },
                        { role: "Tech - Producer - Testing", hours: 8, rate: 120 },
                        { role: "Account Management - Account Manager", hours: 8, rate: 180 }
                    ]
                },
                {
                    id: 28,
                    name: "Marketing Automation | Single Landing Page Development",
                    category: "Development & Design",
                    pricing: "$5,585", 
                    hours: 40,
                    avgRate: "$140",
                    description: "Complete landing page setup with copy, design, development, and integration (max 4 modules)",
                    deliverables: [
                        "Landing Page Copy and Content Creation",
                        "Landing Page Design and Wireframing",
                        "Landing Page Development and Coding",
                        "Deployment and Integration Setup",
                        "Form Review and Integration Testing",
                        "QA Review and User Acceptance Testing",
                        "Go-Live and Handover Documentation"
                    ],
                    phases: ["Planning & Copy", "Design & Development", "Integration & Testing", "Go-Live"],
                    roles: [
                        { role: "Tech - Producer - Landing Page Production", hours: 6, rate: 120 },
                        { role: "Tech - Producer - Copywriting", hours: 3, rate: 120 },
                        { role: "Tech - Producer - Design", hours: 6, rate: 120 },
                        { role: "Tech - Producer - Development", hours: 6, rate: 120 },
                        { role: "Tech - Specialist - Integration Services", hours: 3, rate: 190 },
                        { role: "Account Management - Account Manager", hours: 6, rate: 180 }
                    ]
                },
                {
                    id: 29,
                    name: "Marketing Automation | Marketo 30-Hour Support Retainer",
                    category: "Managed Services",
                    pricing: "$8,060", 
                    hours: 40,
                    avgRate: "$202",
                    description: "2-Month Marketo Support Retainer covering campaign management, technical support, and optimization",
                    deliverables: [
                        "User Support and Technical Troubleshooting",
                        "Campaign Management and Smart Campaign Setup",
                        "Lead Management and Sales Pipeline Optimization",
                        "Email Marketing Support and QA Testing",
                        "Reporting and Analysis with Custom Reports",
                        "Workflow and Automation Configuration Review",
                        "List Segmentation and Management Support"
                    ],                    phases: ["Month 1 Support", "Month 2 Support", "Ongoing Optimization"],
                    roles: [
                        { role: "Tech - Producer - Support & Monitoring", hours: 10, rate: 120 },
                        { role: "Tech - Specialist - Database Management", hours: 10, rate: 180 },
                        { role: "Tech - Sr. Consultant - Advisory & Consultation", hours: 10, rate: 295 },
                        { role: "Tech - Head Of - Senior Project Management", hours: 2, rate: 365 },
                        { role: "Account Management - Account Manager", hours: 6, rate: 180 }
                    ]
                },
                {
                    id: 30,
                    name: "Marketing Automation | Salesforce Marketing Cloud Audit",
                    category: "Audit & Assessment",
                    pricing: "$10,040", 
                    hours: 50,
                    avgRate: "$201",
                    description: "Comprehensive SFMC audit covering current state, technical infrastructure, and future state recommendations",
                    deliverables: [
                        "Current State Analysis and Platform Usage Review",
                        "Technical Infrastructure and Data Extension Audit",
                        "Campaign and Content Effectiveness Assessment",
                        "Process and Workflow Analysis",
                        "Analytics and Reporting Review",
                        "Future State Recommendations and Strategic Enhancements",
                        "Final Documentation and Stakeholder Workshop"
                    ],
                    phases: ["Current State Assessment", "Technical Audit", "Performance Analysis", "Future State Planning"],
                    roles: [
                        { role: "Tech - Producer - Documentation Setup", hours: 15, rate: 120 },
                        { role: "Tech - Sr. Consultant - Advisory & Consultation", hours: 15, rate: 295 },
                        { role: "Tech - Head Of - Customer Experience Strategy", hours: 5, rate: 365 },
                        { role: "Tech - Producer - Reporting", hours: 6, rate: 120 },
                        { role: "Account Management - Account Manager", hours: 4, rate: 180 }
                    ]
                },
                {
                    id: 31,
                    name: "B2B/CRM/ABM | 6-Month Advisory & Consultation",
                    category: "Advisory & Consultation",
                    pricing: "$44,650", 
                    hours: 200,
                    avgRate: "$223",
                    description: "Comprehensive B2B, CRM, and Account-Based Marketing advisory retainer with strategic planning and implementation support",
                    deliverables: [
                        "Initial Discovery Meetings and Requirements Assessment",
                        "Current Systems and Processes Evaluation",
                        "CRM Customization and Configuration Support",
                        "Data Strategy and ABM Framework Development",
                        "Ongoing Support and Consultation Services",
                        "Strategic Planning and Roadmap Development",
                        "Performance Monitoring and Reporting Support"
                    ],
                    phases: ["Discovery & Assessment", "Strategic Planning", "Implementation Support", "Ongoing Optimization"],
                    roles: [
                        { role: "Tech - Head Of - Customer Experience Strategy", hours: 30, rate: 365 },
                        { role: "Tech - Sr. Consultant - Advisory & Consultation", hours: 20, rate: 295 },
                        { role: "Tech - Sr. Architect - Data Strategy", hours: 20, rate: 365 },
                        { role: "Tech - Specialist - Database Management", hours: 20, rate: 180 },
                        { role: "Tech - Specialist - Integration Services", hours: 20, rate: 190 },
                        { role: "Account Management - Account Manager", hours: 30, rate: 180 }
                    ]
                },
                {
                    id: 32,
                    name: "Marketing Automation | HubSpot Full Implementation (All Hubs)",
                    category: "Implementation & Setup",
                    pricing: "$29,750", 
                    hours: 150,
                    avgRate: "$198",
                    description: "Complete HubSpot implementation including Marketing Hub, Sales Hub, and Service Hub with training and support",
                    deliverables: [
                        "Initial Account Customization and User Setup",
                        "Marketing Hub Implementation with Tracking and Domains",
                        "Sales Hub Implementation with Pipelines and Workflows",
                        "Service Hub Implementation with Inbox and Ticket Management",
                        "Reporting and Dashboards (4x custom reports max)",
                        "Go-Live, Deployment, and 2x Training Sessions",
                        "Resource Handover and Documentation"
                    ],
                    phases: ["Account Setup", "Marketing Hub", "Sales Hub", "Service Hub", "Reporting", "Training & Go-Live"],
                    roles: [
                        { role: "Tech - Producer - Admin Configuration", hours: 30, rate: 120 },
                        { role: "Tech - Head Of - System Setup", hours: 20, rate: 365 },
                        { role: "Tech - Sr. Consultant - Advisory & Consultation", hours: 10, rate: 295 },
                        { role: "Tech - Specialist - Database Management", hours: 10, rate: 180 },
                        { role: "Tech - Specialist - Workflows", hours: 10, rate: 180 },
                        { role: "Tech - Specialist - Integration Services", hours: 10, rate: 190 },
                        { role: "Account Management - Account Manager", hours: 15, rate: 180 }
                    ]
                }
            ];
            
            console.log('Real services loaded from KB:', services);
            renderServiceVisualization();
        }        // --- Service Visualization ---
        function renderServiceVisualization() {
            if (!services || services.length === 0) return;
            
            // Use the new view system based on currentView
            const container = document.getElementById('knowledge-visualization');
            
            switch(currentView) {
                case 'tree':
                    renderTreeView(container);
                    break;
                case 'network':
                    renderNetworkView(container);
                    break;
                case 'categories':
                    renderCategoryView(container);
                    break;
                default:
                    renderGridView(container);
            }
        }
        
        function renderGridView(container) {
            // Clear existing content
            container.innerHTML = '';
            
            // Create service grid layout
            const serviceGrid = document.createElement('div');
            serviceGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4';
              services.forEach(service => {
                const serviceCard = document.createElement('div');
                  // Determine category class for color coding
                let categoryClass = 'category-marketing'; // default
                if (service.category.includes('Audit')) categoryClass = 'category-audit';
                else if (service.category.includes('Strategy')) categoryClass = 'category-strategy';
                else if (service.category.includes('Managed')) categoryClass = 'category-managed';
                else if (service.category.includes('Advisory')) categoryClass = 'category-advisory';
                else if (service.category.includes('Configuration') || service.category.includes('Setup')) categoryClass = 'category-configuration';
                else if (service.category.includes('Implementation')) categoryClass = 'category-implementation';
                else if (service.category.includes('Project Management')) categoryClass = 'category-project';
                else if (service.category.includes('Bundles')) categoryClass = 'category-bundles';
                else if (service.category.includes('Custom')) categoryClass = 'category-custom';
                
                serviceCard.className = `service-node ${categoryClass} bg-white border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 cursor-pointer transition-all`;
                serviceCard.onclick = () => showServiceDetails(service);
                
                serviceCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-semibold text-sm text-gray-900 leading-tight pr-2">${service.name}</h3>
                        <div class="text-right flex-shrink-0">
                            <div class="text-lg font-bold text-blue-600">${service.pricing}</div>
                            <div class="text-xs text-gray-500">${service.hours} hrs</div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <span class="inline-block bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs font-medium">${service.category}</span>
                    </div>
                    <div class="text-xs text-gray-600 line-clamp-2">
                        ${service.description}
                    </div>
                    <div class="mt-3 flex justify-between items-center text-xs text-gray-500">
                        <span>${service.deliverables.length} deliverables</span>
                        <span>Avg: ${service.avgRate}</span>
                    </div>
                `;
                
                serviceGrid.appendChild(serviceCard);
            });
            
            container.appendChild(serviceGrid);
        }        function showServiceDetailsById(serviceId) {
            const service = services.find(s => s.id == serviceId);
            if (service) {
                showServiceDetails(service);
            }
        }

          function showServiceDetails(service) {
            const detailsPanel = document.getElementById('service-details');
            const titleElement = document.getElementById('service-title');
            const infoElement = document.getElementById('service-info');
            
            titleElement.textContent = service.name;
            
            infoElement.innerHTML = `
                <div class="glass-effect rounded-xl shadow-lg card-elevated">
                    <!-- Header Section -->
                    <div class="primary-gradient p-6 rounded-t-xl text-white">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="bg-white bg-opacity-20 backdrop-blur rounded-lg p-3">
                                <div class="text-2xl font-bold text-white">${service.pricing}</div>
                                <div class="text-xs text-green-200">Investment</div>
                            </div>
                            <div class="bg-white bg-opacity-20 backdrop-blur rounded-lg p-3">
                                <div class="text-2xl font-bold text-white">${service.hours}</div>
                                <div class="text-xs text-green-200">Hours</div>
                            </div>
                            <div class="bg-white bg-opacity-20 backdrop-blur rounded-lg p-3">
                                <div class="text-2xl font-bold text-white">${service.avgRate}</div>
                                <div class="text-xs text-green-200">Avg Rate</div>
                            </div>
                            <div class="bg-white bg-opacity-20 backdrop-blur rounded-lg p-3">
                                <div class="text-2xl font-bold text-white">${service.category}</div>
                                <div class="text-xs text-green-200">Category</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Section -->
                    <div class="p-6 space-y-6">
                        <!-- Description -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                <span class="w-3 h-3 primary-gradient rounded-full mr-3"></span>
                                Service Overview
                            </h4>
                            <p class="text-gray-700 leading-relaxed bg-gradient-to-r from-gray-50 to-white p-4 rounded-lg border border-gray-100">
                                ${service.description}
                            </p>
                        </div>
                        
                        <!-- Key Deliverables -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                <span class="w-3 h-3 bg-green-500 rounded-full mr-3"></span>
                                Key Deliverables (${service.deliverables.length})
                            </h4>
                            <div class="grid gap-3">
                                ${service.deliverables.map((item, index) => `
                                    <div class="flex items-start space-x-3 p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-100">
                                        <span class="flex-shrink-0 w-6 h-6 primary-gradient text-white rounded-full text-xs flex items-center justify-center font-medium">
                                            ${index + 1}
                                        </span>
                                        <span class="text-gray-700">${item}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Project Phases -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                <span class="w-3 h-3 bg-purple-500 rounded-full mr-3"></span>
                                Project Phases
                            </h4>
                            <div class="flex flex-wrap gap-2">
                                ${service.phases.map((phase, index) => `
                                    <span class="bg-gradient-to-r from-purple-100 to-pink-100 text-purple-800 px-4 py-2 rounded-full text-sm font-medium border border-purple-200">
                                        ${index + 1}. ${phase}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Team Structure -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                <span class="w-3 h-3 bg-orange-500 rounded-full mr-3"></span>
                                Team Structure & Pricing
                            </h4>
                            <div class="bg-gradient-to-r from-gray-50 to-white rounded-lg overflow-hidden border border-gray-200">
                                <div class="grid grid-cols-4 primary-gradient text-white p-3 text-sm font-medium">
                                    <div>Role</div>
                                    <div class="text-center">Hours</div>
                                    <div class="text-center">Rate</div>
                                    <div class="text-center">Total</div>
                                </div>
                                ${service.roles.map(role => `
                                    <div class="grid grid-cols-4 p-3 border-b border-gray-100 text-sm hover:bg-gradient-to-r hover:from-gray-50 hover:to-white transition-colors">
                                        <div class="font-medium text-gray-900">${role.role}</div>
                                        <div class="text-center text-gray-600">${role.hours}h</div>
                                        <div class="text-center text-gray-600">$${role.rate}</div>
                                        <div class="text-center font-semibold text-green-600">$${(role.hours * role.rate).toLocaleString()}</div>
                                    </div>
                                `).join('')}
                                <div class="primary-gradient text-white p-3">
                                    <div class="grid grid-cols-4 text-sm font-bold">
                                        <div>Total Project</div>
                                        <div class="text-center">${service.hours}h</div>
                                        <div class="text-center">${service.avgRate} avg</div>
                                        <div class="text-center">${service.pricing}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-wrap gap-3 pt-4 border-t border-gray-200">
                            <button onclick="addServiceToQuote('${service.id}')" 
                                    class="btn-primary px-4 py-2 rounded-lg hover:scale-105 transition-transform font-medium">
                                üìã Add to Quote
                            </button>
                            <button onclick="generateSOWForService('${service.id}')" 
                                    class="btn-secondary px-4 py-2 rounded-lg hover:scale-105 transition-transform font-medium">
                                üìÑ Generate SOW
                            </button>
                            <button onclick="viewSimilarServices('${service.category}')" 
                                    class="btn-secondary px-4 py-2 rounded-lg hover:scale-105 transition-transform font-medium">
                                üîç Similar Services
                            </button>
                            <button onclick="closeServiceDetails()" 
                                    class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors font-medium">
                                ‚úï Close
                            </button>
                        </div>
                    </div>
                </div>
            `;            
            detailsPanel.classList.remove('hidden');
            detailsPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function closeServiceDetails() {
            document.getElementById('service-details').classList.add('hidden');
        }
        
        function addServiceToQuote(serviceId) {
            showToast('üìã Service added to quote!', 'success');
        }
        
        function generateSOWForService(serviceId) {
            const service = services.find(s => s.id == serviceId);
            if (service) {
                window.open(`enhanced-sow-demo.html?serviceId=${serviceId}&serviceName=${encodeURIComponent(service.name)}`, '_blank');
            }
        }
        
        function viewSimilarServices(category) {
            const similarServices = services.filter(s => s.category === category);
            showToast(`üîç Found ${similarServices.length} services in ${category}`, 'info');
        }
        
        // --- AnythingLLM API Helper ---
        async function callAnythingLLM(message) {
            const response = await fetch(`${ANYTHINGLLM_CONFIG.baseUrl}/api/v1/workspace/${ANYTHINGLLM_CONFIG.workspace}/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ANYTHINGLLM_CONFIG.apiKey}`,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    mode: 'chat'
                })
            });

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status} ${response.statusText}`);
            }            const data = await response.json();
            return data.textResponse || data.message || 'No response received';
        }

        // ======================== SOW GENERATOR FUNCTIONS ========================
        
        // Initialize SOW Generator
        function initializeSOWGenerator() {
            const clientSelect = document.getElementById('sow-client-select');
            const autoResearchBtn = document.getElementById('auto-research-btn');
            const aiSuggestServicesBtn = document.getElementById('ai-suggest-services');
            const generateSOWBtn = document.getElementById('generate-sow');
            const saveDraftBtn = document.getElementById('save-sow-draft');
            const exportPDFBtn = document.getElementById('export-pdf');
            const copySOWBtn = document.getElementById('copy-sow');
            
            // Populate client dropdown
            populateClientDropdown();
            
            // Populate service checkboxes
            populateServiceSelection();
            
            // Add event listeners
            clientSelect.addEventListener('change', handleClientSelection);
            autoResearchBtn.addEventListener('click', performClientResearch);
            aiSuggestServicesBtn.addEventListener('click', suggestServicesForClient);
            generateSOWBtn.addEventListener('click', generateSOW);
            saveDraftBtn.addEventListener('click', saveSOWDraft);
            exportPDFBtn.addEventListener('click', exportSOWToPDF);
            copySOWBtn.addEventListener('click', copySOWToClipboard);
        }
        
        // Populate client dropdown
        function populateClientDropdown() {
            const clientSelect = document.getElementById('sow-client-select');
            clientSelect.innerHTML = '<option value="">Select a client...</option>';
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.name} - ${client.company || 'No Company'}`;
                clientSelect.appendChild(option);
            });
        }
        
        // Populate service selection from KB
        function populateServiceSelection() {
            const serviceSelection = document.getElementById('service-selection');
            serviceSelection.innerHTML = '';
            
            // Group services by category
            const servicesByCategory = {};
            services.forEach(service => {
                if (!servicesByCategory[service.category]) {
                    servicesByCategory[service.category] = [];
                }
                servicesByCategory[service.category].push(service);
            });
            
            // Create category sections
            Object.keys(servicesByCategory).forEach(category => {
                // Create category header
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'text-sm font-medium text-gray-700 mb-2';
                categoryHeader.textContent = category;
                serviceSelection.appendChild(categoryHeader);
                
                // Create service checkboxes
                const serviceGroup = document.createElement('div');
                serviceGroup.className = 'grid grid-cols-1 md:grid-cols-2 gap-2 mb-4';
                
                servicesByCategory[category].forEach(service => {
                    const serviceCheck = document.createElement('div');
                    serviceCheck.className = 'flex items-center';
                    serviceCheck.innerHTML = `
                        <input type="checkbox" id="service-${service.id}" name="service-${service.id}" value="${service.id}" class="mr-2">
                        <label for="service-${service.id}" class="text-sm text-gray-600">${service.name}</label>
                    `;
                    serviceGroup.appendChild(serviceCheck);
                });
                
                serviceSelection.appendChild(serviceGroup);
            });
        }
        
        // Handle client selection
        function handleClientSelection() {
            const clientSelect = document.getElementById('sow-client-select');
            const selectedClientInfo = document.getElementById('selected-client-info');
            const autoResearchBtn = document.getElementById('auto-research-btn');
            
            const clientId = clientSelect.value;
            
            if (!clientId) {
                selectedClientInfo.classList.add('hidden');
                autoResearchBtn.classList.add('hidden');
                return;
            }
            
            const client = DataManager.getClientById(clientId);
            
            if (client) {
                // Show client info
                selectedClientInfo.innerHTML = `
                    <div class="flex flex-col">
                        <h3 class="font-medium text-gray-900">${client.name}</h3>
                        <div class="text-sm text-gray-600 mt-1">
                            ${client.company ? `<p><strong>Company:</strong> ${client.company}</p>` : ''}
                            ${client.industry ? `<p><strong>Industry:</strong> ${client.industry}</p>` : ''}
                            ${client.email ? `<p><strong>Email:</strong> ${client.email}</p>` : ''}
                        </div>
                    </div>
                `;
                selectedClientInfo.classList.remove('hidden');
                
                // Show research button
                autoResearchBtn.classList.remove('hidden');
                
                // Auto-fill project fields if client has research data
                if (client.researchData && client.researchData.companyProfile) {
                    // Auto-fill project title
                    document.getElementById('sow-project-title').value = `${client.company || client.name} - Strategic Services Proposal`;
                    
                    // Auto-select project type based on industry or previous SOWs
                    if (client.industry) {
                        const projectTypeSelect = document.getElementById('sow-project-type');
                        const industry = client.industry.toLowerCase();
                        
                        if (industry.includes('tech')) {
                            projectTypeSelect.value = 'ai-implementation';
                        } else if (industry.includes('retail')) {
                            projectTypeSelect.value = 'marketing-automation';
                        } else if (industry.includes('finance')) {
                            projectTypeSelect.value = 'digital-transformation';
                        }
                    }
                    
                    // Suggest services based on research
                    suggestServicesForClient();
                }
            }
        }
        
        // Perform client research
        async function performClientResearch() {
            const clientSelect = document.getElementById('sow-client-select');
            const clientId = clientSelect.value;
            const client = DataManager.getClientById(clientId);
            
            if (!client) return;
            
            // Show research progress
            const researchProgress = document.getElementById('research-progress');
            const researchSteps = document.getElementById('research-steps');
            
            researchProgress.classList.remove('hidden');
            researchSteps.innerHTML = '';
            
            // Define research steps
            const researchAreas = [
                { id: 'company', name: 'Company Profile', icon: 'üè¢' },
                { id: 'industry', name: 'Industry Context', icon: 'üìä' },
                { id: 'technology', name: 'Technology Landscape', icon: 'üíª' },
                { id: 'competitive', name: 'Competitive Analysis', icon: 'ü•á' },
                { id: 'compliance', name: 'Compliance Requirements', icon: 'üìú' }
            ];
            
            // Create research step UI
            researchAreas.forEach(area => {
                const step = document.createElement('div');
                step.id = `research-${area.id}`;
                step.className = 'research-step p-3 pl-4';
                step.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-sm mr-3">${area.icon}</span>
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${area.name}</h4>
                            <p class="text-sm text-gray-500">Researching...</p>
                        </div>
                        <div class="ml-2 animate-spin h-4 w-4 border-b-2 border-blue-600"></div>
                    </div>
                `;
                researchSteps.appendChild(step);
            });
            
            // Simulate research for each area (in a real app, this would call the AnythingLLM API)
            for (const area of researchAreas) {
                const stepElement = document.getElementById(`research-${area.id}`);
                
                try {
                    // Simulate API call
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Update UI to completed
                    stepElement.className = 'research-step p-3 pl-4 completed';
                    stepElement.querySelector('p').textContent = 'Research completed';
                    stepElement.querySelector('.animate-spin').className = 'ml-2 h-4 w-4 text-green-500';
                    stepElement.querySelector('.animate-spin').innerHTML = '‚úì';
                    
                    // Store research data in client object
                    if (!client.researchData) client.researchData = {};
                    client.researchData[`${area.id}Analysis`] = `Simulated ${area.name} research data`;
                } catch (error) {
                    // Update UI to error
                    stepElement.className = 'research-step p-3 pl-4';
                    stepElement.querySelector('p').textContent = 'Error: ' + error.message;
                    stepElement.querySelector('.animate-spin').className = 'ml-2 h-4 w-4 text-red-500';
                    stepElement.querySelector('.animate-spin').innerHTML = '‚úó';
                }
            }
            
            // Update client data
            client.researchData.lastResearchDate = new Date().toISOString();
            DataManager.saveClient(client);
            
            // Suggest services based on research
            await suggestServicesForClient();
        }
        
        // Suggest services for client
        async function suggestServicesForClient() {
            const clientSelect = document.getElementById('sow-client-select');
            const clientId = clientSelect.value;
            const client = DataManager.getClientById(clientId);
            
            if (!client) return;
            
            // Simulate AI service suggestions (in a real app, this would use the research data)
            const suggestedServices = [];
            
            // If client has research data, use it to suggest services
            if (client.industry) {
                const industry = client.industry.toLowerCase();
                
                if (industry.includes('tech') || industry.includes('software')) {
                    // For tech companies, suggest AI and automation
                    services.forEach(service => {
                        if (service.name.toLowerCase().includes('ai') || 
                            service.name.toLowerCase().includes('automation') ||
                            service.name.toLowerCase().includes('integration')) {
                            suggestedServices.push(service.id);
                        }
                    });
                } else if (industry.includes('retail') || industry.includes('consumer')) {
                    // For retail, suggest marketing and CRM
                    services.forEach(service => {
                        if (service.name.toLowerCase().includes('marketing') || 
                            service.name.toLowerCase().includes('crm') ||
                            service.name.toLowerCase().includes('customer')) {
                            suggestedServices.push(service.id);
                        }
                    });
                } else if (industry.includes('finance') || industry.includes('bank')) {
                    // For finance, suggest digital transformation and compliance
                    services.forEach(service => {
                        if (service.name.toLowerCase().includes('transform') || 
                            service.name.toLowerCase().includes('compliance') ||
                            service.name.toLowerCase().includes('security')) {
                            suggestedServices.push(service.id);
                        }
                    });
                }
            }
            
            // Check at least 3 suggested services
            document.querySelectorAll('#service-selection input[type="checkbox"]').forEach(checkbox => {
                if (suggestedServices.includes(checkbox.value)) {
                    checkbox.checked = true;
                }
            });
            
            // Show a toast notification
            showToast('ü§ñ AI has suggested services based on client profile', 'success');
        }
        
        // Generate SOW based on form data        // NEW, RE-WIRED SOW GENERATION LOGIC
        async function generateSOW() {
            const brief = document.getElementById('sow-project-brief').value.trim();
            if (!brief) {
                showToast('Please provide the raw text brief first.', 'error');
                return;
            }

            const sowPreview = document.getElementById('sow-preview');
            sowPreview.innerHTML = `<div class="text-center py-8"><div class="animate-spin h-12 w-12 border-b-2 border-blue-600 rounded-full mx-auto mb-4"></div><p>The Architect is thinking...</p></div>`;
            
            try {
                // This uses your existing AnythingLLM API function
                const markdownResponse = await callAnythingLLM(brief); 
                
                // This is a NEW function we will create to parse the AI's response
                const sowObject = parseAIResponseToSOW(markdownResponse); 
                
                // This is a NEW function we will create to build the editable HTML
                renderEditableSOW(sowObject);                showToast('‚úÖ SOW draft generated and ready for editing!', 'success');
                document.getElementById('export-pdf').classList.remove('hidden');
                document.getElementById('copy-sow').classList.remove('hidden');

            } catch (error) {
                sowPreview.innerHTML = `<div class="text-center py-8 text-red-600"><p>Error generating SOW: ${error.message}</p></div>`;
                showToast('Error generating SOW. Please try again.', 'error');
            }
        }

        // NEW - SOW EDITOR RENDERER FUNCTION
        function renderEditableSOW(sow) {
            const previewDiv = document.getElementById('sow-preview');
            let html = '';

            // Render header section
            html += `
                <div class="sow-document bg-white p-8 rounded-lg shadow-sm border">
                    <div class="mb-8">
                        <h1 contenteditable="true" class="text-3xl font-bold text-gray-900 mb-2" style="outline: none; border: 1px solid transparent; padding: 4px;" onfocus="this.style.border='1px solid #3b82f6'" onblur="this.style.border='1px solid transparent'">${sow.title}</h1>
                        <div class="text-sm text-gray-500">Generated: ${new Date().toLocaleDateString()}</div>
                    </div>

                    <div class="mb-8">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">Overview</h2>
                        <div contenteditable="true" class="editable-textarea prose max-w-none p-4 border rounded-lg" style="min-height: 120px; outline: none;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#d1d5db'">${sow.overview}</div>
                    </div>

                    <div class="mb-8">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">Project Outcomes</h2>
                        <ul class="project-outcomes-list space-y-2">
                            ${sow.projectOutcomes.map(outcome => `
                                <li class="flex items-start">
                                    <span class="text-green-500 mr-2">‚úì</span>
                                    <span contenteditable="true" class="flex-1 p-2 rounded" style="outline: none;" onfocus="this.style.backgroundColor='#f3f4f6'" onblur="this.style.backgroundColor='transparent'">${outcome}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>

                    <div class="mb-8">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">Scope Assumptions</h2>
                        <ul class="scope-assumptions-list space-y-2">
                            ${sow.scopeAssumptions.map(assumption => `
                                <li class="flex items-start">
                                    <span class="text-blue-500 mr-2">‚Ä¢</span>
                                    <span contenteditable="true" class="flex-1 p-2 rounded" style="outline: none;" onfocus="this.style.backgroundColor='#f3f4f6'" onblur="this.style.backgroundColor='transparent'">${assumption}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
            `;

            // Render each phase
            sow.phases.forEach((phase, index) => {
                html += `
                    <div class="phase-block mb-8 border rounded-lg p-6 bg-gray-50" data-phase-index="${index}">
                        <h2 contenteditable="true" class="text-xl font-semibold text-gray-900 mb-4 p-2 rounded" style="outline: none;" onfocus="this.style.backgroundColor='white'" onblur="this.style.backgroundColor='transparent'">${phase.title}</h2>
                        
                        <div class="mb-6">
                            <h3 class="text-lg font-medium text-gray-800 mb-3">Deliverables</h3>
                            <ul class="deliverables-list space-y-2">
                                ${phase.deliverables.map(deliverable => `
                                    <li class="flex items-start">
                                        <span class="text-indigo-500 mr-2">‚Üí</span>
                                        <span contenteditable="true" class="flex-1 p-2 rounded" style="outline: none;" onfocus="this.style.backgroundColor='white'" onblur="this.style.backgroundColor='transparent'">${deliverable}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        <div class="mb-4">
                            <h3 class="text-lg font-medium text-gray-800 mb-3">Pricing Summary / Investment</h3>
                            <div class="overflow-x-auto">
                                <table class="pricing-table w-full border-collapse border border-gray-300">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-4 py-2 text-left">Role</th>
                                            <th class="border border-gray-300 px-4 py-2 text-center">Hours</th>
                                            <th class="border border-gray-300 px-4 py-2 text-center">Rate (AUD)</th>
                                            <th class="border border-gray-300 px-4 py-2 text-center">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${phase.pricingTable.map((item, itemIndex) => `
                                            <tr data-item-index="${itemIndex}" class="hover:bg-gray-50">
                                                <td class="border border-gray-300 px-4 py-2" contenteditable="true" style="outline: none;">${item.role}</td>
                                                <td class="border border-gray-300 px-2 py-2 text-center">
                                                    <input type="number" class="hours-input w-full text-center border-0 bg-transparent" value="${item.hours}" oninput="recalculateTotals()" min="0" step="0.5">
                                                </td>
                                                <td class="border border-gray-300 px-2 py-2 text-center">
                                                    <input type="number" class="rate-input w-full text-center border-0 bg-transparent" value="${item.rate}" oninput="recalculateTotals()" min="0" step="1">
                                                </td>
                                                <td class="border border-gray-300 px-4 py-2 text-center font-medium line-total">$${item.cost.toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="text-right">
                            <div class="phase-total text-lg font-semibold text-gray-900">Phase Total: <strong class="text-green-600">$${phase.phaseTotal.toFixed(2)}</strong></div>
                        </div>
                    </div>
                `;
            });
            
            // Render final summary section
            html += `
                    <div id="final-summary" class="mt-8 pt-6 border-t">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">Total Project Summary</h2>
                        <div id="summary-table" class="mb-6"></div>
                        
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">Budget & Discount Notes</h2>
                        <div id="budget-notes" contenteditable="true" class="p-4 border rounded-lg prose max-w-none" style="min-height: 80px; outline: none;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#d1d5db'">${sow.budgetNotes}</div>
                        
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 mt-6">Scope & Price Overview</h2>
                        <div id="final-price-overview" class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border"></div>
                    </div>
                </div>
            `;
            
            previewDiv.innerHTML = html;
            recalculateTotals(); // Initial calculation
        }

        // NEW - AI RESPONSE PARSER FUNCTION
        function parseAIResponseToSOW(markdown) {
            const sow = new UnifiedSOW();

            // Helper function to extract a section's content
            const getSectionContent = (title) => {
                const regex = new RegExp(`##?\\s*${title}\\s*\\n([\\s\\S]*?)(?=\\n##|$)`, 'i');
                const match = markdown.match(regex);
                return match ? match[1].trim() : '';
            };

            // Extract simple text sections
            sow.title = markdown.match(/^#\s*(.*)/m)?.[1] || 'Scope of Work';
            sow.overview = getSectionContent('Overview');
            sow.projectOutcomes = getSectionContent('Project Outcomes').split('\n').map(s => s.replace(/[-*]\s*/, '').trim()).filter(s => s);
            sow.scopeAssumptions = getSectionContent('Scope Assumptions').split('\n').map(s => s.replace(/[-*]\s*/, '').trim()).filter(s => s);
            sow.budgetNotes = getSectionContent('Budget & Discount Notes');

            // Extract phases with their details
            const phasesRegex = /###\s*(Phase \d+.*)\n([\s\S]*?)####\s*Pricing Summary \/ Investment\n([\s\S]*?)(?=\n###|\n## Total Project Summary|$)/gi;
            let match;
            while ((match = phasesRegex.exec(markdown)) !== null) {
                const phase = {};
                phase.title = match[1].trim();
                phase.deliverables = match[2].split('\n').map(s => s.replace(/[-*]\s*/, '').trim()).filter(s => s);
                
                const pricingTable = [];
                const rows = match[3].trim().split('\n');
                rows.forEach(row => {
                    const cells = row.split('|').map(cell => cell.trim());
                    if (cells.length === 5 && !cells[1].includes('ROLE')) { // check for table rows
                        pricingTable.push({
                            role: cells[1],
                            hours: parseFloat(cells[2]) || 0,
                            rate: parseFloat(cells[3].replace(/[$,]/g, '')) || 0,
                            cost: parseFloat(cells[4].replace(/[$,]/g, '')) || 0
                        });
                    }
                });
                phase.pricingTable = pricingTable;
                phase.phaseTotal = pricingTable.reduce((sum, item) => sum + item.cost, 0);
                sow.phases.push(phase);
            }
            
            // Calculate subtotal from all phases
            sow.subTotal = sow.phases.reduce((sum, phase) => sum + phase.phaseTotal, 0);

            return sow;
        }
        
        // Generate SOW content
        function generateSOWContent(sow, client, selectedServices, projectBrief) {
            const sowPreview = document.getElementById('sow-preview');
            
            // Calculate total cost
            let totalCost = parseInt(sow.pricing.subtotal) || 10000;
            
            // Generate content
            const sowHTML = `
                <div class="sow-document">
                    <!-- Header -->
                    <div class="flex justify-between items-center border-b pb-6 mb-6">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">${sow.title}</h1>
                            <p class="text-gray-600 mt-1">Statement of Work</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">Date: ${new Date().toLocaleDateString()}</p>
                            <p class="text-sm text-gray-600">Reference: SOW-${sow.id.substring(0, 8)}</p>
                        </div>
                    </div>
                    
                    <!-- Client Information -->
                    <div class="mb-6">
                        <h2 class="text-lg font-bold text-gray-900 mb-3">Client Information</h2>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm font-medium text-gray-700">Client Name:</p>
                                    <p class="text-sm text-gray-900">${client.name}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-700">Company:</p>
                                    <p class="text-sm text-gray-900">${client.company || 'N/A'}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-700">Email:</p>
                                    <p class="text-sm text-gray-900">${client.email || 'N/A'}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-700">Industry:</p>
                                    <p class="text-sm text-gray-900">${client.industry || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Project Overview -->
                    <div class="mb-6">
                        <h2 class="text-lg font-bold text-gray-900 mb-3">Project Overview</h2>
                        <p class="text-gray-700">${projectBrief || 
                            `This Statement of Work outlines the services that Social Garden will provide to ${client.company || 'the client'} 
                            to meet their business objectives and requirements. Our solution is designed to deliver measurable results 
                            and provide exceptional value.`}</p>
                    </div>
                    
                    <!-- Services & Deliverables -->
                    <div class="mb-6">
                        <h2 class="text-lg font-bold text-gray-900 mb-3">Services & Deliverables</h2>
                        ${selectedServices.map(service => `
                            <div class="mb-4 border-l-4 border-blue-600 pl-4">
                                <h3 class="font-medium text-gray-900">${service.name}</h3>
                                <p class="text-sm text-gray-700 mb-2">${service.description}</p>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="text-xs font-medium text-gray-700 mb-1">Key Deliverables:</p>
                                    <ul class="list-disc list-inside text-xs text-gray-600 pl-2 space-y-1">
                                        ${service.deliverables.map(d => `<li>${d}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Timeline -->
                    <div class="mb-6">
                        <h2 class="text-lg font-bold text-gray-900 mb-3">Project Timeline</h2>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="space-y-3">
                                ${selectedServices[0]?.phases?.map((phase, index) => `
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center flex-shrink-0">
                                            ${index + 1}
                                        </div>
                                        <div class="ml-4">
                                            <p class="font-medium text-gray-900">${phase}</p>
                                            <p class="text-sm text-gray-700">
                                                ${['Week 1-2', 'Week 3-4', 'Week 5-6', 'Week 7-8', 'Week 9-10'][index] || 'TBD'}
                                            </p>
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-gray-700">Detailed timeline to be determined based on project kickoff.</p>'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pricing -->
                    <div class="mb-6">
                        <h2 class="text-lg font-bold text-gray-900 mb-3">Investment</h2>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <table class="w-full">
                                <thead>
                                    <tr class="text-left text-sm font-medium text-gray-700 border-b">
                                        <th class="pb-2">Service</th>
                                        <th class="pb-2 text-right">Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${selectedServices.map((service, i) => {
                                        const price = Math.round(totalCost / selectedServices.length);
                                        return `
                                            <tr class="border-b">
                                                <td class="py-2 text-sm">${service.name}</td>
                                                <td class="py-2 text-sm text-right">$${price.toLocaleString()}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    <tr>
                                        <td class="py-2 text-sm font-medium">Total</td>
                                        <td class="py-2 text-sm font-medium text-right">$${totalCost.toLocaleString()}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Acceptance -->
                    <div class="mt-8 pt-6 border-t">
                        <div class="grid grid-cols-2 gap-8">
                            <div>
                                <p class="text-sm font-medium text-gray-700 mb-1">Social Garden Pty Ltd</p>
                                <div class="h-16 border-b border-dashed"></div>
                                <p class="text-xs text-gray-600 mt-1">Authorized Signature</p>
                                <p class="text-xs text-gray-600">Date: _________________</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-700 mb-1">${client.company || client.name}</p>
                                <div class="h-16 border-b border-dashed"></div>
                                <p class="text-xs text-gray-600 mt-1">Authorized Signature</p>
                                <p class="text-xs text-gray-600">Date: _________________</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            sowPreview.innerHTML = sowHTML;
        }
        
        // Save SOW draft
        function saveSOWDraft() {
            const clientSelect = document.getElementById('sow-client-select');
            const clientId = clientSelect.value;
            const client = DataManager.getClientById(clientId);
            
            if (!client) {
                showToast('Please select a client first', 'error');
                return;
            }
            
            // Get form data
            const projectTitle = document.getElementById('sow-project-title').value;
            const projectType = document.getElementById('sow-project-type').value;
            const budget = document.getElementById('sow-budget').value;
            const projectBrief = document.getElementById('sow-project-brief').value;
            
            // Get selected services
            const selectedServiceIds = [];
            document.querySelectorAll('#service-selection input[type="checkbox"]:checked').forEach(checkbox => {
                selectedServiceIds.push(checkbox.value);
            });
            
            // Create draft SOW
            const sow = new UnifiedSOW({
                clientId: client.id,
                title: projectTitle || 'Untitled SOW',
                status: 'draft',
                projectOverview: projectBrief,
                selectedServices: selectedServiceIds,
                pricing: {
                    subtotal: parseInt(budget) || 0,
                    tax: 0,
                    total: parseInt(budget) || 0,
                    currency: 'USD'
                }
            });
            
            // Save to client
            if (!client.sowHistory) client.sowHistory = [];
            client.sowHistory.push(sow);
            client.activeSOW = sow.id;
            DataManager.saveClient(client);
            
            showToast('‚úÖ Draft SOW saved successfully!', 'success');
        }
        
        // Export SOW to PDF
        function exportSOWToPDF() {
            // In a real app, this would use jsPDF or a PDF generation service
            // For now, we'll just show a message
            showToast('PDF export coming soon!', 'info');
        }
        
        // Copy SOW to clipboard
        function copySOWToClipboard() {
            const sowPreview = document.getElementById('sow-preview');
            
            // Create a range and select the SOW content
            const range = document.createRange();
            range.selectNode(sowPreview);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            
            // Copy to clipboard
            document.execCommand('copy');
              // Clear selection
            window.getSelection().removeAllRanges();
            
            showToast('‚úÖ SOW copied to clipboard!', 'success');
        }
        
        // Initialize SOW Generator when app loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSOWGenerator();
            initializeServiceCatalog(); // Initialize the service catalog from kb.md
        });
        
        // Initialize Service Catalog from kb.md
        async function initializeServiceCatalog() {
            try {
                // Fetch kb.md content
                const response = await fetch('kb.md');
                const kbContent = await response.text();
                
                // Parse content into service categories and services
                const serviceCatalog = parseKnowledgeBase(kbContent);
                
                // Store in DataManager
                DataManager.setServiceCatalog(serviceCatalog);
                
                console.log('Service catalog initialized successfully:', serviceCatalog);
                
                // Update any service-related UI elements
                updateServiceSelectionUI();
                
            } catch (error) {
                console.error('Error initializing service catalog:', error);
                showToast('Failed to load service catalog', 'error');
            }
        }
        
        // Parse knowledge base content into structured service catalog
        function parseKnowledgeBase(content) {
            // Initial categories based on the content analysis
            const serviceCategories = [
                { id: 'marketing-automation', name: 'Marketing Automation', description: 'Email templates, nurture programs, platform setup and integration' },
                { id: 'crm', name: 'CRM', description: 'Customer Relationship Management implementation and optimization' },
                { id: 'strategy', name: 'Strategy', description: 'Marketing and sales strategy development and implementation' },
                { id: 'audit', name: 'Audit', description: 'Assessment of current systems and processes' },
                { id: 'digital-marketing', name: 'Digital Marketing', description: 'Digital advertising, SEO, and content marketing' }
            ];
            
            // Services extracted from the knowledge base
            const services = [];
            
            // Use regex to find service sections
            const servicePatterns = [
                {
                    regex: /Marketing AutomationÔΩú([^ÔΩú\n]+)/g,
                    category: 'marketing-automation'
                },
                {
                    regex: /CRMÔΩú([^ÔΩú\n]+)/g,
                    category: 'crm'
                },
                {
                    regex: /AuditÔΩú([^ÔΩú\n]+)/g,
                    category: 'audit'
                }
            ];
            
            // Extract services for each pattern
            servicePatterns.forEach(pattern => {
                let match;
                while ((match = pattern.regex.exec(content)) !== null) {
                    const serviceName = match[1].trim();
                    
                    // Find service description - look for description after service name
                    let descriptionMatch = content.substring(match.index).match(/(?:^|\n)([^:]+?):\s*([^\n]+)/);
                    let description = descriptionMatch ? descriptionMatch[2].trim() : 'Detailed service offering by Social Garden';
                    
                    // Create unique ID for the service
                    const serviceId = (pattern.category + '-' + serviceName.toLowerCase().replace(/\s+/g, '-'))
                        .replace(/[^a-z0-9-]/g, '');
                    
                    // Add service if not a duplicate
                    if (!services.some(s => s.id === serviceId)) {
                        services.push({
                            id: serviceId,
                            name: serviceName,
                            category: pattern.category,
                            description: description,
                            templateText: extractServiceTemplate(content, serviceName)
                        });
                    }
                }
            });
            
            // Add generic services for each category to ensure we have at least something
            serviceCategories.forEach(category => {
                // If no services for this category, add a generic one
                if (!services.some(s => s.category === category.id)) {
                    services.push({
                        id: category.id + '-general',
                        name: category.name + ' Services',
                        category: category.id,
                        description: 'General ' + category.name + ' services offered by Social Garden',
                        templateText: 'This scope of work details a proposed solution for Social Garden to support [CLIENT] with ' + 
                                    category.name + ' services related to [PROJECT].'
                    });
                }
            });
            
            return {
                categories: serviceCategories,
                services: services
            };
        }
        
        // Extract service template text from content
        function extractServiceTemplate(content, serviceName) {
            // Try to find a section specific to this service
            const serviceSection = content.match(new RegExp('(?:' + serviceName + '|' + 
                                              serviceName.replace(/ÔΩú/g, '\\|') + ')[^\\n]*\\n([\\s\\S]+?)(?:\\n\\n|$)'));
            
            // If found, return the section, otherwise return a generic template
            if (serviceSection && serviceSection[1]) {
                return serviceSection[1].trim();
            }
            
            // Default template structure from the knowledge base
            return `This scope of work details a proposed solution for Social Garden to support [CLIENT] with ${serviceName} services related to [PROJECT].
            
Project Outcomes:
- One easy to use unified system
- Improved user experience
- Solution powered by workflow and automation
- Reduced processing times
- Improved conversion rates
- Improved insights

Project Phases:
1. Discovery & Planning
2. Technical Assessment & Setup
3. Quality Assurance & Testing
4. Final Delivery & Go-live`;
        }
        
        // Update Service Selection UI with the parsed service catalog
        function updateServiceSelectionUI() {
            const serviceSelection = document.getElementById('service-selection');
            if (!serviceSelection) return;
            
            const serviceCatalog = DataManager.getServiceCatalog();
            if (!serviceCatalog || !serviceCatalog.categories || !serviceCatalog.services) return;
            
            let html = '';
            
            // Group services by category
            serviceCatalog.categories.forEach(category => {
                const categoryServices = serviceCatalog.services.filter(service => service.category === category.id);
                
                if (categoryServices.length > 0) {
                    html += `
                    <div class="mb-4">
                        <h3 class="font-semibold text-lg mb-2">${category.name}</h3>
                        <div class="space-y-2">`;
                    
                    categoryServices.forEach(service => {
                        html += `
                        <div class="flex items-start">
                            <input type="checkbox" id="service-${service.id}" value="${service.id}" 
                                class="mt-1 h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                            <label for="service-${service.id}" class="ml-2 block">
                                <span class="font-medium">${service.name}</span>
                                <p class="text-sm text-gray-500">${service.description}</p>
                            </label>
                        </div>`;
                    });
                    
                    html += `
                        </div>
                    </div>`;
                }
            });
            
            serviceSelection.innerHTML = html;
        }
        
        // Utility function for notifications
        function showNotification(message, type = 'info') {
            // Reuse the existing toast function
            showToast(message, type);
        }
        
        // Helper functions for the AI Autofill feature (Production Mode)
        async function scrapeUrl(url) {
            try {
                const response = await fetch('/api/v1/document/upload-link', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('anyapi_token') || '')
                    },
                    body: JSON.stringify({
                        link: url
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error scraping URL: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('URL scraping error:', error);
                throw error;
            }
        }
        
        async function analyzeWithAI(prompt) {
            try {
                const response = await fetch('/api/v1/workspace/client-analyzer/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('anyapi_token') || '')
                    },
                    body: JSON.stringify({
                        message: prompt,
                        mode: 'chat'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error analyzing with AI: ${response.statusText}`);
                }
                
                const data = await response.json();
                return data.response || data.content || '';
            } catch (error) {
                console.error('AI analysis error:', error);
                throw error;
            }
        }

        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }
        
        // Final setup and event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // ... (other listeners if any)
            
            document.getElementById('update-client-info-btn').addEventListener('click', function() {
                // Use the existing addClient logic to submit the form
                const addClientForm = document.getElementById('add-client-form');
                if (addClientForm) {
                    addClientForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                }
                
                // Close the AI modal
                const aiModal = document.getElementById('add-client-modal');
                if (aiModal) {
                    aiModal.classList.add('hidden');
                }
            });
        });

    </script>
</body>
</html>
